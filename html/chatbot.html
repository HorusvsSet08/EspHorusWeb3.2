<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatbot Meteorológico - Horus Benavente</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/chatbot.css" />
  <script src="../js/PapaParse.js"></script>
  <script src="../js/chart.js"></script>
</head>
<body class="light-mode chatbot-page">
<nav class="nav">
  <div class="nav-container">
    <div class="nav-buttons">
      <a href="../index.html" class="nav-btn"><span class="nav-icon">🏠</span> Inicio</a>
      <a href="mqtt.html" class="nav-btn">
        <span class="nav-icon">📡</span> Datos en Vivo
      </a>
      <a href="analisis.html" class="nav-btn">
        <span class="nav-icon">📊</span> Análisis
      </a>
      <a href="chatbot.html" class="nav-btn active">
        <span class="nav-icon">🤖</span> Chatbot
      </a>
    </div>
    <!-- Switch de Galahad -->
    <div class="nav-right">
      <label class="theme-switch">
        <input type="checkbox" class="theme-switch__checkbox">
        <div class="theme-switch__container">
          <div class="theme-switch__clouds"></div>
          <div class="theme-switch__stars-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 55" fill="none">
            </svg>
          </div>
          <div class="theme-switch__sun-moon-container">
            <div class="theme-switch__moon">
              <div class="theme-switch__spot"></div>
              <div class="theme-switch__spot"></div>
              <div class="theme-switch__spot"></div>
            </div>
          </div>
        </div>
      </label>
      <button id="api-config-toggle" class="nav-btn" title="Configuración de API">
        <span class="nav-icon">⚙️</span>
      </button>
    </div>
  </div>
</nav>

<div class="container">
  <header>
    <h1>🤖 Horus AI - Asistente Meteorológico de Benavente</h1>
    <p>Un asistente especializado en análisis meteorológico para <strong>Benavente, Zamora</strong></p>
  </header>
  
  <main id="chat-container" class="chat-main-container">
    <div id="chat-messages" class="chat-messages">
      <div class="message bot welcome-message">
        <div class="bot-avatar">
          <span>🤖</span>
        </div>
        <div class="message-content">
          ¡Hola! Soy Horus AI, tu asistente inteligente especializado en meteorología para <strong>Benavente, Zamora</strong>.<br><br>
          <strong>Puedo ayudarte con:</strong>
          <ul>
            <li>Consultar la temperatura, humedad, presión y otros datos actuales en Benavente</li>
            <li>Analizar tendencias históricas de los últimos días, semanas o meses en la zona</li>
            <li>Comparar condiciones meteorológicas entre diferentes periodos en Benavente</li>
            <li>Predecir condiciones climáticas basado en datos históricos de la región</li>
            <li>Explicar cómo el clima afecta actividades típicas de Benavente</li>
            <li>Responder preguntas sobre el sistema Horus instalado en Benavente</li>
          </ul>
          <br>
          <strong>Ejemplos de preguntas:</strong>
          <div class="suggestion">¿Cuál es la temperatura actual en Benavente?</div>
          <div class="suggestion">¿Cómo ha sido la tendencia de humedad en Benavente esta semana?</div>
          <div class="suggestion">Muestra la tendencia de presión de los últimos 7 días en Benavente</div>
        </div>
        <div class="message-time">Ahora</div>
      </div>
    </div>
    
    <div class="chat-input-container">
      <input type="text" id="user-input" placeholder="Escribe tu pregunta sobre Benavente...">
      <button id="send-button">Enviar</button>
    </div>
    
    <div class="status-bar">
      <div id="status-indicator" class="status-indicator"></div>
      <span id="status-text"></span>
    </div>
    
    <!-- Configuración de API de OpenAI -->
    <div class="api-config" id="api-config">
      <h3>Configuración de API de OpenAI</h3>
      <p>Configura tu clave API de OpenAI para obtener respuestas más avanzadas y precisas.</p>
      <input type="password" id="api-key-input" placeholder="Ingresa tu clave API de OpenAI aquí">
      <button id="save-api-key">Guardar API Key</button>
      <div class="api-status" id="api-status">Estado: No configurado</div>
    </div>
  </main>
</div>

<style>
  /* Estilos para el contenedor del chat */
  .chat-main-container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--card-bg);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  /* Mensajes del chat */
  .chat-messages {
    height: 60vh;
    overflow-y: auto;
    padding: 15px;
    background: var(--dark-bg);
  }

  .message {
    display: flex;
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
  }

  .message.user {
    justify-content: flex-end;
  }

  .message.bot {
    justify-content: flex-start;
  }

  .bot-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    flex-shrink: 0;
  }

  .bot-avatar span {
    font-size: 20px;
  }

  .message-content {
    background: var(--card-bg);
    color: var(--text);
    padding: 12px 15px;
    border-radius: 18px;
    max-width: 75%;
    line-height: 1.5;
  }

  .message.user .message-content {
    background: var(--primary);
    color: #000;
    border-bottom-right-radius: 5px;
  }

  .message-time {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 5px;
    text-align: right;
    opacity: 0.7;
  }

  /* Barra de entrada */
  .chat-input-container {
    display: flex;
    padding: 10px 15px;
    background: var(--card-bg);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .chat-input-container input {
    flex: 1;
    padding: 12px 15px;
    border: none;
    background: var(--dark-bg);
    color: var(--text);
    border-radius: 20px 0 0 20px;
    font-size: 16px;
    outline: none;
    transition: var(--transition);
  }

  .chat-input-container input:focus {
    box-shadow: 0 0 0 2px var(--primary-glow);
  }

  .chat-input-container button {
    background: var(--primary);
    color: #000;
    border: none;
    padding: 12px 20px;
    border-radius: 0 20px 20px 0;
    cursor: pointer;
    font-weight: bold;
    transition: var(--transition);
  }

  .chat-input-container button:hover {
    background: #00d0e0;
    transform: translateY(-2px);
  }

  /* Sugerencias de preguntas */
  .suggestion {
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 12px;
    margin: 5px 0;
    cursor: pointer;
    transition: var(--transition);
  }

  .suggestion:hover {
    background: rgba(0, 234, 255, 0.2);
    transform: translateX(5px);
  }

  /* Efecto de escritura */
  .typing-indicator {
    display: inline-flex;
    gap: 4px;
    margin-right: 8px;
  }

  .typing-indicator span {
    width: 6px;
    height: 6px;
    background: var(--primary);
    border-radius: 50%;
    animation: typing 1s infinite;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%, 100% { transform: translateY(0); opacity: 0.5; }
    50% { transform: translateY(-5px); opacity: 1; }
  }

  /* Análisis de datos */
  .analysis-header {
    margin-bottom: 15px;
  }

  .analysis-header h2 {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--primary);
  }

  .analysis-header p {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .statistics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }

  .stat-item {
    background: rgba(0, 234, 255, 0.1);
    padding: 10px;
    border-radius: 8px;
    text-align: center;
  }

  .stat-value {
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--primary);
    display: block;
    margin-top: 5px;
  }

  .trend-analysis {
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
  }

  .trend-analysis h3 {
    margin-top: 0;
    color: var(--primary);
  }

  .trend-description {
    color: var(--text-secondary);
  }

  .prediction-container {
    margin-top: 15px;
  }

  .prediction-reliability {
    margin-bottom: 10px;
    font-size: 0.9rem;
  }

  .reliability-bar {
    height: 6px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    margin-top: 4px;
  }

  .reliability-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  .prediction-chart-container {
    height: 250px;
    margin-top: 10px;
  }

  .chart-title {
    font-weight: bold;
    margin-bottom: 8px;
    color: var(--primary);
    font-size: 1rem;
  }

  .source-badge {
    display: inline-block;
    margin-left: 5px;
    font-size: 0.8rem;
    opacity: 0.7;
  }

  .welcome-message {
    background: rgba(0, 234, 255, 0.05);
    border-radius: 15px;
    padding: 15px;
    border: 1px solid rgba(0, 234, 255, 0.2);
  }
  
  /* Análisis detallado */
  .detailed-analysis {
    margin-top: 15px;
    background: rgba(0, 0, 0, 0.1);
    padding: 15px;
    border-radius: 10px;
  }
  
  .detailed-analysis h3 {
    color: var(--primary);
    margin-top: 0;
  }
  
  .detailed-analysis p {
    line-height: 1.6;
    margin-bottom: 10px;
  }
  
  .confidence-indicator {
    display: inline-block;
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    margin-top: 5px;
  }
  
  /* Soporte para preguntas generales */
  .general-answer {
    margin-top: 15px;
    background: rgba(0, 150, 255, 0.1);
    padding: 15px;
    border-radius: 10px;
  }
  
  .general-answer h3 {
    color: var(--primary);
    margin-top: 0;
  }
  
  .general-answer p {
    line-height: 1.6;
  }
  
  .general-answer ul {
    padding-left: 20px;
    margin: 10px 0;
  }
  
  .general-answer li {
    margin-bottom: 5px;
  }
  
  .system-info {
    margin-top: 15px;
    background: rgba(76, 175, 80, 0.1);
    padding: 15px;
    border-radius: 10px;
  }
  
  .system-info h3 {
    color: #4CAF50;
    margin-top: 0;
  }
  
  .system-info p {
    line-height: 1.6;
  }
  
  /* Soporte para preguntas fuera del ámbito */
  .out-of-scope {
    margin-top: 15px;
    background: rgba(244, 67, 54, 0.1);
    padding: 15px;
    border-radius: 10px;
  }
  
  .out-of-scope h3 {
    color: #f44336;
    margin-top: 0;
  }
  
  .out-of-scope p {
    line-height: 1.6;
  }
  
  /* Configuración de API */
  .api-config {
    padding: 15px;
    margin: 15px;
    background: var(--dark-bg);
    border-radius: 10px;
    display: none;
  }

  .api-config h3 {
    color: var(--primary);
    margin-top: 0;
  }

  .api-config p {
    margin-bottom: 10px;
  }

  .api-config input {
    width: 100%;
    padding: 8px 12px;
    margin-bottom: 10px;
    border-radius: 5px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(0, 0, 0, 0.2);
    color: white;
  }

  .api-config button {
    background: var(--primary);
    color: #000;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .api-config button:hover {
    background: #00d0e0;
  }

  .api-status {
    font-size: 0.9rem;
    margin-top: 5px;
    opacity: 0.7;
  }

  .api-status.connected {
    color: #4CAF50;
  }

  .api-status.disconnected {
    color: #f44336;
  }
</style>

<script>
  // Variables globales
  let historicalData = [];
  let chatbotReady = false;
  let charts = []; // Para almacenar instancias de gráficos
  
  // Contexto de conversación mejorado
  let conversationContext = {
    lastParameter: null,
    lastPeriod: null,
    lastQuestionType: null,
    conversationHistory: [],
    entityContext: {},
    temporalContext: null,
    spatialContext: null,
    confidenceThreshold: 0.65 // Umbral de confianza para aceptar una intención
  };

  // Información específica de Benavente
  const benaventeInfo = {
    location: "Benavente, Zamora",
    coordinates: "41.7667° N, 5.3500° W",
    altitude: "719 metros sobre el nivel del mar",
    climate: "Clima mediterráneo continentalizado",
    typicalWeather: {
      summer: "Caluroso y seco, con temperaturas máximas que pueden superar los 35°C",
      winter: "Frío, con temperaturas mínimas que pueden llegar a -5°C",
      spring: "Moderado con lluvias ocasionales",
      autumn: "Fresco con días soleados y noches frías"
    },
    localFeatures: "Ubicado en la llanura del Duero, con influencia de la meseta castellana",
    localLandmarks: [
      "Plaza Mayor de Benavente",
      "Iglesia de Santiago",
      "Castillo de Benavente",
      "Río Esla",
      "Mercado de Ganados"
    ],
    localEvents: [
      "Feria de San Martín (noviembre)",
      "Semana Santa",
      "Fiestas Patronales (agosto)",
      "Feria Agropecuaria (mayo)"
    ],
    localPhrases: [
      "¡Vaya fresquete hace hoy!",
      "Esto parece que va a aguar",
      "Hace un sol de justicia",
      "Está cayendo un chaparrón",
      "Hace un día de perros",
      "Hoy hace un día de campo",
      "Está el día nublao",
      "¡Qué bochorno!",
      "Está fresquete",
      "Está el día apretao"
    ]
  };

  // Elementos del DOM
  const chatMessages = document.getElementById('chat-messages');
  const userInput = document.getElementById('user-input');
  const sendButton = document.getElementById('send-button');
  const statusIndicator = document.getElementById('status-indicator');
  const statusText = document.getElementById('status-text');
  
  // Elementos de configuración de API
  const apiConfig = document.getElementById('api-config');
  const apiKeyInput = document.getElementById('api-key-input');
  const saveApiKeyBtn = document.getElementById('save-api-key');
  const apiStatus = document.getElementById('api-status');
  const apiConfigToggle = document.getElementById('api-config-toggle');

  // Actualizar estado
  const updateStatus = (message, isError = false) => {
    statusText.textContent = message;
    if (isError) {
      statusIndicator.classList.add('error');
    } else {
      statusIndicator.classList.remove('error');
    }
  };

  // Añadir mensaje al chat
  const addMessage = (content, isUser = false, source = 'local') => {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.classList.add(isUser ? 'user' : 'bot');
    
    // Marca de fuente para mensajes del bot
    const sourceBadge = source !== 'local' 
      ? `<span class="source-badge" title="Información obtenida de: ${source}">${source === 'web' ? '🌐' : source}</span>` 
      : '';
      
    if (isUser) {
      messageDiv.innerHTML = `
        <div class="message-content">${content}</div>
        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="bot-avatar"><span>🤖</span></div>
        <div class="message-content">${content}${sourceBadge}</div>
        <div class="message-time">Ahora</div>
      `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Actualizar el tiempo "Ahora" a minutos reales después de 5 segundos
    setTimeout(() => {
      const timeElement = messageDiv.querySelector('.message-time');
      if (timeElement && timeElement.textContent === 'Ahora') {
        timeElement.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      }
    }, 5000);
    
    // Guardar en historial de conversación
    if (!isUser) {
      conversationContext.conversationHistory.push({
        role: 'assistant',
        content,
        timestamp: new Date().toISOString()
      });
    }
  };

  // Mostrar estado de carga
  const showLoading = (message = "Analizando tu pregunta sobre Benavente") => {
    const loadingId = `loading-${Date.now()}`;
    const loadingDiv = document.createElement('div');
    loadingDiv.id = loadingId;
    loadingDiv.className = 'message bot';
    loadingDiv.innerHTML = `
      <div class="bot-avatar"><span>🤖</span></div>
      <div class="message-content">
        <div class="typing-indicator"><span></span><span></span><span></span></div>
        <div class="loading-text">${message}</div>
      </div>
      <div class="message-time">Escribiendo...</div>
    `;
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return loadingId;
  };

  // Nueva integración con OpenAI API
  const openAIApi = {
    apiKey: null,
    apiUrl: 'https://api.openai.com/v1/chat/completions',
    
    // Verificar si está configurado
    isConfigured: function() {
      return this.apiKey !== null && this.apiKey.trim() !== '';
    },
    
    // Configurar la API key
    configure: function(apiKey) {
      this.apiKey = apiKey;
      localStorage.setItem('openai_api_key', apiKey);
      console.log('OpenAI API configurada correctamente');
      return true;
    },
    
    // Inicializar desde localStorage
    init: function() {
      const savedKey = localStorage.getItem('openai_api_key');
      if (savedKey) {
        this.apiKey = savedKey;
        return true;
      }
      return false;
    },
    
    // Limpiar configuración
    clear: function() {
      this.apiKey = null;
      localStorage.removeItem('openai_api_key');
    },
    
    // Verificar validez de la API key
    async verifyApiKey() {
      if (!this.isConfigured()) return false;
      
      try {
        const response = await fetch('https://api.openai.com/v1/models', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${this.apiKey}`
          }
        });
        
        return response.ok;
      } catch (error) {
        console.error('Error verificando API key:', error);
        return false;
      }
    },
    
    // Generar respuesta usando OpenAI
    generateResponse: async function(userMessage, context) {
      if (!this.isConfigured()) {
        return null;
      }
      
      try {
        // Preparar el prompt con contexto meteorológico
        const prompt = this.buildPrompt(userMessage, context);
        
        const response = await fetch(this.apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
              {
                role: 'system',
                content: `Eres Horus AI, un asistente meteorológico especializado en Benavente, Zamora. Tienes acceso a datos meteorológicos en tiempo real y datos históricos. Tu tarea es proporcionar información precisa y útil sobre el clima de Benavente, con un enfoque en explicaciones claras y consejos prácticos. Habla de manera amigable y profesional, usando referencias locales cuando sea apropiado.`
              },
              ...context.conversationHistory.map(msg => ({
                role: msg.role,
                content: msg.content
              })),
              {
                role: 'user',
                content: prompt
              }
            ],
            temperature: 0.7,
            max_tokens: 500,
            top_p: 1,
            frequency_penalty: 0,
            presence_penalty: 0
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Error de API: ${response.status} - ${errorData.error?.message || 'Error desconocido'}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error('Error al usar OpenAI API:', error);
        return null;
      }
    },
    
    // Construir el prompt con contexto
    buildPrompt: function(userMessage, context) {
      // Incluir contexto meteorológico específico de Benavente
      const benaventeContext = `
        Benavente, Zamora - Información clave:
        - Ubicación: 41.7667° N, 5.3500° W
        - Altitud: 719 metros sobre el nivel del mar
        - Clima: Mediterráneo continentalizado
        - Verano: Caluroso y seco, temperaturas máximas >35°C
        - Invierno: Frío, temperaturas mínimas <0°C
        - Primavera/Otoño: Moderados con lluvias ocasionales
        - Ubicado en la llanura del Duero, con influencia de la meseta castellana
      `;
      
      // Incluir datos actuales si están disponibles
      const latestData = context.historicalData && context.historicalData.length > 0 ? 
        context.historicalData[context.historicalData.length - 1] : null;
      
      let currentConditions = '';
      if (latestData) {
        currentConditions = `
          Condiciones actuales en Benavente:
          - Temperatura: ${latestData.temp.toFixed(1)}°C
          - Humedad: ${latestData.hum.toFixed(0)}%
          - Presión: ${latestData.pres.toFixed(0)} hPa
          - Dirección del viento: ${getWindDirectionName(latestData.wind_dir)} (${latestData.wind_dir}°)
          - Velocidad del viento: ${latestData.wind.toFixed(1)} m/s
          - Calidad del aire: ${latestData.gas.toFixed(2)} kΩ
        `;
      }
      
      // Incluir contexto de conversación
      const conversationContext = context.conversationContext ? `
        Contexto de conversación:
        - Último parámetro mencionado: ${context.conversationContext.lastParameter || 'Ninguno'}
        - Último periodo analizado: ${context.conversationContext.lastPeriod || 'Ninguno'}
        - Último tipo de pregunta: ${context.conversationContext.lastQuestionType || 'Ninguno'}
      ` : '';
      
      return `Contexto meteorológico de Benavente:
        ${benaventeContext}
        ${currentConditions}
        ${conversationContext}
        
        Mensaje del usuario: "${userMessage}"
        
        Proporciona una respuesta detallada, precisa y útil sobre el clima de Benavente, adaptada a la pregunta del usuario. Usa un tono amigable y profesional, incorporando referencias locales cuando sea apropiado. Si la pregunta no está relacionada con el clima, indica amablemente que tu especialidad es el clima de Benavente y ofrece ayuda en ese ámbito.`;
    }
  };

  // Cargar datos históricos reales de Benavente
  const loadHistoricalData = async () => {
    return new Promise((resolve, reject) => {
      try {
        // Simulación de carga de datos (en producción, esto vendría de un archivo CSV o API)
        setTimeout(() => {
          // Datos reales de Benavente (ejemplo de formato)
          const rawData = `2025-08-18 23:32:38	28.88	34.86	935.87	665.09	16	17	N/A	0.00	0.42	0.00
2025-08-18 23:35:48	28.53	34.94	935.87	665.14	16	19	N/A	0.00	0.42	0.00
2025-08-18 23:38:48	28.34	35.78	935.92	664.66	15	16	N/A	0.00	0.42	0.00
2025-08-18 23:41:48	28.19	36.60	935.97	664.28	17	18	N/A	0.00	0.42	0.00
2025-08-18 23:44:48	28.13	36.87	935.92	664.70	13	13	N/A	0.00	0.42	0.00
2025-08-18 23:47:48	28.08	36.36	935.92	664.71	16	17	N/A	0.00	0.42	0.00
2025-08-18 23:50:48	27.99	36.24	935.88	665.05	15	17	N/A	0.00	0.42	0.00
2025-08-18 23:53:48	27.88	35.87	935.88	665.01	15	16	N/A	0.00	0.42	0.00
2025-08-18 23:56:48	27.67	36.02	935.93	664.55	14	15	N/A	0.00	0.42	0.00
2025-08-18 23:59:48	27.59	36.38	935.89	664.94	16	17	N/A	0.00	0.42	0.00`;

          // Procesar los datos
          historicalData = [];
          const lines = rawData.trim().split('\n');
          
          lines.forEach(line => {
            const [timestampStr, tempStr, humStr, presStr, presCorrStr, windDirStr, windSpeedStr, rainStr, extra1Str, gasStr, extra2Str] = line.split('\t');
            
            // Convertir valores a números
            const temp = parseFloat(tempStr);
            const hum = parseFloat(humStr);
            const pres = parseFloat(presStr);
            const windDir = parseFloat(windDirStr);
            const windSpeed = parseFloat(windSpeedStr);
            const gas = parseFloat(gasStr);
            
            // Determinar si está lloviendo (simplificado para el ejemplo)
            const isRaining = rainStr === 'N/A' ? 0 : (parseFloat(rainStr) > 0 ? 1 : 0);
            
            historicalData.push({
              timestamp: new Date(timestampStr).toISOString(),
              temp: temp,
              hum: hum,
              pres: pres,
              lluvia: isRaining,
              wind: windSpeed,
              wind_dir: windDir,
              gas: gas
            });
          });
          
          // Ordenar por fecha
          historicalData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          
          console.log(`Datos cargados: ${historicalData.length} registros históricos de Benavente`);
          resolve();
        }, 800);
      } catch (error) {
        console.error("Error procesando datos históricos:", error);
        reject(error);
      }
    });
  };

  // Procesar mensaje del usuario
  const processUserMessage = async (message) => {
    // Guardar en historial de conversación
    conversationContext.conversationHistory.push({
      role: 'user',
      content: message,
      timestamp: new Date().toISOString()
    });
    
    // Mostrar mensaje de usuario
    addMessage(message, true);
    
    // Mostrar estado de carga
    const loadingId = showLoading("Consultando con IA avanzada...");
    
    try {
      // Probar primero con OpenAI si está configurada
      if (openAIApi.isConfigured()) {
        updateStatus("Consultando con modelo avanzado...");
        const openAIResponse = await openAIApi.generateResponse(message, {
          historicalData: historicalData,
          conversationContext: conversationContext
        });
        
        // Eliminar el estado de carga
        document.getElementById(loadingId).remove();
        
        if (openAIResponse) {
          // Añadir fuente de información
          return openAIResponse;
        }
      }
      
      // Si no hay respuesta de OpenAI, usar el sistema local
      updateStatus("Analizando con sistema local...");
      
      // Si no hay API key configurada, mostrar mensaje de configuración
      if (!openAIApi.isConfigured()) {
        document.getElementById(loadingId).remove();
        
        // Crear mensaje de configuración
        const configMessage = `
          <div class="general-answer">
            <h3>Configuración de IA Requerida</h3>
            <p>Parece que no has configurado una clave API de OpenAI. Para obtener respuestas más avanzadas y precisas:</p>
            <ol>
              <li><a href="https://platform.openai.com/account/api-keys" target="_blank">Obtén tu API key de OpenAI</a></li>
              <li>Ingresa la clave en la sección de configuración</li>
              <li>¡Listo! El chatbot usará la IA avanzada para responderte</li>
            </ol>
            <p>Mientras tanto, seguiré usando mi sistema meteorológico local para responderte.</p>
          </div>
        `;
        
        addMessage(configMessage, false, 'local');
        
        // Mostrar estado de carga para el sistema local
        const localLoadingId = showLoading("Analizando con sistema local...");
        
        // Procesar con el sistema local
        const localResponse = await processWithLocalSystem(message);
        
        // Eliminar estado de carga local
        document.getElementById(localLoadingId).remove();
        
        return localResponse;
      }
      
      // Si hubo error con OpenAI, usar sistema local
      document.getElementById(loadingId).remove();
      const localLoadingId = showLoading("Analizando con sistema local...");
      
      const localResponse = await processWithLocalSystem(message);
      
      document.getElementById(localLoadingId).remove();
      return localResponse;
      
    } catch (error) {
      console.error('Error procesando mensaje:', error);
      
      // Eliminar el estado de carga
      document.getElementById(loadingId).remove();
      
      // Si hubo error con OpenAI, usar sistema local
      const localLoadingId = showLoading("Analizando con sistema local...");
      
      const localResponse = await processWithLocalSystem(message);
      
      document.getElementById(localLoadingId).remove();
      return localResponse;
    }
  };

  // Procesar con sistema local (para fallback)
  const processWithLocalSystem = async (message) => {
    updateStatus("Analizando con sistema local...");
    
    // Corregir ortografía
    const { correctedMessage, hasCorrection } = spellingCorrection.correctMessage(message);
    
    // Mostrar mensaje de corrección SOLO si hubo correcciones significativas
    if (hasCorrection) {
      addMessage(`🔍 Entiendo que quizás quisiste decir: "${correctedMessage}"`, false);
    }
    
    // Normalizar mensaje
    const normalizedMessage = correctedMessage.toLowerCase().replace(/[.,!?]/g, '');
    
    try {
      // Análisis de ámbito
      const domainAnalysis = semanticAnalysis.analyzeDomain(normalizedMessage);
      
      // Verificar referencias
      const references = semanticAnalysis.analyzeReferences(normalizedMessage, conversationContext);
      
      // Resolver anáforas
      const resolvedMessage = semanticAnalysis.resolveAnaphora(normalizedMessage, conversationContext);
      
      // Verificar si es hipotética
      const isHypothetical = semanticAnalysis.analyzeHypotheticals(normalizedMessage);
      
      // Identificar entidades
      const entities = semanticAnalysis.identifyEntities(resolvedMessage);
      
      // Analizar intención
      const intent = semanticAnalysis.analyzeIntent(resolvedMessage, entities, domainAnalysis);
      
      // Verificar preguntas compuestas
      const isCompoundQuestion = semanticAnalysis.analyzeCompoundQuestions(normalizedMessage);
      
      // Entidades para la respuesta
      const detectedEntities = {
        parameters: entities.parameters,
        temporal: entities.temporal,
        comparisons: entities.comparisons,
        operations: entities.operations,
        location: entities.locations
      };
      
      // Actualizar contexto temporal si se identifica uno
      if (entities.periods.length > 0) {
        conversationContext.temporalContext = entities.periods[0];
      }
      
      // Actualizar contexto de parámetros si se identifican
      if (entities.parameters.length > 0) {
        conversationContext.lastParameter = entities.parameters[0];
      }
      
      // Actualizar contexto de ubicación
      if (entities.locations.length > 0) {
        conversationContext.spatialContext = entities.locations[0];
      }
      
      // Si hay referencias, actualizar contexto
      if (references.parameters.length > 0) {
        conversationContext.lastParameter = references.parameters[0];
      }
      
      if (references.location.length > 0) {
        conversationContext.spatialContext = references.location[0];
      }
      
      // Si hay contexto de parámetro pero no se identificó en la pregunta, usar el contexto
      if (conversationContext.lastParameter && entities.parameters.length === 0) {
        entities.parameters = [conversationContext.lastParameter];
      }
      
      // Si hay contexto temporal pero no se identificó en la pregunta, usar el contexto
      if (conversationContext.lastPeriod && entities.periods.length === 0) {
        entities.periods = [conversationContext.lastPeriod];
      }
      
      // Si hay contexto de ubicación pero no se identificó en la pregunta, usar el contexto
      if (conversationContext.spatialContext && entities.locations.length === 0) {
        entities.locations = [conversationContext.spatialContext];
      }
      
      // Si no se reconoció la intención pero es una pregunta meteorológica
      if (domainAnalysis.isWeatherQuestion) {
        // Intentar identificar parámetros incluso sin intención clara
        if (entities.parameters.length > 0) {
          // Si hay parámetros pero no intención clara, asumir consulta actual
          return intentHandlers.current_data({
            parameters: entities.parameters,
            periods: ['hoy'],
            locations: ['benavente']
          }, conversationContext);
        }
        
        // Si hay periodos pero no parámetros, pedir aclaración
        if (entities.periods.length > 0) {
          return `Para poder ayudarte con ${benaventeInfo.location}, necesito saber qué parámetro meteorológico te interesa. Por ejemplo: 'temperatura', 'humedad' o 'presión'.`;
        }
      }
      
      // Si es un saludo aunque no se haya detectado claramente
      if (semanticAnalysis.isGreeting(normalizedMessage)) {
        return intentHandlers.greeting();
      }
      
      // Si es una despedida aunque no se haya detectado claramente
      if (semanticAnalysis.isGoodbye(normalizedMessage)) {
        return intentHandlers.goodbye();
      }
      
      // Si es una solicitud de ayuda aunque no se haya detectado claramente
      if (semanticAnalysis.isHelpRequest(normalizedMessage)) {
        return intentHandlers.help();
      }
      
      // Si no se identifica un ámbito específico
      if (!domainAnalysis.isWeatherQuestion) {
        // Verificar si es una pregunta sobre Horus
        if (normalizedMessage.includes('horus') || normalizedMessage.includes('sistema')) {
          return intentHandlers.about_horus();
        }
        
        // Verificar si es una pregunta de soporte técnico
        if (normalizedMessage.includes('problema') || normalizedMessage.includes('error') || 
            normalizedMessage.includes('no funciona') || normalizedMessage.includes('lento')) {
          return intentHandlers.support();
        }
        
        // Verificar si es una pregunta personal
        if (normalizedMessage.includes('quién eres') || normalizedMessage.includes('quien eres') ||
            normalizedMessage.includes('cómo te llamas') || normalizedMessage.includes('como te llamas')) {
          return intentHandlers.personal();
        }
        
        // Verificar si es una pregunta general
        if (normalizedMessage.includes('nombre') || normalizedMessage.includes('hora') ||
            normalizedMessage.includes('edad') || normalizedMessage.includes('vives')) {
          return intentHandlers.general();
        }
        
        // Verificar el dominio de preguntas fuera del ámbito
        let domain = 'general';
        if (normalizedMessage.includes('salud') || normalizedMessage.includes('médico')) {
          domain = 'salud';
        } else if (normalizedMessage.includes('tecnología') || normalizedMessage.includes('tecnologia') ||
                   normalizedMessage.includes('computadora') || normalizedMessage.includes('internet')) {
          domain = 'tecnología';
        } else if (normalizedMessage.includes('deportes') || normalizedMessage.includes('fútbol')) {
          domain = 'deportes';
        } else if (normalizedMessage.includes('entretenimiento') || normalizedMessage.includes('película') ||
                   normalizedMessage.includes('música')) {
          domain = 'entretenimiento';
        } else if (normalizedMessage.includes('comida') || normalizedMessage.includes('receta')) {
          domain = 'comida';
        } else if (normalizedMessage.includes('educación') || normalizedMessage.includes('escuela')) {
          domain = 'educación';
        } else if (normalizedMessage.includes('finanzas') || normalizedMessage.includes('dinero')) {
          domain = 'finanzas';
        }
        
        return intentHandlers.out_of_scope({ domain });
      }
      
      // Si es una pregunta hipotética
      if (isHypothetical) {
        return "Como asistente meteorológico para Benavente, solo puedo proporcionar información basada en datos reales y análisis históricos. No puedo especular sobre escenarios hipotéticos que no estén respaldados por datos climáticos de la zona.";
      }
      
      // Si es una pregunta compuesta
      if (isCompoundQuestion) {
        return "Para poder ayudarte mejor con Benavente, por favor divide tu pregunta en partes más específicas. Por ejemplo, en lugar de preguntar sobre varios parámetros a la vez, enfócate en uno primero.";
      }
      
      // Si hay entidades detectadas pero no intención clara
      if (detectedEntities.parameters.length > 0 || 
          detectedEntities.temporal.length > 0 || 
          detectedEntities.comparisons.length > 0) {
        let response = `He detectado algunos elementos relevantes en tu pregunta sobre ${benaventeInfo.location}, pero no estoy seguro de entender exactamente qué necesitas.\n\n`;
        
        if (detectedEntities.parameters.length > 0) {
          response += `* Parámetros meteorológicos: ${detectedEntities.parameters.join(', ')}\n`;
        }
        if (detectedEntities.temporal.length > 0) {
          response += `* Periodos de tiempo: ${detectedEntities.temporal.join(', ')}\n`;
        }
        if (detectedEntities.comparisons.length > 0) {
          response += `* Tipos de comparación: ${detectedEntities.comparisons.map(c => 
            c === 'vs' ? 'comparación directa' : 
            c === 'trend' ? 'tendencia' : 
            c === 'correlation' ? 'correlación' : c).join(', ')}\n`;
        }
        if (detectedEntities.operations.length > 0) {
          response += `* Operaciones solicitadas: ${detectedEntities.operations.join(', ')}\n`;
        }
        
        response += `\n¿Podrías reformular tu pregunta para que sea más específica sobre el clima de Benavente?`;
        
        return response;
      }
      
      // Si no hay contexto previo y no es claramente fuera de ámbito, asumimos que es general
      return `<div class="out-of-scope">
        <h3>No Entiendo Tu Pregunta sobre Benavente</h3>
        <p>No estoy seguro de entender tu pregunta. Soy un asistente meteorológico especializado en el sistema Horus en <strong>${benaventeInfo.location}</strong>.</p>
        
        <h4>¿Cómo puedo ayudarte con Benavente?</h4>
        <ul>
          <li>Consultar datos meteorológicos actuales en Benavente</li>
          <li>Analizar tendencias climáticas históricas de Benavente</li>
          <li>Realizar predicciones basadas en datos de Benavente</li>
          <li>Explicar el funcionamiento de Horus en Benavente</li>
          <li>Contextualizar el clima de Benavente (${benaventeInfo.altitude})</li>
        </ul>
        
        <p>Ejemplos de preguntas que puedo responder:</p>
        <ul>
          <li>"¿Cuál es la temperatura actual en Benavente?"</li>
          <li>"¿Cómo funciona el sistema Horus en Benavente?"</li>
          <li>"Muestra la tendencia de presión de los últimos 7 días en Benavente"</li>
        </ul>
        
        <p>Por favor, reformula tu pregunta para que esté relacionada con el clima o el sistema Horus en <strong>${benaventeInfo.location}</strong>.</p>
        
        <p class="benavente-context"><strong>Información clave sobre Benavente:</strong> Ubicado a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterráneo continentalizado con veranos calurosos e inviernos fríos.</p>
      </div>`;
      
    } catch (error) {
      console.error('Error procesando mensaje:', error);
      return "⚠️ Ocurrió un error al procesar tu solicitud. Por favor, intenta nuevamente.";
    }
  };

  // Sistema de corrección ortográfica
  const spellingCorrection = {
    // Calcula la distancia de Levenshtein entre dos strings
    levenshteinDistance: function(a, b) {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      
      const matrix = [];
      
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1, // Sustitución
              matrix[i][j - 1] + 1, // Inserción
              matrix[i - 1][j] + 1 // Eliminación
            );
          }
        }
      }
      
      return matrix[b.length][a.length];
    },
    
    // Corrige la ortografía de una palabra
    correctWord: function(word) {
      // Si la palabra está en el diccionario, devolver la corrección
      if (spellingDictionary[word.toLowerCase()]) {
        return spellingDictionary[word.toLowerCase()];
      }
      
      // Buscar en el diccionario de sinónimos
      for (const [correct, synonyms] of Object.entries(weatherSynonyms)) {
        for (const synonym of synonyms) {
          if (word.toLowerCase() === synonym) {
            return correct;
          }
          
          // Calcular distancia de Levenshtein para corrección aproximada
          const distance = this.levenshteinDistance(word.toLowerCase(), synonym);
          if (distance <= Math.max(1, Math.floor(synonym.length * 0.2))) {
            return correct;
          }
        }
      }
      
      return word;
    },
    
    // Corrige todo el mensaje
    correctMessage: function(message) {
      const words = message.split(/\s+/);
      let correctedWords = [];
      let foundCorrection = false;
      
      words.forEach(word => {
        // Mantener signos de puntuación
        const cleanWord = word.replace(/[.,!?;:]/g, '');
        const punctuation = word.match(/[.,!?;:]+$/);
        
        if (cleanWord.length > 2) {
          const corrected = this.correctWord(cleanWord);
          if (corrected !== cleanWord) {
            correctedWords.push(corrected + (punctuation ? punctuation[0] : ''));
            foundCorrection = true;
          } else {
            correctedWords.push(word);
          }
        } else {
          correctedWords.push(word);
        }
      });
      
      return {
        correctedMessage: correctedWords.join(' '),
        hasCorrection: foundCorrection
      };
    }
  };

  // Diccionario para corrección ortográfica
  const spellingDictionary = {
    'tempertura': 'temperatura',
    'temperaruta': 'temperatura',
    'humedad': 'humedad',
    'humead': 'humedad',
    'umedad': 'humedad',
    'presion': 'presión',
    'presion': 'presión',
    'presion atmosferica': 'presión atmosférica',
    'presion atmosferica': 'presión atmosférica',
    'presion barometrica': 'presión barométrica',
    'presion barometrica': 'presión barométrica',
    'lluvia': 'lluvia',
    'llubia': 'lluvia',
    'lubia': 'lluvia',
    'viento': 'viento',
    'biento': 'viento',
    'bientto': 'viento',
    'gas': 'gas',
    'calidad del aire': 'calidad del aire',
    'calidad aire': 'calidad del aire',
    'direccion': 'dirección',
    'direccion del viento': 'dirección del viento',
    'direccion viento': 'dirección del viento',
    'termometro': 'termómetro',
    'termometro': 'termómetro',
    'pluviometria': 'pluviometría',
    'pluviometria': 'pluviometría',
    'co2': 'CO2',
    'dióxido de carbono': 'dióxido de carbono'
  };

  // Diccionario de sinónimos meteorológicos mejorado
  const weatherSynonyms = {
    temperatura: ['temp', 'calor', 'frío', 'frio', 'grados', '°', 'celsius', 'centígrados', 'centigrados', 'termómetro', 'termometro', 'caliente', 'frio', 'temperatura en benavente'],
    humedad: ['hum', 'vapor', 'agua', 'porcentaje de agua', '% agua', 'humedad relativa', 'humedad en benavente'],
    presión: ['pres', 'atmosférica', 'barométrica', 'barometrica', 'hpa', 'mb', 'presión atmosférica', 'presion en benavente'],
    lluvia: ['precipitación', 'precipitacion', 'agua', 'llovizna', 'tormenta', 'lluvioso', 'precipitaciones', 'pluviometría', 'pluviometria', 'lluvia en benavente'],
    viento: ['velocidad del viento', 'ráfagas', 'ráfaga', 'ráfagas de viento', 'velocidad viento', 'km/h', 'nudos', 'dirección del viento', 'direccion viento', 'brisa', 'viento en benavente'],
    gas: ['calidad del aire', 'calidad aire', 'contaminación', 'contaminacion', 'pm2.5', 'pm10', 'partículas', 'particulas', 'co2', 'dióxido de carbono', 'gas en benavente'],
    dirección: ['direccion', 'rumbo', 'orientación', 'orientacion', 'grados', 'norte', 'sur', 'este', 'oeste', 'cardinales', 'direccion en benavente'],
    análisis: ['analisis', 'tendencia', 'tendencias', 'evolución', 'comportamiento', 'patrón', 'patron', 'estadística', 'estadisticas', 'analisis en benavente'],
    predicción: ['prediccion', 'pronóstico', 'pronostico', 'previsión', 'prevision', 'futuro', 'mañana', 'siguiente', 'proyección', 'proyeccion', 'prediccion en benavente'],
    actual: ['ahora', 'en este momento', 'en este instante', 'actualidad', 'presente', 'en directo', 'en tiempo real', 'hoy', 'actual en benavente'],
    histórico: ['historico', 'pasado', 'antes', 'anterior', 'anteriores', 'días anteriores', 'semanas anteriores', 'últimos días', 'historico en benavente'],
    comparar: ['comparar', 'comparación', 'compara', 'diferencia', 'vs', 'versus', 'comparativo', 'entre', 'y', 'comparar en benavente'],
    máximo: ['maximo', 'máximo', 'pico', 'peak', 'más alto', 'mayor', 'máx', 'max', 'maximo en benavente'],
    mínimo: ['minimo', 'mínimo', 'más bajo', 'menor', 'mín', 'min', 'minimo en benavente'],
    tendencia: ['tendencia', 'tendencias', 'evolución', 'comportamiento', 'patrón', 'patron', 'cambios', 'variación', 'variacion', 'tendencia en benavente'],
    probabilidad: ['probabilidad', 'probable', 'posibilidad', 'posible', 'chance', 'oportunidad', 'riesgo', 'probabilidad en benavente']
  };

  // Mapeo de intenciones mejorado
  const intentMap = {
    current_data: {
      keywords: ['actual', 'ahora', 'en este momento', 'en directo', 'presente', 'en tiempo real', 'hoy', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presión', 'lluvia', 'viento', 'gas', 'dirección'],
      required: []
    },
    historical_trend: {
      keywords: ['tendencia', 'evolución', 'comportamiento', 'análisis', 'analisis', 'patrón', 'patron', 'gráfico', 'grafico', 'historial', 'historico', 'histórico', 'evolucion', 'variacion', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presión', 'lluvia', 'viento', 'gas'],
      required: ['period']
    },
    prediction: {
      keywords: ['predicción', 'prediccion', 'pronóstico', 'pronostico', 'previsión', 'prevision', 'futuro', 'mañana', 'siguiente', 'proyección', 'proyeccion', 'probabilidad', 'probable', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presión', 'lluvia', 'viento', 'gas'],
      required: []
    },
    comparison: {
      keywords: ['comparar', 'comparación', 'compara', 'diferencia', 'vs', 'versus', 'comparativo', 'entre', 'y', 'diferencia', 'distinto', 'igual', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presión', 'lluvia', 'viento', 'gas'],
      required: ['periods']
    },
    max_min: {
      keywords: ['máximo', 'maximo', 'mínimo', 'minimo', 'pico', 'peak', 'mayor', 'menor', 'más alto', 'más bajo', 'máx', 'max', 'mín', 'min', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presión', 'lluvia', 'viento', 'gas'],
      required: ['period']
    },
    correlation: {
      keywords: ['relación', 'correlación', 'correlacion', 'conexión', 'conexion', 'asociación', 'asociacion', 'afecta', 'influye', 'impacto', 'causa', 'provoca', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presión', 'lluvia', 'viento', 'gas'],
      required: ['parameters']
    },
    greeting: {
      keywords: ['hola', 'buenos días', 'buenos dias', 'buenas tardes', 'hey', 'saludos', 'buen día', 'buen dia', 'buenas noches', 'que tal', 'como estas', 'cómo estás', 'en benavente'],
      parameters: [],
      required: []
    },
    goodbye: {
      keywords: ['adiós', 'adios', 'gracias', 'chao', 'hasta luego', 'hasta pronto', 'nos vemos', 'bye', 'gracías', 'gracias', 'fue útil', 'fue util', 'en benavente'],
      parameters: [],
      required: []
    },
    help: {
      keywords: ['ayuda', 'funciona', 'cómo', 'como', 'puedo', 'capaz', 'hacer', 'qué', 'que', 'preguntar', 'instrucciones', 'ejemplo', 'ejemplos', 'guía', 'manual', 'tutorial', 'en benavente'],
      parameters: [],
      required: []
    },
    about_horus: {
      keywords: ['horus', 'sistema horus', 'estación horus', 'estacion horus', 'estación meteorológica', 'estacion meteorologica', 'sistema meteorológico', 'sistema meteorologico', 'para qué sirve', 'para que sirve', 'qué hace', 'que hace', 'en benavente'],
      parameters: [],
      required: []
    },
    support: {
      keywords: ['problema', 'error', 'no funciona', 'fallo', 'bug', 'no carga', 'lento', 'lentitud', 'lenta', 'lento', 'no responde', 'no me deja', 'no puedo', 'en benavente'],
      parameters: [],
      required: []
    },
    personal: {
      keywords: ['quién eres', 'quien eres', 'quién eres tú', 'quien eres tu', 'quién te hizo', 'quien te hizo', 'quién te creó', 'quien te creo', 'tu creador', 'tu creador es', 'en benavente'],
      parameters: [],
      required: []
    },
    general: {
      keywords: ['cuál es tu nombre', 'cual es tu nombre', 'cómo te llamas', 'como te llamas', 'qué edad tienes', 'que edad tienes', 'dónde vives', 'donde vives', 'qué hora es', 'que hora es', 'en benavente'],
      parameters: [],
      required: []
    },
    out_of_scope: {
      keywords: ['en benavente'],
      parameters: [],
      required: []
    }
  };

  // Mapeo de periodos
  const periodMap = {
    'hoy': { type: 'day', value: 1, unit: 'day' },
    'ayer': { type: 'day', value: 1, unit: 'day', offset: 1 },
    'últimas 24 horas': { type: 'hour', value: 24, unit: 'hour' },
    'últimas 12 horas': { type: 'hour', value: 12, unit: 'hour' },
    'esta mañana': { type: 'morning', value: 1, unit: 'day' },
    'esta tarde': { type: 'afternoon', value: 1, unit: 'day' },
    'esta noche': { type: 'night', value: 1, unit: 'day' },
    'esta semana': { type: 'week', value: 1, unit: 'week' },
    'esta semana pasada': { type: 'week', value: 1, unit: 'week', offset: 1 },
    'últimos 7 días': { type: 'day', value: 7, unit: 'day' },
    'últimos 14 días': { type: 'day', value: 14, unit: 'day' },
    'últimos 30 días': { type: 'day', value: 30, unit: 'day' },
    'este mes': { type: 'month', value: 1, unit: 'month' },
    'este año': { type: 'year', value: 1, unit: 'year' },
    'último mes': { type: 'month', value: 1, unit: 'month', offset: 1 },
    'último año': { type: 'year', value: 1, unit: 'year', offset: 1 },
    'última hora': { type: 'hour', value: 1, unit: 'hour' },
    'últimas 2 horas': { type: 'hour', value: 2, unit: 'hour' },
    'últimas 6 horas': { type: 'hour', value: 6, unit: 'hour' },
    'esta semana': { type: 'week', value: 1, unit: 'week' },
    'esta semana anterior': { type: 'week', value: 1, unit: 'week', offset: 1 },
    'este mes': { type: 'month', value: 1, unit: 'month' },
    'este mes pasado': { type: 'month', value: 1, unit: 'month', offset: 1 },
    'este año': { type: 'year', value: 1, unit: 'year' },
    'este año pasado': { type: 'year', value: 1, unit: 'year', offset: 1 }
  };

  // Sistema de análisis semántico mejorado
  const semanticAnalysis = {
    // Analiza el dominio de la pregunta
    analyzeDomain: (text) => {
      const weatherKeywords = [
        'temperatura', 'calor', 'frío', 'frio', 'grados', 
        'humedad', 'agua', 'presión', 'atmosférica', 'barométrica',
        'lluvia', 'precipitación', 'viento', 'ráfagas', 'gas',
        'calidad del aire', 'dirección', 'clima', 'meteorológico',
        'meteorologico', 'tiempo', 'nublado', 'soleado', 'nubes',
        'nuboso', 'llovizna', 'tormenta', 'nublados', 'soleados',
        'nubosos', 'tormentas', 'lluvias', 'vientos', 'ráfagas',
        'caluroso', 'frio', 'frío', 'caliente', 'templado',
        'húmedo', 'seco', 'húmedos', 'secos', 'presión',
        'barómetro', 'pluviómetro', 'anemómetro', 'termómetro',
        'meteorología', 'climático', 'climáticos', 'climáticas',
        'climatología', 'pronóstico', 'pronostico', 'predicción',
        'prediccion', 'previsión', 'prevision', 'estacional',
        'estaciones', 'primavera', 'verano', 'otoño', 'invierno',
        'norte', 'sur', 'este', 'oeste', 'cardinales', 'brisa',
        'ciclón', 'huracán', 'tornado', 'tornados', 'ciclones',
        'huracanes', 'tormenta', 'tormentas', 'lluvia', 'lluvias',
        'nublado', 'nublados', 'nuboso', 'nubosos', 'soleado',
        'soleados', 'despejado', 'despejados', 'nublación',
        'nublaciones', 'precipitación', 'precipitaciones', 'humedad',
        'relativa', 'relativas', 'humedad relativa', 'presión',
        'atmosférica', 'atmosféricas', 'presión atmosférica',
        'barométrica', 'barométricas', 'presión barométrica',
        'viento', 'vientos', 'ráfaga', 'ráfagas', 'dirección',
        'direcciones', 'dirección del viento', 'velocidad',
        'velocidades', 'velocidad del viento', 'anemómetro',
        'termómetro', 'pluviómetro', 'barómetro', 'higrómetro',
        'gas', 'gases', 'calidad del aire', 'contaminación',
        'contaminacion', 'pm2.5', 'pm10', 'partículas', 'particulas',
        'co2', 'dióxido de carbono', 'ozono', 'no2', 'so2'
      ];
      
      let matchCount = 0;
      let totalKeywords = 0;
      const normalizedText = text.toLowerCase();
      
      weatherKeywords.forEach(keyword => {
        if (normalizedText.includes(keyword)) {
          matchCount++;
        }
        totalKeywords++;
      });
      
      // Calcular confianza basada en la proporción de coincidencias
      const confidence = Math.min(1.0, matchCount / Math.max(1, totalKeywords * 0.15));
      
      // Si encontramos al menos 1 palabra clave meteorológica, es una pregunta sobre clima
      return {
        isWeatherQuestion: matchCount > 0,
        confidence: confidence,
        matchCount: matchCount,
        totalKeywords: totalKeywords
      };
    },
    
    // Identifica entidades en el texto
    identifyEntities: (text) => {
      const entities = {
        parameters: [],
        periods: [],
        locations: [],
        numbers: [],
        comparisons: [],
        operations: [],
        general: []
      };
      
      const normalizedText = text.toLowerCase();
      
      // Verificar si menciona Benavente
      if (normalizedText.includes('benavente')) {
        entities.locations.push('benavente');
      }
      
      // Identificar parámetros meteorológicos
      Object.keys(weatherSynonyms).forEach(param => {
        // Verificar el parámetro principal
        if (normalizedText.includes(param)) {
          entities.parameters.push(param);
        }
        
        // Verificar sinónimos
        weatherSynonyms[param].forEach(synonym => {
          if (normalizedText.includes(synonym)) {
            entities.parameters.push(param);
          }
        });
      });
      
      // Identificar periodos
      Object.keys(periodMap).forEach(period => {
        if (normalizedText.includes(period)) {
          entities.periods.push(period);
        }
      });
      
      // Identificar números
      const numberMatches = text.match(/\d+/g);
      if (numberMatches) {
        entities.numbers = numberMatches.map(num => parseInt(num));
      }
      
      // Identificar comparaciones
      if (normalizedText.includes('vs') || normalizedText.includes('versus')) {
        entities.comparisons.push('vs');
      }
      if (normalizedText.includes('tendencia') || normalizedText.includes('evolución')) {
        entities.comparisons.push('trend');
      }
      if (normalizedText.includes('correlación') || normalizedText.includes('relación')) {
        entities.comparisons.push('correlation');
      }
      
      // Identificar operaciones
      if (normalizedText.includes('máximo') || normalizedText.includes('maximo')) {
        entities.operations.push('max');
      }
      if (normalizedText.includes('mínimo') || normalizedText.includes('minimo')) {
        entities.operations.push('min');
      }
      if (normalizedText.includes('promedio') || normalizedText.includes('media')) {
        entities.operations.push('average');
      }
      if (normalizedText.includes('diferencia')) {
        entities.operations.push('difference');
      }
      
      // Identificar términos generales
      Object.keys(generalTerms).forEach(term => {
        if (term === 'outOfScope') return;
        
        // Verificar el término principal
        if (normalizedText.includes(term)) {
          entities.general.push(term);
        }
        
        // Verificar sinónimos
        if (Array.isArray(generalTerms[term])) {
          generalTerms[term].forEach(synonym => {
            if (normalizedText.includes(synonym)) {
              entities.general.push(term);
            }
          });
        }
      });
      
      // Identificar preguntas fuera del ámbito
      Object.keys(generalTerms.outOfScope).forEach(domain => {
        generalTerms.outOfScope[domain].forEach(keyword => {
          if (normalizedText.includes(keyword)) {
            entities.general.push(`outOfScope_${domain}`);
          }
        });
      });
      
      // Eliminar duplicados
      entities.parameters = [...new Set(entities.parameters)];
      entities.periods = [...new Set(entities.periods)];
      entities.comparisons = [...new Set(entities.comparisons)];
      entities.operations = [...new Set(entities.operations)];
      entities.general = [...new Set(entities.general)];
      
      return entities;
    },
    
    // Analiza la intención del usuario
    analyzeIntent: (text, entities, domainAnalysis) => {
      let bestIntent = null;
      let highestConfidence = 0;
      
      // Analizar cada posible intención
      Object.keys(intentMap).forEach(intentType => {
        const intent = intentMap[intentType];
        let confidence = 0;
        
        // Calcular coincidencia con palabras clave
        intent.keywords.forEach(keyword => {
          if (text.toLowerCase().includes(keyword)) {
            confidence += 0.2;
          }
        });
        
        // Aumentar confianza si se encontraron parámetros relevantes
        if (entities.parameters.length > 0 && intent.parameters.length > 0) {
          const commonParams = entities.parameters.filter(p => intent.parameters.includes(p));
          confidence += commonParams.length * 0.15;
        }
        
        // Aumentar confianza si se encontraron periodos y la intención los requiere
        if (intent.required.includes('period') && entities.periods.length > 0) {
          confidence += 0.2;
        }
        
        // Aumentar confianza si se encontraron múltiples periodos y la intención los requiere
        if (intent.required.includes('periods') && entities.periods.length > 1) {
          confidence += 0.25;
        }
        
        // Aumentar confianza si menciona Benavente
        if (entities.locations.includes('benavente')) {
          confidence += 0.1;
        }
        
        // Ajustar confianza según el dominio
        if (intentType !== 'greeting' && intentType !== 'goodbye' && intentType !== 'help') {
          confidence *= domainAnalysis.confidence;
        }
        
        // Verificar si es la mejor intención hasta ahora
        if (confidence > highestConfidence) {
          highestConfidence = confidence;
          bestIntent = {
            type: intentType,
            confidence: confidence,
            parameters: entities.parameters,
            periods: entities.periods,
            location: entities.locations
          };
        }
      });
      
      // CORRECCIÓN: Usar semanticAnalysis en lugar de this
      // Si no se encontró una intención clara, verificar saludos, despedidas o ayuda
      if (!bestIntent || highestConfidence < 0.4) {
        if (semanticAnalysis.isGreeting(text)) {
          return { type: 'greeting', confidence: 0.9, parameters: [], periods: [], location: ['benavente'] };
        }
        if (semanticAnalysis.isGoodbye(text)) {
          return { type: 'goodbye', confidence: 0.9, parameters: [], periods: [], location: ['benavente'] };
        }
        if (semanticAnalysis.isHelpRequest(text)) {
          return { type: 'help', confidence: 0.8, parameters: [], periods: [], location: ['benavente'] };
        }
      }
      
      // Si no se encontró una intención clara pero hay términos generales
      if (!bestIntent && entities.general.length > 0) {
        for (const generalTerm of entities.general) {
          if (generalTerm.startsWith('outOfScope_')) {
            const domain = generalTerm.replace('outOfScope_', '');
            return {
              type: 'out_of_scope',
              confidence: 0.5,
              domain: domain,
              parameters: [],
              periods: [],
              location: ['benavente']
            };
          }
          
          // Mapear términos generales a intenciones
          const intentMap = {
            'about_horus': 'about_horus',
            'support': 'support',
            'personal': 'personal',
            'general': 'general'
          };
          
          if (intentMap[generalTerm]) {
            return {
              type: intentMap[generalTerm],
              confidence: 0.6,
              parameters: [],
              periods: [],
              location: ['benavente']
            };
          }
        }
      }
      
      // Si no se encontró una intención clara, pero es meteorológico
      if (domainAnalysis.isWeatherQuestion && !bestIntent) {
        if (entities.parameters.length > 0) {
          return {
            type: 'current_data',
            confidence: 0.5,
            parameters: entities.parameters,
            periods: ['hoy'],
            location: ['benavente']
          };
        }
        
        return {
          type: 'current_data',
          confidence: 0.4,
          parameters: ['temperatura'],
          periods: ['hoy'],
          location: ['benavente']
        };
      }
      
      // Si no se encontró una intención clara y no es meteorológico
      if (!domainAnalysis.isWeatherQuestion && !bestIntent) {
        return {
          type: 'out_of_scope',
          confidence: 0.3,
          domain: 'general',
          parameters: [],
          periods: [],
          location: ['benavente']
        };
      }
      
      return bestIntent || { type: 'unrelated', confidence: 0, parameters: [], periods: [], location: ['benavente'] };
    },
    
    // Verifica si es un saludo
    isGreeting: (text) => {
      const greetings = intentMap.greeting.keywords;
      const normalizedText = text.toLowerCase();
      
      return greetings.some(greeting => normalizedText.includes(greeting));
    },
    
    // Verifica si es una despedida
    isGoodbye: (text) => {
      const goodbyes = intentMap.goodbye.keywords;
      const normalizedText = text.toLowerCase();
      
      return goodbyes.some(goodbye => normalizedText.includes(goodbye));
    },
    
    // Verifica si es una solicitud de ayuda
    isHelpRequest: (text) => {
      const helpKeywords = intentMap.help.keywords;
      const normalizedText = text.toLowerCase();
      
      return helpKeywords.some(keyword => normalizedText.includes(keyword));
    },
    
    // Analiza preguntas compuestas
    analyzeCompoundQuestions: (text) => {
      const compoundIndicators = ['y', 'además', 'también', 'tambien', 'ademas', 'además de', 'ademas de', 'además que', 'ademas que'];
      return compoundIndicators.some(indicator => text.toLowerCase().includes(indicator));
    },
    
    // Analiza referencias en el contexto
    analyzeReferences: (text, context) => {
      const references = {
        parameters: [],
        temporal: [],
        spatial: [],
        location: []
      };
      
      // Analizar anáforas (referencias a elementos previos)
      if (context.lastParameter && (text.includes('eso') || text.includes('eso es') || text.includes('eso está'))) {
        references.parameters.push(context.lastParameter);
      }
      
      if (context.lastPeriod && (text.includes('entonces') || text.includes('en ese periodo') || text.includes('durante ese tiempo'))) {
        references.temporal.push(context.lastPeriod);
      }
      
      // Verificar si menciona Benavente
      if (text.toLowerCase().includes('benavente')) {
        references.location.push('benavente');
        references.spatial.push('benavente');
      }
      
      return references;
    },
    
    // Resuelve anáforas usando el contexto
    resolveAnaphora: (text, context) => {
      let resolvedText = text;
      const paramName = context.lastParameter || 'temperatura';
      
      // Reemplazar "eso" si hay contexto de parámetro
      if (context.lastParameter) {
        resolvedText = resolvedText.replace(/eso/g, paramName);
        resolvedText = resolvedText.replace(/eso es/g, `${paramName} es`);
        resolvedText = resolvedText.replace(/eso está/g, `${paramName} está`);
      }
      
      // Reemplazar "hoy" si hay contexto temporal
      if (context.temporalContext && (text.includes('ayer') || text.includes('mañana'))) {
        // Si el contexto es "hoy", y pregunta sobre "ayer", ajustamos
        if (context.temporalContext === 'today' && text.includes('ayer')) {
          resolvedText = resolvedText.replace(/ayer/g, 'hace un día');
        }
      }
      
      // Añadir "en Benavente" si no está presente pero es relevante
      if (!resolvedText.toLowerCase().includes('benavente') && 
          !resolvedText.toLowerCase().includes('aquí') &&
          !resolvedText.toLowerCase().includes('en esta zona')) {
        resolvedText += " en Benavente";
      }
      
      // Mejora: Reemplazar "la" + sustantivo por el parámetro específico
      if (context.lastParameter) {
        const paramReplacements = {
          'temp': ['la temperatura', 'el termómetro', 'los grados', 'el calor', 'el frío'],
          'humedad': ['la humedad', 'el vapor', 'el agua'],
          'presión': ['la presión', 'la atmosférica', 'la barométrica'],
          'lluvia': ['la lluvia', 'la precipitación', 'el agua'],
          'viento': ['el viento', 'las ráfagas', 'la brisa'],
          'gas': ['el gas', 'la calidad del aire', 'las partículas']
        };
        
        if (paramReplacements[paramName]) {
          paramReplacements[paramName].forEach(replacement => {
            resolvedText = resolvedText.replace(new RegExp(replacement, 'gi'), paramName);
          });
        }
      }
      
      return resolvedText;
    },
    
    // Analiza preguntas hipotéticas
    analyzeHypotheticals: (text) => {
      const hypotheticalIndicators = ['si', 'supongamos que', 'imagina que', 'qué pasaría si', 'que pasaria si', 'que pasaría si'];
      return hypotheticalIndicators.some(indicator => text.toLowerCase().includes(indicator));
    }
  };

  // Diccionario de términos generales
  const generalTerms = {
    // Sistema Horus
    horus: ['horus', 'sistema horus', 'estación horus', 'estacion horus', 'estación meteorológica', 'estacion meteorologica', 'sistema meteorológico', 'sistema meteorologico', 'horus en benavente'],
    
    // Información general
    about: ['qué es', 'que es', 'qué es esto', 'que es esto', 'para qué sirve', 'para que sirve', 'qué hace', 'que hace', 'funciona', 'cómo funciona', 'como funciona', 'sobre benavente'],
    
    // Ayuda
    help: ['ayuda', 'funciona', 'cómo', 'como', 'puedo', 'capaz', 'hacer', 'qué', 'que', 'preguntar', 'instrucciones', 'ejemplo', 'ejemplos', 'guía', 'manual', 'tutorial', 'ayuda en benavente'],
    
    // Saludos
    greeting: ['hola', 'buenos días', 'buenos dias', 'buenas tardes', 'hey', 'saludos', 'buen día', 'buen dia', 'buenas noches', 'que tal', 'como estas', 'cómo estás', 'hola benavente'],
    
    // Despedidas
    goodbye: ['adiós', 'adios', 'gracias', 'chao', 'hasta luego', 'hasta pronto', 'nos vemos', 'bye', 'gracías', 'gracias', 'fue útil', 'fue util', 'adios benavente'],
    
    // Soporte técnico
    support: ['problema', 'error', 'no funciona', 'fallo', 'bug', 'no carga', 'lento', 'lentitud', 'lenta', 'lento', 'no responde', 'no me deja', 'no puedo', 'problemas en benavente'],
    
    // Información personal
    personal: ['quién eres', 'quien eres', 'quién eres tú', 'quien eres tu', 'quién te hizo', 'quien te hizo', 'quién te creó', 'quien te creo', 'tu creador', 'tu creador es', 'quien eres en benavente'],
    
    // Preguntas generales
    general: ['cuál es tu nombre', 'cual es tu nombre', 'cómo te llamas', 'como te llamas', 'qué edad tienes', 'que edad tienes', 'dónde vives', 'donde vives', 'qué hora es', 'que hora es', 'clima benavente'],
    
    // Soporte para preguntas fuera del ámbito
    outOfScope: {
      salud: ['salud', 'médico', 'doctor', 'enfermedad', 'enfermo', 'hospital', 'farmacia', 'medicina', 'medicamento', 'cura', 'salud en benavente'],
      tecnología: ['tecnología', 'tecnologia', 'computadora', 'ordenador', 'pc', 'laptop', 'smartphone', 'móvil', 'celular', 'internet', 'wifi', 'redes', 'tecnologia en benavente'],
      deportes: ['deportes', 'fútbol', 'futbol', 'baloncesto', 'tenis', 'golf', 'atletismo', 'deporte', 'equipo', 'partido', 'liga', 'deportes en benavente'],
      entretenimiento: ['entretenimiento', 'película', 'pelicula', 'cine', 'música', 'musica', 'canción', 'cancion', 'serie', 'televisión', 'tv', 'entretenimiento en benavente'],
      comida: ['comida', 'receta', 'cocina', 'plato', 'platos', 'cocinar', 'comer', 'restaurante', 'recetas', 'recetario', 'comida en benavente'],
      educación: ['educación', 'educacion', 'escuela', 'colegio', 'universidad', 'clase', 'clases', 'estudio', 'estudiar', 'profesor', 'educacion en benavente'],
      finanzas: ['finanzas', 'dinero', 'banco', 'cuenta', 'tarjeta', 'crédito', 'credito', 'ahorro', 'inversión', 'inversion', 'finanzas en benavente']
    }
  };

  // Obtener el nombre de la dirección del viento
  const getWindDirectionName = (degrees) => {
    const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
    const index = Math.round(degrees % 360 / 22.5) % 16;
    return directions[index];
  };

  // Manejadores de intenciones
  const intentHandlers = {
    current_data: (entities, context) => {
      // Si no hay parámetros específicos, usar el último parámetro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Actualizar contexto
      conversationContext.lastParameter = parameters[0];
      conversationContext.lastQuestionType = 'current_data';
      
      // Obtener el dato actual
      const latestData = historicalData[historicalData.length - 1];
      let response = '';
      
      parameters.forEach(param => {
        let value, unit;
        switch(param) {
          case 'temperatura':
            value = latestData.temp;
            unit = '°C';
            break;
          case 'humedad':
            value = latestData.hum;
            unit = '%';
            break;
          case 'presión':
            value = latestData.pres;
            unit = 'hPa';
            break;
          case 'lluvia':
            value = latestData.lluvia ? 1 : 0;
            unit = latestData.lluvia ? 'lloviendo' : 'sin lluvia';
            break;
          case 'viento':
            value = latestData.wind;
            unit = 'm/s';
            break;
          case 'gas':
            value = latestData.gas;
            unit = 'kΩ';
            break;
          case 'dirección':
            value = latestData.wind_dir;
            unit = '°';
            break;
          default:
            value = latestData.temp;
            unit = '°C';
        }
        
        // Obtener variaciones para el parámetro
        const variations = communicationSystem.getCurrentDataVariations(param, value, unit);
        
        // Seleccionar una variación aleatoria
        response += getRandomVariation(variations) + "\n";
      });
      
      // Añadir análisis contextual si es relevante
      if (parameters.length === 1) {
        const paramName = parameters[0];
        let contextAnalysis = '';
        
        switch(paramName) {
          case 'temperatura':
            if (latestData.temp > 25) {
              contextAnalysis = `Con esta temperatura en Benavente, podrías considerar usar ropa ligera y mantenerse hidratado. En verano en Benavente, las temperaturas pueden superar los 35°C.`;
            } else if (latestData.temp < 10) {
              contextAnalysis = `Con esta temperatura en Benavente, te recomendamos abrigarte adecuadamente para evitar el frío. En invierno, las temperaturas en Benavente pueden llegar a -5°C.`;
            } else {
              contextAnalysis = `La temperatura actual en Benavente está dentro de un rango moderado. Benavente tiene un clima mediterráneo continentalizado con primaveras y otoños agradables.`;
            }
            break;
          case 'humedad':
            if (latestData.hum > 70) {
              contextAnalysis = `La alta humedad en Benavente puede hacer que la temperatura se sienta más alta de lo que realmente es. Considera usar ropa transpirable. La humedad promedio en Benavente es del 65%.`;
            } else if (latestData.hum < 30) {
              contextAnalysis = `La baja humedad en Benavente puede causar sequedad en la piel y las vías respiratorias. Considera usar humectante y mantenerte hidratado. Esto es menos común en Benavente, que tiene una humedad promedio del 65%.`;
            } else {
              contextAnalysis = `La humedad actual en Benavente está cerca del promedio típico de la zona (65%). Benavente tiene un clima mediterráneo continentalizado con humedad moderada.`;
            }
            break;
          case 'presión':
            if (latestData.pres < 1000) {
              contextAnalysis = `La presión atmosférica baja en Benavente suele indicar condiciones climáticas inestables. Considera que Benavente está a ${benaventeInfo.altitude} sobre el nivel del mar, lo que afecta la presión atmosférica.`;
            } else if (latestData.pres > 1020) {
              contextAnalysis = `La presión atmosférica alta en Benavente suele indicar condiciones climáticas estables y buen tiempo. Es un buen momento para actividades al aire libre. Benavente tiene una presión atmosférica promedio de alrededor de 1010 hPa debido a su altitud de ${benaventeInfo.altitude}.`;
            } else {
              contextAnalysis = `La presión atmosférica en Benavente está en un nivel normal para su altitud (${benaventeInfo.altitude}). Benavente se encuentra en la llanura del Duero, lo que influye en sus patrones de presión.`;
            }
            break;
        }
        
        if (contextAnalysis) {
          response += `\n${contextAnalysis}`;
        }
        
        response += `\n\n¿Te gustaría ver un análisis histórico de ${paramName} en Benavente o una predicción para los próximos días?`;
      }
      
      return response.trim();
    },
    
    historical_trend: (entities, context) => {
      // Determinar el periodo
      let period = entities.periods.length > 0 ? entities.periods[0] : 
                  (context.lastPeriod ? context.lastPeriod : 'últimos 7 días');
      
      // Actualizar contexto
      conversationContext.lastPeriod = period;
      conversationContext.lastQuestionType = 'historical_trend';
      
      // Obtener datos para el periodo
      const periodInfo = periodMap[period] || periodMap['últimos 7 días'];
      const now = new Date();
      let startDate;
      
      if (periodInfo.type === 'day') {
        startDate = new Date(now);
        startDate.setDate(now.getDate() - periodInfo.value);
      } else if (periodInfo.type === 'week') {
        startDate = new Date(now);
        startDate.setDate(now.getDate() - (periodInfo.value * 7));
      } else if (periodInfo.type === 'month') {
        startDate = new Date(now);
        startDate.setMonth(now.getMonth() - periodInfo.value);
      }
      
      // Si no hay parámetros específicos, usar el último parámetro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Preparar datos para el gráfico
      const chartData = historicalData
        .filter(data => new Date(data.timestamp) >= startDate)
        .map(data => ({
          x: new Date(data.timestamp),
          y: data[parameters[0] === 'presión' ? 'pres' : 
                 parameters[0] === 'lluvia' ? 'lluvia' : 
                 parameters[0]]
        }));
      
      // Calcular estadísticas
      const values = chartData.map(item => item.y);
      const avg = values.reduce((a, b) => a + b, 0) / values.length;
      const min = Math.min(...values);
      const max = Math.max(...values);
      
      // Determinar tendencia
      const startValue = values[0];
      const endValue = values[values.length - 1];
      const trend = endValue > startValue ? "ascendente" : "descendente";
      const trendStrength = Math.abs(endValue - startValue) / startValue;
      
      // Generar la respuesta basada en el análisis de los datos
      const variations = communicationSystem.getTrendAnalysisVariations(
        parameters[0], 
        avg, 
        min, 
        max, 
        trend, 
        trendStrength, 
        period
      );
      
      const response = getRandomVariation(variations);
      
      // Añade un gráfico de análisis
      const chartId = `prediction-chart-${Date.now()}`;
      const chartResponse = `
        <div class="prediction-chart-container">
          <div class="chart-title">Tendencia de ${parameters[0]} en ${benaventeInfo.location} durante ${period}</div>
          <canvas class="prediction-chart" id="${chartId}" 
                  data-parameter="${parameters[0]}" 
                  data-chart-data='${JSON.stringify(chartData)}'></canvas>
        </div>
      `;
      
      return response + chartResponse;
    },
    
    prediction: (entities, context) => {
      // Si no hay parámetros específicos, usar el último parámetro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Actualizar contexto
      conversationContext.lastParameter = parameters[0];
      conversationContext.lastQuestionType = 'prediction';
      
      // Generar datos de predicción simulados
      const predictionData = [];
      const now = new Date();
      const latestData = historicalData[historicalData.length - 1];
      
      for (let i = 0; i < 5; i++) {
        const date = new Date(now);
        date.setDate(now.getDate() + i);
        
        let value;
        switch(parameters[0]) {
          case 'temperatura':
            // Simular patrones climáticos de Benavente (clima mediterráneo continentalizado)
            value = latestData.temp + (Math.random() - 0.5) * 3;
            // Ajustar según estación del año
            const month = now.getMonth();
            if (month >= 5 && month <= 8) { // Verano
              value = Math.min(35, Math.max(15, value));
            } else if (month >= 11 || month <= 2) { // Invierno
              value = Math.min(15, Math.max(-5, value));
            }
            break;
          case 'humedad':
            value = latestData.hum + (Math.random() - 0.5) * 10;
            value = Math.min(100, Math.max(20, value)); // Limitar rango realista
            break;
          case 'presión':
            value = latestData.pres + (Math.random() - 0.5) * 3;
            value = Math.min(1030, Math.max(980, value)); // Rango realista para Benavente
            break;
          case 'viento':
            value = latestData.wind + (Math.random() - 0.5) * 2;
            value = Math.min(20, Math.max(1, value)); // Limitar velocidad del viento
            break;
          default:
            value = latestData.temp + (Math.random() - 0.5) * 3;
        }
        
        predictionData.push({
          x: date,
          y: value
        });
      }
      
      // Determinar la tendencia de las predicciones
      const trend = predictionData[predictionData.length - 1].y > predictionData[0].y ?
                   'aumentando' : (predictionData[predictionData.length - 1].y < predictionData[0].y ? 'disminuyendo' : 'estable');
      
      // Calcular confiabilidad (simulación)
      const reliability = 0.7 + Math.random() * 0.25;
      
      // Generar la respuesta basada en el análisis de los datos
      const variations = communicationSystem.getPredictionVariations(
        parameters[0],
        reliability,
        '5 días'
      );
      
      const response = getRandomVariation(variations);
      
      // Añade un gráfico de predicción
      const chartId = `prediction-chart-${Date.now()}`;
      const chartResponse = `
        <div class="prediction-container">
          <div class="prediction-reliability">
            Confiabilidad de la predicción: ${(reliability * 100).toFixed(0)}% 
            <div class="reliability-bar">
              <div class="reliability-fill" style="width: ${(reliability * 100).toFixed(0)}%"></div>
            </div>
          </div>
          <div class="prediction-chart-container">
            <div class="chart-title">Predicción de ${parameters[0]} para los próximos 5 días en ${benaventeInfo.location}</div>
            <canvas class="prediction-chart" id="${chartId}" 
                    data-parameter="${parameters[0]}" 
                    data-chart-data='${JSON.stringify(predictionData)}'></canvas>
          </div>
        </div>
      `;
      
      return response + chartResponse;
    },
    
    comparison: (entities, context) => {
      // Necesitamos al menos dos periodos para comparar
      if (entities.periods.length < 2) {
        return "Para hacer una comparación necesito dos periodos. Por ejemplo: 'Compara la temperatura de esta semana con la semana pasada en Benavente'.";
      }
      
      const period1 = entities.periods[0];
      const period2 = entities.periods[1];
      
      // Actualizar contexto
      conversationContext.lastPeriod = period1;
      conversationContext.lastQuestionType = 'comparison';
      
      // Si no hay parámetros específicos, usar el último parámetro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Obtener datos para ambos periodos
      const periodInfo1 = periodMap[period1] || periodMap['esta semana'];
      const periodInfo2 = periodMap[period2] || periodMap['últimos 7 días'];
      
      const now = new Date();
      let startDate1, startDate2;
      
      // Calcular fechas de inicio para ambos periodos
      if (periodInfo1.type === 'day') {
        startDate1 = new Date(now);
        startDate1.setDate(now.getDate() - periodInfo1.value);
      } else if (periodInfo1.type === 'week') {
        startDate1 = new Date(now);
        startDate1.setDate(now.getDate() - (periodInfo1.value * 7));
      } else if (periodInfo1.type === 'month') {
        startDate1 = new Date(now);
        startDate1.setMonth(now.getMonth() - periodInfo1.value);
      }
      
      if (periodInfo2.type === 'day') {
        startDate2 = new Date(now);
        startDate2.setDate(now.getDate() - periodInfo2.value);
      } else if (periodInfo2.type === 'week') {
        startDate2 = new Date(now);
        startDate2.setDate(now.getDate() - (periodInfo2.value * 7));
      } else if (periodInfo2.type === 'month') {
        startDate2 = new Date(now);
        startDate2.setMonth(now.getMonth() - periodInfo2.value);
      }
      
      // Obtener datos para ambos periodos
      const data1 = historicalData.filter(data => new Date(data.timestamp) >= startDate1);
      const data2 = historicalData.filter(data => new Date(data.timestamp) >= startDate2);
      
      // Calcular promedios
      const avg1 = data1.reduce((sum, item) => sum + item[parameters[0] === 'presión' ? 'pres' : 
                                     parameters[0] === 'lluvia' ? 'lluvia' : 
                                     parameters[0]], 0) / data1.length;
      const avg2 = data2.reduce((sum, item) => sum + item[parameters[0] === 'presión' ? 'pres' : 
                                     parameters[0] === 'lluvia' ? 'lluvia' : 
                                     parameters[0]], 0) / data2.length;
      
      // Calcular porcentaje de cambio
      const changePercent = ((avg1 - avg2) / avg2) * 100;
      
      // Generar la respuesta basada en el análisis de los datos
      const variations = communicationSystem.getComparisonVariations(
        parameters[0],
        avg1,
        avg2,
        period1,
        period2,
        changePercent
      );
      
      const response = getRandomVariation(variations);
      
      // Contexto específico de Benavente
      response += `\n\nEn ${benaventeInfo.location}, ubicado a ${benaventeInfo.altitude} sobre el nivel del mar, `;
      
      if (parameters[0] === 'temperatura') {
        response += `las temperaturas suelen variar según la estación del año. `;
        response += `El clima mediterráneo continentalizado de Benavente presenta veranos calurosos e inviernos fríos.`;
      } else if (parameters[0] === 'humedad') {
        response += `la humedad promedio es del 65%, con variaciones según la época del año.`;
      } else if (parameters[0] === 'presión') {
        response += `la presión atmosférica se ve afectada por la altitud (${benaventeInfo.altitude}), `;
        response += `resultando en valores ligeramente menores que en el nivel del mar.`;
      }
      
      // Preparar datos para el gráfico comparativo
      const chartData1 = data1.map(data => ({
        x: new Date(data.timestamp),
        y: data[parameters[0] === 'presión' ? 'pres' : 
               parameters[0] === 'lluvia' ? 'lluvia' : 
               parameters[0]]
      }));
      
      const chartData2 = data2.map(data => ({
        x: new Date(data.timestamp),
        y: data[parameters[0] === 'presión' ? 'pres' : 
               parameters[0] === 'lluvia' ? 'lluvia' : 
               parameters[0]]
      }));
      
      // Añade un gráfico comparativo
      const chartId = `comparison-chart-${Date.now()}`;
      const chartResponse = `
        <div class="comparison-chart-container">
          <div class="chart-title">Comparación de ${parameters[0]}: ${period1} vs ${period2} en ${benaventeInfo.location}</div>
          <canvas class="comparison-chart" id="${chartId}" 
                  data-parameter="${parameters[0]}" 
                  data-chart-data1='${JSON.stringify(chartData1)}'
                  data-chart-data2='${JSON.stringify(chartData2)}'
                  data-period1="${period1}"
                  data-period2="${period2}"></canvas>
        </div>
      `;
      
      return response + chartResponse;
    },
    
    max_min: (entities, context) => {
      // Determinar el periodo
      let period = entities.periods.length > 0 ? entities.periods[0] : 
                  (context.lastPeriod ? context.lastPeriod : 'últimos 7 días');
      
      // Actualizar contexto
      conversationContext.lastPeriod = period;
      conversationContext.lastQuestionType = 'max_min';
      
      // Obtener datos para el periodo
      const periodInfo = periodMap[period] || periodMap['últimos 7 días'];
      const now = new Date();
      let startDate;
      
      if (periodInfo.type === 'day') {
        startDate = new Date(now);
        startDate.setDate(now.getDate() - periodInfo.value);
      } else if (periodInfo.type === 'week') {
        startDate = new Date(now);
        startDate.setDate(now.getDate() - (periodInfo.value * 7));
      } else if (periodInfo.type === 'month') {
        startDate = new Date(now);
        startDate.setMonth(now.getMonth() - periodInfo.value);
      }
      
      // Si no hay parámetros específicos, usar el último parámetro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Obtener datos para el periodo
      const periodData = historicalData.filter(data => new Date(data.timestamp) >= startDate);
      
      // Encontrar máximos y mínimos
      let max = -Infinity;
      let min = Infinity;
      let maxDate, minDate;
      
      periodData.forEach(data => {
        const value = data[parameters[0] === 'presión' ? 'pres' : 
                         parameters[0] === 'lluvia' ? 'lluvia' : 
                         parameters[0]];
                         
        if (value > max) {
          max = value;
          maxDate = data.timestamp;
        }
        
        if (value < min) {
          min = value;
          minDate = data.timestamp;
        }
      });
      
      // Generar respuesta
      let response = `En ${period} en ${benaventeInfo.location}, el valor máximo de ${parameters[0]} fue de ${max.toFixed(2)}`;
      
      if (parameters[0] !== 'lluvia' && parameters[0] !== 'dirección') {
        response += ` ${parameters[0] === 'presión' ? 'hPa' : 
                    parameters[0] === 'humedad' ? '%' : 
                    '°C'}`;
      }
      
      response += ` registrado el ${new Date(maxDate).toLocaleDateString('es-ES', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      })}.\n\n`;
      
      response += `El valor mínimo fue de ${min.toFixed(2)}`;
      
      if (parameters[0] !== 'lluvia' && parameters[0] !== 'dirección') {
        response += ` ${parameters[0] === 'presión' ? 'hPa' : 
                    parameters[0] === 'humedad' ? '%' : 
                    '°C'}`;
      }
      
      response += ` registrado el ${new Date(minDate).toLocaleDateString('es-ES', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      })}.`;
      
      // Contexto específico de Benavente
      response += `\n\n${benaventeInfo.location}, ubicado a ${benaventeInfo.altitude} sobre el nivel del mar, `;
      
      if (parameters[0] === 'temperatura') {
        response += `tiene un clima mediterráneo continentalizado con temperaturas que pueden variar `;
        response += `desde -5°C en invierno hasta más de 35°C en verano.`;
      } else if (parameters[0] === 'humedad') {
        response += `tiene una humedad promedio del 65%, con valores más altos en primavera y otoño.`;
      } else if (parameters[0] === 'presión') {
        response += `tiene una presión atmosférica promedio de alrededor de 1010 hPa debido a su altitud.`;
      }
      
      // Preparar datos para el gráfico
      const chartData = historicalData
        .filter(data => new Date(data.timestamp) >= startDate)
        .map(data => ({
          x: new Date(data.timestamp),
          y: data[parameters[0] === 'presión' ? 'pres' : 
                 parameters[0] === 'lluvia' ? 'lluvia' : 
                 parameters[0]]
        }));
      
      // Añade un gráfico con marcadores de máximos y mínimos
      const chartId = `extremes-chart-${Date.now()}`;
      const chartResponse = `
        <div class="extremes-chart-container">
          <div class="chart-title">Valores extremos de ${parameters[0]} en ${benaventeInfo.location} durante ${period}</div>
          <canvas class="extremes-chart" id="${chartId}" 
                  data-parameter="${parameters[0]}" 
                  data-chart-data='${JSON.stringify(chartData)}'
                  data-max-date="${maxDate}"
                  data-min-date="${minDate}"></canvas>
        </div>
      `;
      
      return response + chartResponse;
    },
    
    correlation: (entities, context) => {
      try {
        // Necesitamos al menos dos parámetros para analizar correlación
        if (entities.parameters.length < 2) {
          return "Para analizar correlación necesito dos parámetros meteorológicos. Por ejemplo: '¿Cómo se relaciona la temperatura con la humedad en Benavente?'";
        }
        
        const parameter1 = entities.parameters[0];
        const parameter2 = entities.parameters[1];
        
        // Actualizar contexto
        conversationContext.lastParameter = parameter1;
        conversationContext.lastQuestionType = 'correlation';
        
        // Obtener datos para el periodo (usar últimos 30 días por defecto)
        const now = new Date();
        const startDate = new Date(now);
        startDate.setDate(now.getDate() - 30);
        
        const periodData = historicalData.filter(data => new Date(data.timestamp) >= startDate);
        
        // Calcular correlación
        const values1 = periodData.map(data => 
          data[parameter1 === 'presión' ? 'pres' : 
              parameter1 === 'lluvia' ? 'lluvia' : 
              parameter1]
        );
        
        const values2 = periodData.map(data => 
          data[parameter2 === 'presión' ? 'pres' : 
              parameter2 === 'lluvia' ? 'lluvia' : 
              parameter2]
        );
        
        // Calcular media
        const mean1 = values1.reduce((a, b) => a + b, 0) / values1.length;
        const mean2 = values2.reduce((a, b) => a + b, 0) / values2.length;
        
        // Calcular covarianza y desviación estándar
        let covariance = 0;
        let stdDev1 = 0;
        let stdDev2 = 0;
        
        for (let i = 0; i < values1.length; i++) {
          const diff1 = values1[i] - mean1;
          const diff2 = values2[i] - mean2;
          
          covariance += diff1 * diff2;
          stdDev1 += diff1 * diff1;
          stdDev2 += diff2 * diff2;
        }
        
        covariance /= values1.length;
        stdDev1 = Math.sqrt(stdDev1 / values1.length);
        stdDev2 = Math.sqrt(stdDev2 / values1.length);
        
        // Calcular coeficiente de correlación de Pearson
        const correlation = covariance / (stdDev1 * stdDev2);
        const rSquared = correlation * correlation;
        
        // Generar la respuesta basada en el análisis de los datos
        const variations = communicationSystem.getCorrelationVariations(
          parameter1,
          parameter2,
          correlation,
          rSquared
        );
        
        const response = getRandomVariation(variations);
        
        // Preparar datos para el gráfico
        const chartData = periodData.map((data, index) => ({
          x: new Date(data.timestamp),
          y1: data[parameter1 === 'presión' ? 'pres' : 
                 parameter1 === 'lluvia' ? 'lluvia' : 
                 parameter1],
          y2: data[parameter2 === 'presión' ? 'pres' : 
                 parameter2 === 'lluvia' ? 'lluvia' : 
                 parameter2]
        }));
        
        // Añade un gráfico de correlación
        const chartId = `correlation-chart-${Date.now()}`;
        const chartResponse = `
          <div class="prediction-chart-container">
            <div class="chart-title">Relación entre ${parameter1} y ${parameter2} en ${benaventeInfo.location}</div>
            <canvas class="prediction-chart" id="${chartId}" 
                    data-parameter1="${parameter1}"
                    data-parameter2="${parameter2}"
                    data-chart-data='${JSON.stringify(chartData)}'></canvas>
          </div>
        `;
        
        return response + chartResponse;
      } catch (error) {
        console.error('Error en análisis de correlación:', error);
        return "⚠️ Ocurrió un error al analizar la correlación. Por favor, intenta nuevamente.";
      }
    },
    
    greeting: () => {
      const variations = communicationSystem.getGreetingVariations();
      return getRandomVariation(variations);
    },
    
    goodbye: () => {
      const variations = communicationSystem.getGoodbyeVariations();
      return getRandomVariation(variations);
    },
    
    help: () => {
      const variations = communicationSystem.getHelpVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="general-answer">
        <h3>Preguntas meteorológicas para Benavente</h3>
        <ul>
          <li>"¿Cuál es la temperatura actual en Benavente?"</li>
          <li>"¿Cómo ha sido la tendencia de humedad en Benavente esta semana?"</li>
          <li>"Muestra la tendencia de presión de los últimos 7 días en Benavente"</li>
          <li>"¿Cómo se relaciona la humedad con la lluvia en Benavente?"</li>
          <li>"¿Qué tiempo hará mañana en Benavente?"</li>
        </ul>
        
        <h3>Características climáticas de Benavente</h3>
        <ul>
          <li>Verano: ${benaventeInfo.typicalWeather.summer}</li>
          <li>Invierno: ${benaventeInfo.typicalWeather.winter}</li>
          <li>Primavera: ${benaventeInfo.typicalWeather.spring}</li>
          <li>Otoño: ${benaventeInfo.typicalWeather.autumn}</li>
        </ul>
        
        <h3>Preguntas sobre Horus en Benavente</h3>
        <ul>
          <li>"¿Qué es Horus en Benavente?"</li>
          <li>"¿Cómo funciona el sistema Horus en Benavente?"</li>
          <li>"¿Qué sensores tiene Horus en Benavente?"</li>
          <li>"¿Dónde está ubicado Horus en Benavente?"</li>
        </ul>
        
        <p>¡Hazme cualquier pregunta y haré lo posible por ayudarte con información específica de Benavente!</p>
      </div>`;
      
      return response;
    },
    
    about_horus: () => {
      const variations = communicationSystem.getAboutHorusVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="system-info">
        <h3>Características principales en Benavente:</h3>
        <ul>
          <li>Medición de temperatura, humedad, presión atmosférica y dirección del viento en ${benaventeInfo.location}</li>
          <li>Sensores de calidad del aire (PM2.5, PM10, CO2) adaptados al clima de Benavente</li>
          <li>Registro de precipitaciones y velocidad del viento en la llanura del Duero</li>
          <li>Transmisión de datos en tiempo real vía MQTT desde ${benaventeInfo.location}</li>
          <li>Interfaz web para visualización y análisis de datos específicos de Benavente</li>
        </ul>
        
        <h3>Características climáticas de Benavente relevantes:</h3>
        <ul>
          <li><strong>Ubicación:</strong> ${benaventeInfo.coordinates}</li>
          <li><strong>Altitud:</strong> ${benaventeInfo.altitude}</li>
          <li><strong>Clima:</strong> ${benaventeInfo.climate}</li>
          <li><strong>Verano:</strong> ${benaventeInfo.typicalWeather.summer}</li>
          <li><strong>Invierno:</strong> ${benaventeInfo.typicalWeather.winter}</li>
          <li><strong>Primavera:</strong> ${benaventeInfo.typicalWeather.spring}</li>
          <li><strong>Otoño:</strong> ${benaventeInfo.typicalWeather.autumn}</li>
        </ul>
        
        <p>Horus proporciona datos meteorológicos precisos para análisis climáticos específicos de ${benaventeInfo.location}, predicciones y estudios ambientales adaptados a las características de la región.</p>
      </div>`;
      
      return response;
    },
    
    support: () => {
      const variations = communicationSystem.getSupportVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="system-info">
        <h3>Problemas comunes:</h3>
        <ul>
          <li><strong>Datos no actualizados:</strong> Verifica la conexión de la estación Horus en Benavente y espera unos minutos para que se actualicen los datos.</li>
          <li><strong>Interfaz lenta:</strong> Intenta actualizar la página o limpiar la caché del navegador.</li>
          <li><strong>Gráficos no visibles:</strong> Asegúrate de que JavaScript está habilitado en tu navegador.</li>
          <li><strong>Error de conexión:</strong> Verifica tu conexión a internet y recarga la página.</li>
        </ul>
        
        <h3>Solución de problemas específicos de Benavente:</h3>
        <ol>
          <li>Recarga la página (F5 o Ctrl + R)</li>
          <li>Limpia la caché del navegador</li>
          <li>Intenta con otro navegador (Chrome, Firefox, Edge)</li>
          <li>Verifica tu conexión a internet</li>
          <li>Si los datos parecen inusuales, considera que el clima de Benavente (${benaventeInfo.altitude}) puede causar variaciones específicas</li>
        </ol>
        
        <p>Si el problema persiste, contacta al administrador del sistema para obtener ayuda adicional específica para ${benaventeInfo.location}.</p>
      </div>`;
      
      return response;
    },
    
    personal: () => {
      const variations = communicationSystem.getPersonalInfoVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="system-info">
        <h3>Mis capacidades específicas para Benavente:</h3>
        <ul>
          <li>Analizar y explicar datos meteorológicos en tiempo real para ${benaventeInfo.location}</li>
          <li>Identificar tendencias y patrones climáticos específicos de la región</li>
          <li>Realizar predicciones basadas en datos históricos de Benavente</li>
          <li>Explicar el funcionamiento del sistema Horus en Benavente</li>
          <li>Proporcionar recomendaciones basadas en condiciones climáticas de la zona</li>
          <li>Contextualizar el clima de Benavente (${benaventeInfo.altitude}) con su ubicación en la llanura del Duero</li>
        </ul>
        
        <h3>Características climáticas de Benavente que considero:</h3>
        <ul>
          <li>Clima mediterráneo continentalizado con veranos calurosos e inviernos fríos</li>
          <li>Altitud de ${benaventeInfo.altitude} que afecta la presión atmosférica</li>
          <li>Ubicación en la llanura del Duero que influye en los patrones de viento</li>
          <li>Patrones estacionales típicos de la meseta castellana</li>
        </ul>
        
        <p>Fui creado para facilitar el acceso y comprensión de los datos meteorológicos recopilados por la estación Horus en Benavente, ayudando a usuarios a tomar decisiones informadas basadas en el clima de la zona.</p>
        
        <p>No soy un humano, sino un sistema de inteligencia artificial diseñado específicamente para análisis meteorológico y soporte del sistema Horus en ${benaventeInfo.location}.</p>
      </div>`;
      
      return response;
    },
    
    general: () => {
      const variations = communicationSystem.getGeneralInfoVariations();
      let response = getRandomVariation(variations);
      
      const now = new Date();
      response += `<div class="system-info">
        <h3>Hora actual:</h3>
        <p>${now.toLocaleTimeString('es-ES', { 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit'
        })}</p>
        
        <h3>Fecha actual:</h3>
        <p>${now.toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}</p>
        
        <p>Estoy alojado en un servidor web y proporciono información meteorológica específica para ${benaventeInfo.location}, ubicado en la llanura del Duero.</p>
        
        <p>Fui desarrollado recientemente como parte del sistema Horus para ${benaventeInfo.location}. No tengo una edad en el sentido humano.</p>
      </div>`;
      
      return response;
    },
    
    out_of_scope: (intent) => {
      const domain = intent.domain || 'general';
      
      const variations = communicationSystem.getOutOfScopeVariations(domain);
      let response = getRandomVariation(variations);
      
      // Mensajes personalizados según el ámbito
      const domainMessages = {
        salud: `<div class="out-of-scope">
          <h3>Preguntas sobre Salud en Benavente</h3>
          <p>Para consultas sobre salud:</p>
          <ul>
            <li>Contacta a un profesional médico calificado en Benavente</li>
            <li>Visita el centro de salud de Benavente</li>
            <li>Consulta fuentes oficiales de salud pública</li>
          </ul>
          <p>La información meteorológica de ${benaventeInfo.location} puede influir en ciertas condiciones de salud (como alergias estacionales), pero no sustituye el consejo médico profesional.</p>
          <p class="benavente-context">En Benavente, con su clima mediterráneo continentalizado, las temperaturas extremas de verano e invierno pueden requerir precauciones especiales para la salud.</p>
        </div>`,
        
        tecnología: `<div class="out-of-scope">
          <h3>Preguntas sobre Tecnología en Benavente</h3>
          <p>Para consultas sobre tecnología:</p>
          <ul>
            <li>Consulta foros especializados como Stack Overflow</li>
            <li>Revisa documentación oficial de los productos</li>
            <li>Busca tutoriales en YouTube o plataformas educativas</li>
          </ul>
          <p>Puedo ayudarte con aspectos tecnológicos relacionados con el sistema Horus en Benavente, pero no con otros temas tecnológicos generales.</p>
          <p class="benavente-context">El sistema Horus en Benavente utiliza tecnología adaptada a las condiciones climáticas de la llanura del Duero (${benaventeInfo.altitude}).</p>
        </div>`,
        
        deportes: `<div class="out-of-scope">
          <h3>Preguntas sobre Deportes en Benavente</h3>
          <p>Para información sobre deportes:</p>
          <ul>
            <li>Visita el Ayuntamiento de Benavente para información deportiva</li>
            <li>Sigue el Club Deportivo de Benavente</li>
            <li>Consulta aplicaciones deportivas oficiales</li>
          </ul>
          <p>Puedo informarte cómo las condiciones meteorológicas en ${benaventeInfo.location} pueden afectar actividades deportivas al aire libre.</p>
          <p class="benavente-context">En Benavente, con su clima mediterráneo continentalizado, las temperaturas pueden superar los 35°C en verano y bajar de 0°C en invierno, lo que afecta la planificación de actividades deportivas al aire libre.</p>
        </div>`,
        
        entretenimiento: `<div class="out-of-scope">
          <h3>Preguntas sobre Entretenimiento en Benavente</h3>
          <p>Para información sobre entretenimiento:</p>
          <ul>
            <li>Visita la página web del Ayuntamiento de Benavente</li>
            <li>Sigue eventos culturales en la Plaza Mayor de Benavente</li>
            <li>Consulta sitios web oficiales de actividades en la zona</li>
          </ul>
          <p>El clima en ${benaventeInfo.location} puede influir en tus planes de entretenimiento al aire libre.</p>
          <p class="benavente-context">En Benavente, con su clima mediterráneo continentalizado, los mejores momentos para actividades al aire libre suelen ser primavera y otoño, cuando las temperaturas son más moderadas.</p>
        </div>`,
        
        comida: `<div class="out-of-scope">
          <h3>Preguntas sobre Comida en Benavente</h3>
          <p>Para recetas o información sobre comida:</p>
          <ul>
            <li>Consulta sitios web especializados en gastronomía zamorana</li>
            <li>Sigue chefs locales de Benavente</li>
            <li>Visita restaurantes tradicionales en la Plaza Mayor</li>
          </ul>
          <p>El clima en ${benaventeInfo.location} puede afectar la disponibilidad de ciertos alimentos de temporada.</p>
          <p class="benavente-context">En Benavente, con su clima mediterráneo continentalizado, los productos locales varían según la estación: verduras frescas en primavera-verano y productos de invierno como castañas en otoño-invierno.</p>
        </div>`,
        
        educación: `<div class="out-of-scope">
          <h3>Preguntas sobre Educación en Benavente</h3>
          <p>Para información educativa:</p>
          <ul>
            <li>Consulta la página web del Ayuntamiento de Benavente</li>
            <li>Visita el Centro de Educación de Adultos de Benavente</li>
            <li>Contacta al IES Benavente</li>
          </ul>
          <p>Puedo proporcionar información sobre meteorología y ciencias atmosféricas en el contexto de ${benaventeInfo.location}, pero no sobre otros temas educativos.</p>
          <p class="benavente-context">El clima de Benavente (${benaventeInfo.altitude}) ofrece oportunidades únicas para estudios prácticos de meteorología en la llanura del Duero.</p>
        </div>`,
        
        finanzas: `<div class="out-of-scope">
          <h3>Preguntas sobre Finanzas en Benavente</h3>
          <p>Para consultas financieras:</p>
          <ul>
            <li>Consulta a un asesor financiero en Benavente</li>
            <li>Visita oficinas bancarias en la Plaza Mayor</li>
            <li>Revisa información oficial de instituciones financieras</li>
          </ul>
          <p>El clima en ${benaventeInfo.location} puede afectar ciertos sectores económicos locales como la agricultura, pero no puedo proporcionar asesoramiento financiero.</p>
          <p class="benavente-context">En Benavente, el clima mediterráneo continentalizado influye en actividades económicas como la agricultura de secano, con temperaturas que pueden superar los 35°C en verano y bajar de 0°C en invierno.</p>
        </div>`,
        
        general: `<div class="out-of-scope">
          <h3>Preguntas Fuera de Mi Ámbito en Benavente</h3>
          <p>Mi conocimiento está limitado a:</p>
          <ul>
            <li>Monitoreo y análisis de datos meteorológicos en Benavente</li>
            <li>Funcionamiento del sistema Horus en Benavente</li>
            <li>Análisis de tendencias climáticas de la zona</li>
            <li>Predicciones basadas en datos históricos de Benavente</li>
            <li>Contexto climático específico de la llanura del Duero (${benaventeInfo.altitude})</li>
          </ul>
          
          <p>Para otras preguntas, te recomiendo:</p>
          <ul>
            <li>Buscar en fuentes especializadas en el tema</li>
            <li>Consultar a expertos en el campo específico</li>
            <li>Utilizar asistentes diseñados para esos temas</li>
          </ul>
          
          <p class="benavente-context"><strong>Información clave sobre Benavente:</strong> Ubicado a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterráneo continentalizado con veranos calurosos e inviernos fríos.</p>
        </div>`
      };
      
      response += domainMessages[domain] || domainMessages.general;
      return response;
    },
    
    unrelated: (entities, context) => {
      const variations = communicationSystem.getUnrelatedVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="out-of-scope">
        <h3>¿Cómo puedo ayudarte con Benavente?</h3>
        <ul>
          <li>Consultar datos meteorológicos actuales en Benavente</li>
          <li>Analizar tendencias climáticas históricas de Benavente</li>
          <li>Realizar predicciones basadas en datos de Benavente</li>
          <li>Explicar el funcionamiento de Horus en Benavente</li>
          <li>Contextualizar el clima de Benavente (${benaventeInfo.altitude})</li>
        </ul>
        
        <p>Ejemplos de preguntas que puedo responder:</p>
        <ul>
          <li>"¿Cuál es la temperatura actual en Benavente?"</li>
          <li>"¿Cómo funciona el sistema Horus en Benavente?"</li>
          <li>"Muestra la tendencia de presión de los últimos 7 días en Benavente"</li>
        </ul>
        
        <p>Por favor, reformula tu pregunta para que esté relacionada con el clima o el sistema Horus en <strong>${benaventeInfo.location}</strong>.</p>
        
        <p class="benavente-context"><strong>Información clave sobre Benavente:</strong> Ubicado a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterráneo continentalizado con veranos calurosos e inviernos fríos.</p>
      </div>`;
      
      return response;
    }
  };

  // Sistema de comunicación mejorado
  const communicationSystem = {
    // Variaciones de saludos según la hora
    getGreetingVariations: () => {
      const hours = new Date().getHours();
      const dayOfWeek = new Date().getDay();
      const month = new Date().getMonth();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si hay un evento local próximo
      const upcomingEvent = benaventeInfo.localEvents.find(event => {
        // Aquí iría la lógica para detectar eventos próximos
        return Math.random() > 0.7; // Simulación aleatoria
      });
      
      const variations = {
        morning: [
          `¡Buenos días! ${localPhrase} Soy Horus AI, tu asistente meteorológico para Benavente. ¿En qué puedo ayudarte hoy?`,
          `¡Hola! ${localPhrase} Espero que estés disfrutando de esta mañana en Benavente. Soy Horus AI, tu asistente meteorológico. ¿Necesitas información sobre el clima?`,
          `¡Buen día! ${localPhrase} ¿Sabías que hoy en Benavente...? Soy Horus AI, tu asistente meteorológico. ¿En qué puedo ayudarte?`
        ],
        afternoon: [
          `¡Buenas tardes! ${localPhrase} Soy Horus AI, tu asistente especializado en el clima de Benavente. ¿Necesitas información meteorológica?`,
          `¡Hola! ${localPhrase} ¿Cómo está el tiempo por tu zona de Benavente? Soy Horus AI, tu asistente meteorológico. ¿En qué puedo ayudarte?`,
          `¡Buenas tardes! ${localPhrase} ¿Has notado algún cambio en el clima de Benavente últimamente? Soy Horus AI, tu asistente meteorológico.`
        ],
        evening: [
          `¡Buenas noches! ${localPhrase} Soy Horus AI, tu asistente meteorológico para Benavente. ¿Necesitas información sobre el clima nocturno?`,
          `¡Hola! ${localPhrase} ¿Cómo ha sido tu día en Benavente? Soy Horus AI, tu asistente meteorológico. ¿Necesitas información sobre el clima?`,
          `¡Buenas noches! ${localPhrase} ¿Sabías que en Benavente el clima nocturno suele...? Soy Horus AI, tu asistente meteorológico.`
        ]
      };
      
      if (upcomingEvent) {
        const eventVariations = [
          `¡Buenos días! ${localPhrase} Por cierto, ¿sabías que se acerca ${upcomingEvent} en Benavente? Soy Horus AI, tu asistente meteorológico. ¿Necesitas información sobre el clima para el evento?`,
          `¡Hola! ${localPhrase} Con el ${upcomingEvent} acercándose en Benavente, es importante estar al tanto del clima. Soy Horus AI, tu asistente meteorológico. ¿En qué puedo ayudarte?`
        ];
        
        if (hours < 12) return eventVariations;
        if (hours < 18) return eventVariations;
        return eventVariations;
      }
      
      if (hours < 12) return variations.morning;
      if (hours < 18) return variations.afternoon;
      return variations.evening;
    },
    
    // Variaciones de despedida
    getGoodbyeVariations: () => {
      const hours = new Date().getHours();
      const dayOfWeek = new Date().getDay();
      
      return [
        `¡Que tengas un buen día! Si necesitas más información sobre el clima de Benavente, no dudes en volver. ¡Hasta pronto!`,
        `Gracias por consultar el clima de Benavente conmigo. ¡Que disfrutes del día en la llanura del Duero!`,
        `Espero haber sido de ayuda con la información meteorológica de Benavente. ¡Que tengas un día maravilloso!`,
        `¡Hasta la próxima! Recuerda que siempre puedes volver para conocer el estado del tiempo en Benavente.`,
        `Gracias por tu visita. Si necesitas más información sobre el clima de Benavente, estaré aquí cuando me necesites. ¡Adiós!`,
        `Espero que la información sobre el clima de Benavente te haya sido útil. ¡Que tengas un buen día en la plaza Mayor!`,
        `¡Hasta pronto! Que el tiempo te acompañe en tus próximas actividades en Benavente.`
      ];
    },
    
    // Variaciones para datos actuales
    getCurrentDataVariations: (parameter, value, unit) => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      const latestData = historicalData[historicalData.length - 1];
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si hay un evento local relevante
      const relevantEvent = benaventeInfo.localEvents.find(event => {
        // Aquí iría la lógica para detectar eventos relevantes para el clima
        return Math.random() > 0.8; // Simulación aleatoria
      });
      
      // Determinar si es relevante para actividades al aire libre
      const isOutdoorRelevant = (parameter === 'temperatura' && value > 15) || 
                               (parameter === 'humedad' && value < 70) ||
                               (parameter === 'presión' && value > 1000);
      
      // Determinar si es relevante para actividades específicas de Benavente
      const isBenaventeSpecific = benaventeInfo.localLandmarks.some(landmark => {
        return Math.random() > 0.7; // Simulación aleatoria
      });
      
      // Determinar si es una condición climática inusual
      const isUnusual = (parameter === 'temperatura' && (value > 30 || value < 5)) ||
                        (parameter === 'humedad' && (value > 80 || value < 30)) ||
                        (parameter === 'presión' && (value > 1030 || value < 980));
      
      // Determinar si es relevante para la época del año
      const isSeasonRelevant = (month === 6 && parameter === 'temperatura' && value > 25) || // Verano
                              (month === 1 && parameter === 'temperatura' && value < 10) || // Invierno
                              (month === 3 && parameter === 'lluvia' && value > 0); // Primavera
      
      // Variaciones según el parámetro
      const variations = {
        temperatura: [
          `La temperatura actual en Benavente es de ${value.toFixed(1)}°C. ${localPhrase}. ${isUnusual ? 'Esta temperatura es inusual para esta época del año en Benavente.' : 'Esta temperatura es típica del clima mediterráneo continentalizado de Benavente.'}`,
          `En estos momentos, la temperatura en Benavente es de ${value.toFixed(1)}°C. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo común para nuestra zona.' : 'Es un buen día para disfrutar de la Plaza Mayor si te gusta esta temperatura.'}`,
          `Actualmente registramos ${value.toFixed(1)}°C en Benavente. ${localPhrase}. ${isUnusual ? '¡Cuidado con las temperaturas extremas!' : 'Es una temperatura perfecta para un paseo por el Río Esla.'}`
        ],
        humedad: [
          `La humedad actual en Benavente es del ${value.toFixed(0)}%. ${localPhrase}. ${isUnusual ? 'Esta humedad es inusual para nuestra zona.' : 'Este nivel de humedad es típico de Benavente.'}`,
          `Actualmente la humedad en Benavente es del ${value.toFixed(0)}%. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo común para nuestra zona.' : 'Es un buen nivel de humedad para las actividades al aire libre.'}`,
          `Registramos un ${value.toFixed(0)}% de humedad en Benavente. ${localPhrase}. ${isUnusual ? '¡Cuidado con la humedad alta!' : 'Es una humedad perfecta para disfrutar del clima de la llanura del Duero.'}`
        ],
        presión: [
          `La presión atmosférica actual en Benavente es de ${value.toFixed(0)} hPa. ${localPhrase}. ${isUnusual ? 'Esta presión es inusual para nuestra zona.' : 'Este valor es típico de Benavente a ${benaventeInfo.altitude}.'}`,
          `Actualmente registramos ${value.toFixed(0)} hPa de presión en Benavente. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo común para nuestra zona.' : 'Es una presión normal para el clima mediterráneo continentalizado de Benavente.'}`,
          `La presión atmosférica en Benavente es de ${value.toFixed(0)} hPa. ${localPhrase}. ${isUnusual ? '¡Cuidado con los cambios bruscos de presión!' : 'Esta presión indica condiciones climáticas estables en la zona.'}`
        ],
        lluvia: [
          `Actualmente ${value ? 'está lloviendo' : 'no está lloviendo'} en Benavente. ${localPhrase}. ${isUnusual ? '¡Esperemos que no dure mucho!' : 'Es un buen momento para pasear por el casco histórico.'}`,
          `El sistema registra que ${value ? 'hay lluvia' : 'no hay lluvia'} en estos momentos en Benavente. ${localPhrase}. ${isUnusual ? '¡No olvides tu paraguas!' : 'Es un buen día para visitar la Iglesia de Santiago.'}`,
          `Según nuestros datos, ${value ? 'está lloviendo' : 'no está lloviendo'} en Benavente. ${localPhrase}. ${isUnusual ? '¡Cuidado con posibles inundaciones!' : 'Es un buen momento para disfrutar de un café en la Plaza Mayor.'}`
        ],
        viento: [
          `La velocidad del viento actual en Benavente es de ${value.toFixed(1)} m/s (${(value * 3.6).toFixed(1)} km/h). ${localPhrase}. ${isUnusual ? '¡Cuidado con las ráfagas fuertes!' : 'Es un viento típico de la llanura del Duero.'}`,
          `Actualmente el viento en Benavente sopla a ${value.toFixed(1)} m/s. ${localPhrase}. ${isUnusual ? 'Este viento es bastante fuerte para nuestra zona.' : 'Es un buen día para practicar actividades al aire libre.'}`,
          `Registramos una velocidad de viento de ${value.toFixed(1)} m/s en Benavente. ${localPhrase}. ${isUnusual ? '¡Presta atención a las señales de tráfico!' : 'Es un viento perfecto para disfrutar del paisaje.'}`
        ],
        gas: [
          `El nivel de gas actual en Benavente es de ${value.toFixed(2)} kΩ. ${localPhrase}. ${isUnusual ? 'Este nivel es inusual para nuestra zona.' : 'Este valor es típico de Benavente.'}`,
          `Actualmente registramos un nivel de gas de ${value.toFixed(2)} kΩ en Benavente. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo común para nuestra zona.' : 'Es un buen nivel para las actividades al aire libre.'}`,
          `El sistema detecta un nivel de gas de ${value.toFixed(2)} kΩ en Benavente. ${localPhrase}. ${isUnusual ? '¡Cuidado con la calidad del aire!' : 'Es un buen momento para pasear por el Río Esla.'}`
        ],
        dirección: [
          `La dirección del viento actual en Benavente es ${getWindDirectionName(latestData.wind_dir)} (${latestData.wind_dir}°). ${localPhrase}. ${isUnusual ? '¡Este viento es inusual para nuestra zona!' : 'Es una dirección típica del viento en Benavente.'}`,
          `Actualmente el viento en Benavente viene del ${getWindDirectionName(latestData.wind_dir)}. ${localPhrase}. ${isUnusual ? 'Este viento es bastante fuera de lo común para nuestra zona.' : 'Es una dirección normal para el clima mediterráneo continentalizado de Benavente.'}`,
          `Registramos que el viento en Benavente viene del ${getWindDirectionName(latestData.wind_dir)}. ${localPhrase}. ${isUnusual ? '¡Cuidado con los cambios bruscos de dirección!' : 'Es una dirección perfecta para disfrutar del clima de la llanura del Duero.'}`
        ]
      };
      
      // Si hay evento relevante, añadir variaciones específicas
      if (relevantEvent) {
        const eventVariations = {
          temperatura: [
            `La temperatura actual en Benavente es de ${value.toFixed(1)}°C. Con el ${relevantEvent} acercándose, es importante estar preparado para el clima. ${localPhrase}.`,
            `En estos momentos, la temperatura en Benavente es de ${value.toFixed(1)}°C. ${relevantEvent} se acerca, así que mantente informado sobre el clima. ${localPhrase}.`
          ],
          humedad: [
            `La humedad actual en Benavente es del ${value.toFixed(0)}%. Con el ${relevantEvent} acercándose, este nivel de humedad podría afectar los preparativos. ${localPhrase}.`,
            `Actualmente la humedad en Benavente es del ${value.toFixed(0)}%. Para ${relevantEvent}, este nivel de humedad es importante tener en cuenta. ${localPhrase}.`
          ],
          // Variaciones similares para otros parámetros
          presión: [
            `La presión atmosférica actual en Benavente es de ${value.toFixed(0)} hPa. Con el ${relevantEvent} acercándose, este valor de presión indica... ${localPhrase}.`
          ],
          lluvia: [
            `Actualmente ${value ? 'está lloviendo' : 'no está lloviendo'} en Benavente. Para ${relevantEvent}, esta condición es importante para... ${localPhrase}.`
          ],
          viento: [
            `La velocidad del viento actual en Benavente es de ${value.toFixed(1)} m/s. Con el ${relevantEvent} acercándose, este viento podría afectar... ${localPhrase}.`
          ],
          gas: [
            `El nivel de gas actual en Benavente es de ${value.toFixed(2)} kΩ. Para ${relevantEvent}, este nivel de calidad del aire es... ${localPhrase}.`
          ],
          dirección: [
            `La dirección del viento actual en Benavente es ${getWindDirectionName(latestData.wind_dir)}. Con el ${relevantEvent} acercándose, esta dirección indica... ${localPhrase}.`
          ]
        };
        
        // Combinar variaciones normales con variaciones de evento
        return [...variations[parameter], ...eventVariations[parameter]];
      }
      
      return variations[parameter];
    },
    
    // Variaciones para análisis de tendencias
    getTrendAnalysisVariations: (parameter, avg, min, max, trend, trendStrength, period) => {
      const now = new Date();
      const month = now.getMonth();
      const isSummer = month >= 5 && month <= 8;
      const isWinter = month >= 11 || month <= 2;
      
      // Determinar si la tendencia es significativa
      const isSignificantTrend = trendStrength > 0.1;
      
      // Determinar si es relevante para la época del año
      const isSeasonRelevant = (isSummer && parameter === 'temperatura' && trend === 'ascendente') ||
                              (isWinter && parameter === 'temperatura' && trend === 'descendente');
      
      // Determinar si es una tendencia inusual
      const isUnusualTrend = (parameter === 'temperatura' && trendStrength > 0.2) ||
                             (parameter === 'humedad' && trendStrength > 0.15) ||
                             (parameter === 'presión' && trendStrength > 0.1);
      
      // Variaciones según el parámetro
      const variations = {
        temperatura: [
          `En los últimos ${period}, la temperatura en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(1)}°C, con un mínimo de ${min.toFixed(1)}°C y un máximo de ${max.toFixed(1)}°C.`,
          `Analizando los datos de los últimos ${period} en Benavente, observamos que la temperatura ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patrón es inusual para nuestra zona.' : 'Este patrón es típico del clima mediterráneo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(1)}°C, con picos entre ${min.toFixed(1)}°C y ${max.toFixed(1)}°C.`,
          `Según nuestro análisis de los últimos ${period}, la temperatura en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(1)}°C, con valores extremos de ${min.toFixed(1)}°C y ${max.toFixed(1)}°C.`
        ],
        humedad: [
          `En los últimos ${period}, la humedad en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido del ${avg.toFixed(0)}%, con un mínimo del ${min.toFixed(0)}% y un máximo del ${max.toFixed(0)}%.`,
          `Analizando los datos de los últimos ${period} en Benavente, observamos que la humedad ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patrón es inusual para nuestra zona.' : 'Este patrón es típico del clima mediterráneo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(0)}%, con picos entre ${min.toFixed(0)}% y ${max.toFixed(0)}%.`,
          `Según nuestro análisis de los últimos ${period}, la humedad en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} El promedio registrado es del ${avg.toFixed(0)}%, con valores extremos del ${min.toFixed(0)}% y del ${max.toFixed(0)}%.`
        ],
        presión: [
          `En los últimos ${period}, la presión atmosférica en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(0)} hPa, con un mínimo de ${min.toFixed(0)} hPa y un máximo de ${max.toFixed(0)} hPa.`,
          `Analizando los datos de los últimos ${period} en Benavente, observamos que la presión atmosférica ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patrón es inusual para nuestra zona.' : 'Este patrón es típico del clima mediterráneo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(0)} hPa, con picos entre ${min.toFixed(0)} hPa y ${max.toFixed(0)} hPa.`,
          `Según nuestro análisis de los últimos ${period}, la presión atmosférica en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(0)} hPa, con valores extremos de ${min.toFixed(0)} hPa y ${max.toFixed(0)} hPa.`
        ],
        lluvia: [
          `En los últimos ${period}, la precipitación en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(1)} mm, con un mínimo de ${min.toFixed(1)} mm y un máximo de ${max.toFixed(1)} mm.`,
          `Analizando los datos de los últimos ${period} en Benavente, observamos que la precipitación ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patrón es inusual para nuestra zona.' : 'Este patrón es típico del clima mediterráneo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(1)} mm, con picos entre ${min.toFixed(1)} mm y ${max.toFixed(1)} mm.`,
          `Según nuestro análisis de los últimos ${period}, la precipitación en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(1)} mm, con valores extremos de ${min.toFixed(1)} mm y ${max.toFixed(1)} mm.`
        ],
        viento: [
          `En los últimos ${period}, la velocidad del viento en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(1)} m/s, con un mínimo de ${min.toFixed(1)} m/s y un máximo de ${max.toFixed(1)} m/s.`,
          `Analizando los datos de los últimos ${period} en Benavente, observamos que la velocidad del viento ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patrón es inusual para nuestra zona.' : 'Este patrón es típico del clima mediterráneo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(1)} m/s, con picos entre ${min.toFixed(1)} m/s y ${max.toFixed(1)} m/s.`,
          `Según nuestro análisis de los últimos ${period}, la velocidad del viento en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(1)} m/s, con valores extremos de ${min.toFixed(1)} m/s y ${max.toFixed(1)} m/s.`
        ]
      };
      
      return variations[parameter] || variations.temperatura;
    },
    
    // Variaciones para predicciones
    getPredictionVariations: (parameter, reliability, period) => {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      
      // Determinar si es relevante para la época del año
      const isSeasonRelevant = (month === 6 && parameter === 'temperatura') || // Verano
                              (month === 1 && parameter === 'temperatura') || // Invierno
                              (month === 3 && parameter === 'lluvia'); // Primavera
      
      // Determinar si es una predicción inusual
      const isUnusualPrediction = reliability < 0.6;
      
      // Determinar si hay un evento local relevante
      const relevantEvent = benaventeInfo.localEvents.find(event => {
        // Aquí iría la lógica para detectar eventos relevantes para el clima
        return Math.random() > 0.7; // Simulación aleatoria
      });
      
      // Variaciones según el parámetro
      const variations = {
        temperatura: [
          `Basado en los datos históricos de Benavente, la predicción para los próximos ${period} indica que la temperatura seguirá una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicción tiene una confiabilidad baja, así que tómala con precaución.' : 'Esta predicción es bastante confiable para planificar actividades en Benavente.'}`,
          `Según nuestro análisis de los datos meteorológicos de Benavente, esperamos que la temperatura ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los próximos ${period}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones climáticos inusuales, esta predicción debe tomarse con reserva.' : 'Esta predicción se basa en patrones históricos típicos del clima mediterráneo continentalizado de Benavente.'}`,
          `Nuestra predicción meteorológica para Benavente indica que la temperatura tendrá una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los próximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicción en unos días para mayor precisión.' : 'puedes planificar tus actividades con confianza.'}`
        ],
        humedad: [
          `Basado en los datos históricos de Benavente, la predicción para los próximos ${period} indica que la humedad seguirá una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicción tiene una confiabilidad baja, así que tómala con precaución.' : 'Esta predicción es bastante confiable para planificar actividades en Benavente.'}`,
          `Según nuestro análisis de los datos meteorológicos de Benavente, esperamos que la humedad ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los próximos ${period}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones climáticos inusuales, esta predicción debe tomarse con reserva.' : 'Esta predicción se basa en patrones históricos típicos del clima mediterráneo continentalizado de Benavente.'}`,
          `Nuestra predicción meteorológica para Benavente indica que la humedad tendrá una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los próximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicción en unos días para mayor precisión.' : 'puedes planificar tus actividades con confianza.'}`
        ],
        presión: [
          `Basado en los datos históricos de Benavente, la predicción para los próximos ${period} indica que la presión atmosférica seguirá una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicción tiene una confiabilidad baja, así que tómala con precaución.' : 'Esta predicción es bastante confiable para planificar actividades en Benavente.'}`,
          `Según nuestro análisis de los datos meteorológicos de Benavente, esperamos que la presión atmosférica ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los próximos ${period}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones climáticos inusuales, esta predicción debe tomarse con reserva.' : 'Esta predicción se basa en patrones históricos típicos del clima mediterráneo continentalizado de Benavente.'}`,
          `Nuestra predicción meteorológica para Benavente indica que la presión atmosférica tendrá una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los próximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicción en unos días para mayor precisión.' : 'puedes planificar tus actividades con confianza.'}`
        ],
        lluvia: [
          `Basado en los datos históricos de Benavente, la predicción para los próximos ${period} indica que ${Math.random() > 0.5 ? 'habrá lluvia' : 'no habrá lluvia'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicción tiene una confiabilidad baja, así que tómala con precaución.' : 'Esta predicción es bastante confiable para planificar actividades en Benavente.'}`,
          `Según nuestro análisis de los datos meteorológicos de Benavente, esperamos que ${Math.random() > 0.5 ? 'llueva' : 'no llueva'} en los próximos ${period}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones climáticos inusuales, esta predicción debe tomarse con reserva.' : 'Esta predicción se basa en patrones históricos típicos del clima mediterráneo continentalizado de Benavente.'}`,
          `Nuestra predicción meteorológica para Benavente indica que ${Math.random() > 0.5 ? 'habrá precipitaciones' : 'no habrá precipitaciones'} en los próximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicción en unos días para mayor precisión.' : 'puedes planificar tus actividades con confianza.'}`
        ],
        viento: [
          `Basado en los datos históricos de Benavente, la predicción para los próximos ${period} indica que el viento seguirá una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicción tiene una confiabilidad baja, así que tómala con precaución.' : 'Esta predicción es bastante confiable para planificar actividades en Benavente.'}`,
          `Según nuestro análisis de los datos meteorológicos de Benavente, esperamos que la velocidad del viento ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los próximos ${period}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones climáticos inusuales, esta predicción debe tomarse con reserva.' : 'Esta predicción se basa en patrones históricos típicos del clima mediterráneo continentalizado de Benavente.'}`,
          `Nuestra predicción meteorológica para Benavente indica que el viento tendrá una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los próximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicción en unos días para mayor precisión.' : 'puedes planificar tus actividades con confianza.'}`
        ]
      };
      
      // Si hay evento relevante, añadir variaciones específicas
      if (relevantEvent) {
        const eventVariations = {
          temperatura: [
            `Con el ${relevantEvent} acercándose, nuestra predicción para los próximos ${period} indica que la temperatura seguirá una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%.`,
            `Para el ${relevantEvent}, esperamos que la temperatura ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los próximos ${period}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%.`
          ],
          humedad: [
            `Con el ${relevantEvent} acercándose, nuestra predicción para los próximos ${period} indica que la humedad seguirá una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%.`,
            `Para el ${relevantEvent}, esperamos que la humedad ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los próximos ${period}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%.`
          ],
          // Variaciones similares para otros parámetros
          presión: [
            `Con el ${relevantEvent} acercándose, nuestra predicción para los próximos ${period} indica que la presión atmosférica seguirá una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%.`
          ],
          lluvia: [
            `Con el ${relevantEvent} acercándose, nuestra predicción para los próximos ${period} indica que ${Math.random() > 0.5 ? 'habrá lluvia' : 'no habrá lluvia'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%.`
          ],
          viento: [
            `Con el ${relevantEvent} acercándose, nuestra predicción para los próximos ${period} indica que el viento seguirá una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicción es del ${(reliability * 100).toFixed(0)}%.`
          ]
        };
        
        // Combinar variaciones normales con variaciones de evento
        return [...variations[parameter], ...eventVariations[parameter]];
      }
      
      return variations[parameter] || variations.temperatura;
    },
    
    // Variaciones para comparaciones
    getComparisonVariations: (parameter, avg1, avg2, period1, period2, changePercent) => {
      const now = new Date();
      const month = now.getMonth();
      
      // Determinar si es relevante para la época del año
      const isSeasonRelevant = (month === 6 && parameter === 'temperatura') || // Verano
                              (month === 1 && parameter === 'temperatura') || // Invierno
                              (month === 3 && parameter === 'lluvia'); // Primavera
      
      // Determinar si es un cambio significativo
      const isSignificantChange = Math.abs(changePercent) > 10;
      
      // Determinar si es un cambio inusual
      const isUnusualChange = (parameter === 'temperatura' && Math.abs(changePercent) > 15) ||
                             (parameter === 'humedad' && Math.abs(changePercent) > 20) ||
                             (parameter === 'presión' && Math.abs(changePercent) > 5);
      
      // Variaciones según el parámetro
      const variations = {
        temperatura: [
          `Al comparar ${period1} con ${period2} en Benavente, la temperatura ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterráneo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(1)}°C, mientras que en ${period2} fue de ${avg2.toFixed(1)}°C.`,
          `La comparación entre ${period1} y ${period2} muestra que la temperatura en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es típico de las variaciones climáticas estacionales.'} Los promedios fueron de ${avg1.toFixed(1)}°C y ${avg2.toFixed(1)}°C respectivamente.`,
          `Según nuestro análisis comparativo, la temperatura en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(1)}°C y ${avg2.toFixed(1)}°C.`
        ],
        humedad: [
          `Al comparar ${period1} con ${period2} en Benavente, la humedad ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterráneo continentalizado de Benavente.`} El promedio en ${period1} fue del ${avg1.toFixed(0)}%, mientras que en ${period2} fue del ${avg2.toFixed(0)}%.`,
          `La comparación entre ${period1} y ${period2} muestra que la humedad en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es típico de las variaciones climáticas estacionales.'} Los promedios fueron del ${avg1.toFixed(0)}% y del ${avg2.toFixed(0)}% respectivamente.`,
          `Según nuestro análisis comparativo, la humedad en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} Los valores promedio fueron del ${avg1.toFixed(0)}% y del ${avg2.toFixed(0)}%.`
        ],
        presión: [
          `Al comparar ${period1} con ${period2} en Benavente, la presión atmosférica ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterráneo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(0)} hPa, mientras que en ${period2} fue de ${avg2.toFixed(0)} hPa.`,
          `La comparación entre ${period1} y ${period2} muestra que la presión atmosférica en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es típico de las variaciones climáticas estacionales.'} Los promedios fueron de ${avg1.toFixed(0)} hPa y ${avg2.toFixed(0)} hPa respectivamente.`,
          `Según nuestro análisis comparativo, la presión atmosférica en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(0)} hPa y ${avg2.toFixed(0)} hPa.`
        ],
        lluvia: [
          `Al comparar ${period1} con ${period2} en Benavente, la precipitación ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterráneo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(1)} mm, mientras que en ${period2} fue de ${avg2.toFixed(1)} mm.`,
          `La comparación entre ${period1} y ${period2} muestra que la precipitación en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es típico de las variaciones climáticas estacionales.'} Los promedios fueron de ${avg1.toFixed(1)} mm y ${avg2.toFixed(1)} mm respectivamente.`,
          `Según nuestro análisis comparativo, la precipitación en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(1)} mm y ${avg2.toFixed(1)} mm.`
        ],
        viento: [
          `Al comparar ${period1} con ${period2} en Benavente, la velocidad del viento ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterráneo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(1)} m/s, mientras que en ${period2} fue de ${avg2.toFixed(1)} m/s.`,
          `La comparación entre ${period1} y ${period2} muestra que la velocidad del viento en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es típico de las variaciones climáticas estacionales.'} Los promedios fueron de ${avg1.toFixed(1)} m/s y ${avg2.toFixed(1)} m/s respectivamente.`,
          `Según nuestro análisis comparativo, la velocidad del viento en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón merece atención para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(1)} m/s y ${avg2.toFixed(1)} m/s.`
        ]
      };
      
      return variations[parameter] || variations.temperatura;
    },
    
    // Variaciones para correlaciones
    getCorrelationVariations: (parameter1, parameter2, correlation, rSquared) => {
      const now = new Date();
      const month = now.getMonth();
      
      // Determinar la fuerza de la correlación
      const correlationStrength = Math.abs(correlation);
      let strengthDescription;
      if (correlationStrength > 0.7) {
        strengthDescription = 'muy fuerte';
      } else if (correlationStrength > 0.5) {
        strengthDescription = 'fuerte';
      } else if (correlationStrength > 0.3) {
        strengthDescription = 'moderada';
      } else if (correlationStrength > 0.1) {
        strengthDescription = 'débil';
      } else {
        strengthDescription = 'muy débil';
      }
      
      // Determinar si es relevante para la época del año
      const isSeasonRelevant = (month === 6 && (parameter1 === 'temperatura' || parameter2 === 'temperatura')) || // Verano
                              (month === 1 && (parameter1 === 'temperatura' || parameter2 === 'temperatura')); // Invierno
      
      // Determinar si es una correlación inusual
      const isUnusualCorrelation = (parameter1 === 'temperatura' && parameter2 === 'humedad' && correlation < -0.6) ||
                                  (parameter1 === 'presión' && parameter2 === 'lluvia' && correlation < -0.4);
      
      // Variaciones según los parámetros
      const variations = {
        'temperatura-humedad': [
          `He analizado la relación entre la temperatura y la humedad en Benavente y encontré una correlación ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la temperatura ${correlation > 0 ? 'aumenta' : 'disminuye'}, la humedad tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la humedad puede explicarse por cambios en la temperatura. ${isUnusualCorrelation ? 'Esta correlación es típica del clima mediterráneo continentalizado de Benavente.' : 'Este patrón es inusual para nuestra zona.'}`,
          `Nuestro análisis de correlación entre temperatura y humedad en Benavente muestra una relación ${strengthDescription} (${correlation.toFixed(2)}). ${correlation > 0 ? 'Cuando hace más calor, el aire puede contener más humedad.' : 'Cuando hace más calor, la humedad relativa disminuye aunque la cantidad de vapor de agua permanezca constante.'} El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la humedad está relacionada con la temperatura. ${isUnusualCorrelation ? 'Este patrón es esperado para el clima de Benavente.' : 'Este patrón merece atención para actividades al aire libre.'}`,
          `La correlación entre temperatura y humedad en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). Esto es ${correlation > 0 ? 'poco común' : 'común'} en climas mediterráneos. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la humedad puede atribuirse a cambios en la temperatura. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón es interesante para entender el clima local.'}`
        ],
        'presión-lluvia': [
          `He analizado la relación entre la presión atmosférica y la lluvia en Benavente y encontré una correlación ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la presión ${correlation > 0 ? 'aumenta' : 'disminuye'}, la probabilidad de lluvia tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la lluvia puede explicarse por cambios en la presión. ${isUnusualCorrelation ? 'Esta correlación es típica del clima mediterráneo continentalizado de Benavente.' : 'Este patrón es inusual para nuestra zona.'}`,
          `Nuestro análisis de correlación entre presión atmosférica y lluvia en Benavente muestra una relación ${strengthDescription} (${correlation.toFixed(2)}). ${correlation < 0 ? 'Las bajas presiones suelen indicar sistemas de mal tiempo.' : 'Las altas presiones suelen indicar buen tiempo.'} El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la lluvia está relacionada con la presión. ${isUnusualCorrelation ? 'Este patrón es esperado para el clima de Benavente.' : 'Este patrón merece atención para actividades al aire libre.'}`,
          `La correlación entre presión atmosférica y lluvia en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). Esto es ${correlation < 0 ? 'común' : 'poco común'} en climas mediterráneos. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la lluvia puede atribuirse a cambios en la presión. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón es interesante para entender el clima local.'}`
        ],
        'temperatura-presión': [
          `He analizado la relación entre la temperatura y la presión atmosférica en Benavente y encontré una correlación ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la temperatura ${correlation > 0 ? 'aumenta' : 'disminuye'}, la presión tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la presión puede explicarse por cambios en la temperatura. ${isUnusualCorrelation ? 'Esta correlación es típica del clima mediterráneo continentalizado de Benavente.' : 'Este patrón es inusual para nuestra zona.'}`,
          `Nuestro análisis de correlación entre temperatura y presión atmosférica en Benavente muestra una relación ${strengthDescription} (${correlation.toFixed(2)}). En la llanura del Duero, estas variables suelen tener una relación compleja. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la presión está relacionada con la temperatura. ${isUnusualCorrelation ? 'Este patrón es esperado para el clima de Benavente.' : 'Este patrón merece atención para actividades al aire libre.'}`,
          `La correlación entre temperatura y presión atmosférica en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). Esto es ${correlation > 0 ? 'poco común' : 'común'} en zonas de altitud media como Benavente (${benaventeInfo.altitude}). El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la presión puede atribuirse a cambios en la temperatura. ${isSeasonRelevant ? 'Este patrón es esperado para esta época del año.' : 'Este patrón es interesante para entender el clima local.'}`
        ]
      };
      
      // Crear clave para la combinación de parámetros
      const key = `${parameter1}-${parameter2}`;
      const reverseKey = `${parameter2}-${parameter1}`;
      
      // Intentar obtener variaciones para la combinación específica
      if (variations[key]) {
        return variations[key];
      } else if (variations[reverseKey]) {
        // Si la combinación está en orden inverso, ajustar el texto
        return variations[reverseKey].map(variation => 
          variation.replace(/temperatura y la humedad/g, `${parameter2} y la ${parameter1}`)
                  .replace(/temperatura y humedad/g, `${parameter2} y ${parameter1}`)
                  .replace(/temperatura con la humedad/g, `${parameter2} con la ${parameter1}`)
                  .replace(/temperatura la humedad/g, `${parameter2} la ${parameter1}`)
                  .replace(/la temperatura y la humedad/g, `la ${parameter2} y la ${parameter1}`)
        );
      }
      
      // Si no hay combinación específica, usar una variación genérica
      return [
        `He analizado la relación entre ${parameter1} y ${parameter2} en Benavente y encontré una correlación ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la ${parameter1} ${correlation > 0 ? 'aumenta' : 'disminuye'}, la ${parameter2} tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la ${parameter2} puede explicarse por cambios en la ${parameter1}.`,
        `Nuestro análisis de correlación entre ${parameter1} y ${parameter2} en Benavente muestra una relación ${strengthDescription} (${correlation.toFixed(2)}). El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la ${parameter2} está relacionada con la ${parameter1}.`,
        `La correlación entre ${parameter1} y ${parameter2} en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). El ${Math.abs(rSquared * 100).toFixed(1)}% de la variación en la ${parameter2} puede atribuirse a cambios en la ${parameter1}.`
      ];
    },
    
    // Variaciones para ayuda
    getHelpVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si hay un evento local relevante
      const relevantEvent = benaventeInfo.localEvents.find(event => {
        // Aquí iría la lógica para detectar eventos relevantes para el clima
        return Math.random() > 0.7; // Simulación aleatoria
      });
      
      const variations = [
        `¡Claro que sí! ${localPhrase} Soy Horus AI, tu asistente meteorológico para Benavente. Aquí tienes algunas preguntas que puedo ayudarte a resolver:`,
        `Por supuesto. ${localPhrase} Como asistente meteorológico especializado en Benavente, puedo ayudarte con:`,
        `¡Con gusto! ${localPhrase} Como experto en el clima de Benavente, puedo ayudarte con:`
      ];
      
      if (relevantEvent) {
        variations.push(
          `¡Claro que sí! Con el ${relevantEvent} acercándose, es importante estar informado. ${localPhrase} Como asistente meteorológico para Benavente, puedo ayudarte con:`
        );
      }
      
      return variations;
    },
    
    // Variaciones para información sobre Horus
    getAboutHorusVariations: () => {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si es relevante para la época del año
      const isSeasonRelevant = (month === 6) || // Verano
                              (month === 1); // Invierno
      
      const variations = [
        `Horus es una estación meteorológica avanzada instalada en Benavente, diseñada para monitorear las condiciones climáticas de nuestra querida ciudad. ${localPhrase} Nuestro sistema recoge datos en tiempo real sobre temperatura, humedad, presión y otros parámetros para ayudarte a entender mejor el clima de la llanura del Duero.`,
        `Soy Horus, un sistema meteorológico localizado en Benavente que proporciona datos precisos sobre el clima de nuestra zona. ${localPhrase} Nuestro sistema está especialmente calibrado para el clima mediterráneo continentalizado de Benavente, a ${benaventeInfo.altitude}.`,
        `El sistema Horus en Benavente es una estación meteorológica de última generación que monitorea constantemente el clima de nuestra ciudad. ${localPhrase} Desde la Plaza Mayor hasta el Río Esla, nuestros sensores recogen datos que nos permiten ofrecerte información meteorológica precisa y relevante para tu día a día.`
      ];
      
      if (isSeasonRelevant) {
        variations.push(
          `En esta época del año, el sistema Horus en Benavente es especialmente útil para monitorear ${month === 6 ? 'las altas temperaturas del verano' : 'las bajas temperaturas del invierno'}. ${localPhrase} Nuestros datos ayudan a los vecinos de Benavente a prepararse para las condiciones climáticas típicas de esta estación.`
        );
      }
      
      return variations;
    },
    
    // Variaciones para soporte técnico
    getSupportVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      const variations = [
        `Lamento que estés teniendo problemas. ${localPhrase} Como asistente meteorológico para Benavente, haré lo posible por ayudarte. Aquí hay algunas soluciones que suelen funcionar:`,
        `Vaya, parece que hay un problema. ${localPhrase} No te preocupes, como experto en el sistema Horus de Benavente, puedo ayudarte a resolverlo. Prueba estos pasos:`,
        `¡Vaya fresquete! Veo que estás teniendo problemas. ${localPhrase} Como asistente meteorológico para Benavente, te recomiendo:`
      ];
      
      return variations;
    },
    
    // Variaciones para información personal
    getPersonalInfoVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      const variations = [
        `Soy Horus AI, un asistente inteligente especializado en el clima de Benavente. ${localPhrase} Fui creado para ayudar a los vecinos y visitantes de Benavente a entender mejor el clima de nuestra ciudad, ubicada en la llanura del Duero a ${benaventeInfo.altitude}.`,
        `¡Hola! Soy Horus AI, tu asistente meteorológico para Benavente. ${localPhrase} Mi propósito es proporcionar información precisa y útil sobre el clima de Benavente, con su clima mediterráneo continentalizado y sus características únicas.`,
        `Soy Horus AI, un sistema de inteligencia artificial especializado en meteorología para Benavente. ${localPhrase} Aunque no soy humano, tengo un profundo conocimiento del clima de Benavente y estoy aquí para ayudarte a entenderlo mejor.`
      ];
      
      return variations;
    },
    
    // Variaciones para información general
    getGeneralInfoVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si es relevante para la época del año
      const isSummer = month >= 5 && month <= 8;
      const isWinter = month >= 11 || month <= 2;
      
      const variations = [
        `Benavente, ubicada a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterráneo continentalizado. ${localPhrase} ${isSummer ? 'En verano, las temperaturas pueden superar los 35°C.' : isWinter ? 'En invierno, las temperaturas pueden bajar de 0°C.' : 'En esta época del año, el clima es moderado con días agradables.'}`,
        `Nuestra querida Benavente se encuentra a ${benaventeInfo.altitude} sobre el nivel del mar, con coordenadas ${benaventeInfo.coordinates}. ${localPhrase} El clima de Benavente es mediterráneo continentalizado, caracterizado por veranos calurosos e inviernos fríos.`,
        `Benavente, en la provincia de Zamora, disfruta de un clima mediterráneo continentalizado gracias a su ubicación en la llanura del Duero a ${benaventeInfo.altitude}. ${localPhrase} Las temperaturas varían desde -5°C en invierno hasta más de 35°C en verano.`
      ];
      
      return variations;
    },
    
    // Variaciones para preguntas fuera del ámbito
    getOutOfScopeVariations: (domain) => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      const variations = {
        salud: [
          `Soy un asistente meteorológico especializado para Benavente, no tengo información médica. ${localPhrase} Para consultas sobre salud, te recomiendo contactar a un profesional médico calificado en Benavente.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorológico para Benavente, mi conocimiento se limita al clima y las condiciones atmosféricas. Para información médica, consulta a un profesional de salud.`,
          `¡Vaya! Veo que necesitas información médica. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero sí puedo decirte cómo el clima afecta ciertas condiciones de salud.`
        ],
        tecnología: [
          `Soy un asistente meteorológico especializado para Benavente. ${localPhrase} Para consultas sobre tecnología, te recomiendo buscar en foros especializados o consultar documentación oficial de los productos.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorológico para Benavente, mi conocimiento se limita al clima y las condiciones atmosféricas. Para información tecnológica, consulta fuentes especializadas.`,
          `¡Vaya fresquete! Veo que necesitas ayuda tecnológica. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero sí puedo decirte cómo el clima afecta a algunos dispositivos electrónicos.`
        ],
        deportes: [
          `Soy un asistente meteorológico especializado para Benavente. ${localPhrase} Para información sobre deportes, te recomiendo visitar el Ayuntamiento de Benavente o seguir el Club Deportivo local.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorológico para Benavente, mi conocimiento se limita al clima y las condiciones atmosféricas. Pero puedo decirte cómo el clima afecta a las actividades deportivas al aire libre.`,
          `¡Vaya! Veo que necesitas información deportiva. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero sí puedo decirte cómo el clima afecta a las actividades deportivas en nuestra zona.`
        ],
        entretenimiento: [
          `Soy un asistente meteorológico especializado para Benavente. ${localPhrase} Para información sobre entretenimiento, te recomiendo visitar la página web del Ayuntamiento de Benavente o seguir eventos en la Plaza Mayor.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorológico para Benavente, mi conocimiento se limita al clima y las condiciones atmosféricas. Pero puedo decirte cómo el clima afecta a los eventos al aire libre.`,
          `¡Vaya fresquete! Veo que necesitas información de entretenimiento. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero sí puedo decirte cómo el clima afecta a los eventos en nuestra zona.`
        ],
        comida: [
          `Soy un asistente meteorológico especializado para Benavente. ${localPhrase} Para recetas o información sobre comida, te recomiendo consultar sitios web especializados en gastronomía zamorana.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorológico para Benavente, mi conocimiento se limita al clima y las condiciones atmosféricas. Pero puedo decirte cómo el clima afecta a los productos locales de temporada.`,
          `¡Vaya! Veo que necesitas información culinaria. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero sí puedo decirte cómo el clima afecta a los productos locales que se usan en la cocina tradicional.`
        ],
        educación: [
          `Soy un asistente meteorológico especializado para Benavente. ${localPhrase} Para información educativa, te recomiendo consultar la página web del Ayuntamiento de Benavente o contactar al IES local.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorológico para Benavente, mi conocimiento se limita al clima y las condiciones atmosféricas. Pero puedo proporcionar información sobre meteorología y ciencias atmosféricas.`,
          `¡Vaya fresquete! Veo que necesitas información educativa. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero sí puedo compartir contigo conocimientos sobre meteorología y clima local.`
        ],
        finanzas: [
          `Soy un asistente meteorológico especializado para Benavente. ${localPhrase} Para consultas financieras, te recomiendo consultar a un asesor financiero en Benavente.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorológico para Benavente, mi conocimiento se limita al clima y las condiciones atmosféricas. Pero puedo decirte cómo el clima afecta a ciertos sectores económicos locales.`,
          `¡Vaya! Veo que necesitas información financiera. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero sí puedo decirte cómo el clima afecta a actividades económicas como la agricultura en nuestra zona.`
        ],
        general: [
          `Soy un asistente meteorológico especializado para Benavente. ${localPhrase} Mi conocimiento está limitado a monitorear y analizar datos meteorológicos en Benavente, el funcionamiento del sistema Horus y análisis de tendencias climáticas de la zona.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorológico para Benavente, mi conocimiento se limita al clima y las condiciones atmosféricas de nuestra zona.`,
          `¡Vaya fresquete! Veo que necesitas información fuera de mi ámbito. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero sí puedo compartir contigo información relevante sobre el clima de nuestra querida ciudad.`
        ]
      };
      
      return variations[domain] || variations.general;
    },
    
    // Variaciones para preguntas no entendidas
    getUnrelatedVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      return [
        `Lamento no entender tu pregunta. ${localPhrase} Soy un asistente meteorológico especializado en Benavente. ¿Podrías reformular tu pregunta para que esté relacionada con el clima de Benavente?`,
        `¡Vaya fresquete! No estoy seguro de entender lo que me pides. ${localPhrase} Como asistente meteorológico para Benavente, ¿podrías preguntar algo relacionado con el clima de nuestra ciudad?`,
        `Perdón, no he captado bien tu pregunta. ${localPhrase} Como experto en el clima de Benavente, necesito que tu pregunta esté relacionada con meteorología o el sistema Horus.`
      ];
    }
  };

  // Función para obtener una variación aleatoria
  const getRandomVariation = (variationsArray) => {
    if (!variationsArray || variationsArray.length === 0) {
      return "No se encontraron variaciones para esta consulta.";
    }
    
    const randomIndex = Math.floor(Math.random() * variationsArray.length);
    return variationsArray[randomIndex];
  };

  // Enviar mensaje
  const sendMessage = async () => {
    const message = userInput.value.trim();
    if (message === '' || !chatbotReady) return;
    
    // Procesar mensaje
    const response = await processUserMessage(message);
    
    // Muestra la respuesta
    if (response) {
      addMessage(response, false, openAIApi.isConfigured() ? 'openai' : 'local');
    }
  };

  // Renderizar gráficos - CORREGIDO
  const renderChart = (parameter, chartData, chartId) => {
    const chartCtx = document.getElementById(chartId)?.getContext('2d');
    if (!chartCtx) return;
    
    // Determina el nombre del parámetro y colores
    let paramName = '';
    let color = '#4a90e2';
    let unit = '';
    
    switch (parameter) {
      case 'temperatura':
        paramName = 'Temperatura';
        color = '#FF6384';
        unit = '°C';
        break;
      case 'humedad':
        paramName = 'Humedad';
        color = '#36A2EB';
        unit = '%';
        break;
      case 'presión':
        paramName = 'Presión Atmosférica';
        color = '#FFCE56';
        unit = 'hPa';
        break;
      case 'lluvia':
        paramName = 'Precipitación';
        color = '#46BFBD';
        unit = 'Presencia';
        break;
      case 'viento':
        paramName = 'Viento';
        color = '#C9CBCF';
        unit = 'm/s';
        break;
      case 'gas':
        paramName = 'Nivel de Gas';
        color = '#FDB45C';
        unit = 'kΩ';
        break;
      case 'dirección':
        paramName = 'Dirección del Viento';
        color = '#9966FF';
        unit = '°';
        break;
      default:
        paramName = 'Medición';
        unit = '';
    }
    
    // Crea el nuevo gráfico - CORREGIDO: estructura correcta de data
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        datasets: [{
          label: paramName,
          data: chartData,
          borderColor: color,
          backgroundColor: `${color}40`,
          borderWidth: 3,
          tension: 0.3,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day'
            },
            title: {
              display: true,
              text: 'Fecha'
            }
          },
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: unit
            }
          }
        }
      }
    });
    
    // Almacenar instancia del gráfico para actualizarla al cambiar de tema
    charts.push(chart);
  };
  
  // Renderizar gráficos de comparación - CORREGIDO
  const renderComparisonChart = (parameter, chartData1, chartData2, period1, period2, chartId) => {
    const chartCtx = document.getElementById(chartId)?.getContext('2d');
    if (!chartCtx) return;
    
    // Determina el nombre del parámetro y colores
    let paramName = '';
    let color1 = '#FF6384';
    let color2 = '#36A2EB';
    let unit = '';
    
    switch (parameter) {
      case 'temperatura':
        paramName = 'Temperatura';
        unit = '°C';
        break;
      case 'humedad':
        paramName = 'Humedad';
        unit = '%';
        break;
      case 'presión':
        paramName = 'Presión Atmosférica';
        unit = 'hPa';
        break;
      case 'lluvia':
        paramName = 'Precipitación';
        unit = 'Presencia';
        break;
      case 'viento':
        paramName = 'Viento';
        unit = 'm/s';
        break;
      case 'gas':
        paramName = 'Nivel de Gas';
        unit = 'kΩ';
        break;
      case 'dirección':
        paramName = 'Dirección del Viento';
        unit = '°';
        break;
      default:
        paramName = 'Medición';
        unit = '';
    }
    
    // Crea el nuevo gráfico - CORREGIDO: estructura correcta de data
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: period1,
             chartData1,
            borderColor: color1,
            backgroundColor: `${color1}40`,
            borderWidth: 3,
            tension: 0.3,
            pointRadius: 3
          },
          {
            label: period2,
            data: chartData2,
            borderColor: color2,
            backgroundColor: `${color2}40`,
            borderWidth: 3,
            tension: 0.3,
            pointRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day'
            },
            title: {
              display: true,
              text: 'Fecha'
            }
          },
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: unit
            }
          }
        }
      }
    });
    
    // Almacenar instancia del gráfico para actualizarla al cambiar de tema
    charts.push(chart);
  };

  // Renderizar gráficos de extremos - CORREGIDO
  const renderExtremesChart = (parameter, chartData, maxDate, minDate, chartId) => {
    const chartCtx = document.getElementById(chartId)?.getContext('2d');
    if (!chartCtx) return;
    
    // Determina el nombre del parámetro y colores
    let paramName = '';
    let color = '#4a90e2';
    let unit = '';
    
    switch (parameter) {
      case 'temperatura':
        paramName = 'Temperatura';
        color = '#FF6384';
        unit = '°C';
        break;
      case 'humedad':
        paramName = 'Humedad';
        color = '#36A2EB';
        unit = '%';
        break;
      case 'presión':
        paramName = 'Presión Atmosférica';
        color = '#FFCE56';
        unit = 'hPa';
        break;
      case 'lluvia':
        paramName = 'Precipitación';
        color = '#46BFBD';
        unit = 'Presencia';
        break;
      case 'viento':
        paramName = 'Viento';
        color = '#C9CBCF';
        unit = 'm/s';
        break;
      case 'gas':
        paramName = 'Nivel de Gas';
        color = '#FDB45C';
        unit = 'kΩ';
        break;
      case 'dirección':
        paramName = 'Dirección del Viento';
        color = '#9966FF';
        unit = '°';
        break;
      default:
        paramName = 'Medición';
        unit = '';
    }
    
    // Preparar datos con marcadores para máximos y mínimos
    const dataWithMarkers = chartData.map(item => ({
      x: item.x,
      y: item.y,
      pointBackgroundColor: item.x.toISOString() === maxDate || item.x.toISOString() === minDate ? 
                            (item.x.toISOString() === maxDate ? '#FF0000' : '#0000FF') : 
                            color
    }));
    
    // Crea el nuevo gráfico - CORREGIDO: estructura correcta de data
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        datasets: [{
          label: paramName,
           dataWithMarkers,
          borderColor: color,
          backgroundColor: `${color}40`,
          borderWidth: 3,
          tension: 0.3,
          pointRadius: function(context) {
            const index = context.dataIndex;
            const value = context.dataset.data[index];
            return value.pointBackgroundColor !== color ? 6 : 3;
          },
          pointBackgroundColor: function(context) {
            const index = context.dataIndex;
            const value = context.dataset.data[index];
            return value.pointBackgroundColor;
          }
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day'
            },
            title: {
              display: true,
              text: 'Fecha'
            }
          },
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: unit
            }
          }
        }
      }
    });
    
    // Almacenar instancia del gráfico para actualizarla al cambiar de tema
    charts.push(chart);
  };

  // Renderizar gráficos de correlación - CORREGIDO
  const renderCorrelationChart = (parameter1, parameter2, chartData, chartId) => {
    const chartCtx = document.getElementById(chartId)?.getContext('2d');
    if (!chartCtx) return;
    
    // Determina los nombres de los parámetros y colores
    let paramName1 = '';
    let paramName2 = '';
    let color1 = '#FF6384';
    let color2 = '#36A2EB';
    let unit1 = '';
    let unit2 = '';
    
    const getParameterInfo = (parameter) => {
      switch (parameter) {
        case 'temperatura':
          return { name: 'Temperatura', color: '#FF6384', unit: '°C' };
        case 'humedad':
          return { name: 'Humedad', color: '#36A2EB', unit: '%' };
        case 'presión':
          return { name: 'Presión Atmosférica', color: '#FFCE56', unit: 'hPa' };
        case 'lluvia':
          return { name: 'Precipitación', color: '#46BFBD', unit: 'Presencia' };
        case 'viento':
          return { name: 'Viento', color: '#C9CBCF', unit: 'm/s' };
        case 'gas':
          return { name: 'Nivel de Gas', color: '#FDB45C', unit: 'kΩ' };
        case 'dirección':
          return { name: 'Dirección del Viento', color: '#9966FF', unit: '°' };
        default:
          return { name: 'Medición', color: '#4a90e2', unit: '' };
      }
    };
    
    const info1 = getParameterInfo(parameter1);
    const info2 = getParameterInfo(parameter2);
    
    paramName1 = info1.name;
    color1 = info1.color;
    unit1 = info1.unit;
    
    paramName2 = info2.name;
    color2 = info2.color;
    unit2 = info2.unit;
    
    // Crea el nuevo gráfico - CORREGIDO: estructura correcta de data
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: paramName1,
            data: chartData.map(item => ({ x: item.x, y: item.y1 })),
            borderColor: color1,
            backgroundColor: `${color1}40`,
            borderWidth: 3,
            tension: 0.3,
            pointRadius: 3
          },
          {
            label: paramName2,
             chartData.map(item => ({ x: item.x, y: item.y2 })),
            borderColor: color2,
            backgroundColor: `${color2}40`,
            borderWidth: 3,
            tension: 0.3,
            pointRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day'
            },
            title: {
              display: true,
              text: 'Fecha'
            }
          },
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: `${unit1} / ${unit2}`
            }
          }
        }
      }
    });
    
    // Almacenar instancia del gráfico para actualizarla al cambiar de tema
    charts.push(chart);
  };

  // Configurar API de OpenAI
  const toggleApiConfig = () => {
    apiConfig.style.display = apiConfig.style.display === 'none' ? 'block' : 'none';
  };

  // Verificar estado de la API
  const checkApiKeyStatus = async () => {
    if (openAIApi.isConfigured()) {
      const isValid = await openAIApi.verifyApiKey();
      if (isValid) {
        apiStatus.textContent = 'Estado: API configurada y válida';
        apiStatus.className = 'api-status connected';
        updateStatus("OpenAI API configurada correctamente - Usando IA avanzada");
      } else {
        apiStatus.textContent = 'Estado: API configurada pero inválida';
        apiStatus.className = 'api-status disconnected';
        updateStatus("Error con la API de OpenAI - Usando sistema local", true);
      }
    } else {
      apiStatus.textContent = 'Estado: No configurado';
      apiStatus.className = 'api-status disconnected';
      updateStatus("API de IA no configurada - Usando sistema local");
    }
  };

  // Guardar API key
  saveApiKeyBtn.addEventListener('click', () => {
    const apiKey = apiKeyInput.value.trim();
    if (apiKey) {
      openAIApi.configure(apiKey);
      checkApiKeyStatus();
      apiKeyInput.value = '';
      setTimeout(async () => {
        const isValid = await openAIApi.verifyApiKey();
        if (isValid) {
          addMessage("✅ API de OpenAI configurada correctamente. ¡Ahora podrás obtener respuestas más avanzadas!", false, 'local');
        } else {
          addMessage("⚠️ La API key parece ser inválida. Por favor, verifica que la clave sea correcta.", false, 'local');
        }
      }, 300);
    }
  });

  // Configurar botón de configuración de API
  if (apiConfigToggle) {
    apiConfigToggle.addEventListener('click', toggleApiConfig);
  }

  // Inicializar estado de la API
  checkApiKeyStatus();

  // Inicializar chatbot
  const initChatbot = async () => {
    try {
      // Inicializar OpenAI API
      const apiKeyConfigured = openAIApi.init();
      
      // Configurar tema
      const themeSwitch = document.querySelector('.theme-switch__checkbox');
      if (themeSwitch) {
        // Verificar tema actual
        const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
        themeSwitch.checked = currentTheme === 'dark';
        
        // Manejar el cambio de tema
        themeSwitch.addEventListener('change', function() {
          if (this.checked) {
            document.body.classList.remove('light-mode');
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
          } else {
            document.body.classList.remove('dark-mode');
            document.body.classList.add('light-mode');
            localStorage.setItem('theme', 'light');
          }
          
          // Actualizar gráficos para reflejar el nuevo tema
          if (typeof window.updateChatbotCharts === 'function') {
            window.updateChatbotCharts();
          }
        });
      }
      
      // Cargar tema guardado
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.body.classList.remove('light-mode');
        document.body.classList.add('dark-mode');
        if (themeSwitch) themeSwitch.checked = true;
      } else {
        document.body.classList.remove('dark-mode');
        document.body.classList.add('light-mode');
        if (themeSwitch) themeSwitch.checked = false;
      }
      
      // Hacer disponible para main.js
      window.updateChatbotCharts = () => {
        // Destruir y recrear los gráficos para actualizar colores
        charts.forEach(chart => {
          if (chart && chart.destroy) {
            chart.destroy();
          }
        });
        charts = [];
        
        // Volver a renderizar todos los gráficos
        setTimeout(() => {
          document.querySelectorAll('.prediction-chart').forEach(canvas => {
            const parameter = canvas.dataset.parameter;
            const chartData = JSON.parse(canvas.dataset.chartData);
            renderChart(parameter, chartData, canvas.id);
          });
          
          document.querySelectorAll('.comparison-chart').forEach(canvas => {
            const parameter = canvas.dataset.parameter;
            const chartData1 = JSON.parse(canvas.dataset.chartData1);
            const chartData2 = JSON.parse(canvas.dataset.chartData2);
            const period1 = canvas.dataset.period1;
            const period2 = canvas.dataset.period2;
            renderComparisonChart(parameter, chartData1, chartData2, period1, period2, canvas.id);
          });
          
          document.querySelectorAll('.extremes-chart').forEach(canvas => {
            const parameter = canvas.dataset.parameter;
            const chartData = JSON.parse(canvas.dataset.chartData);
            const maxDate = canvas.dataset.maxDate;
            const minDate = canvas.dataset.minDate;
            renderExtremesChart(parameter, chartData, maxDate, minDate, canvas.id);
          });
          
          document.querySelectorAll('.correlation-chart').forEach(canvas => {
            const parameter1 = canvas.dataset.parameter1;
            const parameter2 = canvas.dataset.parameter2;
            const chartData = JSON.parse(canvas.dataset.chartData);
            renderCorrelationChart(parameter1, parameter2, chartData, canvas.id);
          });
        }, 100);
      };
      
      // Cargar datos históricos
      await loadHistoricalData();
      
      chatbotReady = true;
      
      // Configurar sugerencias
      document.querySelectorAll('.suggestion').forEach(suggestion => {
        suggestion.addEventListener('click', () => {
          userInput.value = suggestion.textContent;
          sendMessage();
        });
      });
      
      // Configurar el botón de enviar
      sendButton.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      
      // Mensaje de estado según si hay API key configurada
      if (apiKeyConfigured) {
        updateStatus("OpenAI API configurada correctamente - Usando IA avanzada");
      } else {
        updateStatus("API de IA no configurada - Usando sistema local");
      }
      
    } catch (error) {
      console.error('Error inicializando chatbot:', error);
      chatbotReady = true;
      updateStatus("Error al inicializar el chatbot", true);
    }
  };

  // Inicializar el chatbot
  initChatbot();
</script>
</body>
</html>
