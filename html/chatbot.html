<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horus AI - Chatbot Meteorol√≥gico</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #3498db;
            --dark-bg: #1a1a2e;
            --light-bg: #f5f5f5;
            --text-color: #e6e6e6;
            --light-text: #333;
            --card-bg: #16213e;
            --border-color: #4e4e6d;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
        }

        .light-mode {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --dark-bg: #ffffff;
            --light-bg: #f5f5f5;
            --text-color: #333;
            --light-text: #333;
            --card-bg: #ffffff;
            --border-color: #ddd;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --warning-color: #d35400;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .light-mode {
            background-color: var(--light-bg);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo-icon {
            font-size: 1.8rem;
        }

        nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-color);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .status-text {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .theme-switch__checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-switch__container {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .theme-switch__container:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .theme-switch__checkbox:checked + .theme-switch__container {
            background-color: var(--primary-color);
        }

        .theme-switch__checkbox:checked + .theme-switch__container:before {
            transform: translateX(26px);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .chat-header {
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .api-config-toggle {
            cursor: pointer;
            font-size: 1.2rem;
        }

        .api-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f44336;
            margin-left: 5px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 15px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.bot {
            align-self: flex-start;
            background: var(--card-bg);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .bot-avatar {
            position: absolute;
            left: -45px;
            top: 0;
            width: 35px;
            height: 35px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .message-content {
            line-height: 1.5;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .typing-indicator {
            display: flex;
            gap: 3px;
            margin: 5px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .loading-text {
            font-style: italic;
            color: var(--text-color);
            opacity: 0.7;
        }

        .source-badge {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .suggestions {
            display: flex;
            gap: 10px;
            padding: 0 15px 15px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .suggestions::-webkit-scrollbar {
            display: none;
        }

        .suggestion {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .suggestion:hover {
            background: var(--primary-color);
            color: white;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border-radius: 25px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        #user-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        #send-button {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        #send-button:hover {
            background: var(--secondary-color);
            transform: scale(1.05);
        }

        .api-config {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            max-height: 80vh;
            overflow-y: auto;
        }

        .api-config h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .api-config p {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .api-config input {
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            font-family: monospace;
        }

        .api-config button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: all 0.3s;
        }

        .api-config button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .api-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .api-status.connected {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .api-status.disconnected {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--error-color);
            color: var(--error-color);
        }

        .general-answer {
            background: rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .general-answer h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .general-answer ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        .general-answer li {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .benavente-context {
            background: rgba(74, 144, 226, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-style: italic;
            border-left: 3px solid var(--primary-color);
        }

        .system-info {
            margin-top: 15px;
        }

        .system-info h3 {
            color: var(--primary-color);
            margin: 15px 0 10px;
        }

        .system-info ul {
            padding-left: 20px;
            margin: 8px 0;
        }

        .system-info li {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .out-of-scope {
            background: rgba(243, 156, 18, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border-left: 3px solid var(--warning-color);
        }

        .out-of-scope h3 {
            color: var(--warning-color);
            margin: 10px 0 5px;
        }

        .prediction-container {
            margin-top: 15px;
        }

        .prediction-reliability {
            background: rgba(0, 0, 0, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .reliability-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .reliability-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .prediction-chart-container, .comparison-chart-container, .extremes-chart-container {
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 10px;
            height: 300px;
        }

        .chart-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
            margin-top: 5px;
        }

        .analysis-header {
            margin-bottom: 15px;
        }

        .analysis-header h2 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .summary-item {
            background: rgba(0, 0, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .message {
                max-width: 90%;
            }
            
            .chat-container {
                height: calc(100vh - 150px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <span class="logo-icon">üå§Ô∏è</span>
                <h1>Horus AI - Benavente</h1>
            </div>
            <nav>
                <a href="index.html" class="nav-btn"><span class="nav-icon">üì°</span> Datos en Vivo</a>
                <a href="analisis.html" class="nav-btn"><span class="nav-icon">üìä</span> An√°lisis</a>
                <a href="chatbot.html" class="nav-btn active"><span class="nav-icon">ü§ñ</span> Chatbot</a>
            </nav>
            <div class="nav-right">
                <div class="status-bar">
                    <div class="status-indicator" id="status-indicator"></div>
                    <div class="status-text" id="status-text">Cargando...</div>
                </div>
                <label class="theme-switch">
                    <input type="checkbox" class="theme-switch__checkbox">
                    <div class="theme-switch__container"></div>
                </label>
                <button id="api-config-toggle" class="nav-btn" title="Configuraci√≥n de API">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span id="api-status-indicator" class="api-status-indicator"></span>
                </button>
            </div>
        </header>

        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">
                    <span>ü§ñ Horus AI</span>
                    <span>Chat Meteorol√≥gico</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <!-- Los mensajes se generar√°n din√°micamente -->
            </div>
            
            <div class="suggestions">
                <div class="suggestion">¬øCu√°l es la temperatura actual en Benavente?</div>
                <div class="suggestion">Muestra la tendencia de humedad en la √∫ltima semana</div>
                <div class="suggestion">¬øC√≥mo se relaciona la temperatura con la humedad?</div>
                <div class="suggestion">¬øQu√© tiempo har√° ma√±ana en Benavente?</div>
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <input type="text" id="user-input" placeholder="Haz una pregunta detallada...">
                    <button id="send-button">‚û§</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de configuraci√≥n de API -->
    <div class="api-config" id="api-config">
        <h3>Configuraci√≥n de API de OpenAI</h3>
        <p>Configura tu clave API de OpenAI para obtener respuestas m√°s avanzadas y precisas.</p>
        <input type="password" id="api-key-input" placeholder="Ingresa tu clave API de OpenAI aqu√≠">
        <button id="save-api-key">Guardar API Key</button>
        <div class="api-status" id="api-status">Estado: No configurado</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Variables globales
        let historicalData = [];
        let chatbotReady = false;
        let charts = []; // Para almacenar instancias de gr√°ficos
        let apiConfigToggle, apiConfig, apiKeyInput, saveApiKeyBtn, apiStatus, apiStatusIndicator;

        // Contexto de conversaci√≥n mejorado
        let conversationContext = {
            lastParameter: null,
            lastPeriod: null,
            lastQuestionType: null,
            conversationHistory: [],
            entityContext: {},
            temporalContext: null,
            spatialContext: null,
            confidenceThreshold: 0.65 // Umbral de confianza para aceptar una intenci√≥n
        };

        // Informaci√≥n espec√≠fica de Benavente
        const benaventeInfo = {
            location: "Benavente, Zamora",
            coordinates: "41.7667¬∞ N, 5.3500¬∞ W",
            altitude: "719 metros sobre el nivel del mar",
            climate: "Clima mediterr√°neo continentalizado",
            typicalWeather: {
                summer: "Caluroso y seco, con temperaturas m√°ximas que pueden superar los 35¬∞C",
                winter: "Fr√≠o, con temperaturas m√≠nimas que pueden llegar a -5¬∞C",
                spring: "Moderado con lluvias ocasionales",
                autumn: "Fresco con d√≠as soleados y noches fr√≠as"
            },
            localFeatures: "Ubicado en la llanura del Duero, con influencia de la meseta castellana",
            localLandmarks: [
                "Plaza Mayor de Benavente",
                "Iglesia de Santiago",
                "Castillo de Benavente",
                "R√≠o Esla",
                "Mercado de Ganados"
            ],
            localEvents: [
                "Feria de San Mart√≠n (noviembre)",
                "Semana Santa",
                "Fiestas Patronales (agosto)",
                "Feria Agropecuaria (mayo)"
            ],
            localPhrases: [
                "¬°Vaya fresquete hace hoy!",
                "Esto parece que va a aguar",
                "Hace un sol de justicia",
                "Est√° cayendo un chaparr√≥n",
                "Hace un d√≠a de perros",
                "Hoy hace un d√≠a de campo",
                "Est√° el d√≠a nublao",
                "¬°Qu√© bochorno!",
                "Est√° fresquete",
                "Est√° el d√≠a apretao"
            ]
        };

        // Elementos del DOM
        let chatMessages, userInput, sendButton, statusIndicator, statusText;

        // Actualizar estado
        const updateStatus = (message, isError = false) => {
            if (!statusText) return;
            statusText.textContent = message;
            if (isError) {
                statusIndicator.classList.add('error');
            } else {
                statusIndicator.classList.remove('error');
            }
        };

        // A√±adir mensaje al chat
        const addMessage = (content, isUser = false, source = 'local') => {
            if (!chatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isUser ? 'user' : 'bot');
            
            // Marca de fuente para mensajes del bot
            const sourceBadge = source !== 'local' 
                ? `<span class="source-badge" title="Informaci√≥n obtenida de: ${source}">${source === 'web' ? 'üåê' : source}</span>' 
                : '';
                
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bot-avatar"><span>ü§ñ</span></div>
                    <div class="message-content">${content}${sourceBadge}</div>
                    <div class="message-time">Ahora</div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Actualizar el tiempo "Ahora" a minutos reales despu√©s de 5 segundos
            setTimeout(() => {
                const timeElement = messageDiv.querySelector('.message-time');
                if (timeElement && timeElement.textContent === 'Ahora') {
                    timeElement.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
            }, 5000);
            
            // Guardar en historial de conversaci√≥n
            if (!isUser) {
                conversationContext.conversationHistory.push({
                    role: 'assistant',
                    content,
                    timestamp: new Date().toISOString()
                });
            }
        };

        // Mostrar estado de carga
        const showLoading = (message = "Analizando tu pregunta sobre Benavente") => {
            if (!chatMessages) return;
            
            const loadingId = `loading-${Date.now()}`;
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message bot';
            loadingDiv.innerHTML = `
                <div class="bot-avatar"><span>ü§ñ</span></div>
                <div class="message-content">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                    <div class="loading-text">${message}</div>
                </div>
                <div class="message-time">Escribiendo...</div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return loadingId;
        };

        // Nueva integraci√≥n con OpenAI API - CORREGIDA
        const openAIApi = {
            apiKey: null,
            apiUrl: 'https://api.openai.com/v1/chat/completions',
            
            // Verificar si est√° configurado
            isConfigured: function() {
                return this.apiKey !== null && this.apiKey.trim() !== '';
            },
            
            // Configurar la API key
            configure: function(apiKey) {
                this.apiKey = apiKey;
                localStorage.setItem('openai_api_key', apiKey);
                console.log('OpenAI API configurada correctamente');
                return true;
            },
            
            // Inicializar desde localStorage
            init: function() {
                const savedKey = localStorage.getItem('openai_api_key');
                if (savedKey) {
                    this.apiKey = savedKey;
                    return true;
                }
                return false;
            },
            
            // Limpiar configuraci√≥n
            clear: function() {
                this.apiKey = null;
                localStorage.removeItem('openai_api_key');
            },
            
            // Verificar validez de la API key
            async verifyApiKey() {
                if (!this.isConfigured()) return false;
                
                try {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`
                        }
                    });
                    
                    return response.ok;
                } catch (error) {
                    console.error('Error verificando API key:', error);
                    return false;
                }
            },
            
            // Generar respuesta usando OpenAI - CORREGIDA
            generateResponse: async function(userMessage, context) {
                if (!this.isConfigured()) {
                    return null;
                }
                
                try {
                    // Preparar el prompt con contexto meteorol√≥gico
                    const prompt = this.buildPrompt(userMessage, context);
                    
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: `Eres Horus AI, un asistente meteorol√≥gico especializado en Benavente, Zamora. Tienes acceso a datos meteorol√≥gicos en tiempo real y datos hist√≥ricos. Tu tarea es proporcionar informaci√≥n precisa y √∫til sobre el clima de Benavente, con un enfoque en explicaciones claras y consejos pr√°cticos. Habla de manera amigable y profesional, usando referencias locales cuando sea apropiado.`
                                },
                                // CORRECCI√ìN: Usar conversationContext.conversationHistory en lugar de conversationHistory
                                ...(context.conversationContext?.conversationHistory || []).map(msg => ({
                                    role: msg.role,
                                    content: msg.content
                                })),
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 500,
                            top_p: 1,
                            frequency_penalty: 0,
                            presence_penalty: 0
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = errorData.error?.message || 'Error desconocido';
                        
                        // Manejar espec√≠ficamente el error 429
                        if (response.status === 429) {
                            throw new Error(`Error de API: ${response.status} - Has excedido tu cuota actual. Verifica tu plan y detalles de facturaci√≥n. ${errorMessage}`);
                        }
                        
                        throw new Error(`Error de API: ${response.status} - ${errorMessage}`);
                    }
                    
                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('Error al usar OpenAI API:', error);
                    return null;
                }
            },
            
            // Construir el prompt con contexto
            buildPrompt: function(userMessage, context) {
                // Incluir contexto meteorol√≥gico espec√≠fico de Benavente
                const benaventeContext = `
                    Benavente, Zamora - Informaci√≥n clave:
                    - Ubicaci√≥n: 41.7667¬∞ N, 5.3500¬∞ W
                    - Altitud: 719 metros sobre el nivel del mar
                    - Clima: Mediterr√°neo continentalizado
                    - Verano: Caluroso y seco, temperaturas m√°ximas >35¬∞C
                    - Invierno: Fr√≠o, temperaturas m√≠nimas <0¬∞C
                    - Primavera/Oto√±o: Moderados con lluvias ocasionales
                    - Ubicado en la llanura del Duero, con influencia de la meseta castellana
                `;
                
                // Incluir datos actuales si est√°n disponibles
                const latestData = context.historicalData && context.historicalData.length > 0 ? 
                    context.historicalData[context.historicalData.length - 1] : null;
                
                let currentConditions = '';
                if (latestData) {
                    currentConditions = `
                        Condiciones actuales en Benavente:
                        - Temperatura: ${latestData.temp.toFixed(1)}¬∞C
                        - Humedad: ${latestData.hum.toFixed(0)}%
                        - Presi√≥n: ${latestData.pres.toFixed(0)} hPa
                        - Direcci√≥n del viento: ${getWindDirectionName(latestData.wind_dir)} (${latestData.wind_dir}¬∞)
                        - Velocidad del viento: ${latestData.wind.toFixed(1)} m/s
                        - Calidad del aire: ${latestData.gas.toFixed(2)} kŒ©
                    `;
                }
                
                // Incluir contexto de conversaci√≥n
                const conversationContext = context.conversationContext ? `
                    Contexto de conversaci√≥n:
                    - √öltimo par√°metro mencionado: ${context.conversationContext.lastParameter || 'Ninguno'}
                    - √öltimo periodo analizado: ${context.conversationContext.lastPeriod || 'Ninguno'}
                    - √öltimo tipo de pregunta: ${context.conversationContext.lastQuestionType || 'Ninguno'}
                ` : '';
                
                return `Contexto meteorol√≥gico de Benavente:
                    ${benaventeContext}
                    ${currentConditions}
                    ${conversationContext}
                    
                    Mensaje del usuario: "${userMessage}"
                    
                    Proporciona una respuesta detallada, precisa y √∫til sobre el clima de Benavente, adaptada a la pregunta del usuario. Usa un tono amigable y profesional, incorporando referencias locales cuando sea apropiado. Si la pregunta no est√° relacionada con el clima, indica amablemente que tu especialidad es el clima de Benavente y ofrece ayuda en ese √°mbito.`;
            }
        };

        // Cargar datos hist√≥ricos reales de Benavente
        const loadHistoricalData = async () => {
            return new Promise((resolve, reject) => {
                try {
                    // Simulaci√≥n de carga de datos (en producci√≥n, esto vendr√≠a de un archivo CSV o API)
                    setTimeout(() => {
                        // Datos reales de Benavente (ejemplo de formato)
                        const rawData = `2025-08-18 23:32:38	28.88	34.86	935.87	665.09	16	17	N/A	0.00	0.42	0.00
2025-08-18 23:35:48	28.53	34.94	935.87	665.14	16	19	N/A	0.00	0.42	0.00
2025-08-18 23:38:48	28.34	35.78	935.92	664.66	15	16	N/A	0.00	0.42	0.00
2025-08-18 23:41:48	28.19	36.60	935.97	664.28	17	18	N/A	0.00	0.42	0.00
2025-08-18 23:44:48	28.13	36.87	935.92	664.70	13	13	N/A	0.00	0.42	0.00
2025-08-18 23:47:48	28.08	36.36	935.92	664.71	16	17	N/A	0.00	0.42	0.00
2025-08-18 23:50:48	27.99	36.24	935.88	665.05	15	17	N/A	0.00	0.42	0.00
2025-08-18 23:53:48	27.88	35.87	935.88	665.01	15	16	N/A	0.00	0.42	0.00
2025-08-18 23:56:48	27.67	36.02	935.93	664.55	14	15	N/A	0.00	0.42	0.00
2025-08-18 23:59:48	27.59	36.38	935.89	664.94	16	17	N/A	0.00	0.42	0.00`;

                        // Procesar los datos
                        historicalData = [];
                        const lines = rawData.trim().split('\n');
                        
                        lines.forEach(line => {
                            const [timestampStr, tempStr, humStr, presStr, presCorrStr, windDirStr, windSpeedStr, rainStr, extra1Str, gasStr, extra2Str] = line.split('\t');
                            
                            // Convertir valores a n√∫meros
                            const temp = parseFloat(tempStr);
                            const hum = parseFloat(humStr);
                            const pres = parseFloat(presStr);
                            const windDir = parseFloat(windDirStr);
                            const windSpeed = parseFloat(windSpeedStr);
                            const gas = parseFloat(gasStr);
                            
                            // Determinar si est√° lloviendo (simplificado para el ejemplo)
                            const isRaining = rainStr === 'N/A' ? 0 : (parseFloat(rainStr) > 0 ? 1 : 0);
                            
                            historicalData.push({
                                timestamp: new Date(timestampStr).toISOString(),
                                temp: temp,
                                hum: hum,
                                pres: pres,
                                lluvia: isRaining,
                                wind: windSpeed,
                                wind_dir: windDir,
                                gas: gas
                            });
                        });
                        
                        // Ordenar por fecha
                        historicalData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        
                        console.log(`Datos cargados: ${historicalData.length} registros hist√≥ricos de Benavente`);
                        resolve();
                    }, 800);
                } catch (error) {
                    console.error("Error procesando datos hist√≥ricos:", error);
                    reject(error);
                }
            });
        };

        // Configurar API de OpenAI - ¬°DEFINIDA ANTES DE USARLA!
        const toggleApiConfig = () => {
            if (!apiConfig) {
                console.error('Elemento apiConfig no encontrado');
                return;
            }
            
            // Si el elemento no tiene display definido, asumimos que est√° oculto
            const currentDisplay = window.getComputedStyle(apiConfig).display;
            apiConfig.style.display = currentDisplay === 'none' ? 'block' : 'none';
        };

        // Verificar estado de la API
        const checkApiKeyStatus = async () => {
            if (!apiStatus || !apiStatusIndicator || !apiConfigToggle) return;
            
            if (openAIApi.isConfigured()) {
                const isValid = await openAIApi.verifyApiKey();
                if (isValid) {
                    apiStatus.textContent = 'Estado: API configurada y v√°lida';
                    apiStatus.className = 'api-status connected';
                    apiStatusIndicator.style.background = '#4CAF50';
                    apiConfigToggle.classList.add('api-configured');
                    updateStatus("OpenAI API configurada correctamente - Usando IA avanzada");
                } else {
                    apiStatus.textContent = 'Estado: API configurada pero inv√°lida';
                    apiStatus.className = 'api-status disconnected';
                    apiStatusIndicator.style.background = '#ff9800';
                    apiConfigToggle.classList.add('api-error');
                    updateStatus("Error con la API de OpenAI - Usando sistema local", true);
                }
            } else {
                apiStatus.textContent = 'Estado: No configurado';
                apiStatus.className = 'api-status disconnected';
                apiStatusIndicator.style.background = '#f44336';
                apiConfigToggle.classList.remove('api-configured', 'api-error');
                updateStatus("API de IA no configurada - Usando sistema local");
            }
        };

        // Guardar API key
        const setupApiKeyHandling = () => {
            if (!saveApiKeyBtn || !apiKeyInput || !apiStatus) return;
            
            saveApiKeyBtn.addEventListener('click', () => {
                const apiKey = apiKeyInput.value.trim();
                if (apiKey) {
                    openAIApi.configure(apiKey);
                    checkApiKeyStatus();
                    apiKeyInput.value = '';
                    setTimeout(async () => {
                        const isValid = await openAIApi.verifyApiKey();
                        if (isValid) {
                            addMessage("‚úÖ API de OpenAI configurada correctamente. ¬°Ahora podr√°s obtener respuestas m√°s avanzadas!", false, 'local');
                        } else {
                            addMessage("‚ö†Ô∏è La API key parece ser inv√°lida. Por favor, verifica que la clave sea correcta.", false, 'local');
                        }
                    }, 300);
                }
            });
        };

        // Inicializar chatbot
        const initChatbot = async () => {
            try {
                // OBTENER ELEMENTOS DEL DOM - ¬°AHORA DENTRO DE initChatbot!
                chatMessages = document.getElementById('chat-messages');
                userInput = document.getElementById('user-input');
                sendButton = document.getElementById('send-button');
                statusIndicator = document.getElementById('status-indicator');
                statusText = document.getElementById('status-text');
                
                // Elementos de configuraci√≥n de API
                apiConfig = document.getElementById('api-config');
                apiKeyInput = document.getElementById('api-key-input');
                saveApiKeyBtn = document.getElementById('save-api-key');
                apiStatus = document.getElementById('api-status');
                apiConfigToggle = document.getElementById('api-config-toggle');
                apiStatusIndicator = document.getElementById('api-status-indicator');

                // Verificar que todos los elementos existan
                if (!apiConfigToggle) {
                    console.error('Elemento apiConfigToggle no encontrado');
                }
                if (!apiConfig) {
                    console.error('Elemento apiConfig no encontrado');
                }
                
                // Configurar tema
                const themeSwitch = document.querySelector('.theme-switch__checkbox');
                if (themeSwitch) {
                    // Verificar tema actual
                    const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
                    themeSwitch.checked = currentTheme === 'dark';
                    
                    // Manejar el cambio de tema
                    themeSwitch.addEventListener('change', function() {
                        if (this.checked) {
                            document.body.classList.remove('light-mode');
                            document.body.classList.add('dark-mode');
                            localStorage.setItem('theme', 'dark');
                        } else {
                            document.body.classList.remove('dark-mode');
                            document.body.classList.add('light-mode');
                            localStorage.setItem('theme', 'light');
                        }
                        
                        // Actualizar gr√°ficos para reflejar el nuevo tema
                        if (typeof window.updateChatbotCharts === 'function') {
                            window.updateChatbotCharts();
                        }
                    });
                }
                
                // Cargar tema guardado
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.body.classList.remove('light-mode');
                    document.body.classList.add('dark-mode');
                    if (themeSwitch) themeSwitch.checked = true;
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                    if (themeSwitch) themeSwitch.checked = false;
                }
                
                // Hacer disponible para main.js
                window.updateChatbotCharts = () => {
                    // Destruir y recrear los gr√°ficos para actualizar colores
                    charts.forEach(chart => {
                        if (chart && chart.destroy) {
                            chart.destroy();
                        }
                    });
                    charts = [];
                    
                    // Volver a renderizar todos los gr√°ficos
                    setTimeout(() => {
                        document.querySelectorAll('.prediction-chart').forEach(canvas => {
                            const parameter = canvas.dataset.parameter;
                            const chartData = JSON.parse(canvas.dataset.chartData);
                            renderChart(parameter, chartData, canvas.id);
                        });
                        
                        document.querySelectorAll('.comparison-chart').forEach(canvas => {
                            const parameter = canvas.dataset.parameter;
                            const chartData1 = JSON.parse(canvas.dataset.chartData1);
                            const chartData2 = JSON.parse(canvas.dataset.chartData2);
                            const period1 = canvas.dataset.period1;
                            const period2 = canvas.dataset.period2;
                            renderComparisonChart(parameter, chartData1, chartData2, period1, period2, canvas.id);
                        });
                        
                        document.querySelectorAll('.extremes-chart').forEach(canvas => {
                            const parameter = canvas.dataset.parameter;
                            const chartData = JSON.parse(canvas.dataset.chartData);
                            const maxDate = canvas.dataset.maxDate;
                            const minDate = canvas.dataset.minDate;
                            renderExtremesChart(parameter, chartData, maxDate, minDate, canvas.id);
                        });
                        
                        document.querySelectorAll('.correlation-chart').forEach(canvas => {
                            const parameter1 = canvas.dataset.parameter1;
                            const parameter2 = canvas.dataset.parameter2;
                            const chartData = JSON.parse(canvas.dataset.chartData);
                            renderCorrelationChart(parameter1, parameter2, chartData, canvas.id);
                        });
                    }, 100);
                };
                
                // Configurar bot√≥n de configuraci√≥n de API - ¬°AHORA DENTRO DE initChatbot!
                if (apiConfigToggle) {
                    apiConfigToggle.addEventListener('click', toggleApiConfig);
                } else {
                    console.error('No se encontr√≥ el bot√≥n de configuraci√≥n de API');
                }
                
                // Configurar guardado de API key
                setupApiKeyHandling();
                
                // Inicializar OpenAI API
                const apiKeyConfigured = openAIApi.init();
                
                // Inicializar estado de la API
                checkApiKeyStatus();
                
                // Cargar datos hist√≥ricos
                await loadHistoricalData();
                
                chatbotReady = true;
                
                // Configurar sugerencias
                document.querySelectorAll('.suggestion').forEach(suggestion => {
                    suggestion.addEventListener('click', () => {
                        userInput.value = suggestion.textContent;
                        sendMessage();
                    });
                });
                
                // Configurar el bot√≥n de enviar
                if (sendButton && userInput) {
                    sendButton.addEventListener('click', sendMessage);
                    userInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') sendMessage();
                    });
                }
                
                // Mensaje de estado seg√∫n si hay API key configurada
                if (apiKeyConfigured) {
                    const isValid = await openAIApi.verifyApiKey();
                    if (isValid) {
                        updateStatus("OpenAI API configurada correctamente - Usando IA avanzada");
                    } else {
                        updateStatus("Error con la API de OpenAI - Usando sistema local", true);
                    }
                } else {
                    updateStatus("API de IA no configurada - Usando sistema local");
                }
                
                // Mensaje de bienvenida
                setTimeout(() => {
                    addMessage(`
                        <div class="general-answer">
                            <h3>¬°Hola! Soy Horus AI</h3>
                            <p>Soy un asistente meteorol√≥gico especializado en Benavente, Zamora. Tengo acceso a datos meteorol√≥gicos en tiempo real y datos hist√≥ricos para proporcionar informaci√≥n precisa y √∫til sobre el clima de Benavente.</p>
                            
                            <div class="feature">
                                <span class="feature-icon">üå°Ô∏è</span> 
                                <strong>Temperatura</strong>
                                <p>Consultar y analizar temperaturas actuales y tendencias</p>
                            </div>
                            <div class="feature">
                                <span class="feature-icon">üíß</span> 
                                <strong>Humedad</strong>
                                <p>Monitoreo y an√°lisis de niveles de humedad</p>
                            </div>
                            <div class="feature">
                                <span class="feature-icon">üå¨Ô∏è</span> 
                                <strong>Viento</strong>
                                <p>Velocidad y direcci√≥n del viento en Benavente</p>
                            </div>
                            <div class="feature">
                                <span class="feature-icon">üìä</span> 
                                <strong>An√°lisis meteorol√≥gico profundo</strong>
                                <p>Comparaciones, predicciones y correlaciones</p>
                            </div>
                        </div>
                        <p>Form√∫lame cualquier pregunta, y analizar√© su significado completo para proporcionarte una respuesta precisa y contextualizada.</p>
                    `, false, 'local');
                }, 500);
                
            } catch (error) {
                console.error('Error inicializando chatbot:', error);
                chatbotReady = true;
                updateStatus("Error al inicializar el chatbot", true);
            }
        };

        // Enviar mensaje
        const sendMessage = async () => {
            if (!userInput || !chatbotReady) return;
            
            const message = userInput.value.trim();
            if (message === '') return;
            
            // Procesar mensaje
            const response = await processUserMessage(message);
            
            // Muestra la respuesta
            if (response) {
                addMessage(response, false, openAIApi.isConfigured() ? 'openai' : 'local');
            }
            
            // Limpiar el campo de entrada
            userInput.value = '';
        };

        // Procesar mensaje del usuario - CORREGIDA
        const processUserMessage = async (message) => {
            // Guardar en historial de conversaci√≥n
            conversationContext.conversationHistory.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            
            // Mostrar mensaje de usuario
            addMessage(message, true);
            
            // Mostrar estado de carga
            const loadingId = showLoading("Consultando con IA avanzada...");
            
            try {
                // Probar primero con OpenAI si est√° configurada
                if (openAIApi.isConfigured()) {
                    updateStatus("Consultando con modelo avanzado...");
                    const openAIResponse = await openAIApi.generateResponse(message, {
                        historicalData: historicalData,
                        conversationContext: conversationContext
                    });
                    
                    // Eliminar el estado de carga
                    const loadingElement = document.getElementById(loadingId);
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    if (openAIResponse) {
                        // A√±adir fuente de informaci√≥n
                        return openAIResponse;
                    }
                }
                
                // Si no hay respuesta de OpenAI, usar el sistema local
                updateStatus("Analizando con sistema local...");
                
                // Si no hay API key configurada, mostrar mensaje de configuraci√≥n
                if (!openAIApi.isConfigured()) {
                    const loadingElement = document.getElementById(loadingId);
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // Crear mensaje de configuraci√≥n
                    const configMessage = `
                        <div class="general-answer">
                            <h3>Configuraci√≥n de IA Requerida</h3>
                            <p>Parece que no has configurado una clave API de OpenAI. Para obtener respuestas m√°s avanzadas y precisas:</p>
                            <ol>
                                <li><a href="https://platform.openai.com/account/api-keys" target="_blank">Obt√©n tu API key de OpenAI</a></li>
                                <li>Ingresa la clave en la secci√≥n de configuraci√≥n</li>
                                <li>¬°Listo! El chatbot usar√° la IA avanzada para responderte</li>
                            </ol>
                            <p>Mientras tanto, seguir√© usando mi sistema meteorol√≥gico local para responderte.</p>
                        </div>
                    `;
                    
                    addMessage(configMessage, false, 'local');
                    
                    // Mostrar estado de carga para el sistema local
                    const localLoadingId = showLoading("Analizando con sistema local...");
                    
                    // Procesar con el sistema local
                    const localResponse = await processWithLocalSystem(message);
                    
                    // Eliminar estado de carga local
                    const localLoadingElement = document.getElementById(localLoadingId);
                    if (localLoadingElement) {
                        localLoadingElement.remove();
                    }
                    
                    return localResponse;
                }
                
                // Si hubo error con OpenAI, usar sistema local
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                const localLoadingId = showLoading("Analizando con sistema local...");
                
                const localResponse = await processWithLocalSystem(message);
                
                // Eliminar estado de carga local
                const localLoadingElement = document.getElementById(localLoadingId);
                if (localLoadingElement) {
                    localLoadingElement.remove();
                }
                
                return localResponse;
                
            } catch (error) {
                console.error('Error procesando mensaje:', error);
                
                // Eliminar el estado de carga
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                try {
                    // Intentar procesar con el sistema local
                    const localLoadingId = showLoading("Analizando con sistema local...");
                    const localResponse = await processWithLocalSystem(message);
                    
                    // Eliminar estado de carga local
                    const localLoadingElement = document.getElementById(localLoadingId);
                    if (localLoadingElement) {
                        localLoadingElement.remove();
                    }
                    
                    return localResponse;
                } catch (localError) {
                    console.error('Error procesando con sistema local:', localError);
                    
                    // Eliminar estado de carga local si existe
                    const localLoadingElement = document.getElementById(localLoadingId);
                    if (localLoadingElement) {
                        localLoadingElement.remove();
                    }
                    
                    // Mensaje de error final
                    return "‚ö†Ô∏è Ocurri√≥ un error al procesar tu solicitud. Por favor, intenta nuevamente.";
                }
            }
        };

        // Procesar con sistema local (para fallback)
        const processWithLocalSystem = async (message) => {
            updateStatus("Analizando con sistema local...");
            
            // Corregir ortograf√≠a
            const { correctedMessage, hasCorrection } = spellingCorrection.correctMessage(message);
            
            // Mostrar mensaje de correcci√≥n SOLO si hubo correcciones significativas
            if (hasCorrection) {
                addMessage(`üîç Entiendo que quiz√°s quisiste decir: "${correctedMessage}"`, false);
            }
            
            // Normalizar mensaje
            const normalizedMessage = correctedMessage.toLowerCase().replace(/[.,!?]/g, '');
            
            try {
                // An√°lisis de √°mbito
                const domainAnalysis = semanticAnalysis.analyzeDomain(normalizedMessage);
                
                // Verificar referencias
                const references = semanticAnalysis.analyzeReferences(normalizedMessage, conversationContext);
                
                // Resolver an√°foras
                const resolvedMessage = semanticAnalysis.resolveAnaphora(normalizedMessage, conversationContext);
                
                // Verificar si es hipot√©tica
                const isHypothetical = semanticAnalysis.analyzeHypotheticals(normalizedMessage);
                
                // Identificar entidades
                const entities = semanticAnalysis.identifyEntities(resolvedMessage);
                
                // Analizar intenci√≥n
                const intent = semanticAnalysis.analyzeIntent(resolvedMessage, entities, domainAnalysis);
                
                // Verificar preguntas compuestas
                const isCompoundQuestion = semanticAnalysis.analyzeCompoundQuestions(normalizedMessage);
                
                // Entidades para la respuesta
                const detectedEntities = {
                    parameters: entities.parameters,
                    temporal: entities.temporal,
                    comparisons: entities.comparisons,
                    operations: entities.operations,
                    location: entities.locations
                };
                
                // Actualizar contexto temporal si se identifica uno
                if (entities.periods.length > 0) {
                    conversationContext.temporalContext = entities.periods[0];
                }
                
                // Actualizar contexto de par√°metros si se identifican
                if (entities.parameters.length > 0) {
                    conversationContext.lastParameter = entities.parameters[0];
                }
                
                // Actualizar contexto de ubicaci√≥n
                if (entities.locations.length > 0) {
                    conversationContext.spatialContext = entities.locations[0];
                }
                
                // Si hay referencias, actualizar contexto
                if (references.parameters.length > 0) {
                    conversationContext.lastParameter = references.parameters[0];
                }
                
                if (references.location.length > 0) {
                    conversationContext.spatialContext = references.location[0];
                }
                
                // Si hay contexto de par√°metro pero no se identific√≥ en la pregunta, usar el contexto
                if (conversationContext.lastParameter && entities.parameters.length === 0) {
                    entities.parameters = [conversationContext.lastParameter];
                }
                
                // Si hay contexto temporal pero no se identific√≥ en la pregunta, usar el contexto
                if (conversationContext.lastPeriod && entities.periods.length === 0) {
                    entities.periods = [conversationContext.lastPeriod];
                }
                
                // Si hay contexto de ubicaci√≥n pero no se identific√≥ en la pregunta, usar el contexto
                if (conversationContext.spatialContext && entities.locations.length === 0) {
                    entities.locations = [conversationContext.spatialContext];
                }
                
                // Si no se reconoci√≥ la intenci√≥n pero es una pregunta meteorol√≥gica
                if (domainAnalysis.isWeatherQuestion) {
                    // Intentar identificar par√°metros incluso sin intenci√≥n clara
                    if (entities.parameters.length > 0) {
                        // Si hay par√°metros pero no intenci√≥n clara, asumir consulta actual
                        return intentHandlers.current_data({
                            parameters: entities.parameters,
                            periods: ['hoy'],
                            locations: ['benavente']
                        }, conversationContext);
                    }
                    
                    // Si hay periodos pero no par√°metros, pedir aclaraci√≥n
                    if (entities.periods.length > 0) {
                        return `Para poder ayudarte con ${benaventeInfo.location}, necesito saber qu√© par√°metro meteorol√≥gico te interesa. Por ejemplo: 'temperatura', 'humedad' o 'presi√≥n'.`;
                    }
                }
                
                // Si es un saludo aunque no se haya detectado claramente
                if (semanticAnalysis.isGreeting(normalizedMessage)) {
                    return intentHandlers.greeting();
                }
                
                // Si es una despedida aunque no se haya detectado claramente
                if (semanticAnalysis.isGoodbye(normalizedMessage)) {
                    return intentHandlers.goodbye();
                }
                
                // Si es una solicitud de ayuda aunque no se haya detectado claramente
                if (semanticAnalysis.isHelpRequest(normalizedMessage)) {
                    return intentHandlers.help();
                }
                
                // Si no se identifica un √°mbito espec√≠fico
                if (!domainAnalysis.isWeatherQuestion) {
                    // Verificar si es una pregunta sobre Horus
                    if (normalizedMessage.includes('horus') || normalizedMessage.includes('sistema')) {
                        return intentHandlers.about_horus();
                    }
                    
                    // Verificar si es una pregunta de soporte t√©cnico
                    if (normalizedMessage.includes('problema') || normalizedMessage.includes('error') || 
                        normalizedMessage.includes('no funciona') || normalizedMessage.includes('lento')) {
                        return intentHandlers.support();
                    }
                    
                    // Verificar si es una pregunta personal
                    if (normalizedMessage.includes('qui√©n eres') || normalizedMessage.includes('quien eres') ||
                        normalizedMessage.includes('c√≥mo te llamas') || normalizedMessage.includes('como te llamas')) {
                        return intentHandlers.personal();
                    }
                    
                    // Verificar si es una pregunta general
                    if (normalizedMessage.includes('nombre') || normalizedMessage.includes('hora') ||
                        normalizedMessage.includes('edad') || normalizedMessage.includes('vives')) {
                        return intentHandlers.general();
                    }
                    
                    // Verificar el dominio de preguntas fuera del √°mbito
                    let domain = 'general';
                    if (normalizedMessage.includes('salud') || normalizedMessage.includes('m√©dico')) {
                        domain = 'salud';
                    } else if (normalizedMessage.includes('tecnolog√≠a') || normalizedMessage.includes('tecnologia') ||
                             normalizedMessage.includes('computadora') || normalizedMessage.includes('internet')) {
                        domain = 'tecnolog√≠a';
                    } else if (normalizedMessage.includes('deportes') || normalizedMessage.includes('f√∫tbol')) {
                        domain = 'deportes';
                    } else if (normalizedMessage.includes('entretenimiento') || normalizedMessage.includes('pel√≠cula') ||
                             normalizedMessage.includes('m√∫sica')) {
                        domain = 'entretenimiento';
                    } else if (normalizedMessage.includes('comida') || normalizedMessage.includes('receta')) {
                        domain = 'comida';
                    } else if (normalizedMessage.includes('educaci√≥n') || normalizedMessage.includes('escuela')) {
                        domain = 'educaci√≥n';
                    } else if (normalizedMessage.includes('finanzas') || normalizedMessage.includes('dinero')) {
                        domain = 'finanzas';
                    }
                    
                    return intentHandlers.out_of_scope({ domain });
                }
                
                // Si es una pregunta hipot√©tica
                if (isHypothetical) {
                    return "Como asistente meteorol√≥gico para Benavente, solo puedo proporcionar informaci√≥n basada en datos reales y an√°lisis hist√≥ricos. No puedo especular sobre escenarios hipot√©ticos que no est√©n respaldados por datos clim√°ticos de la zona.";
                }
                
                // Si es una pregunta compuesta
                if (isCompoundQuestion) {
                    return "Para poder ayudarte mejor con Benavente, por favor divide tu pregunta en partes m√°s espec√≠ficas. Por ejemplo, en lugar de preguntar sobre varios par√°metros a la vez, enf√≥cate en uno primero.";
                }
                
                // Si hay entidades detectadas pero no intenci√≥n clara
                if (detectedEntities.parameters.length > 0 || 
                    detectedEntities.temporal.length > 0 || 
                    detectedEntities.comparisons.length > 0) {
                    let response = `He detectado algunos elementos relevantes en tu pregunta sobre ${benaventeInfo.location}, pero no estoy seguro de entender exactamente qu√© necesitas.\n\n`;
                    
                    if (detectedEntities.parameters.length > 0) {
                        response += `* Par√°metros meteorol√≥gicos: ${detectedEntities.parameters.join(', ')}\n`;
                    }
                    if (detectedEntities.temporal.length > 0) {
                        response += `* Periodos de tiempo: ${detectedEntities.temporal.join(', ')}\n`;
                    }
                    if (detectedEntities.comparisons.length > 0) {
                        response += `* Tipos de comparaci√≥n: ${detectedEntities.comparisons.map(c => 
                          c === 'vs' ? 'comparaci√≥n directa' : 
                          c === 'trend' ? 'tendencia' : 
                          c === 'correlation' ? 'correlaci√≥n' : c).join(', ')}\n`;
                    }
                    if (detectedEntities.operations.length > 0) {
                        response += `* Operaciones solicitadas: ${detectedEntities.operations.join(', ')}\n`;
                    }
                    
                    response += `\n¬øPodr√≠as reformular tu pregunta para que sea m√°s espec√≠fica sobre el clima de Benavente?`;
                    
                    return response;
                }
                
                // Si no hay contexto previo y no es claramente fuera de √°mbito, asumimos que es general
                return `<div class="out-of-scope">
                    <h3>No Entiendo Tu Pregunta sobre Benavente</h3>
                    <p>No estoy seguro de entender tu pregunta. Soy un asistente meteorol√≥gico especializado en el sistema Horus en <strong>${benaventeInfo.location}</strong>.</p>
                    
                    <h4>¬øC√≥mo puedo ayudarte con Benavente?</h4>
                    <ul>
                        <li>Consultar datos meteorol√≥gicos actuales en Benavente</li>
                        <li>Analizar tendencias clim√°ticas hist√≥ricas de Benavente</li>
                        <li>Realizar predicciones basadas en datos de Benavente</li>
                        <li>Explicar el funcionamiento de Horus en Benavente</li>
                        <li>Contextualizar el clima de Benavente (${benaventeInfo.altitude})</li>
                    </ul>
                    
                    <p>Ejemplos de preguntas que puedo responder:</p>
                    <ul>
                        <li>"¬øCu√°l es la temperatura actual en Benavente?"</li>
                        <li>"¬øC√≥mo funciona el sistema Horus en Benavente?"</li>
                        <li>"Muestra la tendencia de presi√≥n de los √∫ltimos 7 d√≠as en Benavente"</li>
                    </ul>
                    
                    <p>Por favor, reformula tu pregunta para que est√© relacionada con el clima o el sistema Horus en <strong>${benaventeInfo.location}</strong>.</p>
                    
                    <p class="benavente-context"><strong>Informaci√≥n clave sobre Benavente:</strong> Ubicado a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterr√°neo continentalizado con veranos calurosos e inviernos fr√≠os.</p>
                </div>`;
                
            } catch (error) {
                console.error('Error procesando mensaje:', error);
                return "‚ö†Ô∏è Ocurri√≥ un error al procesar tu solicitud. Por favor, intenta nuevamente.";
            }
        };

        // Sistema de correcci√≥n ortogr√°fica
        const spellingCorrection = {
            // Calcula la distancia de Levenshtein entre dos strings
            levenshteinDistance: function(a, b) {
                if (a.length === 0) return b.length;
                if (b.length === 0) return a.length;
                
                const matrix = [];
                
                for (let i = 0; i <= b.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= a.length; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= b.length; i++) {
                    for (let j = 1; j <= a.length; j++) {
                        if (b.charAt(i - 1) === a.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1, // Sustituci√≥n
                                matrix[i][j - 1] + 1, // Inserci√≥n
                                matrix[i - 1][j] + 1 // Eliminaci√≥n
                            );
                        }
                    }
                }
                
                return matrix[b.length][a.length];
            },
            
            // Corrige la ortograf√≠a de una palabra
            correctWord: function(word) {
                // Si la palabra est√° en el diccionario, devolver la correcci√≥n
                if (spellingDictionary[word.toLowerCase()]) {
                    return spellingDictionary[word.toLowerCase()];
                }
                
                // Buscar en el diccionario de sin√≥nimos
                for (const [correct, synonyms] of Object.entries(weatherSynonyms)) {
                    for (const synonym of synonyms) {
                        if (word.toLowerCase() === synonym) {
                            return correct;
                        }
                        
                        // Calcular distancia de Levenshtein para correcci√≥n aproximada
                        const distance = this.levenshteinDistance(word.toLowerCase(), synonym);
                        if (distance <= Math.max(1, Math.floor(synonym.length * 0.2))) {
                            return correct;
                        }
                    }
                }
                
                return word;
            },
            
            // Corrige todo el mensaje
            correctMessage: function(message) {
                const words = message.split(/\s+/);
                let correctedWords = [];
                let foundCorrection = false;
                
                words.forEach(word => {
                    // Mantener signos de puntuaci√≥n
                    const cleanWord = word.replace(/[.,!?;:]/g, '');
                    const punctuation = word.match(/[.,!?;:]+$/);
                    
                    if (cleanWord.length > 2) {
                        const corrected = this.correctWord(cleanWord);
                        if (corrected !== cleanWord) {
                            correctedWords.push(corrected + (punctuation ? punctuation[0] : ''));
                            foundCorrection = true;
                        } else {
                            correctedWords.push(word);
                        }
                    } else {
                        correctedWords.push(word);
                    }
                });
                
                return {
                    correctedMessage: correctedWords.join(' '),
                    hasCorrection: foundCorrection
                };
            }
        };

        // Diccionario para correcci√≥n ortogr√°fica
        const spellingDictionary = {
            'tempertura': 'temperatura',
            'temperaruta': 'temperatura',
            'humedad': 'humedad',
            'humead': 'humedad',
            'umedad': 'humedad',
            'presion': 'presi√≥n',
            'presion': 'presi√≥n',
            'presion atmosferica': 'presi√≥n atmosf√©rica',
            'presion atmosferica': 'presi√≥n atmosf√©rica',
            'presion barometrica': 'presi√≥n barom√©trica',
            'presion barometrica': 'presi√≥n barom√©trica',
            'lluvia': 'lluvia',
            'llubia': 'lluvia',
            'lubia': 'lluvia',
            'viento': 'viento',
            'biento': 'viento',
            'bientto': 'viento',
            'gas': 'gas',
            'calidad del aire': 'calidad del aire',
            'calidad aire': 'calidad del aire',
            'direccion': 'direcci√≥n',
            'direccion del viento': 'direcci√≥n del viento',
            'direccion viento': 'direcci√≥n del viento',
            'termometro': 'term√≥metro',
            'termometro': 'term√≥metro',
            'pluviometria': 'pluviometr√≠a',
            'pluviometria': 'pluviometr√≠a',
            'co2': 'CO2',
            'di√≥xido de carbono': 'di√≥xido de carbono'
        };

        // Diccionario de sin√≥nimos meteorol√≥gicos mejorado
        const weatherSynonyms = {
            temperatura: ['temp', 'calor', 'fr√≠o', 'frio', 'grados', '¬∞', 'celsius', 'cent√≠grados', 'centigrados', 'term√≥metro', 'termometro', 'caliente', 'frio', 'temperatura en benavente'],
            humedad: ['hum', 'vapor', 'agua', 'porcentaje de agua', '% agua', 'humedad relativa', 'humedad en benavente'],
            presi√≥n: ['pres', 'atmosf√©rica', 'barom√©trica', 'barometrica', 'hpa', 'mb', 'presi√≥n atmosf√©rica', 'presion en benavente'],
            lluvia: ['precipitaci√≥n', 'precipitacion', 'agua', 'llovizna', 'tormenta', 'lluvioso', 'precipitaciones', 'pluviometr√≠a', 'pluviometria', 'lluvia en benavente'],
            viento: ['velocidad del viento', 'r√°fagas', 'r√°faga', 'r√°fagas de viento', 'velocidad viento', 'km/h', 'nudos', 'direcci√≥n del viento', 'direccion viento', 'brisa', 'viento en benavente'],
            gas: ['calidad del aire', 'calidad aire', 'contaminaci√≥n', 'contaminacion', 'pm2.5', 'pm10', 'part√≠culas', 'particulas', 'co2', 'di√≥xido de carbono', 'gas en benavente'],
            direcci√≥n: ['direccion', 'rumbo', 'orientaci√≥n', 'orientacion', 'grados', 'norte', 'sur', 'este', 'oeste', 'cardinales', 'direccion en benavente'],
            an√°lisis: ['analisis', 'tendencia', 'tendencias', 'evoluci√≥n', 'comportamiento', 'patr√≥n', 'patron', 'estad√≠stica', 'estadisticas', 'analisis en benavente'],
            predicci√≥n: ['prediccion', 'pron√≥stico', 'pronostico', 'previsi√≥n', 'prevision', 'futuro', 'ma√±ana', 'siguiente', 'proyecci√≥n', 'proyeccion', 'prediccion en benavente'],
            actual: ['ahora', 'en este momento', 'en este instante', 'actualidad', 'presente', 'en directo', 'en tiempo real', 'hoy', 'actual en benavente'],
            hist√≥rico: ['historico', 'pasado', 'antes', 'anterior', 'anteriores', 'd√≠as anteriores', 'semanas anteriores', '√∫ltimos d√≠as', 'historico en benavente'],
            comparar: ['comparar', 'comparaci√≥n', 'compara', 'diferencia', 'vs', 'versus', 'comparativo', 'entre', 'y', 'comparar en benavente'],
            m√°ximo: ['maximo', 'm√°ximo', 'pico', 'peak', 'm√°s alto', 'mayor', 'm√°x', 'max', 'maximo en benavente'],
            m√≠nimo: ['minimo', 'm√≠nimo', 'm√°s bajo', 'menor', 'm√≠n', 'min', 'minimo en benavente'],
            tendencia: ['tendencia', 'tendencias', 'evoluci√≥n', 'comportamiento', 'patr√≥n', 'patron', 'cambios', 'variaci√≥n', 'variacion', 'tendencia en benavente'],
            probabilidad: ['probabilidad', 'probable', 'posibilidad', 'posible', 'chance', 'oportunidad', 'riesgo', 'probabilidad en benavente']
        };

        // Mapeo de intenciones mejorado
        const intentMap = {
            current_ {
                keywords: ['actual', 'ahora', 'en este momento', 'en directo', 'presente', 'en tiempo real', 'hoy', 'en benavente'],
                parameters: ['temperatura', 'humedad', 'presi√≥n', 'lluvia', 'viento', 'gas', 'direcci√≥n'],
                required: []
            },
            historical_trend: {
                keywords: ['tendencia', 'evoluci√≥n', 'comportamiento', 'an√°lisis', 'analisis', 'patr√≥n', 'patron', 'gr√°fico', 'grafico', 'historial', 'historico', 'hist√≥rico', 'evolucion', 'variacion', 'en benavente'],
                parameters: ['temperatura', 'humedad', 'presi√≥n', 'lluvia', 'viento', 'gas'],
                required: ['period']
            },
            prediction: {
                keywords: ['predicci√≥n', 'prediccion', 'pron√≥stico', 'pronostico', 'previsi√≥n', 'prevision', 'futuro', 'ma√±ana', 'siguiente', 'proyecci√≥n', 'proyeccion', 'probabilidad', 'probable', 'en benavente'],
                parameters: ['temperatura', 'humedad', 'presi√≥n', 'lluvia', 'viento', 'gas'],
                required: []
            },
            comparison: {
                keywords: ['comparar', 'comparaci√≥n', 'compara', 'diferencia', 'vs', 'versus', 'comparativo', 'entre', 'y', 'diferencia', 'distinto', 'igual', 'en benavente'],
                parameters: ['temperatura', 'humedad', 'presi√≥n', 'lluvia', 'viento', 'gas'],
                required: ['periods']
            },
            max_min: {
                keywords: ['m√°ximo', 'maximo', 'm√≠nimo', 'minimo', 'pico', 'peak', 'mayor', 'menor', 'm√°s alto', 'm√°s bajo', 'm√°x', 'max', 'm√≠n', 'min', 'en benavente'],
                parameters: ['temperatura', 'humedad', 'presi√≥n', 'lluvia', 'viento', 'gas'],
                required: ['period']
            },
            correlation: {
                keywords: ['relaci√≥n', 'correlaci√≥n', 'correlacion', 'conexi√≥n', 'conexion', 'asociaci√≥n', 'asociacion', 'afecta', 'influye', 'impacto', 'causa', 'provoca', 'en benavente'],
                parameters: ['temperatura', 'humedad', 'presi√≥n', 'lluvia', 'viento', 'gas'],
                required: ['parameters']
            },
            greeting: {
                keywords: ['hola', 'buenos d√≠as', 'buenos dias', 'buenas tardes', 'hey', 'saludos', 'buen d√≠a', 'buen dia', 'buenas noches', 'que tal', 'como estas', 'c√≥mo est√°s', 'en benavente'],
                parameters: [],
                required: []
            },
            goodbye: {
                keywords: ['adi√≥s', 'adios', 'gracias', 'chao', 'hasta luego', 'hasta pronto', 'nos vemos', 'bye', 'grac√≠as', 'gracias', 'fue √∫til', 'fue util', 'en benavente'],
                parameters: [],
                required: []
            },
            help: {
                keywords: ['ayuda', 'funciona', 'c√≥mo', 'como', 'puedo', 'capaz', 'hacer', 'qu√©', 'que', 'preguntar', 'instrucciones', 'ejemplo', 'ejemplos', 'gu√≠a', 'manual', 'tutorial', 'en benavente'],
                parameters: [],
                required: []
            },
            about_horus: {
                keywords: ['horus', 'sistema horus', 'estaci√≥n horus', 'estacion horus', 'estaci√≥n meteorol√≥gica', 'estacion meteorologica', 'sistema meteorol√≥gico', 'sistema meteorologico', 'para qu√© sirve', 'para que sirve', 'qu√© hace', 'que hace', 'en benavente'],
                parameters: [],
                required: []
            },
            support: {
                keywords: ['problema', 'error', 'no funciona', 'fallo', 'bug', 'no carga', 'lento', 'lentitud', 'lenta', 'lento', 'no responde', 'no me deja', 'no puedo', 'en benavente'],
                parameters: [],
                required: []
            },
            personal: {
                keywords: ['qui√©n eres', 'quien eres', 'qui√©n eres t√∫', 'quien eres tu', 'qui√©n te hizo', 'quien te hizo', 'qui√©n te cre√≥', 'quien te creo', 'tu creador', 'tu creador es', 'en benavente'],
                parameters: [],
                required: []
            },
            general: {
                keywords: ['cu√°l es tu nombre', 'cual es tu nombre', 'c√≥mo te llamas', 'como te llamas', 'qu√© edad tienes', 'que edad tienes', 'd√≥nde vives', 'donde vives', 'qu√© hora es', 'que hora es', 'en benavente'],
                parameters: [],
                required: []
            },
            out_of_scope: {
                keywords: ['en benavente'],
                parameters: [],
                required: []
            }
        };

        // Mapeo de periodos
        const periodMap = {
            'hoy': { type: 'day', value: 1, unit: 'day' },
            'ayer': { type: 'day', value: 1, unit: 'day', offset: 1 },
            '√∫ltimas 24 horas': { type: 'hour', value: 24, unit: 'hour' },
            '√∫ltimas 12 horas': { type: 'hour', value: 12, unit: 'hour' },
            'esta ma√±ana': { type: 'morning', value: 1, unit: 'day' },
            'esta tarde': { type: 'afternoon', value: 1, unit: 'day' },
            'esta noche': { type: 'night', value: 1, unit: 'day' },
            'esta semana': { type: 'week', value: 1, unit: 'week' },
            'esta semana pasada': { type: 'week', value: 1, unit: 'week', offset: 1 },
            '√∫ltimos 7 d√≠as': { type: 'day', value: 7, unit: 'day' },
            '√∫ltimos 14 d√≠as': { type: 'day', value: 14, unit: 'day' },
            '√∫ltimos 30 d√≠as': { type: 'day', value: 30, unit: 'day' },
            'este mes': { type: 'month', value: 1, unit: 'month' },
            'este a√±o': { type: 'year', value: 1, unit: 'year' },
            '√∫ltimo mes': { type: 'month', value: 1, unit: 'month', offset: 1 },
            '√∫ltimo a√±o': { type: 'year', value: 1, unit: 'year', offset: 1 },
            '√∫ltima hora': { type: 'hour', value: 1, unit: 'hour' },
            '√∫ltimas 2 horas': { type: 'hour', value: 2, unit: 'hour' },
            '√∫ltimas 6 horas': { type: 'hour', value: 6, unit: 'hour' },
            'esta semana': { type: 'week', value: 1, unit: 'week' },
            'esta semana anterior': { type: 'week', value: 1, unit: 'week', offset: 1 },
            'este mes': { type: 'month', value: 1, unit: 'month' },
            'este mes pasado': { type: 'month', value: 1, unit: 'month', offset: 1 },
            'este a√±o': { type: 'year', value: 1, unit: 'year' },
            'este a√±o pasado': { type: 'year', value: 1, unit: 'year', offset: 1 }
        };

        // Sistema de an√°lisis sem√°ntico mejorado
        const semanticAnalysis = {
            // Analiza el dominio de la pregunta
            analyzeDomain: (text) => {
                const weatherKeywords = [
                    'temperatura', 'calor', 'fr√≠o', 'frio', 'grados', 
                    'humedad', 'agua', 'presi√≥n', 'atmosf√©rica', 'barom√©trica',
                    'lluvia', 'precipitaci√≥n', 'viento', 'r√°fagas', 'gas',
                    'calidad del aire', 'direcci√≥n', 'clima', 'meteorol√≥gico',
                    'meteorologico', 'tiempo', 'nublado', 'soleado', 'nubes',
                    'nuboso', 'llovizna', 'tormenta', 'nublados', 'soleados',
                    'nubosos', 'tormentas', 'lluvias', 'vientos', 'r√°fagas',
                    'caluroso', 'frio', 'fr√≠o', 'caliente', 'templado',
                    'h√∫medo', 'seco', 'h√∫medos', 'secos', 'presi√≥n',
                    'bar√≥metro', 'pluvi√≥metro', 'anem√≥metro', 'term√≥metro',
                    'meteorolog√≠a', 'clim√°tico', 'clim√°ticos', 'clim√°ticas',
                    'climatolog√≠a', 'pron√≥stico', 'pronostico', 'predicci√≥n',
                    'prediccion', 'previsi√≥n', 'prevision', 'estacional',
                    'estaciones', 'primavera', 'verano', 'oto√±o', 'invierno',
                    'norte', 'sur', 'este', 'oeste', 'cardinales', 'brisa',
                    'cicl√≥n', 'hurac√°n', 'tornado', 'tornados', 'ciclones',
                    'huracanes', 'tormenta', 'tormentas', 'lluvia', 'lluvias',
                    'nublado', 'nublados', 'nuboso', 'nubosos', 'soleado',
                    'soleados', 'despejado', 'despejados', 'nublaci√≥n',
                    'nublaciones', 'precipitaci√≥n', 'precipitaciones', 'humedad',
                    'relativa', 'relativas', 'humedad relativa', 'presi√≥n',
                    'atmosf√©rica', 'atmosf√©ricas', 'presi√≥n atmosf√©rica',
                    'barom√©trica', 'barom√©tricas', 'presi√≥n barom√©trica',
                    'viento', 'vientos', 'r√°faga', 'r√°fagas', 'direcci√≥n',
                    'direcciones', 'direcci√≥n del viento', 'velocidad',
                    'velocidades', 'velocidad del viento', 'anem√≥metro',
                    'term√≥metro', 'pluvi√≥metro', 'bar√≥metro', 'higr√≥metro',
                    'gas', 'gases', 'calidad del aire', 'contaminaci√≥n',
                    'contaminacion', 'pm2.5', 'pm10', 'part√≠culas', 'particulas',
                    'co2', 'di√≥xido de carbono', 'ozono', 'no2', 'so2'
                ];
                
                let matchCount = 0;
                let totalKeywords = 0;
                const normalizedText = text.toLowerCase();
                
                weatherKeywords.forEach(keyword => {
                    if (normalizedText.includes(keyword)) {
                        matchCount++;
                    }
                    totalKeywords++;
                });
                
                // Calcular confianza basada en la proporci√≥n de coincidencias
                const confidence = Math.min(1.0, matchCount / Math.max(1, totalKeywords * 0.15));
                
                // Si encontramos al menos 1 palabra clave meteorol√≥gica, es una pregunta sobre clima
                return {
                    isWeatherQuestion: matchCount > 0,
                    confidence: confidence,
                    matchCount: matchCount,
                    totalKeywords: totalKeywords
                };
            },
            
            // Identifica entidades en el texto
            identifyEntities: (text) => {
                const entities = {
                    parameters: [],
                    periods: [],
                    locations: [],
                    numbers: [],
                    comparisons: [],
                    operations: [],
                    general: []
                };
                
                const normalizedText = text.toLowerCase();
                
                // Verificar si menciona Benavente
                if (normalizedText.includes('benavente')) {
                    entities.locations.push('benavente');
                }
                
                // Identificar par√°metros meteorol√≥gicos
                Object.keys(weatherSynonyms).forEach(param => {
                    // Verificar el par√°metro principal
                    if (normalizedText.includes(param)) {
                        entities.parameters.push(param);
                    }
                    
                    // Verificar sin√≥nimos
                    weatherSynonyms[param].forEach(synonym => {
                        if (normalizedText.includes(synonym)) {
                            entities.parameters.push(param);
                        }
                    });
                });
                
                // Identificar periodos
                Object.keys(periodMap).forEach(period => {
                    if (normalizedText.includes(period)) {
                        entities.periods.push(period);
                    }
                });
                
                // Identificar n√∫meros
                const numberMatches = text.match(/\d+/g);
                if (numberMatches) {
                    entities.numbers = numberMatches.map(num => parseInt(num));
                }
                
                // Identificar comparaciones
                if (normalizedText.includes('vs') || normalizedText.includes('versus')) {
                    entities.comparisons.push('vs');
                }
                if (normalizedText.includes('tendencia') || normalizedText.includes('evoluci√≥n')) {
                    entities.comparisons.push('trend');
                }
                if (normalizedText.includes('correlaci√≥n') || normalizedText.includes('relaci√≥n')) {
                    entities.comparisons.push('correlation');
                }
                
                // Identificar operaciones
                if (normalizedText.includes('m√°ximo') || normalizedText.includes('maximo')) {
                    entities.operations.push('max');
                }
                if (normalizedText.includes('m√≠nimo') || normalizedText.includes('minimo')) {
                    entities.operations.push('min');
                }
                if (normalizedText.includes('promedio') || normalizedText.includes('media')) {
                    entities.operations.push('average');
                }
                if (normalizedText.includes('diferencia')) {
                    entities.operations.push('difference');
                }
                
                // Identificar t√©rminos generales
                Object.keys(generalTerms).forEach(term => {
                    if (term === 'outOfScope') return;
                    
                    // Verificar el t√©rmino principal
                    if (normalizedText.includes(term)) {
                        entities.general.push(term);
                    }
                    
                    // Verificar sin√≥nimos
                    if (Array.isArray(generalTerms[term])) {
                        generalTerms[term].forEach(synonym => {
                            if (normalizedText.includes(synonym)) {
                                entities.general.push(term);
                            }
                        });
                    }
                });
                
                // Identificar preguntas fuera del √°mbito
                Object.keys(generalTerms.outOfScope).forEach(domain => {
                    generalTerms.outOfScope[domain].forEach(keyword => {
                        if (normalizedText.includes(keyword)) {
                            entities.general.push(`outOfScope_${domain}`);
                        }
                    });
                });
                
                // Eliminar duplicados
                entities.parameters = [...new Set(entities.parameters)];
                entities.periods = [...new Set(entities.periods)];
                entities.comparisons = [...new Set(entities.comparisons)];
                entities.operations = [...new Set(entities.operations)];
                entities.general = [...new Set(entities.general)];
                
                return entities;
            },
            
            // Analiza la intenci√≥n del usuario
            analyzeIntent: (text, entities, domainAnalysis) => {
                let bestIntent = null;
                let highestConfidence = 0;
                
                // Analizar cada posible intenci√≥n
                Object.keys(intentMap).forEach(intentType => {
                    const intent = intentMap[intentType];
                    let confidence = 0;
                    
                    // Calcular coincidencia con palabras clave
                    intent.keywords.forEach(keyword => {
                        if (text.toLowerCase().includes(keyword)) {
                            confidence += 0.2;
                        }
                    });
                    
                    // Aumentar confianza si se encontraron par√°metros relevantes
                    if (entities.parameters.length > 0 && intent.parameters.length > 0) {
                        const commonParams = entities.parameters.filter(p => intent.parameters.includes(p));
                        confidence += commonParams.length * 0.15;
                    }
                    
                    // Aumentar confianza si se encontraron periodos y la intenci√≥n los requiere
                    if (intent.required.includes('period') && entities.periods.length > 0) {
                        confidence += 0.2;
                    }
                    
                    // Aumentar confianza si se encontraron m√∫ltiples periodos y la intenci√≥n los requiere
                    if (intent.required.includes('periods') && entities.periods.length > 1) {
                        confidence += 0.25;
                    }
                    
                    // Aumentar confianza si menciona Benavente
                    if (entities.locations.includes('benavente')) {
                        confidence += 0.1;
                    }
                    
                    // Ajustar confianza seg√∫n el dominio
                    if (intentType !== 'greeting' && intentType !== 'goodbye' && intentType !== 'help') {
                        confidence *= domainAnalysis.confidence;
                    }
                    
                    // Verificar si es la mejor intenci√≥n hasta ahora
                    if (confidence > highestConfidence) {
                        highestConfidence = confidence;
                        bestIntent = {
                            type: intentType,
                            confidence: confidence,
                            parameters: entities.parameters,
                            periods: entities.periods,
                            location: entities.locations
                        };
                    }
                });
                
                // CORRECCI√ìN: Usar semanticAnalysis en lugar de this
                // Si no se encontr√≥ una intenci√≥n clara, verificar saludos, despedidas o ayuda
                if (!bestIntent || highestConfidence < 0.4) {
                    if (semanticAnalysis.isGreeting(text)) {
                        return { type: 'greeting', confidence: 0.9, parameters: [], periods: [], location: ['benavente'] };
                    }
                    if (semanticAnalysis.isGoodbye(text)) {
                        return { type: 'goodbye', confidence: 0.9, parameters: [], periods: [], location: ['benavente'] };
                    }
                    if (semanticAnalysis.isHelpRequest(text)) {
                        return { type: 'help', confidence: 0.8, parameters: [], periods: [], location: ['benavente'] };
                    }
                }
                
                // Si no se encontr√≥ una intenci√≥n clara pero hay t√©rminos generales
                if (!bestIntent && entities.general.length > 0) {
                    for (const generalTerm of entities.general) {
                        if (generalTerm.startsWith('outOfScope_')) {
                            const domain = generalTerm.replace('outOfScope_', '');
                            return {
                                type: 'out_of_scope',
                                confidence: 0.5,
                                domain: domain,
                                parameters: [],
                                periods: [],
                                location: ['benavente']
                            };
                        }
                        
                        // Mapear t√©rminos generales a intenciones
                        const intentMap = {
                            'about_horus': 'about_horus',
                            'support': 'support',
                            'personal': 'personal',
                            'general': 'general'
                        };
                        
                        if (intentMap[generalTerm]) {
                            return {
                                type: intentMap[generalTerm],
                                confidence: 0.6,
                                parameters: [],
                                periods: [],
                                location: ['benavente']
                            };
                        }
                    }
                }
                
                // Si no se encontr√≥ una intenci√≥n clara, pero es meteorol√≥gico
                if (domainAnalysis.isWeatherQuestion && !bestIntent) {
                    if (entities.parameters.length > 0) {
                        return {
                            type: 'current_data',
                            confidence: 0.5,
                            parameters: entities.parameters,
                            periods: ['hoy'],
                            location: ['benavente']
                        };
                    }
                    
                    return {
                        type: 'current_data',
                        confidence: 0.4,
                        parameters: ['temperatura'],
                        periods: ['hoy'],
                        location: ['benavente']
                    };
                }
                
                // Si no se encontr√≥ una intenci√≥n clara y no es meteorol√≥gico
                if (!domainAnalysis.isWeatherQuestion && !bestIntent) {
                    return {
                        type: 'out_of_scope',
                        confidence: 0.3,
                        domain: 'general',
                        parameters: [],
                        periods: [],
                        location: ['benavente']
                    };
                }
                
                return bestIntent || { type: 'unrelated', confidence: 0, parameters: [], periods: [], location: ['benavente'] };
            },
            
            // Verifica si es un saludo
            isGreeting: (text) => {
                const greetings = intentMap.greeting.keywords;
                const normalizedText = text.toLowerCase();
                
                return greetings.some(greeting => normalizedText.includes(greeting));
            },
            
            // Verifica si es una despedida
            isGoodbye: (text) => {
                const goodbyes = intentMap.goodbye.keywords;
                const normalizedText = text.toLowerCase();
                
                return goodbyes.some(goodbye => normalizedText.includes(goodbye));
            },
            
            // Verifica si es una solicitud de ayuda
            isHelpRequest: (text) => {
                const helpKeywords = intentMap.help.keywords;
                const normalizedText = text.toLowerCase();
                
                return helpKeywords.some(keyword => normalizedText.includes(keyword));
            },
            
            // Analiza preguntas compuestas
            analyzeCompoundQuestions: (text) => {
                const compoundIndicators = ['y', 'adem√°s', 'tambi√©n', 'tambien', 'ademas', 'adem√°s de', 'ademas de', 'adem√°s que', 'ademas que'];
                return compoundIndicators.some(indicator => text.toLowerCase().includes(indicator));
            },
            
            // Analiza referencias en el contexto
            analyzeReferences: (text, context) => {
                const references = {
                    parameters: [],
                    temporal: [],
                    spatial: [],
                    location: []
                };
                
                // Analizar an√°foras (referencias a elementos previos)
                if (context.lastParameter && (text.includes('eso') || text.includes('eso es') || text.includes('eso est√°'))) {
                    references.parameters.push(context.lastParameter);
                }
                
                if (context.lastPeriod && (text.includes('entonces') || text.includes('en ese periodo') || text.includes('durante ese tiempo'))) {
                    references.temporal.push(context.lastPeriod);
                }
                
                // Verificar si menciona Benavente
                if (text.toLowerCase().includes('benavente')) {
                    references.location.push('benavente');
                    references.spatial.push('benavente');
                }
                
                return references;
            },
            
            // Resuelve an√°foras usando el contexto
            resolveAnaphora: (text, context) => {
                let resolvedText = text;
                const paramName = context.lastParameter || 'temperatura';
                
                // Reemplazar "eso" si hay contexto de par√°metro
                if (context.lastParameter) {
                    resolvedText = resolvedText.replace(/eso/g, paramName);
                    resolvedText = resolvedText.replace(/eso es/g, `${paramName} es`);
                    resolvedText = resolvedText.replace(/eso est√°/g, `${paramName} est√°`);
                }
                
                // Reemplazar "hoy" si hay contexto temporal
                if (context.temporalContext && (text.includes('ayer') || text.includes('ma√±ana'))) {
                    // Si el contexto es "hoy", y pregunta sobre "ayer", ajustamos
                    if (context.temporalContext === 'today' && text.includes('ayer')) {
                        resolvedText = resolvedText.replace(/ayer/g, 'hace un d√≠a');
                    }
                }
                
                // A√±adir "en Benavente" si no est√° presente pero es relevante
                if (!resolvedText.toLowerCase().includes('benavente') && 
                    !resolvedText.toLowerCase().includes('aqu√≠') &&
                    !resolvedText.toLowerCase().includes('en esta zona')) {
                    resolvedText += " en Benavente";
                }
                
                // Mejora: Reemplazar "la" + sustantivo por el par√°metro espec√≠fico
                if (context.lastParameter) {
                    const paramReplacements = {
                        'temp': ['la temperatura', 'el term√≥metro', 'los grados', 'el calor', 'el fr√≠o'],
                        'humedad': ['la humedad', 'el vapor', 'el agua'],
                        'presi√≥n': ['la presi√≥n', 'la atmosf√©rica', 'la barom√©trica'],
                        'lluvia': ['la lluvia', 'la precipitaci√≥n', 'el agua'],
                        'viento': ['el viento', 'las r√°fagas', 'la brisa'],
                        'gas': ['el gas', 'la calidad del aire', 'las part√≠culas']
                    };
                    
                    if (paramReplacements[paramName]) {
                        paramReplacements[paramName].forEach(replacement => {
                            resolvedText = resolvedText.replace(new RegExp(replacement, 'gi'), paramName);
                        });
                    }
                }
                
                return resolvedText;
            },
            
            // Analiza preguntas hipot√©ticas
            analyzeHypotheticals: (text) => {
                const hypotheticalIndicators = ['si', 'supongamos que', 'imagina que', 'qu√© pasar√≠a si', 'que pasaria si', 'que pasar√≠a si'];
                return hypotheticalIndicators.some(indicator => text.toLowerCase().includes(indicator));
            }
        };

        // Diccionario de t√©rminos generales
        const generalTerms = {
            // Sistema Horus
            horus: ['horus', 'sistema horus', 'estaci√≥n horus', 'estacion horus', 'estaci√≥n meteorol√≥gica', 'estacion meteorologica', 'sistema meteorol√≥gico', 'sistema meteorologico', 'horus en benavente'],
            
            // Informaci√≥n general
            about: ['qu√© es', 'que es', 'qu√© es esto', 'que es esto', 'para qu√© sirve', 'para que sirve', 'qu√© hace', 'que hace', 'funciona', 'c√≥mo funciona', 'como funciona', 'sobre benavente'],
            
            // Ayuda
            help: ['ayuda', 'funciona', 'c√≥mo', 'como', 'puedo', 'capaz', 'hacer', 'qu√©', 'que', 'preguntar', 'instrucciones', 'ejemplo', 'ejemplos', 'gu√≠a', 'manual', 'tutorial', 'ayuda en benavente'],
            
            // Saludos
            greeting: ['hola', 'buenos d√≠as', 'buenos dias', 'buenas tardes', 'hey', 'saludos', 'buen d√≠a', 'buen dia', 'buenas noches', 'que tal', 'como estas', 'c√≥mo est√°s', 'hola benavente'],
            
            // Despedidas
            goodbye: ['adi√≥s', 'adios', 'gracias', 'chao', 'hasta luego', 'hasta pronto', 'nos vemos', 'bye', 'grac√≠as', 'gracias', 'fue √∫til', 'fue util', 'adios benavente'],
            
            // Soporte t√©cnico
            support: ['problema', 'error', 'no funciona', 'fallo', 'bug', 'no carga', 'lento', 'lentitud', 'lenta', 'lento', 'no responde', 'no me deja', 'no puedo', 'problemas en benavente'],
            
            // Informaci√≥n personal
            personal: ['qui√©n eres', 'quien eres', 'qui√©n eres t√∫', 'quien eres tu', 'qui√©n te hizo', 'quien te hizo', 'qui√©n te cre√≥', 'quien te creo', 'tu creador', 'tu creador es', 'quien eres en benavente'],
            
            // Preguntas generales
            general: ['cu√°l es tu nombre', 'cual es tu nombre', 'c√≥mo te llamas', 'como te llamas', 'qu√© edad tienes', 'que edad tienes', 'd√≥nde vives', 'donde vives', 'qu√© hora es', 'que hora es', 'clima benavente'],
            
            // Soporte para preguntas fuera del √°mbito
            outOfScope: {
                salud: ['salud', 'm√©dico', 'doctor', 'enfermedad', 'enfermo', 'hospital', 'farmacia', 'medicina', 'medicamento', 'cura', 'salud en benavente'],
                tecnolog√≠a: ['tecnolog√≠a', 'tecnologia', 'computadora', 'ordenador', 'pc', 'laptop', 'smartphone', 'm√≥vil', 'celular', 'internet', 'wifi', 'redes', 'tecnologia en benavente'],
                deportes: ['deportes', 'f√∫tbol', 'futbol', 'baloncesto', 'tenis', 'golf', 'atletismo', 'deporte', 'equipo', 'partido', 'liga', 'deportes en benavente'],
                entretenimiento: ['entretenimiento', 'pel√≠cula', 'pelicula', 'cine', 'm√∫sica', 'musica', 'canci√≥n', 'cancion', 'serie', 'televisi√≥n', 'tv', 'entretenimiento en benavente'],
                comida: ['comida', 'receta', 'cocina', 'plato', 'platos', 'cocinar', 'comer', 'restaurante', 'recetas', 'recetario', 'comida en benavente'],
                educaci√≥n: ['educaci√≥n', 'educacion', 'escuela', 'colegio', 'universidad', 'clase', 'clases', 'estudio', 'estudiar', 'profesor', 'educacion en benavente'],
                finanzas: ['finanzas', 'dinero', 'banco', 'cuenta', 'tarjeta', 'cr√©dito', 'credito', 'ahorro', 'inversi√≥n', 'inversion', 'finanzas en benavente']
            }
        };

        // Obtener el nombre de la direcci√≥n del viento
        const getWindDirectionName = (degrees) => {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(degrees % 360 / 22.5) % 16;
            return directions[index];
        };

        // Manejadores de intenciones
        const intentHandlers = {
            current_ (entities, context) => {
                // Si no hay par√°metros espec√≠ficos, usar el √∫ltimo par√°metro mencionado o uno por defecto
                let parameters = entities.parameters.length > 0 ? entities.parameters : 
                                (context.lastParameter ? [context.lastParameter] : ['temperatura']);
                
                // Actualizar contexto
                conversationContext.lastParameter = parameters[0];
                conversationContext.lastQuestionType = 'current_data';
                
                // Obtener el dato actual
                const latestData = historicalData[historicalData.length - 1];
                let response = '';
                
                parameters.forEach(param => {
                    let value, unit;
                    switch(param) {
                        case 'temperatura':
                            value = latestData.temp;
                            unit = '¬∞C';
                            break;
                        case 'humedad':
                            value = latestData.hum;
                            unit = '%';
                            break;
                        case 'presi√≥n':
                            value = latestData.pres;
                            unit = 'hPa';
                            break;
                        case 'lluvia':
                            value = latestData.lluvia ? 1 : 0;
                            unit = latestData.lluvia ? 'lloviendo' : 'sin lluvia';
                            break;
                        case 'viento':
                            value = latestData.wind;
                            unit = 'm/s';
                            break;
                        case 'gas':
                            value = latestData.gas;
                            unit = 'kŒ©';
                            break;
                        case 'direcci√≥n':
                            value = latestData.wind_dir;
                            unit = '¬∞';
                            break;
                        default:
                            value = latestData.temp;
                            unit = '¬∞C';
                    }
                    
                    // Obtener variaciones para el par√°metro
                    const variations = communicationSystem.getCurrentDataVariations(param, value, unit);
                    
                    // Seleccionar una variaci√≥n aleatoria
                    response += getRandomVariation(variations) + "\n";
                });
                
                // A√±adir an√°lisis contextual si es relevante
                if (parameters.length === 1) {
                    const paramName = parameters[0];
                    let contextAnalysis = '';
                    
                    switch(paramName) {
                        case 'temperatura':
                            if (latestData.temp > 25) {
                                contextAnalysis = `Con esta temperatura en Benavente, podr√≠as considerar usar ropa ligera y mantenerse hidratado. En verano en Benavente, las temperaturas pueden superar los 35¬∞C.`;
                            } else if (latestData.temp < 10) {
                                contextAnalysis = `Con esta temperatura en Benavente, te recomendamos abrigarte adecuadamente para evitar el fr√≠o. En invierno, las temperaturas en Benavente pueden llegar a -5¬∞C.`;
                            } else {
                                contextAnalysis = `La temperatura actual en Benavente est√° dentro de un rango moderado. Benavente tiene un clima mediterr√°neo continentalizado con primaveras y oto√±os agradables.`;
                            }
                            break;
                        case 'humedad':
                            if (latestData.hum > 70) {
                                contextAnalysis = `La alta humedad en Benavente puede hacer que la temperatura se sienta m√°s alta de lo que realmente es. Considera usar ropa transpirable. La humedad promedio en Benavente es del 65%.`;
                            } else if (latestData.hum < 30) {
                                contextAnalysis = `La baja humedad en Benavente puede causar sequedad en la piel y las v√≠as respiratorias. Considera usar humectante y mantenerte hidratado. Esto es menos com√∫n en Benavente, que tiene una humedad promedio del 65%.`;
                            } else {
                                contextAnalysis = `La humedad actual en Benavente est√° cerca del promedio t√≠pico de la zona (65%). Benavente tiene un clima mediterr√°neo continentalizado con humedad moderada.`;
                            }
                            break;
                        case 'presi√≥n':
                            if (latestData.pres < 1000) {
                                contextAnalysis = `La presi√≥n atmosf√©rica baja en Benavente suele indicar condiciones clim√°ticas inestables. Considera que Benavente est√° a ${benaventeInfo.altitude} sobre el nivel del mar, lo que afecta la presi√≥n atmosf√©rica.`;
                            } else if (latestData.pres > 1020) {
                                contextAnalysis = `La presi√≥n atmosf√©rica alta en Benavente suele indicar condiciones clim√°ticas estables y buen tiempo. Es un buen momento para actividades al aire libre. Benavente tiene una presi√≥n atmosf√©rica promedio de alrededor de 1010 hPa debido a su altitud de ${benaventeInfo.altitude}.`;
                            } else {
                                contextAnalysis = `La presi√≥n atmosf√©rica en Benavente est√° en un nivel normal para su altitud (${benaventeInfo.altitude}). Benavente se encuentra en la llanura del Duero, lo que influye en sus patrones de presi√≥n.`;
                            }
                            break;
                    }
                    
                    if (contextAnalysis) {
                        response += `\n${contextAnalysis}`;
                    }
                    
                    response += `\n\n¬øTe gustar√≠a ver un an√°lisis hist√≥rico de ${paramName} en Benavente o una predicci√≥n para los pr√≥ximos d√≠as?`;
                }
                
                return response.trim();
            },
            
            historical_trend: (entities, context) => {
                // Determinar el periodo
                let period = entities.periods.length > 0 ? entities.periods[0] : 
                            (context.lastPeriod ? context.lastPeriod : '√∫ltimos 7 d√≠as');
                
                // Actualizar contexto
                conversationContext.lastPeriod = period;
                conversationContext.lastQuestionType = 'historical_trend';
                
                // Obtener datos para el periodo
                const periodInfo = periodMap[period] || periodMap['√∫ltimos 7 d√≠as'];
                const now = new Date();
                let startDate;
                
                if (periodInfo.type === 'day') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - periodInfo.value);
                } else if (periodInfo.type === 'week') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - (periodInfo.value * 7));
                } else if (periodInfo.type === 'month') {
                    startDate = new Date(now);
                    startDate.setMonth(now.getMonth() - periodInfo.value);
                }
                
                // Si no hay par√°metros espec√≠ficos, usar el √∫ltimo par√°metro mencionado o uno por defecto
                let parameters = entities.parameters.length > 0 ? entities.parameters : 
                                (context.lastParameter ? [context.lastParameter] : ['temperatura']);
                
                // Preparar datos para el gr√°fico
                const chartData = historicalData
                    .filter(data => new Date(data.timestamp) >= startDate)
                    .map(data => ({
                        x: new Date(data.timestamp),
                        y: data[parameters[0] === 'presi√≥n' ? 'pres' : 
                            parameters[0] === 'lluvia' ? 'lluvia' : 
                            parameters[0]]
                    }));
                
                // Calcular estad√≠sticas
                const values = chartData.map(item => item.y);
                const avg = values.reduce((a, b) => a + b, 0) / values.length;
                const min = Math.min(...values);
                const max = Math.max(...values);
                
                // Determinar tendencia
                const startValue = values[0];
                const endValue = values[values.length - 1];
                const trend = endValue > startValue ? "ascendente" : "descendente";
                const trendStrength = Math.abs(endValue - startValue) / startValue;
                
                // Generar la respuesta basada en el an√°lisis de los datos
                const variations = communicationSystem.getTrendAnalysisVariations(
                    parameters[0], 
                    avg, 
                    min, 
                    max, 
                    trend, 
                    trendStrength, 
                    period
                );
                
                const response = getRandomVariation(variations);
                
                // A√±ade un gr√°fico de an√°lisis
                const chartId = `prediction-chart-${Date.now()}`;
                const chartResponse = `
                    <div class="prediction-chart-container">
                        <div class="chart-title">Tendencia de ${parameters[0]} en ${benaventeInfo.location} durante ${period}</div>
                        <canvas class="prediction-chart" id="${chartId}" 
                                data-parameter="${parameters[0]}" 
                                data-chart-data='${JSON.stringify(chartData)}'></canvas>
                    </div>
                `;
                
                return response + chartResponse;
            },
            
            prediction: (entities, context) => {
                // Si no hay par√°metros espec√≠ficos, usar el √∫ltimo par√°metro mencionado o uno por defecto
                let parameters = entities.parameters.length > 0 ? entities.parameters : 
                                (context.lastParameter ? [context.lastParameter] : ['temperatura']);
                
                // Actualizar contexto
                conversationContext.lastParameter = parameters[0];
                conversationContext.lastQuestionType = 'prediction';
                
                // Generar datos de predicci√≥n simulados
                const predictionData = [];
                const now = new Date();
                const latestData = historicalData[historicalData.length - 1];
                
                for (let i = 0; i < 5; i++) {
                    const date = new Date(now);
                    date.setDate(now.getDate() + i);
                    
                    let value;
                    switch(parameters[0]) {
                        case 'temperatura':
                            // Simular patrones clim√°ticos de Benavente (clima mediterr√°neo continentalizado)
                            value = latestData.temp + (Math.random() - 0.5) * 3;
                            // Ajustar seg√∫n estaci√≥n del a√±o
                            const month = now.getMonth();
                            if (month >= 5 && month <= 8) { // Verano
                                value = Math.min(35, Math.max(15, value));
                            } else if (month >= 11 || month <= 2) { // Invierno
                                value = Math.min(15, Math.max(-5, value));
                            }
                            break;
                        case 'humedad':
                            value = latestData.hum + (Math.random() - 0.5) * 10;
                            value = Math.min(100, Math.max(20, value)); // Limitar rango realista
                            break;
                        case 'presi√≥n':
                            value = latestData.pres + (Math.random() - 0.5) * 3;
                            value = Math.min(1030, Math.max(980, value)); // Rango realista para Benavente
                            break;
                        case 'viento':
                            value = latestData.wind + (Math.random() - 0.5) * 2;
                            value = Math.min(20, Math.max(1, value)); // Limitar velocidad del viento
                            break;
                        default:
                            value = latestData.temp + (Math.random() - 0.5) * 3;
                    }
                    
                    predictionData.push({
                        x: date,
                        y: value
                    });
                }
                
                // Determinar la tendencia de las predicciones
                const trend = predictionData[predictionData.length - 1].y > predictionData[0].y ?
                            'aumentando' : (predictionData[predictionData.length - 1].y < predictionData[0].y ? 'disminuyendo' : 'estable');
                
                // Calcular confiabilidad (simulaci√≥n)
                const reliability = 0.7 + Math.random() * 0.25;
                
                // Generar la respuesta basada en el an√°lisis de los datos
                const variations = communicationSystem.getPredictionVariations(
                    parameters[0],
                    reliability,
                    '5 d√≠as'
                );
                
                const response = getRandomVariation(variations);
                
                // A√±ade un gr√°fico de predicci√≥n
                const chartId = `prediction-chart-${Date.now()}`;
                const chartResponse = `
                    <div class="prediction-container">
                        <div class="prediction-reliability">
                            Confiabilidad de la predicci√≥n: ${(reliability * 100).toFixed(0)}% 
                            <div class="reliability-bar">
                                <div class="reliability-fill" style="width: ${(reliability * 100).toFixed(0)}%"></div>
                            </div>
                        </div>
                        <div class="prediction-chart-container">
                            <div class="chart-title">Predicci√≥n de ${parameters[0]} para los pr√≥ximos 5 d√≠as en ${benaventeInfo.location}</div>
                            <canvas class="prediction-chart" id="${chartId}" 
                                    data-parameter="${parameters[0]}" 
                                    data-chart-data='${JSON.stringify(predictionData)}'></canvas>
                        </div>
                    </div>
                `;
                
                return response + chartResponse;
            },
            
            comparison: (entities, context) => {
                // Necesitamos al menos dos periodos para comparar
                if (entities.periods.length < 2) {
                    return "Para hacer una comparaci√≥n necesito dos periodos. Por ejemplo: 'Compara la temperatura de esta semana con la semana pasada en Benavente'.";
                }
                
                const period1 = entities.periods[0];
                const period2 = entities.periods[1];
                
                // Actualizar contexto
                conversationContext.lastPeriod = period1;
                conversationContext.lastQuestionType = 'comparison';
                
                // Si no hay par√°metros espec√≠ficos, usar el √∫ltimo par√°metro mencionado o uno por defecto
                let parameters = entities.parameters.length > 0 ? entities.parameters : 
                                (context.lastParameter ? [context.lastParameter] : ['temperatura']);
                
                // Obtener datos para ambos periodos
                const periodInfo1 = periodMap[period1] || periodMap['esta semana'];
                const periodInfo2 = periodMap[period2] || periodMap['√∫ltimos 7 d√≠as'];
                
                const now = new Date();
                let startDate1, startDate2;
                
                // Calcular fechas de inicio para ambos periodos
                if (periodInfo1.type === 'day') {
                    startDate1 = new Date(now);
                    startDate1.setDate(now.getDate() - periodInfo1.value);
                } else if (periodInfo1.type === 'week') {
                    startDate1 = new Date(now);
                    startDate1.setDate(now.getDate() - (periodInfo1.value * 7));
                } else if (periodInfo1.type === 'month') {
                    startDate1 = new Date(now);
                    startDate1.setMonth(now.getMonth() - periodInfo1.value);
                }
                
                if (periodInfo2.type === 'day') {
                    startDate2 = new Date(now);
                    startDate2.setDate(now.getDate() - periodInfo2.value);
                } else if (periodInfo2.type === 'week') {
                    startDate2 = new Date(now);
                    startDate2.setDate(now.getDate() - (periodInfo2.value * 7));
                } else if (periodInfo2.type === 'month') {
                    startDate2 = new Date(now);
                    startDate2.setMonth(now.getMonth() - periodInfo2.value);
                }
                
                // Obtener datos para ambos periodos
                const data1 = historicalData.filter(data => new Date(data.timestamp) >= startDate1);
                const data2 = historicalData.filter(data => new Date(data.timestamp) >= startDate2);
                
                // Calcular promedios
                const avg1 = data1.reduce((sum, item) => sum + item[parameters[0] === 'presi√≥n' ? 'pres' : 
                                        parameters[0] === 'lluvia' ? 'lluvia' : 
                                        parameters[0]], 0) / data1.length;
                const avg2 = data2.reduce((sum, item) => sum + item[parameters[0] === 'presi√≥n' ? 'pres' : 
                                        parameters[0] === 'lluvia' ? 'lluvia' : 
                                        parameters[0]], 0) / data2.length;
                
                // Calcular porcentaje de cambio
                const changePercent = ((avg1 - avg2) / avg2) * 100;
                
                // Generar la respuesta basada en el an√°lisis de los datos
                const variations = communicationSystem.getComparisonVariations(
                    parameters[0],
                    avg1,
                    avg2,
                    period1,
                    period2,
                    changePercent
                );
                
                const response = getRandomVariation(variations);
                
                // Contexto espec√≠fico de Benavente
                response += `\n\nEn ${benaventeInfo.location}, ubicado a ${benaventeInfo.altitude} sobre el nivel del mar, `;
                
                if (parameters[0] === 'temperatura') {
                    response += `las temperaturas suelen variar seg√∫n la estaci√≥n del a√±o. `;
                    response += `El clima mediterr√°neo continentalizado de Benavente presenta veranos calurosos e inviernos fr√≠os.`;
                } else if (parameters[0] === 'humedad') {
                    response += `la humedad promedio es del 65%, con variaciones seg√∫n la √©poca del a√±o.`;
                } else if (parameters[0] === 'presi√≥n') {
                    response += `la presi√≥n atmosf√©rica se ve afectada por la altitud (${benaventeInfo.altitude}), `;
                    response += `resultando en valores ligeramente menores que en el nivel del mar.`;
                }
                
                // Preparar datos para el gr√°fico comparativo
                const chartData1 = data1.map(data => ({
                    x: new Date(data.timestamp),
                    y: data[parameters[0] === 'presi√≥n' ? 'pres' : 
                        parameters[0] === 'lluvia' ? 'lluvia' : 
                        parameters[0]]
                }));
                
                const chartData2 = data2.map(data => ({
                    x: new Date(data.timestamp),
                    y: data[parameters[0] === 'presi√≥n' ? 'pres' : 
                        parameters[0] === 'lluvia' ? 'lluvia' : 
                        parameters[0]]
                }));
                
                // A√±ade un gr√°fico comparativo
                const chartId = `comparison-chart-${Date.now()}`;
                const chartResponse = `
                    <div class="comparison-chart-container">
                        <div class="chart-title">Comparaci√≥n de ${parameters[0]}: ${period1} vs ${period2} en ${benaventeInfo.location}</div>
                        <canvas class="comparison-chart" id="${chartId}" 
                                data-parameter="${parameters[0]}" 
                                data-chart-data1='${JSON.stringify(chartData1)}'
                                data-chart-data2='${JSON.stringify(chartData2)}'
                                data-period1="${period1}"
                                data-period2="${period2}"></canvas>
                    </div>
                `;
                
                return response + chartResponse;
            },
            
            max_min: (entities, context) => {
                // Determinar el periodo
                let period = entities.periods.length > 0 ? entities.periods[0] : 
                            (context.lastPeriod ? context.lastPeriod : '√∫ltimos 7 d√≠as');
                
                // Actualizar contexto
                conversationContext.lastPeriod = period;
                conversationContext.lastQuestionType = 'max_min';
                
                // Obtener datos para el periodo
                const periodInfo = periodMap[period] || periodMap['√∫ltimos 7 d√≠as'];
                const now = new Date();
                let startDate;
                
                if (periodInfo.type === 'day') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - periodInfo.value);
                } else if (periodInfo.type === 'week') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - (periodInfo.value * 7));
                } else if (periodInfo.type === 'month') {
                    startDate = new Date(now);
                    startDate.setMonth(now.getMonth() - periodInfo.value);
                }
                
                // Si no hay par√°metros espec√≠ficos, usar el √∫ltimo par√°metro mencionado o uno por defecto
                let parameters = entities.parameters.length > 0 ? entities.parameters : 
                                (context.lastParameter ? [context.lastParameter] : ['temperatura']);
                
                // Obtener datos para el periodo
                const periodData = historicalData.filter(data => new Date(data.timestamp) >= startDate);
                
                // Encontrar m√°ximos y m√≠nimos
                let max = -Infinity;
                let min = Infinity;
                let maxDate, minDate;
                
                periodData.forEach(data => {
                    const value = data[parameters[0] === 'presi√≥n' ? 'pres' : 
                                    parameters[0] === 'lluvia' ? 'lluvia' : 
                                    parameters[0]];
                                    
                    if (value > max) {
                        max = value;
                        maxDate = data.timestamp;
                    }
                    
                    if (value < min) {
                        min = value;
                        minDate = data.timestamp;
                    }
                });
                
                // Generar respuesta
                let response = `En ${period} en ${benaventeInfo.location}, el valor m√°ximo de ${parameters[0]} fue de ${max.toFixed(2)}`;
                
                if (parameters[0] !== 'lluvia' && parameters[0] !== 'direcci√≥n') {
                    response += ` ${parameters[0] === 'presi√≥n' ? 'hPa' : 
                                parameters[0] === 'humedad' ? '%' : 
                                '¬∞C'}`;
                }
                
                response += ` registrado el ${new Date(maxDate).toLocaleDateString('es-ES', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                })}.\n\n`;
                
                response += `El valor m√≠nimo fue de ${min.toFixed(2)}`;
                
                if (parameters[0] !== 'lluvia' && parameters[0] !== 'direcci√≥n') {
                    response += ` ${parameters[0] === 'presi√≥n' ? 'hPa' : 
                                parameters[0] === 'humedad' ? '%' : 
                                '¬∞C'}`;
                }
                
                response += ` registrado el ${new Date(minDate).toLocaleDateString('es-ES', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                })}.`;
                
                // Contexto espec√≠fico de Benavente
                response += `\n\n${benaventeInfo.location}, ubicado a ${benaventeInfo.altitude} sobre el nivel del mar, `;
                
                if (parameters[0] === 'temperatura') {
                    response += `tiene un clima mediterr√°neo continentalizado con temperaturas que pueden variar `;
                    response += `desde -5¬∞C en invierno hasta m√°s de 35¬∞C en verano.`;
                } else if (parameters[0] === 'humedad') {
                    response += `tiene una humedad promedio del 65%, con valores m√°s altos en primavera y oto√±o.`;
                } else if (parameters[0] === 'presi√≥n') {
                    response += `tiene una presi√≥n atmosf√©rica promedio de alrededor de 1010 hPa debido a su altitud.`;
                }
                
                // Preparar datos para el gr√°fico
                const chartData = historicalData
                    .filter(data => new Date(data.timestamp) >= startDate)
                    .map(data => ({
                        x: new Date(data.timestamp),
                        y: data[parameters[0] === 'presi√≥n' ? 'pres' : 
                            parameters[0] === 'lluvia' ? 'lluvia' : 
                            parameters[0]]
                    }));
                
                // A√±ade un gr√°fico con marcadores de m√°ximos y m√≠nimos
                const chartId = `extremes-chart-${Date.now()}`;
                const chartResponse = `
                    <div class="extremes-chart-container">
                        <div class="chart-title">Valores extremos de ${parameters[0]} en ${benaventeInfo.location} durante ${period}</div>
                        <canvas class="extremes-chart" id="${chartId}" 
                                data-parameter="${parameters[0]}" 
                                data-chart-data='${JSON.stringify(chartData)}'
                                data-max-date="${maxDate}"
                                data-min-date="${minDate}"></canvas>
                    </div>
                `;
                
                return response + chartResponse;
            },
            
            correlation: (entities, context) => {
                try {
                    // Necesitamos al menos dos par√°metros para analizar correlaci√≥n
                    if (entities.parameters.length < 2) {
                        return "Para analizar correlaci√≥n necesito dos par√°metros meteorol√≥gicos. Por ejemplo: '¬øC√≥mo se relaciona la temperatura con la humedad en Benavente?'";
                    }
                    
                    const parameter1 = entities.parameters[0];
                    const parameter2 = entities.parameters[1];
                    
                    // Actualizar contexto
                    conversationContext.lastParameter = parameter1;
                    conversationContext.lastQuestionType = 'correlation';
                    
                    // Obtener datos para el periodo (usar √∫ltimos 30 d√≠as por defecto)
                    const now = new Date();
                    const startDate = new Date(now);
                    startDate.setDate(now.getDate() - 30);
                    
                    const periodData = historicalData.filter(data => new Date(data.timestamp) >= startDate);
                    
                    // Calcular correlaci√≥n
                    const values1 = periodData.map(data => 
                        data[parameter1 === 'presi√≥n' ? 'pres' : 
                            parameter1 === 'lluvia' ? 'lluvia' : 
                            parameter1]
                    );
                    
                    const values2 = periodData.map(data => 
                        data[parameter2 === 'presi√≥n' ? 'pres' : 
                            parameter2 === 'lluvia' ? 'lluvia' : 
                            parameter2]
                    );
                    
                    // Calcular media
                    const mean1 = values1.reduce((a, b) => a + b, 0) / values1.length;
                    const mean2 = values2.reduce((a, b) => a + b, 0) / values2.length;
                    
                    // Calcular covarianza y desviaci√≥n est√°ndar
                    let covariance = 0;
                    let stdDev1 = 0;
                    let stdDev2 = 0;
                    
                    for (let i = 0; i < values1.length; i++) {
                        const diff1 = values1[i] - mean1;
                        const diff2 = values2[i] - mean2;
                        
                        covariance += diff1 * diff2;
                        stdDev1 += diff1 * diff1;
                        stdDev2 += diff2 * diff2;
                    }
                    
                    covariance /= values1.length;
                    stdDev1 = Math.sqrt(stdDev1 / values1.length);
                    stdDev2 = Math.sqrt(stdDev2 / values1.length);
                    
                    // Calcular coeficiente de correlaci√≥n de Pearson
                    const correlation = covariance / (stdDev1 * stdDev2);
                    const rSquared = correlation * correlation;
                    
                    // Generar la respuesta basada en el an√°lisis de los datos
                    const variations = communicationSystem.getCorrelationVariations(
                        parameter1,
                        parameter2,
                        correlation,
                        rSquared
                    );
                    
                    const response = getRandomVariation(variations);
                    
                    // Preparar datos para el gr√°fico
                    const chartData = periodData.map((data, index) => ({
                        x: new Date(data.timestamp),
                        y1: data[parameter1 === 'presi√≥n' ? 'pres' : 
                            parameter1 === 'lluvia' ? 'lluvia' : 
                            parameter1],
                        y2: data[parameter2 === 'presi√≥n' ? 'pres' : 
                            parameter2 === 'lluvia' ? 'lluvia' : 
                            parameter2]
                    }));
                    
                    // A√±ade un gr√°fico de correlaci√≥n
                    const chartId = `correlation-chart-${Date.now()}`;
                    const chartResponse = `
                        <div class="prediction-chart-container">
                            <div class="chart-title">Relaci√≥n entre ${parameter1} y ${parameter2} en ${benaventeInfo.location}</div>
                            <canvas class="prediction-chart" id="${chartId}" 
                                    data-parameter1="${parameter1}"
                                    data-parameter2="${parameter2}"
                                    data-chart-data='${JSON.stringify(chartData)}'></canvas>
                        </div>
                    `;
                    
                    return response + chartResponse;
                } catch (error) {
                    console.error('Error en an√°lisis de correlaci√≥n:', error);
                    return "‚ö†Ô∏è Ocurri√≥ un error al analizar la correlaci√≥n. Por favor, intenta nuevamente.";
                }
            },
            
            greeting: () => {
                const variations = communicationSystem.getGreetingVariations();
                return getRandomVariation(variations);
            },
            
            goodbye: () => {
                const variations = communicationSystem.getGoodbyeVariations();
                return getRandomVariation(variations);
            },
            
            help: () => {
                const variations = communicationSystem.getHelpVariations();
                let response = getRandomVariation(variations);
                
                response += `<div class="general-answer">
                    <h3>Preguntas meteorol√≥gicas para Benavente</h3>
                    <ul>
                        <li>"¬øCu√°l es la temperatura actual en Benavente?"</li>
                        <li>"¬øC√≥mo ha sido la tendencia de humedad en Benavente esta semana?"</li>
                        <li>"Muestra la tendencia de presi√≥n de los √∫ltimos 7 d√≠as en Benavente"</li>
                        <li>"¬øC√≥mo se relaciona la humedad con la lluvia en Benavente?"</li>
                        <li>"¬øQu√© tiempo har√° ma√±ana en Benavente?"</li>
                    </ul>
                    
                    <h3>Caracter√≠sticas clim√°ticas de Benavente</h3>
                    <ul>
                        <li>Verano: ${benaventeInfo.typicalWeather.summer}</li>
                        <li>Invierno: ${benaventeInfo.typicalWeather.winter}</li>
                        <li>Primavera: ${benaventeInfo.typicalWeather.spring}</li>
                        <li>Oto√±o: ${benaventeInfo.typicalWeather.autumn}</li>
                    </ul>
                    
                    <h3>Preguntas sobre Horus en Benavente</h3>
                    <ul>
                        <li>"¬øQu√© es Horus en Benavente?"</li>
                        <li>"¬øC√≥mo funciona el sistema Horus en Benavente?"</li>
                        <li>"¬øQu√© sensores tiene Horus en Benavente?"</li>
                        <li>"¬øD√≥nde est√° ubicado Horus en Benavente?"</li>
                    </ul>
                    
                    <p>¬°Hazme cualquier pregunta y har√© lo posible por ayudarte con informaci√≥n espec√≠fica de Benavente!</p>
                </div>`;
                
                return response;
            },
            
            about_horus: () => {
                const variations = communicationSystem.getAboutHorusVariations();
                let response = getRandomVariation(variations);
                
                response += `<div class="system-info">
                    <h3>Caracter√≠sticas principales en Benavente:</h3>
                    <ul>
                        <li>Medici√≥n de temperatura, humedad, presi√≥n atmosf√©rica y direcci√≥n del viento en ${benaventeInfo.location}</li>
                        <li>Sensores de calidad del aire (PM2.5, PM10, CO2) adaptados al clima de Benavente</li>
                        <li>Registro de precipitaciones y velocidad del viento en la llanura del Duero</li>
                        <li>Transmisi√≥n de datos en tiempo real v√≠a MQTT desde ${benaventeInfo.location}</li>
                        <li>Interfaz web para visualizaci√≥n y an√°lisis de datos espec√≠ficos de Benavente</li>
                    </ul>
                    
                    <h3>Caracter√≠sticas clim√°ticas de Benavente relevantes:</h3>
                    <ul>
                        <li><strong>Ubicaci√≥n:</strong> ${benaventeInfo.coordinates}</li>
                        <li><strong>Altitud:</strong> ${benaventeInfo.altitude}</li>
                        <li><strong>Clima:</strong> ${benaventeInfo.climate}</li>
                        <li><strong>Verano:</strong> ${benaventeInfo.typicalWeather.summer}</li>
                        <li><strong>Invierno:</strong> ${benaventeInfo.typicalWeather.winter}</li>
                        <li><strong>Primavera:</strong> ${benaventeInfo.typicalWeather.spring}</li>
                        <li><strong>Oto√±o:</strong> ${benaventeInfo.typicalWeather.autumn}</li>
                    </ul>
                    
                    <p>Horus proporciona datos meteorol√≥gicos precisos para an√°lisis clim√°ticos espec√≠ficos de ${benaventeInfo.location}, predicciones y estudios ambientales adaptados a las caracter√≠sticas de la regi√≥n.</p>
                </div>`;
                
                return response;
            },
            
            support: () => {
                const variations = communicationSystem.getSupportVariations();
                let response = getRandomVariation(variations);
                
                response += `<div class="system-info">
                    <h3>Problemas comunes:</h3>
                    <ul>
                        <li><strong>Datos no actualizados:</strong> Verifica la conexi√≥n de la estaci√≥n Horus en Benavente y espera unos minutos para que se actualicen los datos.</li>
                        <li><strong>Interfaz lenta:</strong> Intenta actualizar la p√°gina o limpiar la cach√© del navegador.</li>
                        <li><strong>Gr√°ficos no visibles:</strong> Aseg√∫rate de que JavaScript est√° habilitado en tu navegador.</li>
                        <li><strong>Error de conexi√≥n:</strong> Verifica tu conexi√≥n a internet y recarga la p√°gina.</li>
                    </ul>
                    
                    <h3>Soluci√≥n de problemas espec√≠ficos de Benavente:</h3>
                    <ol>
                        <li>Recarga la p√°gina (F5 o Ctrl + R)</li>
                        <li>Limpia la cach√© del navegador</li>
                        <li>Intenta con otro navegador (Chrome, Firefox, Edge)</li>
                        <li>Verifica tu conexi√≥n a internet</li>
                        <li>Si los datos parecen inusuales, considera que el clima de Benavente (${benaventeInfo.altitude}) puede causar variaciones espec√≠ficas</li>
                    </ol>
                    
                    <p>Si el problema persiste, contacta al administrador del sistema para obtener ayuda adicional espec√≠fica para ${benaventeInfo.location}.</p>
                </div>`;
                
                return response;
            },
            
            personal: () => {
                const variations = communicationSystem.getPersonalInfoVariations();
                let response = getRandomVariation(variations);
                
                response += `<div class="system-info">
                    <h3>Mis capacidades espec√≠ficas para Benavente:</h3>
                    <ul>
                        <li>Analizar y explicar datos meteorol√≥gicos en tiempo real para ${benaventeInfo.location}</li>
                        <li>Identificar tendencias y patrones clim√°ticos espec√≠ficos de la regi√≥n</li>
                        <li>Realizar predicciones basadas en datos hist√≥ricos de Benavente</li>
                        <li>Explicar el funcionamiento del sistema Horus en Benavente</li>
                        <li>Proporcionar recomendaciones basadas en condiciones clim√°ticas de la zona</li>
                        <li>Contextualizar el clima de Benavente (${benaventeInfo.altitude}) con su ubicaci√≥n en la llanura del Duero</li>
                    </ul>
                    
                    <h3>Caracter√≠sticas clim√°ticas de Benavente que considero:</h3>
                    <ul>
                        <li>Clima mediterr√°neo continentalizado con veranos calurosos e inviernos fr√≠os</li>
                        <li>Altitud de ${benaventeInfo.altitude} que afecta la presi√≥n atmosf√©rica</li>
                        <li>Ubicaci√≥n en la llanura del Duero que influye en los patrones de viento</li>
                        <li>Patrones estacionales t√≠picos de la meseta castellana</li>
                    </ul>
                    
                    <p>Fui creado para facilitar el acceso y comprensi√≥n de los datos meteorol√≥gicos recopilados por la estaci√≥n Horus en Benavente, ayudando a usuarios a tomar decisiones informadas basadas en el clima de la zona.</p>
                    
                    <p>No soy un humano, sino un sistema de inteligencia artificial dise√±ado espec√≠ficamente para an√°lisis meteorol√≥gico y soporte del sistema Horus en ${benaventeInfo.location}.</p>
                </div>`;
                
                return response;
            },
            
            general: () => {
                const variations = communicationSystem.getGeneralInfoVariations();
                let response = getRandomVariation(variations);
                
                const now = new Date();
                response += `<div class="system-info">
                    <h3>Hora actual:</h3>
                    <p>${now.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit'
                    })}</p>
                    
                    <h3>Fecha actual:</h3>
                    <p>${now.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}</p>
                    
                    <p>Estoy alojado en un servidor web y proporciono informaci√≥n meteorol√≥gica espec√≠fica para ${benaventeInfo.location}, ubicado en la llanura del Duero.</p>
                    
                    <p>Fui desarrollado recientemente como parte del sistema Horus para ${benaventeInfo.location}. No tengo una edad en el sentido humano.</p>
                </div>`;
                
                return response;
            },
            
            out_of_scope: (intent) => {
                const domain = intent.domain || 'general';
                
                const variations = communicationSystem.getOutOfScopeVariations(domain);
                let response = getRandomVariation(variations);
                
                // Mensajes personalizados seg√∫n el √°mbito
                const domainMessages = {
                    salud: `<div class="out-of-scope">
                        <h3>Preguntas sobre Salud en Benavente</h3>
                        <p>Para consultas sobre salud:</p>
                        <ul>
                            <li>Contacta a un profesional m√©dico calificado en Benavente</li>
                            <li>Visita el centro de salud de Benavente</li>
                            <li>Consulta fuentes oficiales de salud p√∫blica</li>
                        </ul>
                        <p>La informaci√≥n meteorol√≥gica de ${benaventeInfo.location} puede influir en ciertas condiciones de salud (como alergias estacionales), pero no sustituye el consejo m√©dico profesional.</p>
                        <p class="benavente-context">En Benavente, con su clima mediterr√°neo continentalizado, las temperaturas extremas de verano e invierno pueden requerir precauciones especiales para la salud.</p>
                    </div>`,
                    
                    tecnolog√≠a: `<div class="out-of-scope">
                        <h3>Preguntas sobre Tecnolog√≠a en Benavente</h3>
                        <p>Para consultas sobre tecnolog√≠a:</p>
                        <ul>
                            <li>Consulta foros especializados como Stack Overflow</li>
                            <li>Revisa documentaci√≥n oficial de los productos</li>
                            <li>Busca tutoriales en YouTube o plataformas educativas</li>
                        </ul>
                        <p>Puedo ayudarte con aspectos tecnol√≥gicos relacionados con el sistema Horus en Benavente, pero no con otros temas tecnol√≥gicos generales.</p>
                        <p class="benavente-context">El sistema Horus en Benavente utiliza tecnolog√≠a adaptada a las condiciones clim√°ticas de la llanura del Duero (${benaventeInfo.altitude}).</p>
                    </div>`,
                    
                    deportes: `<div class="out-of-scope">
                        <h3>Preguntas sobre Deportes en Benavente</h3>
                        <p>Para informaci√≥n sobre deportes:</p>
                        <ul>
                            <li>Visita el Ayuntamiento de Benavente para informaci√≥n deportiva</li>
                            <li>Sigue el Club Deportivo de Benavente</li>
                            <li>Consulta aplicaciones deportivas oficiales</li>
                        </ul>
                        <p>Puedo informarte c√≥mo las condiciones meteorol√≥gicas en ${benaventeInfo.location} pueden afectar actividades deportivas al aire libre.</p>
                        <p class="benavente-context">En Benavente, con su clima mediterr√°neo continentalizado, las temperaturas pueden superar los 35¬∞C en verano y bajar de 0¬∞C en invierno, lo que afecta la planificaci√≥n de actividades deportivas al aire libre.</p>
                    </div>`,
                    
                    entretenimiento: `<div class="out-of-scope">
                        <h3>Preguntas sobre Entretenimiento en Benavente</h3>
                        <p>Para informaci√≥n sobre entretenimiento:</p>
                        <ul>
                            <li>Visita la p√°gina web del Ayuntamiento de Benavente</li>
                            <li>Sigue eventos culturales en la Plaza Mayor de Benavente</li>
                            <li>Consulta sitios web oficiales de actividades en la zona</li>
                        </ul>
                        <p>El clima en ${benaventeInfo.location} puede influir en tus planes de entretenimiento al aire libre.</p>
                        <p class="benavente-context">En Benavente, con su clima mediterr√°neo continentalizado, los mejores momentos para actividades al aire libre suelen ser primavera y oto√±o, cuando las temperaturas son m√°s moderadas.</p>
                    </div>`,
                    
                    comida: `<div class="out-of-scope">
                        <h3>Preguntas sobre Comida en Benavente</h3>
                        <p>Para recetas o informaci√≥n sobre comida:</p>
                        <ul>
                            <li>Consulta sitios web especializados en gastronom√≠a zamorana</li>
                            <li>Sigue chefs locales de Benavente</li>
                            <li>Visita restaurantes tradicionales en la Plaza Mayor</li>
                        </ul>
                        <p>El clima en ${benaventeInfo.location} puede afectar la disponibilidad de ciertos alimentos de temporada.</p>
                        <p class="benavente-context">En Benavente, con su clima mediterr√°neo continentalizado, los productos locales var√≠an seg√∫n la estaci√≥n: verduras frescas en primavera-verano y productos de invierno como casta√±as en oto√±o-invierno.</p>
                    </div>`,
                    
                    educaci√≥n: `<div class="out-of-scope">
                        <h3>Preguntas sobre Educaci√≥n en Benavente</h3>
                        <p>Para informaci√≥n educativa:</p>
                        <ul>
                            <li>Consulta la p√°gina web del Ayuntamiento de Benavente</li>
                            <li>Visita el Centro de Educaci√≥n de Adultos de Benavente</li>
                            <li>Contacta al IES Benavente</li>
                        </ul>
                        <p>Puedo proporcionar informaci√≥n sobre meteorolog√≠a y ciencias atmosf√©ricas en el contexto de ${benaventeInfo.location}, pero no sobre otros temas educativos.</p>
                        <p class="benavente-context">El clima de Benavente (${benaventeInfo.altitude}) ofrece oportunidades √∫nicas para estudios pr√°cticos de meteorolog√≠a en la llanura del Duero.</p>
                    </div>`,
                    
                    finanzas: `<div class="out-of-scope">
                        <h3>Preguntas sobre Finanzas en Benavente</h3>
                        <p>Para consultas financieras:</p>
                        <ul>
                            <li>Consulta a un asesor financiero en Benavente</li>
                            <li>Visita oficinas bancarias en la Plaza Mayor</li>
                            <li>Revisa informaci√≥n oficial de instituciones financieras</li>
                        </ul>
                        <p>El clima en ${benaventeInfo.location} puede afectar ciertos sectores econ√≥micos locales como la agricultura, pero no puedo proporcionar asesoramiento financiero.</p>
                        <p class="benavente-context">En Benavente, el clima mediterr√°neo continentalizado influye en actividades econ√≥micas como la agricultura de secano, con temperaturas que pueden superar los 35¬∞C en verano y bajar de 0¬∞C en invierno.</p>
                    </div>`,
                    
                    general: `<div class="out-of-scope">
                        <h3>Preguntas Fuera de Mi √Åmbito en Benavente</h3>
                        <p>Mi conocimiento est√° limitado a:</p>
                        <ul>
                            <li>Monitoreo y an√°lisis de datos meteorol√≥gicos en Benavente</li>
                            <li>Funcionamiento del sistema Horus en Benavente</li>
                            <li>An√°lisis de tendencias clim√°ticas de la zona</li>
                            <li>Predicciones basadas en datos hist√≥ricos de Benavente</li>
                            <li>Contexto clim√°tico espec√≠fico de la llanura del Duero (${benaventeInfo.altitude})</li>
                        </ul>
                        
                        <p>Para otras preguntas, te recomiendo:</p>
                        <ul>
                            <li>Buscar en fuentes especializadas en el tema</li>
                            <li>Consultar a expertos en el campo espec√≠fico</li>
                            <li>Utilizar asistentes dise√±ados para esos temas</li>
                        </ul>
                        
                        <p class="benavente-context"><strong>Informaci√≥n clave sobre Benavente:</strong> Ubicado a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterr√°neo continentalizado con veranos calurosos e inviernos fr√≠os.</p>
                    </div>`
                };
                
                response += domainMessages[domain] || domainMessages.general;
                return response;
            },
            
            unrelated: (entities, context) => {
                const variations = communicationSystem.getUnrelatedVariations();
                let response = getRandomVariation(variations);
                
                response += `<div class="out-of-scope">
                    <h3>¬øC√≥mo puedo ayudarte con Benavente?</h3>
                    <ul>
                        <li>Consultar datos meteorol√≥gicos actuales en Benavente</li>
                        <li>Analizar tendencias clim√°ticas hist√≥ricas de Benavente</li>
                        <li>Realizar predicciones basadas en datos de Benavente</li>
                        <li>Explicar el funcionamiento de Horus en Benavente</li>
                        <li>Contextualizar el clima de Benavente (${benaventeInfo.altitude})</li>
                    </ul>
                    
                    <p>Ejemplos de preguntas que puedo responder:</p>
                    <ul>
                        <li>"¬øCu√°l es la temperatura actual en Benavente?"</li>
                        <li>"¬øC√≥mo funciona el sistema Horus en Benavente?"</li>
                        <li>"Muestra la tendencia de presi√≥n de los √∫ltimos 7 d√≠as en Benavente"</li>
                    </ul>
                    
                    <p>Por favor, reformula tu pregunta para que est√© relacionada con el clima o el sistema Horus en <strong>${benaventeInfo.location}</strong>.</p>
                    
                    <p class="benavente-context"><strong>Informaci√≥n clave sobre Benavente:</strong> Ubicado a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterr√°neo continentalizado con veranos calurosos e inviernos fr√≠os.</p>
                </div>`;
                
                return response;
            }
        };

        // Sistema de comunicaci√≥n mejorado
        const communicationSystem = {
            // Variaciones de saludos seg√∫n la hora
            getGreetingVariations: () => {
                const hours = new Date().getHours();
                const dayOfWeek = new Date().getDay();
                const month = new Date().getMonth();
                
                // Obtener una frase local aleatoria
                const localPhrase = benaventeInfo.localPhrases[
                    Math.floor(Math.random() * benaventeInfo.localPhrases.length)
                ];
                
                // Determinar si hay un evento local pr√≥ximo
                const upcomingEvent = benaventeInfo.localEvents.find(event => {
                    // Aqu√≠ ir√≠a la l√≥gica para detectar eventos pr√≥ximos
                    return Math.random() > 0.7; // Simulaci√≥n aleatoria
                });
                
                const variations = {
                    morning: [
                        `¬°Buenos d√≠as! ${localPhrase} Soy Horus AI, tu asistente meteorol√≥gico para Benavente. ¬øEn qu√© puedo ayudarte hoy?`,
                        `¬°Hola! ${localPhrase} Espero que est√©s disfrutando de esta ma√±ana en Benavente. Soy Horus AI, tu asistente meteorol√≥gico. ¬øNecesitas informaci√≥n sobre el clima?`,
                        `¬°Buen d√≠a! ${localPhrase} ¬øSab√≠as que hoy en Benavente...? Soy Horus AI, tu asistente meteorol√≥gico. ¬øEn qu√© puedo ayudarte?`
                    ],
                    afternoon: [
                        `¬°Buenas tardes! ${localPhrase} Soy Horus AI, tu asistente especializado en el clima de Benavente. ¬øNecesitas informaci√≥n meteorol√≥gica?`,
                        `¬°Hola! ${localPhrase} ¬øC√≥mo est√° el tiempo por tu zona de Benavente? Soy Horus AI, tu asistente meteorol√≥gico. ¬øEn qu√© puedo ayudarte?`,
                        `¬°Buenas tardes! ${localPhrase} ¬øHas notado alg√∫n cambio en el clima de Benavente √∫ltimamente? Soy Horus AI, tu asistente meteorol√≥gico.`
                    ],
                    evening: [
                        `¬°Buenas noches! ${localPhrase} Soy Horus AI, tu asistente meteorol√≥gico para Benavente. ¬øNecesitas informaci√≥n sobre el clima nocturno?`,
                        `¬°Hola! ${localPhrase} ¬øC√≥mo ha sido tu d√≠a en Benavente? Soy Horus AI, tu asistente meteorol√≥gico. ¬øNecesitas informaci√≥n sobre el clima?`,
                        `¬°Buenas noches! ${localPhrase} ¬øSab√≠as que en Benavente el clima nocturno suele...? Soy Horus AI, tu asistente meteorol√≥gico.`
                    ]
                };
                
                if (upcomingEvent) {
                    const eventVariations = [
                        `¬°Buenos d√≠as! ${localPhrase} Por cierto, ¬øsab√≠as que se acerca ${upcomingEvent} en Benavente? Soy Horus AI, tu asistente meteorol√≥gico. ¬øNecesitas informaci√≥n sobre el clima para el evento?`,
                        `¬°Hola! ${localPhrase} Con el ${upcomingEvent} acerc√°ndose en Benavente, es importante estar al tanto del clima. Soy Horus AI, tu asistente meteorol√≥gico. ¬øEn qu√© puedo ayudarte?`
                    ];
                    
                    if (hours < 12) return eventVariations;
                    if (hours < 18) return eventVariations;
                    return eventVariations;
                }
                
                if (hours < 12) return variations.morning;
                if (hours < 18) return variations.afternoon;
                return variations.evening;
            },
            
            // Variaciones de despedida
            getGoodbyeVariations: () => {
                const hours = new Date().getHours();
                const dayOfWeek = new Date().getDay();
                
                return [
                    `¬°Que tengas un buen d√≠a! Si necesitas m√°s informaci√≥n sobre el clima de Benavente, no dudes en volver. ¬°Hasta pronto!`,
                    `Gracias por consultar el clima de Benavente conmigo. ¬°Que disfrutes del d√≠a en la llanura del Duero!`,
                    `Espero haber sido de ayuda con la informaci√≥n meteorol√≥gica de Benavente. ¬°Que tengas un d√≠a maravilloso!`,
                    `¬°Hasta la pr√≥xima! Recuerda que siempre puedes volver para conocer el estado del tiempo en Benavente.`,
                    `Gracias por tu visita. Si necesitas m√°s informaci√≥n sobre el clima de Benavente, estar√© aqu√≠ cuando me necesites. ¬°Adi√≥s!`,
                    `Espero que la informaci√≥n sobre el clima de Benavente te haya sido √∫til. ¬°Que tengas un buen d√≠a en la plaza Mayor!`,
                    `¬°Hasta pronto! Que el tiempo te acompa√±e en tus pr√≥ximas actividades en Benavente.`
                ];
            },
            
            // Variaciones para datos actuales
            getCurrentDataVariations: (parameter, value, unit) => {
                const now = new Date();
                const hours = now.getHours();
                const dayOfWeek = now.getDay();
                const month = now.getMonth();
                const latestData = historicalData[historicalData.length - 1];
                
                // Obtener una frase local aleatoria
                const localPhrase = benaventeInfo.localPhrases[
                    Math.floor(Math.random() * benaventeInfo.localPhrases.length)
                ];
                
                // Determinar si hay un evento local relevante
                const relevantEvent = benaventeInfo.localEvents.find(event => {
                    // Aqu√≠ ir√≠a la l√≥gica para detectar eventos relevantes para el clima
                    return Math.random() > 0.8; // Simulaci√≥n aleatoria
                });
                
                // Determinar si es relevante para actividades al aire libre
                const isOutdoorRelevant = (parameter === 'temperatura' && value > 15) || 
                                        (parameter === 'humedad' && value < 70) ||
                                        (parameter === 'presi√≥n' && value > 1000);
                
                // Determinar si es relevante para actividades espec√≠ficas de Benavente
                const isBenaventeSpecific = benaventeInfo.localLandmarks.some(landmark => {
                    return Math.random() > 0.7; // Simulaci√≥n aleatoria
                });
                
                // Determinar si es una condici√≥n clim√°tica inusual
                const isUnusual = (parameter === 'temperatura' && (value > 30 || value < 5)) ||
                                (parameter === 'humedad' && (value > 80 || value < 30)) ||
                                (parameter === 'presi√≥n' && (value > 1030 || value < 980));
                
                // Determinar si es relevante para la √©poca del a√±o
                const isSeasonRelevant = (month === 6 && parameter === 'temperatura') || // Verano
                                    (month === 1 && parameter === 'temperatura') || // Invierno
                                    (month === 3 && parameter === 'lluvia'); // Primavera
                
                // Variaciones seg√∫n el par√°metro
                const variations = {
                    temperatura: [
                        `La temperatura actual en Benavente es de ${value.toFixed(1)}¬∞C. ${localPhrase}. ${isUnusual ? 'Esta temperatura es inusual para esta √©poca del a√±o en Benavente.' : 'Esta temperatura es t√≠pica del clima mediterr√°neo continentalizado de Benavente.'}`,
                        `En estos momentos, la temperatura en Benavente es de ${value.toFixed(1)}¬∞C. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo com√∫n para nuestra zona.' : 'Es un buen d√≠a para disfrutar de la Plaza Mayor si te gusta esta temperatura.'}`,
                        `Actualmente registramos ${value.toFixed(1)}¬∞C en Benavente. ${localPhrase}. ${isUnusual ? '¬°Cuidado con las temperaturas extremas!' : 'Es una temperatura perfecta para un paseo por el R√≠o Esla.'}`
                    ],
                    humedad: [
                        `La humedad actual en Benavente es del ${value.toFixed(0)}%. ${localPhrase}. ${isUnusual ? 'Esta humedad es inusual para nuestra zona.' : 'Este nivel de humedad es t√≠pico de Benavente.'}`,
                        `Actualmente la humedad en Benavente es del ${value.toFixed(0)}%. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo com√∫n para nuestra zona.' : 'Es un buen nivel de humedad para las actividades al aire libre.'}`,
                        `Registramos un ${value.toFixed(0)}% de humedad en Benavente. ${localPhrase}. ${isUnusual ? '¬°Cuidado con la humedad alta!' : 'Es una humedad perfecta para disfrutar del clima de la llanura del Duero.'}`
                    ],
                    presi√≥n: [
                        `La presi√≥n atmosf√©rica actual en Benavente es de ${value.toFixed(0)} hPa. ${localPhrase}. ${isUnusual ? 'Esta presi√≥n es inusual para nuestra zona.' : 'Este valor es t√≠pico de Benavente a ${benaventeInfo.altitude}.'}`,
                        `Actualmente registramos ${value.toFixed(0)} hPa de presi√≥n en Benavente. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo com√∫n para nuestra zona.' : 'Es una presi√≥n normal para el clima mediterr√°neo continentalizado de Benavente.'}`,
                        `La presi√≥n atmosf√©rica en Benavente es de ${value.toFixed(0)} hPa. ${localPhrase}. ${isUnusual ? '¬°Cuidado con los cambios bruscos de presi√≥n!' : 'Esta presi√≥n indica condiciones clim√°ticas estables en la zona.'}`
                    ],
                    lluvia: [
                        `Actualmente ${value ? 'est√° lloviendo' : 'no est√° lloviendo'} en Benavente. ${localPhrase}. ${isUnusual ? '¬°Esperemos que no dure mucho!' : 'Es un buen momento para pasear por el casco hist√≥rico.'}`,
                        `El sistema registra que ${value ? 'hay lluvia' : 'no hay lluvia'} en estos momentos en Benavente. ${localPhrase}. ${isUnusual ? '¬°No olvides tu paraguas!' : 'Es un buen d√≠a para visitar la Iglesia de Santiago.'}`,
                        `Seg√∫n nuestros datos, ${value ? 'est√° lloviendo' : 'no est√° lloviendo'} en Benavente. ${localPhrase}. ${isUnusual ? '¬°Cuidado con posibles inundaciones!' : 'Es un buen momento para disfrutar de un caf√© en la Plaza Mayor.'}`
                    ],
                    viento: [
                        `La velocidad del viento actual en Benavente es de ${value.toFixed(1)} m/s (${(value * 3.6).toFixed(1)} km/h). ${localPhrase}. ${isUnusual ? '¬°Cuidado con las r√°fagas fuertes!' : 'Es un viento t√≠pico de la llanura del Duero.'}`,
                        `Actualmente el viento en Benavente sopla a ${value.toFixed(1)} m/s. ${localPhrase}. ${isUnusual ? 'Este viento es bastante fuerte para nuestra zona.' : 'Es un buen d√≠a para practicar actividades al aire libre.'}`,
                        `Registramos una velocidad de viento de ${value.toFixed(1)} m/s en Benavente. ${localPhrase}. ${isUnusual ? '¬°Presta atenci√≥n a las se√±ales de tr√°fico!' : 'Es un viento perfecto para disfrutar del paisaje.'}`
                    ],
                    gas: [
                        `El nivel de gas actual en Benavente es de ${value.toFixed(2)} kŒ©. ${localPhrase}. ${isUnusual ? 'Este nivel es inusual para nuestra zona.' : 'Este valor es t√≠pico de Benavente.'}`,
                        `Actualmente registramos un nivel de gas de ${value.toFixed(2)} kŒ© en Benavente. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo com√∫n para nuestra zona.' : 'Es un buen nivel para las actividades al aire libre.'}`,
                        `El sistema detecta un nivel de gas de ${value.toFixed(2)} kŒ© en Benavente. ${localPhrase}. ${isUnusual ? '¬°Cuidado con la calidad del aire!' : 'Es un buen momento para pasear por el R√≠o Esla.'}`
                    ],
                    direcci√≥n: [
                        `La direcci√≥n del viento actual en Benavente es ${getWindDirectionName(latestData.wind_dir)} (${latestData.wind_dir}¬∞). ${localPhrase}. ${isUnusual ? '¬°Este viento es inusual para nuestra zona!' : 'Es una direcci√≥n t√≠pica del viento en Benavente.'}`,
                        `Actualmente el viento en Benavente viene del ${getWindDirectionName(latestData.wind_dir)}. ${localPhrase}. ${isUnusual ? 'Este viento es bastante fuera de lo com√∫n para nuestra zona.' : 'Es una direcci√≥n normal para el clima mediterr√°neo continentalizado de Benavente.'}`,
                        `Registramos que el viento en Benavente viene del ${getWindDirectionName(latestData.wind_dir)}. ${localPhrase}. ${isUnusual ? '¬°Cuidado con los cambios bruscos de direcci√≥n!' : 'Es una direcci√≥n perfecta para disfrutar del clima de la llanura del Duero.'}`
                    ]
                };
                
                // Si hay evento relevante, a√±adir variaciones espec√≠ficas
                if (relevantEvent) {
                    const eventVariations = {
                        temperatura: [
                            `La temperatura actual en Benavente es de ${value.toFixed(1)}¬∞C. Con el ${relevantEvent} acerc√°ndose, es importante estar preparado para el clima. ${localPhrase}.`,
                            `En estos momentos, la temperatura en Benavente es de ${value.toFixed(1)}¬∞C. ${relevantEvent} se acerca, as√≠ que mantente informado sobre el clima. ${localPhrase}.`
                        ],
                        humedad: [
                            `La humedad actual en Benavente es del ${value.toFixed(0)}%. Con el ${relevantEvent} acerc√°ndose, este nivel de humedad podr√≠a afectar los preparativos. ${localPhrase}.`,
                            `Actualmente la humedad en Benavente es del ${value.toFixed(0)}%. Para ${relevantEvent}, este nivel de humedad es importante tener en cuenta. ${localPhrase}.`
                        ],
                        // Variaciones similares para otros par√°metros
                        presi√≥n: [
                            `La presi√≥n atmosf√©rica actual en Benavente es de ${value.toFixed(0)} hPa. Con el ${relevantEvent} acerc√°ndose, este valor de presi√≥n indica... ${localPhrase}.`
                        ],
                        lluvia: [
                            `Actualmente ${value ? 'est√° lloviendo' : 'no est√° lloviendo'} en Benavente. Para ${relevantEvent}, esta condici√≥n es importante para... ${localPhrase}.`
                        ],
                        viento: [
                            `La velocidad del viento actual en Benavente es de ${value.toFixed(1)} m/s. Con el ${relevantEvent} acerc√°ndose, este viento podr√≠a afectar... ${localPhrase}.`
                        ],
                        gas: [
                            `El nivel de gas actual en Benavente es de ${value.toFixed(2)} kŒ©. Para ${relevantEvent}, este nivel de calidad del aire es... ${localPhrase}.`
                        ],
                        direcci√≥n: [
                            `La direcci√≥n del viento actual en Benavente es ${getWindDirectionName(latestData.wind_dir)}. Con el ${relevantEvent} acerc√°ndose, esta direcci√≥n indica... ${localPhrase}.`
                        ]
                    };
                    
                    // Combinar variaciones normales con variaciones de evento
                    return [...variations[parameter], ...eventVariations[parameter]];
                }
                
                return variations[parameter];
            },
            
            // Variaciones para an√°lisis de tendencias
            getTrendAnalysisVariations: (parameter, avg, min, max, trend, trendStrength, period) => {
                const now = new Date();
                const month = now.getMonth();
                const isSummer = month >= 5 && month <= 8;
                const isWinter = month >= 11 || month <= 2;
                
                // Determinar si la tendencia es significativa
                const isSignificantTrend = trendStrength > 0.1;
                
                // Determinar si es relevante para la √©poca del a√±o
                const isSeasonRelevant = (isSummer && parameter === 'temperatura' && trend === 'ascendente') ||
                                    (isWinter && parameter === 'temperatura' && trend === 'descendente');
                
                // Determinar si es una tendencia inusual
                const isUnusualTrend = (parameter === 'temperatura' && trendStrength > 0.2) ||
                                    (parameter === 'humedad' && trendStrength > 0.15) ||
                                    (parameter === 'presi√≥n' && trendStrength > 0.1);
                
                // Variaciones seg√∫n el par√°metro
                const variations = {
                    temperatura: [
                        `En los √∫ltimos ${period}, la temperatura en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(1)}¬∞C, con un m√≠nimo de ${min.toFixed(1)}¬∞C y un m√°ximo de ${max.toFixed(1)}¬∞C.`,
                        `Analizando los datos de los √∫ltimos ${period} en Benavente, observamos que la temperatura ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr√≥n es inusual para nuestra zona.' : 'Este patr√≥n es t√≠pico del clima mediterr√°neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(1)}¬∞C, con picos entre ${min.toFixed(1)}¬∞C y ${max.toFixed(1)}¬∞C.`,
                        `Seg√∫n nuestro an√°lisis de los √∫ltimos ${period}, la temperatura en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(1)}¬∞C, con valores extremos de ${min.toFixed(1)}¬∞C y ${max.toFixed(1)}¬∞C.`
                    ],
                    humedad: [
                        `En los √∫ltimos ${period}, la humedad en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido del ${avg.toFixed(0)}%, con un m√≠nimo del ${min.toFixed(0)}% y un m√°ximo del ${max.toFixed(0)}%.`,
                        `Analizando los datos de los √∫ltimos ${period} en Benavente, observamos que la humedad ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr√≥n es inusual para nuestra zona.' : 'Este patr√≥n es t√≠pico del clima mediterr√°neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(0)}%, con picos entre ${min.toFixed(0)}% y ${max.toFixed(0)}%.`,
                        `Seg√∫n nuestro an√°lisis de los √∫ltimos ${period}, la humedad en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} El promedio registrado es del ${avg.toFixed(0)}%, con valores extremos del ${min.toFixed(0)}% y del ${max.toFixed(0)}%.`
                    ],
                    presi√≥n: [
                        `En los √∫ltimos ${period}, la presi√≥n atmosf√©rica en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(0)} hPa, con un m√≠nimo de ${min.toFixed(0)} hPa y un m√°ximo de ${max.toFixed(0)} hPa.`,
                        `Analizando los datos de los √∫ltimos ${period} en Benavente, observamos que la presi√≥n atmosf√©rica ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr√≥n es inusual para nuestra zona.' : 'Este patr√≥n es t√≠pico del clima mediterr√°neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(0)} hPa, con picos entre ${min.toFixed(0)} hPa y ${max.toFixed(0)} hPa.`,
                        `Seg√∫n nuestro an√°lisis de los √∫ltimos ${period}, la presi√≥n atmosf√©rica en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(0)} hPa, con valores extremos de ${min.toFixed(0)} hPa y ${max.toFixed(0)} hPa.`
                    ],
                    lluvia: [
                        `En los √∫ltimos ${period}, la precipitaci√≥n en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(1)} mm, con un m√≠nimo de ${min.toFixed(1)} mm y un m√°ximo de ${max.toFixed(1)} mm.`,
                        `Analizando los datos de los √∫ltimos ${period} en Benavente, observamos que la precipitaci√≥n ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr√≥n es inusual para nuestra zona.' : 'Este patr√≥n es t√≠pico del clima mediterr√°neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(1)} mm, con picos entre ${min.toFixed(1)} mm y ${max.toFixed(1)} mm.`,
                        `Seg√∫n nuestro an√°lisis de los √∫ltimos ${period}, la precipitaci√≥n en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(1)} mm, con valores extremos de ${min.toFixed(1)} mm y ${max.toFixed(1)} mm.`
                    ],
                    viento: [
                        `En los √∫ltimos ${period}, la velocidad del viento en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(1)} m/s, con un m√≠nimo de ${min.toFixed(1)} m/s y un m√°ximo de ${max.toFixed(1)} m/s.`,
                        `Analizando los datos de los √∫ltimos ${period} en Benavente, observamos que la velocidad del viento ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr√≥n es inusual para nuestra zona.' : 'Este patr√≥n es t√≠pico del clima mediterr√°neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(1)} m/s, con picos entre ${min.toFixed(1)} m/s y ${max.toFixed(1)} m/s.`,
                        `Seg√∫n nuestro an√°lisis de los √∫ltimos ${period}, la velocidad del viento en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(1)} m/s, con valores extremos de ${min.toFixed(1)} m/s y ${max.toFixed(1)} m/s.`
                    ]
                };
                
                return variations[parameter] || variations.temperatura;
            },
            
            // Variaciones para predicciones
            getPredictionVariations: (parameter, reliability, period) => {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const month = now.getMonth();
                
                // Determinar si es relevante para la √©poca del a√±o
                const isSeasonRelevant = (month === 6 && parameter === 'temperatura') || // Verano
                                    (month === 1 && parameter === 'temperatura') || // Invierno
                                    (month === 3 && parameter === 'lluvia'); // Primavera
                
                // Determinar si es una predicci√≥n inusual
                const isUnusualPrediction = reliability < 0.6;
                
                // Determinar si hay un evento local relevante
                const relevantEvent = benaventeInfo.localEvents.find(event => {
                    // Aqu√≠ ir√≠a la l√≥gica para detectar eventos relevantes para el clima
                    return Math.random() > 0.7; // Simulaci√≥n aleatoria
                });
                
                // Variaciones seg√∫n el par√°metro
                const variations = {
                    temperatura: [
                        `Basado en los datos hist√≥ricos de Benavente, la predicci√≥n para los pr√≥ximos ${period} indica que la temperatura seguir√° una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci√≥n tiene una confiabilidad baja, as√≠ que t√≥mala con precauci√≥n.' : 'Esta predicci√≥n es bastante confiable para planificar actividades en Benavente.'}`,
                        `Seg√∫n nuestro an√°lisis de los datos meteorol√≥gicos de Benavente, esperamos que la temperatura ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr√≥ximos ${period}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim√°ticos inusuales, esta predicci√≥n debe tomarse con reserva.' : 'Esta predicci√≥n se basa en patrones hist√≥ricos t√≠picos del clima mediterr√°neo continentalizado de Benavente.'}`,
                        `Nuestra predicci√≥n meteorol√≥gica para Benavente indica que la temperatura tendr√° una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los pr√≥ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci√≥n en unos d√≠as para mayor precisi√≥n.' : 'puedes planificar tus actividades con confianza.'}`
                    ],
                    humedad: [
                        `Basado en los datos hist√≥ricos de Benavente, la predicci√≥n para los pr√≥ximos ${period} indica que la humedad seguir√° una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci√≥n tiene una confiabilidad baja, as√≠ que t√≥mala con precauci√≥n.' : 'Esta predicci√≥n es bastante confiable para planificar actividades en Benavente.'}`,
                        `Seg√∫n nuestro an√°lisis de los datos meteorol√≥gicos de Benavente, esperamos que la humedad ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr√≥ximos ${period}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim√°ticos inusuales, esta predicci√≥n debe tomarse con reserva.' : 'Esta predicci√≥n se basa en patrones hist√≥ricos t√≠picos del clima mediterr√°neo continentalizado de Benavente.'}`,
                        `Nuestra predicci√≥n meteorol√≥gica para Benavente indica que la humedad tendr√° una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los pr√≥ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci√≥n en unos d√≠as para mayor precisi√≥n.' : 'puedes planificar tus actividades con confianza.'}`
                    ],
                    presi√≥n: [
                        `Basado en los datos hist√≥ricos de Benavente, la predicci√≥n para los pr√≥ximos ${period} indica que la presi√≥n atmosf√©rica seguir√° una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci√≥n tiene una confiabilidad baja, as√≠ que t√≥mala con precauci√≥n.' : 'Esta predicci√≥n es bastante confiable para planificar actividades en Benavente.'}`,
                        `Seg√∫n nuestro an√°lisis de los datos meteorol√≥gicos de Benavente, esperamos que la presi√≥n atmosf√©rica ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr√≥ximos ${period}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim√°ticos inusuales, esta predicci√≥n debe tomarse con reserva.' : 'Esta predicci√≥n se basa en patrones hist√≥ricos t√≠picos del clima mediterr√°neo continentalizado de Benavente.'}`,
                        `Nuestra predicci√≥n meteorol√≥gica para Benavente indica que la presi√≥n atmosf√©rica tendr√° una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los pr√≥ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci√≥n en unos d√≠as para mayor precisi√≥n.' : 'puedes planificar tus actividades con confianza.'}`
                    ],
                    lluvia: [
                        `Basado en los datos hist√≥ricos de Benavente, la predicci√≥n para los pr√≥ximos ${period} indica que ${Math.random() > 0.5 ? 'habr√° lluvia' : 'no habr√° lluvia'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci√≥n tiene una confiabilidad baja, as√≠ que t√≥mala con precauci√≥n.' : 'Esta predicci√≥n es bastante confiable para planificar actividades en Benavente.'}`,
                        `Seg√∫n nuestro an√°lisis de los datos meteorol√≥gicos de Benavente, esperamos que ${Math.random() > 0.5 ? 'llueva' : 'no llueva'} en los pr√≥ximos ${period}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim√°ticos inusuales, esta predicci√≥n debe tomarse con reserva.' : 'Esta predicci√≥n se basa en patrones hist√≥ricos t√≠picos del clima mediterr√°neo continentalizado de Benavente.'}`,
                        `Nuestra predicci√≥n meteorol√≥gica para Benavente indica que ${Math.random() > 0.5 ? 'habr√° precipitaciones' : 'no habr√° precipitaciones'} en los pr√≥ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci√≥n en unos d√≠as para mayor precisi√≥n.' : 'puedes planificar tus actividades con confianza.'}`
                    ],
                    viento: [
                        `Basado en los datos hist√≥ricos de Benavente, la predicci√≥n para los pr√≥ximos ${period} indica que el viento seguir√° una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci√≥n tiene una confiabilidad baja, as√≠ que t√≥mala con precauci√≥n.' : 'Esta predicci√≥n es bastante confiable para planificar actividades en Benavente.'}`,
                        `Seg√∫n nuestro an√°lisis de los datos meteorol√≥gicos de Benavente, esperamos que la velocidad del viento ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr√≥ximos ${period}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim√°ticos inusuales, esta predicci√≥n debe tomarse con reserva.' : 'Esta predicci√≥n se basa en patrones hist√≥ricos t√≠picos del clima mediterr√°neo continentalizado de Benavente.'}`,
                        `Nuestra predicci√≥n meteorol√≥gica para Benavente indica que el viento tendr√° una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los pr√≥ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci√≥n en unos d√≠as para mayor precisi√≥n.' : 'puedes planificar tus actividades con confianza.'}`
                    ]
                };
                
                // Si hay evento relevante, a√±adir variaciones espec√≠ficas
                if (relevantEvent) {
                    const eventVariations = {
                        temperatura: [
                            `Con el ${relevantEvent} acerc√°ndose, nuestra predicci√≥n para los pr√≥ximos ${period} indica que la temperatura seguir√° una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%.`,
                            `Para el ${relevantEvent}, esperamos que la temperatura ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr√≥ximos ${period}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%.`
                        ],
                        humedad: [
                            `Con el ${relevantEvent} acerc√°ndose, nuestra predicci√≥n para los pr√≥ximos ${period} indica que la humedad seguir√° una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%.`,
                            `Para el ${relevantEvent}, esperamos que la humedad ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr√≥ximos ${period}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%.`
                        ],
                        // Variaciones similares para otros par√°metros
                        presi√≥n: [
                            `Con el ${relevantEvent} acerc√°ndose, nuestra predicci√≥n para los pr√≥ximos ${period} indica que la presi√≥n atmosf√©rica seguir√° una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%.`
                        ],
                        lluvia: [
                            `Con el ${relevantEvent} acerc√°ndose, nuestra predicci√≥n para los pr√≥ximos ${period} indica que ${Math.random() > 0.5 ? 'habr√° lluvia' : 'no habr√° lluvia'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%.`
                        ],
                        viento: [
                            `Con el ${relevantEvent} acerc√°ndose, nuestra predicci√≥n para los pr√≥ximos ${period} indica que el viento seguir√° una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci√≥n es del ${(reliability * 100).toFixed(0)}%.`
                        ]
                    };
                    
                    // Combinar variaciones normales con variaciones de evento
                    return [...variations[parameter], ...eventVariations[parameter]];
                }
                
                return variations[parameter] || variations.temperatura;
            },
            
            // Variaciones para comparaciones
            getComparisonVariations: (parameter, avg1, avg2, period1, period2, changePercent) => {
                const now = new Date();
                const month = now.getMonth();
                
                // Determinar si es relevante para la √©poca del a√±o
                const isSeasonRelevant = (month === 6 && parameter === 'temperatura') || // Verano
                                    (month === 1 && parameter === 'temperatura') || // Invierno
                                    (month === 3 && parameter === 'lluvia'); // Primavera
                
                // Determinar si es un cambio significativo
                const isSignificantChange = Math.abs(changePercent) > 10;
                
                // Determinar si es un cambio inusual
                const isUnusualChange = (parameter === 'temperatura' && Math.abs(changePercent) > 15) ||
                                    (parameter === 'humedad' && Math.abs(changePercent) > 20) ||
                                    (parameter === 'presi√≥n' && Math.abs(changePercent) > 5);
                
                // Variaciones seg√∫n el par√°metro
                const variations = {
                    temperatura: [
                        `Al comparar ${period1} con ${period2} en Benavente, la temperatura ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr√°neo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(1)}¬∞C, mientras que en ${period2} fue de ${avg2.toFixed(1)}¬∞C.`,
                        `La comparaci√≥n entre ${period1} y ${period2} muestra que la temperatura en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t√≠pico de las variaciones clim√°ticas estacionales.'} Los promedios fueron de ${avg1.toFixed(1)}¬∞C y ${avg2.toFixed(1)}¬∞C respectivamente.`,
                        `Seg√∫n nuestro an√°lisis comparativo, la temperatura en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(1)}¬∞C y ${avg2.toFixed(1)}¬∞C.`
                    ],
                    humedad: [
                        `Al comparar ${period1} con ${period2} en Benavente, la humedad ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr√°neo continentalizado de Benavente.`} El promedio en ${period1} fue del ${avg1.toFixed(0)}%, mientras que en ${period2} fue del ${avg2.toFixed(0)}%.`,
                        `La comparaci√≥n entre ${period1} y ${period2} muestra que la humedad en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t√≠pico de las variaciones clim√°ticas estacionales.'} Los promedios fueron del ${avg1.toFixed(0)}% y del ${avg2.toFixed(0)}% respectivamente.`,
                        `Seg√∫n nuestro an√°lisis comparativo, la humedad en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} Los valores promedio fueron del ${avg1.toFixed(0)}% y del ${avg2.toFixed(0)}%.`
                    ],
                    presi√≥n: [
                        `Al comparar ${period1} con ${period2} en Benavente, la presi√≥n atmosf√©rica ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr√°neo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(0)} hPa, mientras que en ${period2} fue de ${avg2.toFixed(0)} hPa.`,
                        `La comparaci√≥n entre ${period1} y ${period2} muestra que la presi√≥n atmosf√©rica en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t√≠pico de las variaciones clim√°ticas estacionales.'} Los promedios fueron de ${avg1.toFixed(0)} hPa y ${avg2.toFixed(0)} hPa respectivamente.`,
                        `Seg√∫n nuestro an√°lisis comparativo, la presi√≥n atmosf√©rica en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(0)} hPa y ${avg2.toFixed(0)} hPa.`
                    ],
                    lluvia: [
                        `Al comparar ${period1} con ${period2} en Benavente, la precipitaci√≥n ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr√°neo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(1)} mm, mientras que en ${period2} fue de ${avg2.toFixed(1)} mm.`,
                        `La comparaci√≥n entre ${period1} y ${period2} muestra que la precipitaci√≥n en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t√≠pico de las variaciones clim√°ticas estacionales.'} Los promedios fueron de ${avg1.toFixed(1)} mm y ${avg2.toFixed(1)} mm respectivamente.`,
                        `Seg√∫n nuestro an√°lisis comparativo, la precipitaci√≥n en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(1)} mm y ${avg2.toFixed(1)} mm.`
                    ],
                    viento: [
                        `Al comparar ${period1} con ${period2} en Benavente, la velocidad del viento ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr√°neo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(1)} m/s, mientras que en ${period2} fue de ${avg2.toFixed(1)} m/s.`,
                        `La comparaci√≥n entre ${period1} y ${period2} muestra que la velocidad del viento en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t√≠pico de las variaciones clim√°ticas estacionales.'} Los promedios fueron de ${avg1.toFixed(1)} m/s y ${avg2.toFixed(1)} m/s respectivamente.`,
                        `Seg√∫n nuestro an√°lisis comparativo, la velocidad del viento en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(1)} m/s y ${avg2.toFixed(1)} m/s.`
                    ]
                };
                
                return variations[parameter] || variations.temperatura;
            },
            
            // Variaciones para correlaciones
            getCorrelationVariations: (parameter1, parameter2, correlation, rSquared) => {
                const now = new Date();
                const month = now.getMonth();
                
                // Determinar la fuerza de la correlaci√≥n
                const correlationStrength = Math.abs(correlation);
                let strengthDescription;
                if (correlationStrength > 0.7) {
                    strengthDescription = 'muy fuerte';
                } else if (correlationStrength > 0.5) {
                    strengthDescription = 'fuerte';
                } else if (correlationStrength > 0.3) {
                    strengthDescription = 'moderada';
                } else if (correlationStrength > 0.1) {
                    strengthDescription = 'd√©bil';
                } else {
                    strengthDescription = 'muy d√©bil';
                }
                
                // Determinar si es relevante para la √©poca del a√±o
                const isSeasonRelevant = (month === 6 && (parameter1 === 'temperatura' || parameter2 === 'temperatura')) || // Verano
                                    (month === 1 && (parameter1 === 'temperatura' || parameter2 === 'temperatura')); // Invierno
                
                // Determinar si es una correlaci√≥n inusual
                const isUnusualCorrelation = (parameter1 === 'temperatura' && parameter2 === 'humedad' && correlation < -0.6) ||
                                    (parameter1 === 'presi√≥n' && parameter2 === 'lluvia' && correlation < -0.4);
                
                // Variaciones seg√∫n los par√°metros
                const variations = {
                    'temperatura-humedad': [
                        `He analizado la relaci√≥n entre la temperatura y la humedad en Benavente y encontr√© una correlaci√≥n ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la temperatura ${correlation > 0 ? 'aumenta' : 'disminuye'}, la humedad tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la humedad puede explicarse por cambios en la temperatura. ${isUnusualCorrelation ? 'Esta correlaci√≥n es t√≠pica del clima mediterr√°neo continentalizado de Benavente.' : 'Este patr√≥n es inusual para nuestra zona.'}`,
                        `Nuestro an√°lisis de correlaci√≥n entre temperatura y humedad en Benavente muestra una relaci√≥n ${strengthDescription} (${correlation.toFixed(2)}). ${correlation > 0 ? 'Cuando hace m√°s calor, el aire puede contener m√°s humedad.' : 'Cuando hace m√°s calor, la humedad relativa disminuye aunque la cantidad de vapor de agua permanezca constante.'} El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la humedad est√° relacionada con la temperatura. ${isUnusualCorrelation ? 'Este patr√≥n es esperado para el clima de Benavente.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'}`,
                        `La correlaci√≥n entre temperatura y humedad en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). Esto es ${correlation > 0 ? 'poco com√∫n' : 'com√∫n'} en climas mediterr√°neos. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la humedad puede atribuirse a cambios en la temperatura. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n es interesante para entender el clima local.'}`
                    ],
                    'presi√≥n-lluvia': [
                        `He analizado la relaci√≥n entre la presi√≥n atmosf√©rica y la lluvia en Benavente y encontr√© una correlaci√≥n ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la presi√≥n ${correlation > 0 ? 'aumenta' : 'disminuye'}, la probabilidad de lluvia tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la lluvia puede explicarse por cambios en la presi√≥n. ${isUnusualCorrelation ? 'Esta correlaci√≥n es t√≠pica del clima mediterr√°neo continentalizado de Benavente.' : 'Este patr√≥n es inusual para nuestra zona.'}`,
                        `Nuestro an√°lisis de correlaci√≥n entre presi√≥n atmosf√©rica y lluvia en Benavente muestra una relaci√≥n ${strengthDescription} (${correlation.toFixed(2)}). ${correlation < 0 ? 'Las bajas presiones suelen indicar sistemas de mal tiempo.' : 'Las altas presiones suelen indicar buen tiempo.'} El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la lluvia est√° relacionada con la presi√≥n. ${isUnusualCorrelation ? 'Este patr√≥n es esperado para el clima de Benavente.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'}`,
                        `La correlaci√≥n entre presi√≥n atmosf√©rica y lluvia en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). Esto es ${correlation < 0 ? 'com√∫n' : 'poco com√∫n'} en climas mediterr√°neos. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la lluvia puede atribuirse a cambios en la presi√≥n. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n es interesante para entender el clima local.'}`
                    ],
                    'temperatura-presi√≥n': [
                        `He analizado la relaci√≥n entre la temperatura y la presi√≥n atmosf√©rica en Benavente y encontr√© una correlaci√≥n ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la temperatura ${correlation > 0 ? 'aumenta' : 'disminuye'}, la presi√≥n tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la presi√≥n puede explicarse por cambios en la temperatura. ${isUnusualCorrelation ? 'Esta correlaci√≥n es t√≠pica del clima mediterr√°neo continentalizado de Benavente.' : 'Este patr√≥n es inusual para nuestra zona.'}`,
                        `Nuestro an√°lisis de correlaci√≥n entre temperatura y presi√≥n atmosf√©rica en Benavente muestra una relaci√≥n ${strengthDescription} (${correlation.toFixed(2)}). En la llanura del Duero, estas variables suelen tener una relaci√≥n compleja. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la presi√≥n est√° relacionada con la temperatura. ${isUnusualCorrelation ? 'Este patr√≥n es esperado para el clima de Benavente.' : 'Este patr√≥n merece atenci√≥n para actividades al aire libre.'}`,
                        `La correlaci√≥n entre temperatura y presi√≥n atmosf√©rica en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). Esto es ${correlation > 0 ? 'poco com√∫n' : 'com√∫n'} en zonas de altitud media como Benavente (${benaventeInfo.altitude}). El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la presi√≥n puede atribuirse a cambios en la temperatura. ${isSeasonRelevant ? 'Este patr√≥n es esperado para esta √©poca del a√±o.' : 'Este patr√≥n es interesante para entender el clima local.'}`
                    ]
                };
                
                // Crear clave para la combinaci√≥n de par√°metros
                const key = `${parameter1}-${parameter2}`;
                const reverseKey = `${parameter2}-${parameter1}`;
                
                // Intentar obtener variaciones para la combinaci√≥n espec√≠fica
                if (variations[key]) {
                    return variations[key];
                } else if (variations[reverseKey]) {
                    // Si la combinaci√≥n est√° en orden inverso, ajustar el texto
                    return variations[reverseKey].map(variation => 
                        variation.replace(/temperatura y la humedad/g, `${parameter2} y la ${parameter1}`)
                                .replace(/temperatura y humedad/g, `${parameter2} y ${parameter1}`)
                                .replace(/temperatura con la humedad/g, `${parameter2} con la ${parameter1}`)
                                .replace(/temperatura la humedad/g, `${parameter2} la ${parameter1}`)
                                .replace(/la temperatura y la humedad/g, `la ${parameter2} y la ${parameter1}`)
                    );
                }
                
                // Si no hay combinaci√≥n espec√≠fica, usar una variaci√≥n gen√©rica
                return [
                    `He analizado la relaci√≥n entre ${parameter1} y ${parameter2} en Benavente y encontr√© una correlaci√≥n ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la ${parameter1} ${correlation > 0 ? 'aumenta' : 'disminuye'}, la ${parameter2} tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la ${parameter2} puede explicarse por cambios en la ${parameter1}.`,
                    `Nuestro an√°lisis de correlaci√≥n entre ${parameter1} y ${parameter2} en Benavente muestra una relaci√≥n ${strengthDescription} (${correlation.toFixed(2)}). El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la ${parameter2} est√° relacionada con la ${parameter1}.`,
                    `La correlaci√≥n entre ${parameter1} y ${parameter2} en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci√≥n en la ${parameter2} puede atribuirse a cambios en la ${parameter1}.`
                ];
            },
            
            // Variaciones para ayuda
            getHelpVariations: () => {
                const now = new Date();
                const hours = now.getHours();
                const dayOfWeek = now.getDay();
                const month = now.getMonth();
                
                // Obtener una frase local aleatoria
                const localPhrase = benaventeInfo.localPhrases[
                    Math.floor(Math.random() * benaventeInfo.localPhrases.length)
                ];
                
                // Determinar si hay un evento local relevante
                const relevantEvent = benaventeInfo.localEvents.find(event => {
                    // Aqu√≠ ir√≠a la l√≥gica para detectar eventos relevantes para el clima
                    return Math.random() > 0.7; // Simulaci√≥n aleatoria
                });
                
                const variations = [
                    `¬°Claro que s√≠! ${localPhrase} Soy Horus AI, tu asistente meteorol√≥gico para Benavente. Aqu√≠ tienes algunas preguntas que puedo ayudarte a resolver:`,
                    `Por supuesto. ${localPhrase} Como asistente meteorol√≥gico especializado en Benavente, puedo ayudarte con:`,
                    `¬°Con gusto! ${localPhrase} Como experto en el clima de Benavente, puedo ayudarte con:`
                ];
                
                if (relevantEvent) {
                    variations.push(
                        `¬°Claro que s√≠! Con el ${relevantEvent} acerc√°ndose, es importante estar informado. ${localPhrase} Como asistente meteorol√≥gico para Benavente, puedo ayudarte con:`
                    );
                }
                
                return variations;
            },
            
            // Variaciones para informaci√≥n sobre Horus
            getAboutHorusVariations: () => {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const month = now.getMonth();
                
                // Obtener una frase local aleatoria
                const localPhrase = benaventeInfo.localPhrases[
                    Math.floor(Math.random() * benaventeInfo.localPhrases.length)
                ];
                
                // Determinar si es relevante para la √©poca del a√±o
                const isSeasonRelevant = (month === 6) || // Verano
                                    (month === 1); // Invierno
                
                const variations = [
                    `Horus es una estaci√≥n meteorol√≥gica avanzada instalada en Benavente, dise√±ada para monitorear las condiciones clim√°ticas de nuestra querida ciudad. ${localPhrase} Nuestro sistema recoge datos en tiempo real sobre temperatura, humedad, presi√≥n y otros par√°metros para ayudarte a entender mejor el clima de la llanura del Duero.`,
                    `Soy Horus, un sistema meteorol√≥gico localizado en Benavente que proporciona datos precisos sobre el clima de nuestra zona. ${localPhrase} Nuestro sistema est√° especialmente calibrado para el clima mediterr√°neo continentalizado de Benavente, a ${benaventeInfo.altitude}.`,
                    `El sistema Horus en Benavente es una estaci√≥n meteorol√≥gica de √∫ltima generaci√≥n que monitorea constantemente el clima de nuestra ciudad. ${localPhrase} Desde la Plaza Mayor hasta el R√≠o Esla, nuestros sensores recogen datos que nos permiten ofrecerte informaci√≥n meteorol√≥gica precisa y relevante para tu d√≠a a d√≠a.`
                ];
                
                if (isSeasonRelevant) {
                    variations.push(
                        `En esta √©poca del a√±o, el sistema Horus en Benavente es especialmente √∫til para monitorear ${month === 6 ? 'las altas temperaturas del verano' : 'las bajas temperaturas del invierno'}. ${localPhrase} Nuestros datos ayudan a los vecinos de Benavente a prepararse para las condiciones clim√°ticas t√≠picas de esta estaci√≥n.`
                    );
                }
                
                return variations;
            },
            
            // Variaciones para soporte t√©cnico
            getSupportVariations: () => {
                const now = new Date();
                const hours = now.getHours();
                const dayOfWeek = now.getDay();
                
                // Obtener una frase local aleatoria
                const localPhrase = benaventeInfo.localPhrases[
                    Math.floor(Math.random() * benaventeInfo.localPhrases.length)
                ];
                
                const variations = [
                    `Lamento que est√©s teniendo problemas. ${localPhrase} Como asistente meteorol√≥gico para Benavente, har√© lo posible por ayudarte. Aqu√≠ hay algunas soluciones que suelen funcionar:`,
                    `Vaya, parece que hay un problema. ${localPhrase} No te preocupes, como experto en el sistema Horus de Benavente, puedo ayudarte a resolverlo. Prueba estos pasos:`,
                    `¬°Vaya fresquete! Veo que est√°s teniendo problemas. ${localPhrase} Como asistente meteorol√≥gico para Benavente, te recomiendo:`
                ];
                
                return variations;
            },
            
            // Variaciones para informaci√≥n personal
            getPersonalInfoVariations: () => {
                const now = new Date();
                const hours = now.getHours();
                const dayOfWeek = now.getDay();
                
                // Obtener una frase local aleatoria
                const localPhrase = benaventeInfo.localPhrases[
                    Math.floor(Math.random() * benaventeInfo.localPhrases.length)
                ];
                
                const variations = [
                    `Soy Horus AI, un asistente inteligente especializado en el clima de Benavente. ${localPhrase} Fui creado para ayudar a los vecinos y visitantes de Benavente a entender mejor el clima de nuestra ciudad, ubicada en la llanura del Duero a ${benaventeInfo.altitude}.`,
                    `¬°Hola! Soy Horus AI, tu asistente meteorol√≥gico para Benavente. ${localPhrase} Mi prop√≥sito es proporcionar informaci√≥n precisa y √∫til sobre el clima de Benavente, con su clima mediterr√°neo continentalizado y sus caracter√≠sticas √∫nicas.`,
                    `Soy Horus AI, un sistema de inteligencia artificial especializado en meteorolog√≠a para Benavente. ${localPhrase} Aunque no soy humano, tengo un profundo conocimiento del clima de Benavente y estoy aqu√≠ para ayudarte a entenderlo mejor.`
                ];
                
                return variations;
            },
            
            // Variaciones para informaci√≥n general
            getGeneralInfoVariations: () => {
                const now = new Date();
                const hours = now.getHours();
                const dayOfWeek = now.getDay();
                const month = now.getMonth();
                
                // Obtener una frase local aleatoria
                const localPhrase = benaventeInfo.localPhrases[
                    Math.floor(Math.random() * benaventeInfo.localPhrases.length)
                ];
                
                // Determinar si es relevante para la √©poca del a√±o
                const isSummer = month >= 5 && month <= 8;
                const isWinter = month >= 11 || month <= 2;
                
                const variations = [
                    `Benavente, ubicada a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterr√°neo continentalizado. ${localPhrase} ${isSummer ? 'En verano, las temperaturas pueden superar los 35¬∞C.' : isWinter ? 'En invierno, las temperaturas pueden bajar de 0¬∞C.' : 'En esta √©poca del a√±o, el clima es moderado con d√≠as agradables.'}`,
                    `Nuestra querida Benavente se encuentra a ${benaventeInfo.altitude} sobre el nivel del mar, con coordenadas ${benaventeInfo.coordinates}. ${localPhrase} El clima de Benavente es mediterr√°neo continentalizado, caracterizado por veranos calurosos e inviernos fr√≠os.`,
                    `Benavente, en la provincia de Zamora, disfruta de un clima mediterr√°neo continentalizado gracias a su ubicaci√≥n en la llanura del Duero a ${benaventeInfo.altitude}. ${localPhrase} Las temperaturas var√≠an desde -5¬∞C en invierno hasta m√°s de 35¬∞C en verano.`
                ];
                
                return variations;
            },
            
            // Variaciones para preguntas fuera del √°mbito
            getOutOfScopeVariations: (domain) => {
                const now = new Date();
                const hours = now.getHours();
                const dayOfWeek = now.getDay();
                
                // Obtener una frase local aleatoria
                const localPhrase = benaventeInfo.localPhrases[
                    Math.floor(Math.random() * benaventeInfo.localPhrases.length)
                ];
                
                const variations = {
                    salud: [
                        `Soy un asistente meteorol√≥gico especializado para Benavente, no tengo informaci√≥n m√©dica. ${localPhrase} Para consultas sobre salud, te recomiendo contactar a un profesional m√©dico calificado en Benavente.`,
                        `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol√≥gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf√©ricas. Para informaci√≥n m√©dica, consulta a un profesional de salud.`,
                        `¬°Vaya! Veo que necesitas informaci√≥n m√©dica. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s√≠ puedo decirte c√≥mo el clima afecta ciertas condiciones de salud.`
                    ],
                    tecnolog√≠a: [
                        `Soy un asistente meteorol√≥gico especializado para Benavente. ${localPhrase} Para consultas sobre tecnolog√≠a, te recomiendo buscar en foros especializados o consultar documentaci√≥n oficial de los productos.`,
                        `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol√≥gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf√©ricas. Para informaci√≥n tecnol√≥gica, consulta fuentes especializadas.`,
                        `¬°Vaya fresquete! Veo que necesitas ayuda tecnol√≥gica. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s√≠ puedo decirte c√≥mo el clima afecta a algunos dispositivos electr√≥nicos.`
                    ],
                    deportes: [
                        `Soy un asistente meteorol√≥gico especializado para Benavente. ${localPhrase} Para informaci√≥n sobre deportes, te recomiendo visitar el Ayuntamiento de Benavente o seguir el Club Deportivo local.`,
                        `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol√≥gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf√©ricas. Pero puedo decirte c√≥mo el clima afecta a las actividades deportivas al aire libre.`,
                        `¬°Vaya! Veo que necesitas informaci√≥n deportiva. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s√≠ puedo decirte c√≥mo el clima afecta a las actividades deportivas en nuestra zona.`
                    ],
                    entretenimiento: [
                        `Soy un asistente meteorol√≥gico especializado para Benavente. ${localPhrase} Para informaci√≥n sobre entretenimiento, te recomiendo visitar la p√°gina web del Ayuntamiento de Benavente o seguir eventos en la Plaza Mayor.`,
                        `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol√≥gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf√©ricas. Pero puedo decirte c√≥mo el clima afecta a los eventos al aire libre.`,
                        `¬°Vaya fresquete! Veo que necesitas informaci√≥n de entretenimiento. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s√≠ puedo decirte c√≥mo el clima afecta a los eventos en nuestra zona.`
                    ],
                    comida: [
                        `Soy un asistente meteorol√≥gico especializado para Benavente. ${localPhrase} Para recetas o informaci√≥n sobre comida, te recomiendo consultar sitios web especializados en gastronom√≠a zamorana.`,
                        `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol√≥gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf√©ricas. Pero puedo decirte c√≥mo el clima afecta a los productos locales de temporada.`,
                        `¬°Vaya! Veo que necesitas informaci√≥n culinaria. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s√≠ puedo decirte c√≥mo el clima afecta a los productos locales que se usan en la cocina tradicional.`
                    ],
                    educaci√≥n: [
                        `Soy un asistente meteorol√≥gico especializado para Benavente. ${localPhrase} Para informaci√≥n educativa, te recomiendo consultar la p√°gina web del Ayuntamiento de Benavente o contactar al IES local.`,
                        `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol√≥gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf√©ricas. Pero puedo proporcionar informaci√≥n sobre meteorolog√≠a y ciencias atmosf√©ricas.`,
                        `¬°Vaya fresquete! Veo que necesitas informaci√≥n educativa. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s√≠ puedo compartir contigo conocimientos sobre meteorolog√≠a y clima local.`
                    ],
                    finanzas: [
                        `Soy un asistente meteorol√≥gico especializado para Benavente. ${localPhrase} Para consultas financieras, te recomiendo consultar a un asesor financiero en Benavente.`,
                        `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol√≥gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf√©ricas. Pero puedo decirte c√≥mo el clima afecta a ciertos sectores econ√≥micos locales.`,
                        `¬°Vaya! Veo que necesitas informaci√≥n financiera. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s√≠ puedo decirte c√≥mo el clima afecta a actividades econ√≥micas como la agricultura en nuestra zona.`
                    ],
                    general: [
                        `Soy un asistente meteorol√≥gico especializado para Benavente. ${localPhrase} Mi conocimiento est√° limitado a monitorear y analizar datos meteorol√≥gicos en Benavente, el funcionamiento del sistema Horus y an√°lisis de tendencias clim√°ticas de la zona.`,
                        `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol√≥gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf√©ricas de nuestra zona.`,
                        `¬°Vaya fresquete! Veo que necesitas informaci√≥n fuera de mi √°mbito. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s√≠ puedo compartir contigo informaci√≥n relevante sobre el clima de nuestra querida ciudad.`
                    ]
                };
                
                return variations[domain] || variations.general;
            },
            
            // Variaciones para preguntas no entendidas
            getUnrelatedVariations: () => {
                const now = new Date();
                const hours = now.getHours();
                const dayOfWeek = now.getDay();
                
                // Obtener una frase local aleatoria
                const localPhrase = benaventeInfo.localPhrases[
                    Math.floor(Math.random() * benaventeInfo.localPhrases.length)
                ];
                
                return [
                    `Lamento no entender tu pregunta. ${localPhrase} Soy un asistente meteorol√≥gico especializado en Benavente. ¬øPodr√≠as reformular tu pregunta para que est√© relacionada con el clima de Benavente?`,
                    `¬°Vaya fresquete! No estoy seguro de entender lo que me pides. ${localPhrase} Como asistente meteorol√≥gico para Benavente, ¬øpodr√≠as preguntar algo relacionado con el clima de nuestra ciudad?`,
                    `Perd√≥n, no he captado bien tu pregunta. ${localPhrase} Como experto en el clima de Benavente, necesito que tu pregunta est√© relacionada con meteorolog√≠a o el sistema Horus.`
                ];
            }
        };

        // Funci√≥n para obtener una variaci√≥n aleatoria
        const getRandomVariation = (variationsArray) => {
            if (!variationsArray || variationsArray.length === 0) {
                return "No se encontraron variaciones para esta consulta.";
            }
            
            const randomIndex = Math.floor(Math.random() * variationsArray.length);
            return variationsArray[randomIndex];
        };

        // Renderizar gr√°ficos
        const renderChart = (parameter, chartData, chartId) => {
            const chartCtx = document.getElementById(chartId)?.getContext('2d');
            if (!chartCtx) return;
            
            // Determina el nombre del par√°metro y colores
            let paramName = '';
            let color = '#4a90e2';
            let unit = '';
            
            switch (parameter) {
                case 'temperatura':
                    paramName = 'Temperatura';
                    color = '#FF6384';
                    unit = '¬∞C';
                    break;
                case 'humedad':
                    paramName = 'Humedad';
                    color = '#36A2EB';
                    unit = '%';
                    break;
                case 'presi√≥n':
                    paramName = 'Presi√≥n Atmosf√©rica';
                    color = '#FFCE56';
                    unit = 'hPa';
                    break;
                case 'lluvia':
                    paramName = 'Precipitaci√≥n';
                    color = '#46BFBD';
                    unit = 'Presencia';
                    break;
                case 'viento':
                    paramName = 'Viento';
                    color = '#C9CBCF';
                    unit = 'm/s';
                    break;
                case 'gas':
                    paramName = 'Nivel de Gas';
                    color = '#FDB45C';
                    unit = 'kŒ©';
                    break;
                case 'direcci√≥n':
                    paramName = 'Direcci√≥n del Viento';
                    color = '#9966FF';
                    unit = '¬∞';
                    break;
                default:
                    paramName = 'Medici√≥n';
                    unit = '';
            }
            
            // Crea el nuevo gr√°fico
            const chart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: paramName,
                         chartData,
                        borderColor: color,
                        backgroundColor: `${color}40`,
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: unit
                            }
                        }
                    }
                }
            });
            
            // Almacenar instancia del gr√°fico para actualizarla al cambiar de tema
            charts.push(chart);
        };

        // Renderizar gr√°ficos de comparaci√≥n
        const renderComparisonChart = (parameter, chartData1, chartData2, period1, period2, chartId) => {
            const chartCtx = document.getElementById(chartId)?.getContext('2d');
            if (!chartCtx) return;
            
            // Determina el nombre del par√°metro y colores
            let paramName = '';
            let color1 = '#FF6384';
            let color2 = '#36A2EB';
            let unit = '';
            
            switch (parameter) {
                case 'temperatura':
                    paramName = 'Temperatura';
                    unit = '¬∞C';
                    break;
                case 'humedad':
                    paramName = 'Humedad';
                    unit = '%';
                    break;
                case 'presi√≥n':
                    paramName = 'Presi√≥n Atmosf√©rica';
                    unit = 'hPa';
                    break;
                case 'lluvia':
                    paramName = 'Precipitaci√≥n';
                    unit = 'Presencia';
                    break;
                case 'viento':
                    paramName = 'Viento';
                    unit = 'm/s';
                    break;
                case 'gas':
                    paramName = 'Nivel de Gas';
                    unit = 'kŒ©';
                    break;
                case 'direcci√≥n':
                    paramName = 'Direcci√≥n del Viento';
                    unit = '¬∞';
                    break;
                default:
                    paramName = 'Medici√≥n';
                    unit = '';
            }
            
            // Crea el nuevo gr√°fico
            const chart = new Chart(chartCtx, {
                type: 'line',
                 {
                    datasets: [
                        {
                            label: period1,
                             chartData1,
                            borderColor: color1,
                            backgroundColor: `${color1}40`,
                            borderWidth: 3,
                            tension: 0.3,
                            pointRadius: 3
                        },
                        {
                            label: period2,
                            data: chartData2,
                            borderColor: color2,
                            backgroundColor: `${color2}40`,
                            borderWidth: 3,
                            tension: 0.3,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: unit
                            }
                        }
                    }
                }
            });
            
            // Almacenar instancia del gr√°fico para actualizarla al cambiar de tema
            charts.push(chart);
        };

        // Renderizar gr√°ficos de extremos
        const renderExtremesChart = (parameter, chartData, maxDate, minDate, chartId) => {
            const chartCtx = document.getElementById(chartId)?.getContext('2d');
            if (!chartCtx) return;
            
            // Determina el nombre del par√°metro y colores
            let paramName = '';
            let color = '#4a90e2';
            let unit = '';
            
            switch (parameter) {
                case 'temperatura':
                    paramName = 'Temperatura';
                    color = '#FF6384';
                    unit = '¬∞C';
                    break;
                case 'humedad':
                    paramName = 'Humedad';
                    color = '#36A2EB';
                    unit = '%';
                    break;
                case 'presi√≥n':
                    paramName = 'Presi√≥n Atmosf√©rica';
                    color = '#FFCE56';
                    unit = 'hPa';
                    break;
                case 'lluvia':
                    paramName = 'Precipitaci√≥n';
                    color = '#46BFBD';
                    unit = 'Presencia';
                    break;
                case 'viento':
                    paramName = 'Viento';
                    color = '#C9CBCF';
                    unit = 'm/s';
                    break;
                case 'gas':
                    paramName = 'Nivel de Gas';
                    color = '#FDB45C';
                    unit = 'kŒ©';
                    break;
                case 'direcci√≥n':
                    paramName = 'Direcci√≥n del Viento';
                    color = '#9966FF';
                    unit = '¬∞';
                    break;
                default:
                    paramName = 'Medici√≥n';
                    unit = '';
            }
            
            // Preparar datos con marcadores para m√°ximos y m√≠nimos
            const dataWithMarkers = chartData.map(item => ({
                x: item.x,
                y: item.y,
                pointBackgroundColor: item.x.toISOString() === maxDate || item.x.toISOString() === minDate ? 
                                    (item.x.toISOString() === maxDate ? '#FF0000' : '#0000FF') : 
                                    color
            }));
            
            // Crea el nuevo gr√°fico
            const chart = new Chart(chartCtx, {
                type: 'line',
                 {
                    datasets: [{
                        label: paramName,
                         dataWithMarkers,
                        borderColor: color,
                        backgroundColor: `${color}40`,
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: function(context) {
                            const index = context.dataIndex;
                            const value = context.dataset.data[index];
                            return value.pointBackgroundColor !== color ? 6 : 3;
                        },
                        pointBackgroundColor: function(context) {
                            const index = context.dataIndex;
                            const value = context.dataset.data[index];
                            return value.pointBackgroundColor;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: unit
                            }
                        }
                    }
                }
            });
            
            // Almacenar instancia del gr√°fico para actualizarla al cambiar de tema
            charts.push(chart);
        };

        // Renderizar gr√°ficos de correlaci√≥n
        const renderCorrelationChart = (parameter1, parameter2, chartData, chartId) => {
            const chartCtx = document.getElementById(chartId)?.getContext('2d');
            if (!chartCtx) return;
            
            // Determina los nombres de los par√°metros y colores
            let paramName1 = '';
            let paramName2 = '';
            let color1 = '#FF6384';
            let color2 = '#36A2EB';
            let unit1 = '';
            let unit2 = '';
            
            const getParameterInfo = (parameter) => {
                switch (parameter) {
                    case 'temperatura':
                        return { name: 'Temperatura', color: '#FF6384', unit: '¬∞C' };
                    case 'humedad':
                        return { name: 'Humedad', color: '#36A2EB', unit: '%' };
                    case 'presi√≥n':
                        return { name: 'Presi√≥n Atmosf√©rica', color: '#FFCE56', unit: 'hPa' };
                    case 'lluvia':
                        return { name: 'Precipitaci√≥n', color: '#46BFBD', unit: 'Presencia' };
                    case 'viento':
                        return { name: 'Viento', color: '#C9CBCF', unit: 'm/s' };
                    case 'gas':
                        return { name: 'Nivel de Gas', color: '#FDB45C', unit: 'kŒ©' };
                    case 'direcci√≥n':
                        return { name: 'Direcci√≥n del Viento', color: '#9966FF', unit: '¬∞' };
                    default:
                        return { name: 'Medici√≥n', color: '#4a90e2', unit: '' };
                }
            };
            
            const info1 = getParameterInfo(parameter1);
            const info2 = getParameterInfo(parameter2);
            
            paramName1 = info1.name;
            color1 = info1.color;
            unit1 = info1.unit;
            
            paramName2 = info2.name;
            color2 = info2.color;
            unit2 = info2.unit;
            
            // Crea el nuevo gr√°fico
            const chart = new Chart(chartCtx, {
                type: 'line',
                 {
                    datasets: [
                        {
                            label: paramName1,
                             chartData.map(item => ({ x: item.x, y: item.y1 })),
                            borderColor: color1,
                            backgroundColor: `${color1}40`,
                            borderWidth: 3,
                            tension: 0.3,
                            pointRadius: 3
                        },
                        {
                            label: paramName2,
                             chartData.map(item => ({ x: item.x, y: item.y2 })),
                            borderColor: color2,
                            backgroundColor: `${color2}40`,
                            borderWidth: 3,
                            tension: 0.3,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: `${unit1} / ${unit2}`
                            }
                        }
                    }
                }
            });
            
            // Almacenar instancia del gr√°fico para actualizarla al cambiar de tema
            charts.push(chart);
        };

        // Inicializar chatbot
        document.addEventListener('DOMContentLoaded', () => {
            initChatbot();
        });
    </script>
</body>
</html>
