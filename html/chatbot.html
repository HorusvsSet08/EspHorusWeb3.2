<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatbot Meteorol칩gico - Horus Benavente</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/chatbot.css" />
  <script src="../js/PapaParse.js"></script>
  <script src="../js/chart.js"></script>
</head>
<body class="light-mode chatbot-page">
<nav class="nav">
  <div class="nav-container">
    <div class="nav-buttons">
      <a href="../index.html" class="nav-btn"><span class="nav-icon">游</span> Inicio</a>
      <a href="mqtt.html" class="nav-btn">
        <span class="nav-icon">游니</span> Datos en Vivo
      </a>
      <a href="analisis.html" class="nav-btn">
        <span class="nav-icon">游늵</span> An치lisis
      </a>
      <a href="chatbot.html" class="nav-btn active">
        <span class="nav-icon">游뱄</span> Chatbot
      </a>
    </div>
    <!-- Switch de Galahad -->
    <div class="nav-right">
      <label class="theme-switch">
        <input type="checkbox" class="theme-switch__checkbox">
        <div class="theme-switch__container">
          <div class="theme-switch__clouds"></div>
          <div class="theme-switch__stars-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 55" fill="none">
            </svg>
          </div>
          <div class="theme-switch__sun-moon-container">
            <div class="theme-switch__moon">
              <div class="theme-switch__spot"></div>
              <div class="theme-switch__spot"></div>
              <div class="theme-switch__spot"></div>
            </div>
          </div>
        </div>
      </label>
      <button id="api-config-toggle" class="nav-btn" title="Configuraci칩n de API">
        <span class="nav-icon">丘뙖잺</span>
      </button>
    </div>
  </div>
</nav>

<div class="container">
  <header>
    <h1>游뱄 Horus AI - Asistente Meteorol칩gico de Benavente</h1>
    <p>Un asistente especializado en an치lisis meteorol칩gico para <strong>Benavente, Zamora</strong></p>
  </header>
  
  <main id="chat-container" class="chat-main-container">
    <div id="chat-messages" class="chat-messages">
      <div class="message bot welcome-message">
        <div class="bot-avatar">
          <span>游뱄</span>
        </div>
        <div class="message-content">
          춰Hola! Soy Horus AI, tu asistente inteligente especializado en meteorolog칤a para <strong>Benavente, Zamora</strong>.<br><br>
          <strong>Puedo ayudarte con:</strong>
          <ul>
            <li>Consultar la temperatura, humedad, presi칩n y otros datos actuales en Benavente</li>
            <li>Analizar tendencias hist칩ricas de los 칰ltimos d칤as, semanas o meses en la zona</li>
            <li>Comparar condiciones meteorol칩gicas entre diferentes periodos en Benavente</li>
            <li>Predecir condiciones clim치ticas basado en datos hist칩ricos de la regi칩n</li>
            <li>Explicar c칩mo el clima afecta actividades t칤picas de Benavente</li>
            <li>Responder preguntas sobre el sistema Horus instalado en Benavente</li>
          </ul>
          <br>
          <strong>Ejemplos de preguntas:</strong>
          <div class="suggestion">쮺u치l es la temperatura actual en Benavente?</div>
          <div class="suggestion">쮺칩mo ha sido la tendencia de humedad en Benavente esta semana?</div>
          <div class="suggestion">Muestra la tendencia de presi칩n de los 칰ltimos 7 d칤as en Benavente</div>
        </div>
        <div class="message-time">Ahora</div>
      </div>
    </div>
    
    <div class="chat-input-container">
      <input type="text" id="user-input" placeholder="Escribe tu pregunta sobre Benavente...">
      <button id="send-button">Enviar</button>
    </div>
    
    <div class="status-bar">
      <div id="status-indicator" class="status-indicator"></div>
      <span id="status-text"></span>
    </div>
    
    <!-- Configuraci칩n de API de OpenAI -->
    <div class="api-config" id="api-config">
      <h3>Configuraci칩n de API de OpenAI</h3>
      <p>Configura tu clave API de OpenAI para obtener respuestas m치s avanzadas y precisas.</p>
      <input type="password" id="api-key-input" placeholder="Ingresa tu clave API de OpenAI aqu칤">
      <button id="save-api-key">Guardar API Key</button>
      <div class="api-status" id="api-status">Estado: No configurado</div>
    </div>
  </main>
</div>

<style>
  /* Estilos para el contenedor del chat */
  .chat-main-container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--card-bg);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  /* Mensajes del chat */
  .chat-messages {
    height: 60vh;
    overflow-y: auto;
    padding: 15px;
    background: var(--dark-bg);
  }

  .message {
    display: flex;
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
  }

  .message.user {
    justify-content: flex-end;
  }

  .message.bot {
    justify-content: flex-start;
  }

  .bot-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    flex-shrink: 0;
  }

  .bot-avatar span {
    font-size: 20px;
  }

  .message-content {
    background: var(--card-bg);
    color: var(--text);
    padding: 12px 15px;
    border-radius: 18px;
    max-width: 75%;
    line-height: 1.5;
  }

  .message.user .message-content {
    background: var(--primary);
    color: #000;
    border-bottom-right-radius: 5px;
  }

  .message-time {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 5px;
    text-align: right;
    opacity: 0.7;
  }

  /* Barra de entrada */
  .chat-input-container {
    display: flex;
    padding: 10px 15px;
    background: var(--card-bg);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .chat-input-container input {
    flex: 1;
    padding: 12px 15px;
    border: none;
    background: var(--dark-bg);
    color: var(--text);
    border-radius: 20px 0 0 20px;
    font-size: 16px;
    outline: none;
    transition: var(--transition);
  }

  .chat-input-container input:focus {
    box-shadow: 0 0 0 2px var(--primary-glow);
  }

  .chat-input-container button {
    background: var(--primary);
    color: #000;
    border: none;
    padding: 12px 20px;
    border-radius: 0 20px 20px 0;
    cursor: pointer;
    font-weight: bold;
    transition: var(--transition);
  }

  .chat-input-container button:hover {
    background: #00d0e0;
    transform: translateY(-2px);
  }

  /* Sugerencias de preguntas */
  .suggestion {
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 12px;
    margin: 5px 0;
    cursor: pointer;
    transition: var(--transition);
  }

  .suggestion:hover {
    background: rgba(0, 234, 255, 0.2);
    transform: translateX(5px);
  }

  /* Efecto de escritura */
  .typing-indicator {
    display: inline-flex;
    gap: 4px;
    margin-right: 8px;
  }

  .typing-indicator span {
    width: 6px;
    height: 6px;
    background: var(--primary);
    border-radius: 50%;
    animation: typing 1s infinite;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%, 100% { transform: translateY(0); opacity: 0.5; }
    50% { transform: translateY(-5px); opacity: 1; }
  }

  /* An치lisis de datos */
  .analysis-header {
    margin-bottom: 15px;
  }

  .analysis-header h2 {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--primary);
  }

  .analysis-header p {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .statistics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }

  .stat-item {
    background: rgba(0, 234, 255, 0.1);
    padding: 10px;
    border-radius: 8px;
    text-align: center;
  }

  .stat-value {
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--primary);
    display: block;
    margin-top: 5px;
  }

  .trend-analysis {
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
  }

  .trend-analysis h3 {
    margin-top: 0;
    color: var(--primary);
  }

  .trend-description {
    color: var(--text-secondary);
  }

  .prediction-container {
    margin-top: 15px;
  }

  .prediction-reliability {
    margin-bottom: 10px;
    font-size: 0.9rem;
  }

  .reliability-bar {
    height: 6px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    margin-top: 4px;
  }

  .reliability-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  .prediction-chart-container {
    height: 250px;
    margin-top: 10px;
  }

  .chart-title {
    font-weight: bold;
    margin-bottom: 8px;
    color: var(--primary);
    font-size: 1rem;
  }

  .source-badge {
    display: inline-block;
    margin-left: 5px;
    font-size: 0.8rem;
    opacity: 0.7;
  }

  .welcome-message {
    background: rgba(0, 234, 255, 0.05);
    border-radius: 15px;
    padding: 15px;
    border: 1px solid rgba(0, 234, 255, 0.2);
  }
  
  /* An치lisis detallado */
  .detailed-analysis {
    margin-top: 15px;
    background: rgba(0, 0, 0, 0.1);
    padding: 15px;
    border-radius: 10px;
  }
  
  .detailed-analysis h3 {
    color: var(--primary);
    margin-top: 0;
  }
  
  .detailed-analysis p {
    line-height: 1.6;
    margin-bottom: 10px;
  }
  
  .confidence-indicator {
    display: inline-block;
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    margin-top: 5px;
  }
  
  /* Soporte para preguntas generales */
  .general-answer {
    margin-top: 15px;
    background: rgba(0, 150, 255, 0.1);
    padding: 15px;
    border-radius: 10px;
  }
  
  .general-answer h3 {
    color: var(--primary);
    margin-top: 0;
  }
  
  .general-answer p {
    line-height: 1.6;
  }
  
  .general-answer ul {
    padding-left: 20px;
    margin: 10px 0;
  }
  
  .general-answer li {
    margin-bottom: 5px;
  }
  
  .system-info {
    margin-top: 15px;
    background: rgba(76, 175, 80, 0.1);
    padding: 15px;
    border-radius: 10px;
  }
  
  .system-info h3 {
    color: #4CAF50;
    margin-top: 0;
  }
  
  .system-info p {
    line-height: 1.6;
  }
  
  /* Soporte para preguntas fuera del 치mbito */
  .out-of-scope {
    margin-top: 15px;
    background: rgba(244, 67, 54, 0.1);
    padding: 15px;
    border-radius: 10px;
  }
  
  .out-of-scope h3 {
    color: #f44336;
    margin-top: 0;
  }
  
  .out-of-scope p {
    line-height: 1.6;
  }
  
  /* Configuraci칩n de API */
  .api-config {
    padding: 15px;
    margin: 15px;
    background: var(--dark-bg);
    border-radius: 10px;
    display: none;
  }

  .api-config h3 {
    color: var(--primary);
    margin-top: 0;
  }

  .api-config p {
    margin-bottom: 10px;
  }

  .api-config input {
    width: 100%;
    padding: 8px 12px;
    margin-bottom: 10px;
    border-radius: 5px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(0, 0, 0, 0.2);
    color: white;
  }

  .api-config button {
    background: var(--primary);
    color: #000;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .api-config button:hover {
    background: #00d0e0;
  }

  .api-status {
    font-size: 0.9rem;
    margin-top: 5px;
    opacity: 0.7;
  }

  .api-status.connected {
    color: #4CAF50;
  }

  .api-status.disconnected {
    color: #f44336;
  }
</style>

<script>
  // Variables globales
  let historicalData = [];
  let chatbotReady = false;
  let charts = []; // Para almacenar instancias de gr치ficos
  
  // Contexto de conversaci칩n mejorado
  let conversationContext = {
    lastParameter: null,
    lastPeriod: null,
    lastQuestionType: null,
    conversationHistory: [],
    entityContext: {},
    temporalContext: null,
    spatialContext: null,
    confidenceThreshold: 0.65 // Umbral de confianza para aceptar una intenci칩n
  };

  // Informaci칩n espec칤fica de Benavente
  const benaventeInfo = {
    location: "Benavente, Zamora",
    coordinates: "41.7667춿 N, 5.3500춿 W",
    altitude: "719 metros sobre el nivel del mar",
    climate: "Clima mediterr치neo continentalizado",
    typicalWeather: {
      summer: "Caluroso y seco, con temperaturas m치ximas que pueden superar los 35춿C",
      winter: "Fr칤o, con temperaturas m칤nimas que pueden llegar a -5춿C",
      spring: "Moderado con lluvias ocasionales",
      autumn: "Fresco con d칤as soleados y noches fr칤as"
    },
    localFeatures: "Ubicado en la llanura del Duero, con influencia de la meseta castellana",
    localLandmarks: [
      "Plaza Mayor de Benavente",
      "Iglesia de Santiago",
      "Castillo de Benavente",
      "R칤o Esla",
      "Mercado de Ganados"
    ],
    localEvents: [
      "Feria de San Mart칤n (noviembre)",
      "Semana Santa",
      "Fiestas Patronales (agosto)",
      "Feria Agropecuaria (mayo)"
    ],
    localPhrases: [
      "춰Vaya fresquete hace hoy!",
      "Esto parece que va a aguar",
      "Hace un sol de justicia",
      "Est치 cayendo un chaparr칩n",
      "Hace un d칤a de perros",
      "Hoy hace un d칤a de campo",
      "Est치 el d칤a nublao",
      "춰Qu칠 bochorno!",
      "Est치 fresquete",
      "Est치 el d칤a apretao"
    ]
  };

  // Elementos del DOM
  const chatMessages = document.getElementById('chat-messages');
  const userInput = document.getElementById('user-input');
  const sendButton = document.getElementById('send-button');
  const statusIndicator = document.getElementById('status-indicator');
  const statusText = document.getElementById('status-text');
  
  // Elementos de configuraci칩n de API
  const apiConfig = document.getElementById('api-config');
  const apiKeyInput = document.getElementById('api-key-input');
  const saveApiKeyBtn = document.getElementById('save-api-key');
  const apiStatus = document.getElementById('api-status');
  const apiConfigToggle = document.getElementById('api-config-toggle');

  // Actualizar estado
  const updateStatus = (message, isError = false) => {
    statusText.textContent = message;
    if (isError) {
      statusIndicator.classList.add('error');
    } else {
      statusIndicator.classList.remove('error');
    }
  };

  // A침adir mensaje al chat
  const addMessage = (content, isUser = false, source = 'local') => {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.classList.add(isUser ? 'user' : 'bot');
    
    // Marca de fuente para mensajes del bot
    const sourceBadge = source !== 'local' 
      ? `<span class="source-badge" title="Informaci칩n obtenida de: ${source}">${source === 'web' ? '游깷' : source}</span>` 
      : '';
      
    if (isUser) {
      messageDiv.innerHTML = `
        <div class="message-content">${content}</div>
        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="bot-avatar"><span>游뱄</span></div>
        <div class="message-content">${content}${sourceBadge}</div>
        <div class="message-time">Ahora</div>
      `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Actualizar el tiempo "Ahora" a minutos reales despu칠s de 5 segundos
    setTimeout(() => {
      const timeElement = messageDiv.querySelector('.message-time');
      if (timeElement && timeElement.textContent === 'Ahora') {
        timeElement.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      }
    }, 5000);
    
    // Guardar en historial de conversaci칩n
    if (!isUser) {
      conversationContext.conversationHistory.push({
        role: 'assistant',
        content,
        timestamp: new Date().toISOString()
      });
    }
  };

  // Mostrar estado de carga
  const showLoading = (message = "Analizando tu pregunta sobre Benavente") => {
    const loadingId = `loading-${Date.now()}`;
    const loadingDiv = document.createElement('div');
    loadingDiv.id = loadingId;
    loadingDiv.className = 'message bot';
    loadingDiv.innerHTML = `
      <div class="bot-avatar"><span>游뱄</span></div>
      <div class="message-content">
        <div class="typing-indicator"><span></span><span></span><span></span></div>
        <div class="loading-text">${message}</div>
      </div>
      <div class="message-time">Escribiendo...</div>
    `;
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return loadingId;
  };

  // Nueva integraci칩n con OpenAI API
  const openAIApi = {
    apiKey: null,
    apiUrl: 'https://api.openai.com/v1/chat/completions',
    
    // Verificar si est치 configurado
    isConfigured: function() {
      return this.apiKey !== null && this.apiKey.trim() !== '';
    },
    
    // Configurar la API key
    configure: function(apiKey) {
      this.apiKey = apiKey;
      localStorage.setItem('openai_api_key', apiKey);
      console.log('OpenAI API configurada correctamente');
      return true;
    },
    
    // Inicializar desde localStorage
    init: function() {
      const savedKey = localStorage.getItem('openai_api_key');
      if (savedKey) {
        this.apiKey = savedKey;
        return true;
      }
      return false;
    },
    
    // Limpiar configuraci칩n
    clear: function() {
      this.apiKey = null;
      localStorage.removeItem('openai_api_key');
    },
    
    // Verificar validez de la API key
    async verifyApiKey() {
      if (!this.isConfigured()) return false;
      
      try {
        const response = await fetch('https://api.openai.com/v1/models', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${this.apiKey}`
          }
        });
        
        return response.ok;
      } catch (error) {
        console.error('Error verificando API key:', error);
        return false;
      }
    },
    
    // Generar respuesta usando OpenAI
    generateResponse: async function(userMessage, context) {
      if (!this.isConfigured()) {
        return null;
      }
      
      try {
        // Preparar el prompt con contexto meteorol칩gico
        const prompt = this.buildPrompt(userMessage, context);
        
        const response = await fetch(this.apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
              {
                role: 'system',
                content: `Eres Horus AI, un asistente meteorol칩gico especializado en Benavente, Zamora. Tienes acceso a datos meteorol칩gicos en tiempo real y datos hist칩ricos. Tu tarea es proporcionar informaci칩n precisa y 칰til sobre el clima de Benavente, con un enfoque en explicaciones claras y consejos pr치cticos. Habla de manera amigable y profesional, usando referencias locales cuando sea apropiado.`
              },
              ...context.conversationHistory.map(msg => ({
                role: msg.role,
                content: msg.content
              })),
              {
                role: 'user',
                content: prompt
              }
            ],
            temperature: 0.7,
            max_tokens: 500,
            top_p: 1,
            frequency_penalty: 0,
            presence_penalty: 0
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Error de API: ${response.status} - ${errorData.error?.message || 'Error desconocido'}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error('Error al usar OpenAI API:', error);
        return null;
      }
    },
    
    // Construir el prompt con contexto
    buildPrompt: function(userMessage, context) {
      // Incluir contexto meteorol칩gico espec칤fico de Benavente
      const benaventeContext = `
        Benavente, Zamora - Informaci칩n clave:
        - Ubicaci칩n: 41.7667춿 N, 5.3500춿 W
        - Altitud: 719 metros sobre el nivel del mar
        - Clima: Mediterr치neo continentalizado
        - Verano: Caluroso y seco, temperaturas m치ximas >35춿C
        - Invierno: Fr칤o, temperaturas m칤nimas <0춿C
        - Primavera/Oto침o: Moderados con lluvias ocasionales
        - Ubicado en la llanura del Duero, con influencia de la meseta castellana
      `;
      
      // Incluir datos actuales si est치n disponibles
      const latestData = context.historicalData && context.historicalData.length > 0 ? 
        context.historicalData[context.historicalData.length - 1] : null;
      
      let currentConditions = '';
      if (latestData) {
        currentConditions = `
          Condiciones actuales en Benavente:
          - Temperatura: ${latestData.temp.toFixed(1)}춿C
          - Humedad: ${latestData.hum.toFixed(0)}%
          - Presi칩n: ${latestData.pres.toFixed(0)} hPa
          - Direcci칩n del viento: ${getWindDirectionName(latestData.wind_dir)} (${latestData.wind_dir}춿)
          - Velocidad del viento: ${latestData.wind.toFixed(1)} m/s
          - Calidad del aire: ${latestData.gas.toFixed(2)} k풜
        `;
      }
      
      // Incluir contexto de conversaci칩n
      const conversationContext = context.conversationContext ? `
        Contexto de conversaci칩n:
        - 칔ltimo par치metro mencionado: ${context.conversationContext.lastParameter || 'Ninguno'}
        - 칔ltimo periodo analizado: ${context.conversationContext.lastPeriod || 'Ninguno'}
        - 칔ltimo tipo de pregunta: ${context.conversationContext.lastQuestionType || 'Ninguno'}
      ` : '';
      
      return `Contexto meteorol칩gico de Benavente:
        ${benaventeContext}
        ${currentConditions}
        ${conversationContext}
        
        Mensaje del usuario: "${userMessage}"
        
        Proporciona una respuesta detallada, precisa y 칰til sobre el clima de Benavente, adaptada a la pregunta del usuario. Usa un tono amigable y profesional, incorporando referencias locales cuando sea apropiado. Si la pregunta no est치 relacionada con el clima, indica amablemente que tu especialidad es el clima de Benavente y ofrece ayuda en ese 치mbito.`;
    }
  };

  // Cargar datos hist칩ricos reales de Benavente
  const loadHistoricalData = async () => {
    return new Promise((resolve, reject) => {
      try {
        // Simulaci칩n de carga de datos (en producci칩n, esto vendr칤a de un archivo CSV o API)
        setTimeout(() => {
          // Datos reales de Benavente (ejemplo de formato)
          const rawData = `2025-08-18 23:32:38	28.88	34.86	935.87	665.09	16	17	N/A	0.00	0.42	0.00
2025-08-18 23:35:48	28.53	34.94	935.87	665.14	16	19	N/A	0.00	0.42	0.00
2025-08-18 23:38:48	28.34	35.78	935.92	664.66	15	16	N/A	0.00	0.42	0.00
2025-08-18 23:41:48	28.19	36.60	935.97	664.28	17	18	N/A	0.00	0.42	0.00
2025-08-18 23:44:48	28.13	36.87	935.92	664.70	13	13	N/A	0.00	0.42	0.00
2025-08-18 23:47:48	28.08	36.36	935.92	664.71	16	17	N/A	0.00	0.42	0.00
2025-08-18 23:50:48	27.99	36.24	935.88	665.05	15	17	N/A	0.00	0.42	0.00
2025-08-18 23:53:48	27.88	35.87	935.88	665.01	15	16	N/A	0.00	0.42	0.00
2025-08-18 23:56:48	27.67	36.02	935.93	664.55	14	15	N/A	0.00	0.42	0.00
2025-08-18 23:59:48	27.59	36.38	935.89	664.94	16	17	N/A	0.00	0.42	0.00`;

          // Procesar los datos
          historicalData = [];
          const lines = rawData.trim().split('\n');
          
          lines.forEach(line => {
            const [timestampStr, tempStr, humStr, presStr, presCorrStr, windDirStr, windSpeedStr, rainStr, extra1Str, gasStr, extra2Str] = line.split('\t');
            
            // Convertir valores a n칰meros
            const temp = parseFloat(tempStr);
            const hum = parseFloat(humStr);
            const pres = parseFloat(presStr);
            const windDir = parseFloat(windDirStr);
            const windSpeed = parseFloat(windSpeedStr);
            const gas = parseFloat(gasStr);
            
            // Determinar si est치 lloviendo (simplificado para el ejemplo)
            const isRaining = rainStr === 'N/A' ? 0 : (parseFloat(rainStr) > 0 ? 1 : 0);
            
            historicalData.push({
              timestamp: new Date(timestampStr).toISOString(),
              temp: temp,
              hum: hum,
              pres: pres,
              lluvia: isRaining,
              wind: windSpeed,
              wind_dir: windDir,
              gas: gas
            });
          });
          
          // Ordenar por fecha
          historicalData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          
          console.log(`Datos cargados: ${historicalData.length} registros hist칩ricos de Benavente`);
          resolve();
        }, 800);
      } catch (error) {
        console.error("Error procesando datos hist칩ricos:", error);
        reject(error);
      }
    });
  };

  // Procesar mensaje del usuario
  const processUserMessage = async (message) => {
    // Guardar en historial de conversaci칩n
    conversationContext.conversationHistory.push({
      role: 'user',
      content: message,
      timestamp: new Date().toISOString()
    });
    
    // Mostrar mensaje de usuario
    addMessage(message, true);
    
    // Mostrar estado de carga
    const loadingId = showLoading("Consultando con IA avanzada...");
    
    try {
      // Probar primero con OpenAI si est치 configurada
      if (openAIApi.isConfigured()) {
        updateStatus("Consultando con modelo avanzado...");
        const openAIResponse = await openAIApi.generateResponse(message, {
          historicalData: historicalData,
          conversationContext: conversationContext
        });
        
        // Eliminar el estado de carga
        document.getElementById(loadingId).remove();
        
        if (openAIResponse) {
          // A침adir fuente de informaci칩n
          return openAIResponse;
        }
      }
      
      // Si no hay respuesta de OpenAI, usar el sistema local
      updateStatus("Analizando con sistema local...");
      
      // Si no hay API key configurada, mostrar mensaje de configuraci칩n
      if (!openAIApi.isConfigured()) {
        document.getElementById(loadingId).remove();
        
        // Crear mensaje de configuraci칩n
        const configMessage = `
          <div class="general-answer">
            <h3>Configuraci칩n de IA Requerida</h3>
            <p>Parece que no has configurado una clave API de OpenAI. Para obtener respuestas m치s avanzadas y precisas:</p>
            <ol>
              <li><a href="https://platform.openai.com/account/api-keys" target="_blank">Obt칠n tu API key de OpenAI</a></li>
              <li>Ingresa la clave en la secci칩n de configuraci칩n</li>
              <li>춰Listo! El chatbot usar치 la IA avanzada para responderte</li>
            </ol>
            <p>Mientras tanto, seguir칠 usando mi sistema meteorol칩gico local para responderte.</p>
          </div>
        `;
        
        addMessage(configMessage, false, 'local');
        
        // Mostrar estado de carga para el sistema local
        const localLoadingId = showLoading("Analizando con sistema local...");
        
        // Procesar con el sistema local
        const localResponse = await processWithLocalSystem(message);
        
        // Eliminar estado de carga local
        document.getElementById(localLoadingId).remove();
        
        return localResponse;
      }
      
      // Si hubo error con OpenAI, usar sistema local
      document.getElementById(loadingId).remove();
      const localLoadingId = showLoading("Analizando con sistema local...");
      
      const localResponse = await processWithLocalSystem(message);
      
      document.getElementById(localLoadingId).remove();
      return localResponse;
      
    } catch (error) {
      console.error('Error procesando mensaje:', error);
      
      // Eliminar el estado de carga
      document.getElementById(loadingId).remove();
      
      // Si hubo error con OpenAI, usar sistema local
      const localLoadingId = showLoading("Analizando con sistema local...");
      
      const localResponse = await processWithLocalSystem(message);
      
      document.getElementById(localLoadingId).remove();
      return localResponse;
    }
  };

  // Procesar con sistema local (para fallback)
  const processWithLocalSystem = async (message) => {
    updateStatus("Analizando con sistema local...");
    
    // Corregir ortograf칤a
    const { correctedMessage, hasCorrection } = spellingCorrection.correctMessage(message);
    
    // Mostrar mensaje de correcci칩n SOLO si hubo correcciones significativas
    if (hasCorrection) {
      addMessage(`游댌 Entiendo que quiz치s quisiste decir: "${correctedMessage}"`, false);
    }
    
    // Normalizar mensaje
    const normalizedMessage = correctedMessage.toLowerCase().replace(/[.,!?]/g, '');
    
    try {
      // An치lisis de 치mbito
      const domainAnalysis = semanticAnalysis.analyzeDomain(normalizedMessage);
      
      // Verificar referencias
      const references = semanticAnalysis.analyzeReferences(normalizedMessage, conversationContext);
      
      // Resolver an치foras
      const resolvedMessage = semanticAnalysis.resolveAnaphora(normalizedMessage, conversationContext);
      
      // Verificar si es hipot칠tica
      const isHypothetical = semanticAnalysis.analyzeHypotheticals(normalizedMessage);
      
      // Identificar entidades
      const entities = semanticAnalysis.identifyEntities(resolvedMessage);
      
      // Analizar intenci칩n
      const intent = semanticAnalysis.analyzeIntent(resolvedMessage, entities, domainAnalysis);
      
      // Verificar preguntas compuestas
      const isCompoundQuestion = semanticAnalysis.analyzeCompoundQuestions(normalizedMessage);
      
      // Entidades para la respuesta
      const detectedEntities = {
        parameters: entities.parameters,
        temporal: entities.temporal,
        comparisons: entities.comparisons,
        operations: entities.operations,
        location: entities.locations
      };
      
      // Actualizar contexto temporal si se identifica uno
      if (entities.periods.length > 0) {
        conversationContext.temporalContext = entities.periods[0];
      }
      
      // Actualizar contexto de par치metros si se identifican
      if (entities.parameters.length > 0) {
        conversationContext.lastParameter = entities.parameters[0];
      }
      
      // Actualizar contexto de ubicaci칩n
      if (entities.locations.length > 0) {
        conversationContext.spatialContext = entities.locations[0];
      }
      
      // Si hay referencias, actualizar contexto
      if (references.parameters.length > 0) {
        conversationContext.lastParameter = references.parameters[0];
      }
      
      if (references.location.length > 0) {
        conversationContext.spatialContext = references.location[0];
      }
      
      // Si hay contexto de par치metro pero no se identific칩 en la pregunta, usar el contexto
      if (conversationContext.lastParameter && entities.parameters.length === 0) {
        entities.parameters = [conversationContext.lastParameter];
      }
      
      // Si hay contexto temporal pero no se identific칩 en la pregunta, usar el contexto
      if (conversationContext.lastPeriod && entities.periods.length === 0) {
        entities.periods = [conversationContext.lastPeriod];
      }
      
      // Si hay contexto de ubicaci칩n pero no se identific칩 en la pregunta, usar el contexto
      if (conversationContext.spatialContext && entities.locations.length === 0) {
        entities.locations = [conversationContext.spatialContext];
      }
      
      // Si no se reconoci칩 la intenci칩n pero es una pregunta meteorol칩gica
      if (domainAnalysis.isWeatherQuestion) {
        // Intentar identificar par치metros incluso sin intenci칩n clara
        if (entities.parameters.length > 0) {
          // Si hay par치metros pero no intenci칩n clara, asumir consulta actual
          return intentHandlers.current_data({
            parameters: entities.parameters,
            periods: ['hoy'],
            locations: ['benavente']
          }, conversationContext);
        }
        
        // Si hay periodos pero no par치metros, pedir aclaraci칩n
        if (entities.periods.length > 0) {
          return `Para poder ayudarte con ${benaventeInfo.location}, necesito saber qu칠 par치metro meteorol칩gico te interesa. Por ejemplo: 'temperatura', 'humedad' o 'presi칩n'.`;
        }
      }
      
      // Si es un saludo aunque no se haya detectado claramente
      if (semanticAnalysis.isGreeting(normalizedMessage)) {
        return intentHandlers.greeting();
      }
      
      // Si es una despedida aunque no se haya detectado claramente
      if (semanticAnalysis.isGoodbye(normalizedMessage)) {
        return intentHandlers.goodbye();
      }
      
      // Si es una solicitud de ayuda aunque no se haya detectado claramente
      if (semanticAnalysis.isHelpRequest(normalizedMessage)) {
        return intentHandlers.help();
      }
      
      // Si no se identifica un 치mbito espec칤fico
      if (!domainAnalysis.isWeatherQuestion) {
        // Verificar si es una pregunta sobre Horus
        if (normalizedMessage.includes('horus') || normalizedMessage.includes('sistema')) {
          return intentHandlers.about_horus();
        }
        
        // Verificar si es una pregunta de soporte t칠cnico
        if (normalizedMessage.includes('problema') || normalizedMessage.includes('error') || 
            normalizedMessage.includes('no funciona') || normalizedMessage.includes('lento')) {
          return intentHandlers.support();
        }
        
        // Verificar si es una pregunta personal
        if (normalizedMessage.includes('qui칠n eres') || normalizedMessage.includes('quien eres') ||
            normalizedMessage.includes('c칩mo te llamas') || normalizedMessage.includes('como te llamas')) {
          return intentHandlers.personal();
        }
        
        // Verificar si es una pregunta general
        if (normalizedMessage.includes('nombre') || normalizedMessage.includes('hora') ||
            normalizedMessage.includes('edad') || normalizedMessage.includes('vives')) {
          return intentHandlers.general();
        }
        
        // Verificar el dominio de preguntas fuera del 치mbito
        let domain = 'general';
        if (normalizedMessage.includes('salud') || normalizedMessage.includes('m칠dico')) {
          domain = 'salud';
        } else if (normalizedMessage.includes('tecnolog칤a') || normalizedMessage.includes('tecnologia') ||
                   normalizedMessage.includes('computadora') || normalizedMessage.includes('internet')) {
          domain = 'tecnolog칤a';
        } else if (normalizedMessage.includes('deportes') || normalizedMessage.includes('f칰tbol')) {
          domain = 'deportes';
        } else if (normalizedMessage.includes('entretenimiento') || normalizedMessage.includes('pel칤cula') ||
                   normalizedMessage.includes('m칰sica')) {
          domain = 'entretenimiento';
        } else if (normalizedMessage.includes('comida') || normalizedMessage.includes('receta')) {
          domain = 'comida';
        } else if (normalizedMessage.includes('educaci칩n') || normalizedMessage.includes('escuela')) {
          domain = 'educaci칩n';
        } else if (normalizedMessage.includes('finanzas') || normalizedMessage.includes('dinero')) {
          domain = 'finanzas';
        }
        
        return intentHandlers.out_of_scope({ domain });
      }
      
      // Si es una pregunta hipot칠tica
      if (isHypothetical) {
        return "Como asistente meteorol칩gico para Benavente, solo puedo proporcionar informaci칩n basada en datos reales y an치lisis hist칩ricos. No puedo especular sobre escenarios hipot칠ticos que no est칠n respaldados por datos clim치ticos de la zona.";
      }
      
      // Si es una pregunta compuesta
      if (isCompoundQuestion) {
        return "Para poder ayudarte mejor con Benavente, por favor divide tu pregunta en partes m치s espec칤ficas. Por ejemplo, en lugar de preguntar sobre varios par치metros a la vez, enf칩cate en uno primero.";
      }
      
      // Si hay entidades detectadas pero no intenci칩n clara
      if (detectedEntities.parameters.length > 0 || 
          detectedEntities.temporal.length > 0 || 
          detectedEntities.comparisons.length > 0) {
        let response = `He detectado algunos elementos relevantes en tu pregunta sobre ${benaventeInfo.location}, pero no estoy seguro de entender exactamente qu칠 necesitas.\n\n`;
        
        if (detectedEntities.parameters.length > 0) {
          response += `* Par치metros meteorol칩gicos: ${detectedEntities.parameters.join(', ')}\n`;
        }
        if (detectedEntities.temporal.length > 0) {
          response += `* Periodos de tiempo: ${detectedEntities.temporal.join(', ')}\n`;
        }
        if (detectedEntities.comparisons.length > 0) {
          response += `* Tipos de comparaci칩n: ${detectedEntities.comparisons.map(c => 
            c === 'vs' ? 'comparaci칩n directa' : 
            c === 'trend' ? 'tendencia' : 
            c === 'correlation' ? 'correlaci칩n' : c).join(', ')}\n`;
        }
        if (detectedEntities.operations.length > 0) {
          response += `* Operaciones solicitadas: ${detectedEntities.operations.join(', ')}\n`;
        }
        
        response += `\n쯇odr칤as reformular tu pregunta para que sea m치s espec칤fica sobre el clima de Benavente?`;
        
        return response;
      }
      
      // Si no hay contexto previo y no es claramente fuera de 치mbito, asumimos que es general
      return `<div class="out-of-scope">
        <h3>No Entiendo Tu Pregunta sobre Benavente</h3>
        <p>No estoy seguro de entender tu pregunta. Soy un asistente meteorol칩gico especializado en el sistema Horus en <strong>${benaventeInfo.location}</strong>.</p>
        
        <h4>쮺칩mo puedo ayudarte con Benavente?</h4>
        <ul>
          <li>Consultar datos meteorol칩gicos actuales en Benavente</li>
          <li>Analizar tendencias clim치ticas hist칩ricas de Benavente</li>
          <li>Realizar predicciones basadas en datos de Benavente</li>
          <li>Explicar el funcionamiento de Horus en Benavente</li>
          <li>Contextualizar el clima de Benavente (${benaventeInfo.altitude})</li>
        </ul>
        
        <p>Ejemplos de preguntas que puedo responder:</p>
        <ul>
          <li>"쮺u치l es la temperatura actual en Benavente?"</li>
          <li>"쮺칩mo funciona el sistema Horus en Benavente?"</li>
          <li>"Muestra la tendencia de presi칩n de los 칰ltimos 7 d칤as en Benavente"</li>
        </ul>
        
        <p>Por favor, reformula tu pregunta para que est칠 relacionada con el clima o el sistema Horus en <strong>${benaventeInfo.location}</strong>.</p>
        
        <p class="benavente-context"><strong>Informaci칩n clave sobre Benavente:</strong> Ubicado a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterr치neo continentalizado con veranos calurosos e inviernos fr칤os.</p>
      </div>`;
      
    } catch (error) {
      console.error('Error procesando mensaje:', error);
      return "丘멆잺 Ocurri칩 un error al procesar tu solicitud. Por favor, intenta nuevamente.";
    }
  };

  // Sistema de correcci칩n ortogr치fica
  const spellingCorrection = {
    // Calcula la distancia de Levenshtein entre dos strings
    levenshteinDistance: function(a, b) {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      
      const matrix = [];
      
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1, // Sustituci칩n
              matrix[i][j - 1] + 1, // Inserci칩n
              matrix[i - 1][j] + 1 // Eliminaci칩n
            );
          }
        }
      }
      
      return matrix[b.length][a.length];
    },
    
    // Corrige la ortograf칤a de una palabra
    correctWord: function(word) {
      // Si la palabra est치 en el diccionario, devolver la correcci칩n
      if (spellingDictionary[word.toLowerCase()]) {
        return spellingDictionary[word.toLowerCase()];
      }
      
      // Buscar en el diccionario de sin칩nimos
      for (const [correct, synonyms] of Object.entries(weatherSynonyms)) {
        for (const synonym of synonyms) {
          if (word.toLowerCase() === synonym) {
            return correct;
          }
          
          // Calcular distancia de Levenshtein para correcci칩n aproximada
          const distance = this.levenshteinDistance(word.toLowerCase(), synonym);
          if (distance <= Math.max(1, Math.floor(synonym.length * 0.2))) {
            return correct;
          }
        }
      }
      
      return word;
    },
    
    // Corrige todo el mensaje
    correctMessage: function(message) {
      const words = message.split(/\s+/);
      let correctedWords = [];
      let foundCorrection = false;
      
      words.forEach(word => {
        // Mantener signos de puntuaci칩n
        const cleanWord = word.replace(/[.,!?;:]/g, '');
        const punctuation = word.match(/[.,!?;:]+$/);
        
        if (cleanWord.length > 2) {
          const corrected = this.correctWord(cleanWord);
          if (corrected !== cleanWord) {
            correctedWords.push(corrected + (punctuation ? punctuation[0] : ''));
            foundCorrection = true;
          } else {
            correctedWords.push(word);
          }
        } else {
          correctedWords.push(word);
        }
      });
      
      return {
        correctedMessage: correctedWords.join(' '),
        hasCorrection: foundCorrection
      };
    }
  };

  // Diccionario para correcci칩n ortogr치fica
  const spellingDictionary = {
    'tempertura': 'temperatura',
    'temperaruta': 'temperatura',
    'humedad': 'humedad',
    'humead': 'humedad',
    'umedad': 'humedad',
    'presion': 'presi칩n',
    'presion': 'presi칩n',
    'presion atmosferica': 'presi칩n atmosf칠rica',
    'presion atmosferica': 'presi칩n atmosf칠rica',
    'presion barometrica': 'presi칩n barom칠trica',
    'presion barometrica': 'presi칩n barom칠trica',
    'lluvia': 'lluvia',
    'llubia': 'lluvia',
    'lubia': 'lluvia',
    'viento': 'viento',
    'biento': 'viento',
    'bientto': 'viento',
    'gas': 'gas',
    'calidad del aire': 'calidad del aire',
    'calidad aire': 'calidad del aire',
    'direccion': 'direcci칩n',
    'direccion del viento': 'direcci칩n del viento',
    'direccion viento': 'direcci칩n del viento',
    'termometro': 'term칩metro',
    'termometro': 'term칩metro',
    'pluviometria': 'pluviometr칤a',
    'pluviometria': 'pluviometr칤a',
    'co2': 'CO2',
    'di칩xido de carbono': 'di칩xido de carbono'
  };

  // Diccionario de sin칩nimos meteorol칩gicos mejorado
  const weatherSynonyms = {
    temperatura: ['temp', 'calor', 'fr칤o', 'frio', 'grados', '춿', 'celsius', 'cent칤grados', 'centigrados', 'term칩metro', 'termometro', 'caliente', 'frio', 'temperatura en benavente'],
    humedad: ['hum', 'vapor', 'agua', 'porcentaje de agua', '% agua', 'humedad relativa', 'humedad en benavente'],
    presi칩n: ['pres', 'atmosf칠rica', 'barom칠trica', 'barometrica', 'hpa', 'mb', 'presi칩n atmosf칠rica', 'presion en benavente'],
    lluvia: ['precipitaci칩n', 'precipitacion', 'agua', 'llovizna', 'tormenta', 'lluvioso', 'precipitaciones', 'pluviometr칤a', 'pluviometria', 'lluvia en benavente'],
    viento: ['velocidad del viento', 'r치fagas', 'r치faga', 'r치fagas de viento', 'velocidad viento', 'km/h', 'nudos', 'direcci칩n del viento', 'direccion viento', 'brisa', 'viento en benavente'],
    gas: ['calidad del aire', 'calidad aire', 'contaminaci칩n', 'contaminacion', 'pm2.5', 'pm10', 'part칤culas', 'particulas', 'co2', 'di칩xido de carbono', 'gas en benavente'],
    direcci칩n: ['direccion', 'rumbo', 'orientaci칩n', 'orientacion', 'grados', 'norte', 'sur', 'este', 'oeste', 'cardinales', 'direccion en benavente'],
    an치lisis: ['analisis', 'tendencia', 'tendencias', 'evoluci칩n', 'comportamiento', 'patr칩n', 'patron', 'estad칤stica', 'estadisticas', 'analisis en benavente'],
    predicci칩n: ['prediccion', 'pron칩stico', 'pronostico', 'previsi칩n', 'prevision', 'futuro', 'ma침ana', 'siguiente', 'proyecci칩n', 'proyeccion', 'prediccion en benavente'],
    actual: ['ahora', 'en este momento', 'en este instante', 'actualidad', 'presente', 'en directo', 'en tiempo real', 'hoy', 'actual en benavente'],
    hist칩rico: ['historico', 'pasado', 'antes', 'anterior', 'anteriores', 'd칤as anteriores', 'semanas anteriores', '칰ltimos d칤as', 'historico en benavente'],
    comparar: ['comparar', 'comparaci칩n', 'compara', 'diferencia', 'vs', 'versus', 'comparativo', 'entre', 'y', 'comparar en benavente'],
    m치ximo: ['maximo', 'm치ximo', 'pico', 'peak', 'm치s alto', 'mayor', 'm치x', 'max', 'maximo en benavente'],
    m칤nimo: ['minimo', 'm칤nimo', 'm치s bajo', 'menor', 'm칤n', 'min', 'minimo en benavente'],
    tendencia: ['tendencia', 'tendencias', 'evoluci칩n', 'comportamiento', 'patr칩n', 'patron', 'cambios', 'variaci칩n', 'variacion', 'tendencia en benavente'],
    probabilidad: ['probabilidad', 'probable', 'posibilidad', 'posible', 'chance', 'oportunidad', 'riesgo', 'probabilidad en benavente']
  };

  // Mapeo de intenciones mejorado
  const intentMap = {
    current_data: {
      keywords: ['actual', 'ahora', 'en este momento', 'en directo', 'presente', 'en tiempo real', 'hoy', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presi칩n', 'lluvia', 'viento', 'gas', 'direcci칩n'],
      required: []
    },
    historical_trend: {
      keywords: ['tendencia', 'evoluci칩n', 'comportamiento', 'an치lisis', 'analisis', 'patr칩n', 'patron', 'gr치fico', 'grafico', 'historial', 'historico', 'hist칩rico', 'evolucion', 'variacion', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presi칩n', 'lluvia', 'viento', 'gas'],
      required: ['period']
    },
    prediction: {
      keywords: ['predicci칩n', 'prediccion', 'pron칩stico', 'pronostico', 'previsi칩n', 'prevision', 'futuro', 'ma침ana', 'siguiente', 'proyecci칩n', 'proyeccion', 'probabilidad', 'probable', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presi칩n', 'lluvia', 'viento', 'gas'],
      required: []
    },
    comparison: {
      keywords: ['comparar', 'comparaci칩n', 'compara', 'diferencia', 'vs', 'versus', 'comparativo', 'entre', 'y', 'diferencia', 'distinto', 'igual', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presi칩n', 'lluvia', 'viento', 'gas'],
      required: ['periods']
    },
    max_min: {
      keywords: ['m치ximo', 'maximo', 'm칤nimo', 'minimo', 'pico', 'peak', 'mayor', 'menor', 'm치s alto', 'm치s bajo', 'm치x', 'max', 'm칤n', 'min', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presi칩n', 'lluvia', 'viento', 'gas'],
      required: ['period']
    },
    correlation: {
      keywords: ['relaci칩n', 'correlaci칩n', 'correlacion', 'conexi칩n', 'conexion', 'asociaci칩n', 'asociacion', 'afecta', 'influye', 'impacto', 'causa', 'provoca', 'en benavente'],
      parameters: ['temperatura', 'humedad', 'presi칩n', 'lluvia', 'viento', 'gas'],
      required: ['parameters']
    },
    greeting: {
      keywords: ['hola', 'buenos d칤as', 'buenos dias', 'buenas tardes', 'hey', 'saludos', 'buen d칤a', 'buen dia', 'buenas noches', 'que tal', 'como estas', 'c칩mo est치s', 'en benavente'],
      parameters: [],
      required: []
    },
    goodbye: {
      keywords: ['adi칩s', 'adios', 'gracias', 'chao', 'hasta luego', 'hasta pronto', 'nos vemos', 'bye', 'grac칤as', 'gracias', 'fue 칰til', 'fue util', 'en benavente'],
      parameters: [],
      required: []
    },
    help: {
      keywords: ['ayuda', 'funciona', 'c칩mo', 'como', 'puedo', 'capaz', 'hacer', 'qu칠', 'que', 'preguntar', 'instrucciones', 'ejemplo', 'ejemplos', 'gu칤a', 'manual', 'tutorial', 'en benavente'],
      parameters: [],
      required: []
    },
    about_horus: {
      keywords: ['horus', 'sistema horus', 'estaci칩n horus', 'estacion horus', 'estaci칩n meteorol칩gica', 'estacion meteorologica', 'sistema meteorol칩gico', 'sistema meteorologico', 'para qu칠 sirve', 'para que sirve', 'qu칠 hace', 'que hace', 'en benavente'],
      parameters: [],
      required: []
    },
    support: {
      keywords: ['problema', 'error', 'no funciona', 'fallo', 'bug', 'no carga', 'lento', 'lentitud', 'lenta', 'lento', 'no responde', 'no me deja', 'no puedo', 'en benavente'],
      parameters: [],
      required: []
    },
    personal: {
      keywords: ['qui칠n eres', 'quien eres', 'qui칠n eres t칰', 'quien eres tu', 'qui칠n te hizo', 'quien te hizo', 'qui칠n te cre칩', 'quien te creo', 'tu creador', 'tu creador es', 'en benavente'],
      parameters: [],
      required: []
    },
    general: {
      keywords: ['cu치l es tu nombre', 'cual es tu nombre', 'c칩mo te llamas', 'como te llamas', 'qu칠 edad tienes', 'que edad tienes', 'd칩nde vives', 'donde vives', 'qu칠 hora es', 'que hora es', 'en benavente'],
      parameters: [],
      required: []
    },
    out_of_scope: {
      keywords: ['en benavente'],
      parameters: [],
      required: []
    }
  };

  // Mapeo de periodos
  const periodMap = {
    'hoy': { type: 'day', value: 1, unit: 'day' },
    'ayer': { type: 'day', value: 1, unit: 'day', offset: 1 },
    '칰ltimas 24 horas': { type: 'hour', value: 24, unit: 'hour' },
    '칰ltimas 12 horas': { type: 'hour', value: 12, unit: 'hour' },
    'esta ma침ana': { type: 'morning', value: 1, unit: 'day' },
    'esta tarde': { type: 'afternoon', value: 1, unit: 'day' },
    'esta noche': { type: 'night', value: 1, unit: 'day' },
    'esta semana': { type: 'week', value: 1, unit: 'week' },
    'esta semana pasada': { type: 'week', value: 1, unit: 'week', offset: 1 },
    '칰ltimos 7 d칤as': { type: 'day', value: 7, unit: 'day' },
    '칰ltimos 14 d칤as': { type: 'day', value: 14, unit: 'day' },
    '칰ltimos 30 d칤as': { type: 'day', value: 30, unit: 'day' },
    'este mes': { type: 'month', value: 1, unit: 'month' },
    'este a침o': { type: 'year', value: 1, unit: 'year' },
    '칰ltimo mes': { type: 'month', value: 1, unit: 'month', offset: 1 },
    '칰ltimo a침o': { type: 'year', value: 1, unit: 'year', offset: 1 },
    '칰ltima hora': { type: 'hour', value: 1, unit: 'hour' },
    '칰ltimas 2 horas': { type: 'hour', value: 2, unit: 'hour' },
    '칰ltimas 6 horas': { type: 'hour', value: 6, unit: 'hour' },
    'esta semana': { type: 'week', value: 1, unit: 'week' },
    'esta semana anterior': { type: 'week', value: 1, unit: 'week', offset: 1 },
    'este mes': { type: 'month', value: 1, unit: 'month' },
    'este mes pasado': { type: 'month', value: 1, unit: 'month', offset: 1 },
    'este a침o': { type: 'year', value: 1, unit: 'year' },
    'este a침o pasado': { type: 'year', value: 1, unit: 'year', offset: 1 }
  };

  // Sistema de an치lisis sem치ntico mejorado
  const semanticAnalysis = {
    // Analiza el dominio de la pregunta
    analyzeDomain: (text) => {
      const weatherKeywords = [
        'temperatura', 'calor', 'fr칤o', 'frio', 'grados', 
        'humedad', 'agua', 'presi칩n', 'atmosf칠rica', 'barom칠trica',
        'lluvia', 'precipitaci칩n', 'viento', 'r치fagas', 'gas',
        'calidad del aire', 'direcci칩n', 'clima', 'meteorol칩gico',
        'meteorologico', 'tiempo', 'nublado', 'soleado', 'nubes',
        'nuboso', 'llovizna', 'tormenta', 'nublados', 'soleados',
        'nubosos', 'tormentas', 'lluvias', 'vientos', 'r치fagas',
        'caluroso', 'frio', 'fr칤o', 'caliente', 'templado',
        'h칰medo', 'seco', 'h칰medos', 'secos', 'presi칩n',
        'bar칩metro', 'pluvi칩metro', 'anem칩metro', 'term칩metro',
        'meteorolog칤a', 'clim치tico', 'clim치ticos', 'clim치ticas',
        'climatolog칤a', 'pron칩stico', 'pronostico', 'predicci칩n',
        'prediccion', 'previsi칩n', 'prevision', 'estacional',
        'estaciones', 'primavera', 'verano', 'oto침o', 'invierno',
        'norte', 'sur', 'este', 'oeste', 'cardinales', 'brisa',
        'cicl칩n', 'hurac치n', 'tornado', 'tornados', 'ciclones',
        'huracanes', 'tormenta', 'tormentas', 'lluvia', 'lluvias',
        'nublado', 'nublados', 'nuboso', 'nubosos', 'soleado',
        'soleados', 'despejado', 'despejados', 'nublaci칩n',
        'nublaciones', 'precipitaci칩n', 'precipitaciones', 'humedad',
        'relativa', 'relativas', 'humedad relativa', 'presi칩n',
        'atmosf칠rica', 'atmosf칠ricas', 'presi칩n atmosf칠rica',
        'barom칠trica', 'barom칠tricas', 'presi칩n barom칠trica',
        'viento', 'vientos', 'r치faga', 'r치fagas', 'direcci칩n',
        'direcciones', 'direcci칩n del viento', 'velocidad',
        'velocidades', 'velocidad del viento', 'anem칩metro',
        'term칩metro', 'pluvi칩metro', 'bar칩metro', 'higr칩metro',
        'gas', 'gases', 'calidad del aire', 'contaminaci칩n',
        'contaminacion', 'pm2.5', 'pm10', 'part칤culas', 'particulas',
        'co2', 'di칩xido de carbono', 'ozono', 'no2', 'so2'
      ];
      
      let matchCount = 0;
      let totalKeywords = 0;
      const normalizedText = text.toLowerCase();
      
      weatherKeywords.forEach(keyword => {
        if (normalizedText.includes(keyword)) {
          matchCount++;
        }
        totalKeywords++;
      });
      
      // Calcular confianza basada en la proporci칩n de coincidencias
      const confidence = Math.min(1.0, matchCount / Math.max(1, totalKeywords * 0.15));
      
      // Si encontramos al menos 1 palabra clave meteorol칩gica, es una pregunta sobre clima
      return {
        isWeatherQuestion: matchCount > 0,
        confidence: confidence,
        matchCount: matchCount,
        totalKeywords: totalKeywords
      };
    },
    
    // Identifica entidades en el texto
    identifyEntities: (text) => {
      const entities = {
        parameters: [],
        periods: [],
        locations: [],
        numbers: [],
        comparisons: [],
        operations: [],
        general: []
      };
      
      const normalizedText = text.toLowerCase();
      
      // Verificar si menciona Benavente
      if (normalizedText.includes('benavente')) {
        entities.locations.push('benavente');
      }
      
      // Identificar par치metros meteorol칩gicos
      Object.keys(weatherSynonyms).forEach(param => {
        // Verificar el par치metro principal
        if (normalizedText.includes(param)) {
          entities.parameters.push(param);
        }
        
        // Verificar sin칩nimos
        weatherSynonyms[param].forEach(synonym => {
          if (normalizedText.includes(synonym)) {
            entities.parameters.push(param);
          }
        });
      });
      
      // Identificar periodos
      Object.keys(periodMap).forEach(period => {
        if (normalizedText.includes(period)) {
          entities.periods.push(period);
        }
      });
      
      // Identificar n칰meros
      const numberMatches = text.match(/\d+/g);
      if (numberMatches) {
        entities.numbers = numberMatches.map(num => parseInt(num));
      }
      
      // Identificar comparaciones
      if (normalizedText.includes('vs') || normalizedText.includes('versus')) {
        entities.comparisons.push('vs');
      }
      if (normalizedText.includes('tendencia') || normalizedText.includes('evoluci칩n')) {
        entities.comparisons.push('trend');
      }
      if (normalizedText.includes('correlaci칩n') || normalizedText.includes('relaci칩n')) {
        entities.comparisons.push('correlation');
      }
      
      // Identificar operaciones
      if (normalizedText.includes('m치ximo') || normalizedText.includes('maximo')) {
        entities.operations.push('max');
      }
      if (normalizedText.includes('m칤nimo') || normalizedText.includes('minimo')) {
        entities.operations.push('min');
      }
      if (normalizedText.includes('promedio') || normalizedText.includes('media')) {
        entities.operations.push('average');
      }
      if (normalizedText.includes('diferencia')) {
        entities.operations.push('difference');
      }
      
      // Identificar t칠rminos generales
      Object.keys(generalTerms).forEach(term => {
        if (term === 'outOfScope') return;
        
        // Verificar el t칠rmino principal
        if (normalizedText.includes(term)) {
          entities.general.push(term);
        }
        
        // Verificar sin칩nimos
        if (Array.isArray(generalTerms[term])) {
          generalTerms[term].forEach(synonym => {
            if (normalizedText.includes(synonym)) {
              entities.general.push(term);
            }
          });
        }
      });
      
      // Identificar preguntas fuera del 치mbito
      Object.keys(generalTerms.outOfScope).forEach(domain => {
        generalTerms.outOfScope[domain].forEach(keyword => {
          if (normalizedText.includes(keyword)) {
            entities.general.push(`outOfScope_${domain}`);
          }
        });
      });
      
      // Eliminar duplicados
      entities.parameters = [...new Set(entities.parameters)];
      entities.periods = [...new Set(entities.periods)];
      entities.comparisons = [...new Set(entities.comparisons)];
      entities.operations = [...new Set(entities.operations)];
      entities.general = [...new Set(entities.general)];
      
      return entities;
    },
    
    // Analiza la intenci칩n del usuario
    analyzeIntent: (text, entities, domainAnalysis) => {
      let bestIntent = null;
      let highestConfidence = 0;
      
      // Analizar cada posible intenci칩n
      Object.keys(intentMap).forEach(intentType => {
        const intent = intentMap[intentType];
        let confidence = 0;
        
        // Calcular coincidencia con palabras clave
        intent.keywords.forEach(keyword => {
          if (text.toLowerCase().includes(keyword)) {
            confidence += 0.2;
          }
        });
        
        // Aumentar confianza si se encontraron par치metros relevantes
        if (entities.parameters.length > 0 && intent.parameters.length > 0) {
          const commonParams = entities.parameters.filter(p => intent.parameters.includes(p));
          confidence += commonParams.length * 0.15;
        }
        
        // Aumentar confianza si se encontraron periodos y la intenci칩n los requiere
        if (intent.required.includes('period') && entities.periods.length > 0) {
          confidence += 0.2;
        }
        
        // Aumentar confianza si se encontraron m칰ltiples periodos y la intenci칩n los requiere
        if (intent.required.includes('periods') && entities.periods.length > 1) {
          confidence += 0.25;
        }
        
        // Aumentar confianza si menciona Benavente
        if (entities.locations.includes('benavente')) {
          confidence += 0.1;
        }
        
        // Ajustar confianza seg칰n el dominio
        if (intentType !== 'greeting' && intentType !== 'goodbye' && intentType !== 'help') {
          confidence *= domainAnalysis.confidence;
        }
        
        // Verificar si es la mejor intenci칩n hasta ahora
        if (confidence > highestConfidence) {
          highestConfidence = confidence;
          bestIntent = {
            type: intentType,
            confidence: confidence,
            parameters: entities.parameters,
            periods: entities.periods,
            location: entities.locations
          };
        }
      });
      
      // CORRECCI칍N: Usar semanticAnalysis en lugar de this
      // Si no se encontr칩 una intenci칩n clara, verificar saludos, despedidas o ayuda
      if (!bestIntent || highestConfidence < 0.4) {
        if (semanticAnalysis.isGreeting(text)) {
          return { type: 'greeting', confidence: 0.9, parameters: [], periods: [], location: ['benavente'] };
        }
        if (semanticAnalysis.isGoodbye(text)) {
          return { type: 'goodbye', confidence: 0.9, parameters: [], periods: [], location: ['benavente'] };
        }
        if (semanticAnalysis.isHelpRequest(text)) {
          return { type: 'help', confidence: 0.8, parameters: [], periods: [], location: ['benavente'] };
        }
      }
      
      // Si no se encontr칩 una intenci칩n clara pero hay t칠rminos generales
      if (!bestIntent && entities.general.length > 0) {
        for (const generalTerm of entities.general) {
          if (generalTerm.startsWith('outOfScope_')) {
            const domain = generalTerm.replace('outOfScope_', '');
            return {
              type: 'out_of_scope',
              confidence: 0.5,
              domain: domain,
              parameters: [],
              periods: [],
              location: ['benavente']
            };
          }
          
          // Mapear t칠rminos generales a intenciones
          const intentMap = {
            'about_horus': 'about_horus',
            'support': 'support',
            'personal': 'personal',
            'general': 'general'
          };
          
          if (intentMap[generalTerm]) {
            return {
              type: intentMap[generalTerm],
              confidence: 0.6,
              parameters: [],
              periods: [],
              location: ['benavente']
            };
          }
        }
      }
      
      // Si no se encontr칩 una intenci칩n clara, pero es meteorol칩gico
      if (domainAnalysis.isWeatherQuestion && !bestIntent) {
        if (entities.parameters.length > 0) {
          return {
            type: 'current_data',
            confidence: 0.5,
            parameters: entities.parameters,
            periods: ['hoy'],
            location: ['benavente']
          };
        }
        
        return {
          type: 'current_data',
          confidence: 0.4,
          parameters: ['temperatura'],
          periods: ['hoy'],
          location: ['benavente']
        };
      }
      
      // Si no se encontr칩 una intenci칩n clara y no es meteorol칩gico
      if (!domainAnalysis.isWeatherQuestion && !bestIntent) {
        return {
          type: 'out_of_scope',
          confidence: 0.3,
          domain: 'general',
          parameters: [],
          periods: [],
          location: ['benavente']
        };
      }
      
      return bestIntent || { type: 'unrelated', confidence: 0, parameters: [], periods: [], location: ['benavente'] };
    },
    
    // Verifica si es un saludo
    isGreeting: (text) => {
      const greetings = intentMap.greeting.keywords;
      const normalizedText = text.toLowerCase();
      
      return greetings.some(greeting => normalizedText.includes(greeting));
    },
    
    // Verifica si es una despedida
    isGoodbye: (text) => {
      const goodbyes = intentMap.goodbye.keywords;
      const normalizedText = text.toLowerCase();
      
      return goodbyes.some(goodbye => normalizedText.includes(goodbye));
    },
    
    // Verifica si es una solicitud de ayuda
    isHelpRequest: (text) => {
      const helpKeywords = intentMap.help.keywords;
      const normalizedText = text.toLowerCase();
      
      return helpKeywords.some(keyword => normalizedText.includes(keyword));
    },
    
    // Analiza preguntas compuestas
    analyzeCompoundQuestions: (text) => {
      const compoundIndicators = ['y', 'adem치s', 'tambi칠n', 'tambien', 'ademas', 'adem치s de', 'ademas de', 'adem치s que', 'ademas que'];
      return compoundIndicators.some(indicator => text.toLowerCase().includes(indicator));
    },
    
    // Analiza referencias en el contexto
    analyzeReferences: (text, context) => {
      const references = {
        parameters: [],
        temporal: [],
        spatial: [],
        location: []
      };
      
      // Analizar an치foras (referencias a elementos previos)
      if (context.lastParameter && (text.includes('eso') || text.includes('eso es') || text.includes('eso est치'))) {
        references.parameters.push(context.lastParameter);
      }
      
      if (context.lastPeriod && (text.includes('entonces') || text.includes('en ese periodo') || text.includes('durante ese tiempo'))) {
        references.temporal.push(context.lastPeriod);
      }
      
      // Verificar si menciona Benavente
      if (text.toLowerCase().includes('benavente')) {
        references.location.push('benavente');
        references.spatial.push('benavente');
      }
      
      return references;
    },
    
    // Resuelve an치foras usando el contexto
    resolveAnaphora: (text, context) => {
      let resolvedText = text;
      const paramName = context.lastParameter || 'temperatura';
      
      // Reemplazar "eso" si hay contexto de par치metro
      if (context.lastParameter) {
        resolvedText = resolvedText.replace(/eso/g, paramName);
        resolvedText = resolvedText.replace(/eso es/g, `${paramName} es`);
        resolvedText = resolvedText.replace(/eso est치/g, `${paramName} est치`);
      }
      
      // Reemplazar "hoy" si hay contexto temporal
      if (context.temporalContext && (text.includes('ayer') || text.includes('ma침ana'))) {
        // Si el contexto es "hoy", y pregunta sobre "ayer", ajustamos
        if (context.temporalContext === 'today' && text.includes('ayer')) {
          resolvedText = resolvedText.replace(/ayer/g, 'hace un d칤a');
        }
      }
      
      // A침adir "en Benavente" si no est치 presente pero es relevante
      if (!resolvedText.toLowerCase().includes('benavente') && 
          !resolvedText.toLowerCase().includes('aqu칤') &&
          !resolvedText.toLowerCase().includes('en esta zona')) {
        resolvedText += " en Benavente";
      }
      
      // Mejora: Reemplazar "la" + sustantivo por el par치metro espec칤fico
      if (context.lastParameter) {
        const paramReplacements = {
          'temp': ['la temperatura', 'el term칩metro', 'los grados', 'el calor', 'el fr칤o'],
          'humedad': ['la humedad', 'el vapor', 'el agua'],
          'presi칩n': ['la presi칩n', 'la atmosf칠rica', 'la barom칠trica'],
          'lluvia': ['la lluvia', 'la precipitaci칩n', 'el agua'],
          'viento': ['el viento', 'las r치fagas', 'la brisa'],
          'gas': ['el gas', 'la calidad del aire', 'las part칤culas']
        };
        
        if (paramReplacements[paramName]) {
          paramReplacements[paramName].forEach(replacement => {
            resolvedText = resolvedText.replace(new RegExp(replacement, 'gi'), paramName);
          });
        }
      }
      
      return resolvedText;
    },
    
    // Analiza preguntas hipot칠ticas
    analyzeHypotheticals: (text) => {
      const hypotheticalIndicators = ['si', 'supongamos que', 'imagina que', 'qu칠 pasar칤a si', 'que pasaria si', 'que pasar칤a si'];
      return hypotheticalIndicators.some(indicator => text.toLowerCase().includes(indicator));
    }
  };

  // Diccionario de t칠rminos generales
  const generalTerms = {
    // Sistema Horus
    horus: ['horus', 'sistema horus', 'estaci칩n horus', 'estacion horus', 'estaci칩n meteorol칩gica', 'estacion meteorologica', 'sistema meteorol칩gico', 'sistema meteorologico', 'horus en benavente'],
    
    // Informaci칩n general
    about: ['qu칠 es', 'que es', 'qu칠 es esto', 'que es esto', 'para qu칠 sirve', 'para que sirve', 'qu칠 hace', 'que hace', 'funciona', 'c칩mo funciona', 'como funciona', 'sobre benavente'],
    
    // Ayuda
    help: ['ayuda', 'funciona', 'c칩mo', 'como', 'puedo', 'capaz', 'hacer', 'qu칠', 'que', 'preguntar', 'instrucciones', 'ejemplo', 'ejemplos', 'gu칤a', 'manual', 'tutorial', 'ayuda en benavente'],
    
    // Saludos
    greeting: ['hola', 'buenos d칤as', 'buenos dias', 'buenas tardes', 'hey', 'saludos', 'buen d칤a', 'buen dia', 'buenas noches', 'que tal', 'como estas', 'c칩mo est치s', 'hola benavente'],
    
    // Despedidas
    goodbye: ['adi칩s', 'adios', 'gracias', 'chao', 'hasta luego', 'hasta pronto', 'nos vemos', 'bye', 'grac칤as', 'gracias', 'fue 칰til', 'fue util', 'adios benavente'],
    
    // Soporte t칠cnico
    support: ['problema', 'error', 'no funciona', 'fallo', 'bug', 'no carga', 'lento', 'lentitud', 'lenta', 'lento', 'no responde', 'no me deja', 'no puedo', 'problemas en benavente'],
    
    // Informaci칩n personal
    personal: ['qui칠n eres', 'quien eres', 'qui칠n eres t칰', 'quien eres tu', 'qui칠n te hizo', 'quien te hizo', 'qui칠n te cre칩', 'quien te creo', 'tu creador', 'tu creador es', 'quien eres en benavente'],
    
    // Preguntas generales
    general: ['cu치l es tu nombre', 'cual es tu nombre', 'c칩mo te llamas', 'como te llamas', 'qu칠 edad tienes', 'que edad tienes', 'd칩nde vives', 'donde vives', 'qu칠 hora es', 'que hora es', 'clima benavente'],
    
    // Soporte para preguntas fuera del 치mbito
    outOfScope: {
      salud: ['salud', 'm칠dico', 'doctor', 'enfermedad', 'enfermo', 'hospital', 'farmacia', 'medicina', 'medicamento', 'cura', 'salud en benavente'],
      tecnolog칤a: ['tecnolog칤a', 'tecnologia', 'computadora', 'ordenador', 'pc', 'laptop', 'smartphone', 'm칩vil', 'celular', 'internet', 'wifi', 'redes', 'tecnologia en benavente'],
      deportes: ['deportes', 'f칰tbol', 'futbol', 'baloncesto', 'tenis', 'golf', 'atletismo', 'deporte', 'equipo', 'partido', 'liga', 'deportes en benavente'],
      entretenimiento: ['entretenimiento', 'pel칤cula', 'pelicula', 'cine', 'm칰sica', 'musica', 'canci칩n', 'cancion', 'serie', 'televisi칩n', 'tv', 'entretenimiento en benavente'],
      comida: ['comida', 'receta', 'cocina', 'plato', 'platos', 'cocinar', 'comer', 'restaurante', 'recetas', 'recetario', 'comida en benavente'],
      educaci칩n: ['educaci칩n', 'educacion', 'escuela', 'colegio', 'universidad', 'clase', 'clases', 'estudio', 'estudiar', 'profesor', 'educacion en benavente'],
      finanzas: ['finanzas', 'dinero', 'banco', 'cuenta', 'tarjeta', 'cr칠dito', 'credito', 'ahorro', 'inversi칩n', 'inversion', 'finanzas en benavente']
    }
  };

  // Obtener el nombre de la direcci칩n del viento
  const getWindDirectionName = (degrees) => {
    const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
    const index = Math.round(degrees % 360 / 22.5) % 16;
    return directions[index];
  };

  // Manejadores de intenciones
  const intentHandlers = {
    current_data: (entities, context) => {
      // Si no hay par치metros espec칤ficos, usar el 칰ltimo par치metro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Actualizar contexto
      conversationContext.lastParameter = parameters[0];
      conversationContext.lastQuestionType = 'current_data';
      
      // Obtener el dato actual
      const latestData = historicalData[historicalData.length - 1];
      let response = '';
      
      parameters.forEach(param => {
        let value, unit;
        switch(param) {
          case 'temperatura':
            value = latestData.temp;
            unit = '춿C';
            break;
          case 'humedad':
            value = latestData.hum;
            unit = '%';
            break;
          case 'presi칩n':
            value = latestData.pres;
            unit = 'hPa';
            break;
          case 'lluvia':
            value = latestData.lluvia ? 1 : 0;
            unit = latestData.lluvia ? 'lloviendo' : 'sin lluvia';
            break;
          case 'viento':
            value = latestData.wind;
            unit = 'm/s';
            break;
          case 'gas':
            value = latestData.gas;
            unit = 'k풜';
            break;
          case 'direcci칩n':
            value = latestData.wind_dir;
            unit = '춿';
            break;
          default:
            value = latestData.temp;
            unit = '춿C';
        }
        
        // Obtener variaciones para el par치metro
        const variations = communicationSystem.getCurrentDataVariations(param, value, unit);
        
        // Seleccionar una variaci칩n aleatoria
        response += getRandomVariation(variations) + "\n";
      });
      
      // A침adir an치lisis contextual si es relevante
      if (parameters.length === 1) {
        const paramName = parameters[0];
        let contextAnalysis = '';
        
        switch(paramName) {
          case 'temperatura':
            if (latestData.temp > 25) {
              contextAnalysis = `Con esta temperatura en Benavente, podr칤as considerar usar ropa ligera y mantenerse hidratado. En verano en Benavente, las temperaturas pueden superar los 35춿C.`;
            } else if (latestData.temp < 10) {
              contextAnalysis = `Con esta temperatura en Benavente, te recomendamos abrigarte adecuadamente para evitar el fr칤o. En invierno, las temperaturas en Benavente pueden llegar a -5춿C.`;
            } else {
              contextAnalysis = `La temperatura actual en Benavente est치 dentro de un rango moderado. Benavente tiene un clima mediterr치neo continentalizado con primaveras y oto침os agradables.`;
            }
            break;
          case 'humedad':
            if (latestData.hum > 70) {
              contextAnalysis = `La alta humedad en Benavente puede hacer que la temperatura se sienta m치s alta de lo que realmente es. Considera usar ropa transpirable. La humedad promedio en Benavente es del 65%.`;
            } else if (latestData.hum < 30) {
              contextAnalysis = `La baja humedad en Benavente puede causar sequedad en la piel y las v칤as respiratorias. Considera usar humectante y mantenerte hidratado. Esto es menos com칰n en Benavente, que tiene una humedad promedio del 65%.`;
            } else {
              contextAnalysis = `La humedad actual en Benavente est치 cerca del promedio t칤pico de la zona (65%). Benavente tiene un clima mediterr치neo continentalizado con humedad moderada.`;
            }
            break;
          case 'presi칩n':
            if (latestData.pres < 1000) {
              contextAnalysis = `La presi칩n atmosf칠rica baja en Benavente suele indicar condiciones clim치ticas inestables. Considera que Benavente est치 a ${benaventeInfo.altitude} sobre el nivel del mar, lo que afecta la presi칩n atmosf칠rica.`;
            } else if (latestData.pres > 1020) {
              contextAnalysis = `La presi칩n atmosf칠rica alta en Benavente suele indicar condiciones clim치ticas estables y buen tiempo. Es un buen momento para actividades al aire libre. Benavente tiene una presi칩n atmosf칠rica promedio de alrededor de 1010 hPa debido a su altitud de ${benaventeInfo.altitude}.`;
            } else {
              contextAnalysis = `La presi칩n atmosf칠rica en Benavente est치 en un nivel normal para su altitud (${benaventeInfo.altitude}). Benavente se encuentra en la llanura del Duero, lo que influye en sus patrones de presi칩n.`;
            }
            break;
        }
        
        if (contextAnalysis) {
          response += `\n${contextAnalysis}`;
        }
        
        response += `\n\n쯊e gustar칤a ver un an치lisis hist칩rico de ${paramName} en Benavente o una predicci칩n para los pr칩ximos d칤as?`;
      }
      
      return response.trim();
    },
    
    historical_trend: (entities, context) => {
      // Determinar el periodo
      let period = entities.periods.length > 0 ? entities.periods[0] : 
                  (context.lastPeriod ? context.lastPeriod : '칰ltimos 7 d칤as');
      
      // Actualizar contexto
      conversationContext.lastPeriod = period;
      conversationContext.lastQuestionType = 'historical_trend';
      
      // Obtener datos para el periodo
      const periodInfo = periodMap[period] || periodMap['칰ltimos 7 d칤as'];
      const now = new Date();
      let startDate;
      
      if (periodInfo.type === 'day') {
        startDate = new Date(now);
        startDate.setDate(now.getDate() - periodInfo.value);
      } else if (periodInfo.type === 'week') {
        startDate = new Date(now);
        startDate.setDate(now.getDate() - (periodInfo.value * 7));
      } else if (periodInfo.type === 'month') {
        startDate = new Date(now);
        startDate.setMonth(now.getMonth() - periodInfo.value);
      }
      
      // Si no hay par치metros espec칤ficos, usar el 칰ltimo par치metro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Preparar datos para el gr치fico
      const chartData = historicalData
        .filter(data => new Date(data.timestamp) >= startDate)
        .map(data => ({
          x: new Date(data.timestamp),
          y: data[parameters[0] === 'presi칩n' ? 'pres' : 
                 parameters[0] === 'lluvia' ? 'lluvia' : 
                 parameters[0]]
        }));
      
      // Calcular estad칤sticas
      const values = chartData.map(item => item.y);
      const avg = values.reduce((a, b) => a + b, 0) / values.length;
      const min = Math.min(...values);
      const max = Math.max(...values);
      
      // Determinar tendencia
      const startValue = values[0];
      const endValue = values[values.length - 1];
      const trend = endValue > startValue ? "ascendente" : "descendente";
      const trendStrength = Math.abs(endValue - startValue) / startValue;
      
      // Generar la respuesta basada en el an치lisis de los datos
      const variations = communicationSystem.getTrendAnalysisVariations(
        parameters[0], 
        avg, 
        min, 
        max, 
        trend, 
        trendStrength, 
        period
      );
      
      const response = getRandomVariation(variations);
      
      // A침ade un gr치fico de an치lisis
      const chartId = `prediction-chart-${Date.now()}`;
      const chartResponse = `
        <div class="prediction-chart-container">
          <div class="chart-title">Tendencia de ${parameters[0]} en ${benaventeInfo.location} durante ${period}</div>
          <canvas class="prediction-chart" id="${chartId}" 
                  data-parameter="${parameters[0]}" 
                  data-chart-data='${JSON.stringify(chartData)}'></canvas>
        </div>
      `;
      
      return response + chartResponse;
    },
    
    prediction: (entities, context) => {
      // Si no hay par치metros espec칤ficos, usar el 칰ltimo par치metro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Actualizar contexto
      conversationContext.lastParameter = parameters[0];
      conversationContext.lastQuestionType = 'prediction';
      
      // Generar datos de predicci칩n simulados
      const predictionData = [];
      const now = new Date();
      const latestData = historicalData[historicalData.length - 1];
      
      for (let i = 0; i < 5; i++) {
        const date = new Date(now);
        date.setDate(now.getDate() + i);
        
        let value;
        switch(parameters[0]) {
          case 'temperatura':
            // Simular patrones clim치ticos de Benavente (clima mediterr치neo continentalizado)
            value = latestData.temp + (Math.random() - 0.5) * 3;
            // Ajustar seg칰n estaci칩n del a침o
            const month = now.getMonth();
            if (month >= 5 && month <= 8) { // Verano
              value = Math.min(35, Math.max(15, value));
            } else if (month >= 11 || month <= 2) { // Invierno
              value = Math.min(15, Math.max(-5, value));
            }
            break;
          case 'humedad':
            value = latestData.hum + (Math.random() - 0.5) * 10;
            value = Math.min(100, Math.max(20, value)); // Limitar rango realista
            break;
          case 'presi칩n':
            value = latestData.pres + (Math.random() - 0.5) * 3;
            value = Math.min(1030, Math.max(980, value)); // Rango realista para Benavente
            break;
          case 'viento':
            value = latestData.wind + (Math.random() - 0.5) * 2;
            value = Math.min(20, Math.max(1, value)); // Limitar velocidad del viento
            break;
          default:
            value = latestData.temp + (Math.random() - 0.5) * 3;
        }
        
        predictionData.push({
          x: date,
          y: value
        });
      }
      
      // Determinar la tendencia de las predicciones
      const trend = predictionData[predictionData.length - 1].y > predictionData[0].y ?
                   'aumentando' : (predictionData[predictionData.length - 1].y < predictionData[0].y ? 'disminuyendo' : 'estable');
      
      // Calcular confiabilidad (simulaci칩n)
      const reliability = 0.7 + Math.random() * 0.25;
      
      // Generar la respuesta basada en el an치lisis de los datos
      const variations = communicationSystem.getPredictionVariations(
        parameters[0],
        reliability,
        '5 d칤as'
      );
      
      const response = getRandomVariation(variations);
      
      // A침ade un gr치fico de predicci칩n
      const chartId = `prediction-chart-${Date.now()}`;
      const chartResponse = `
        <div class="prediction-container">
          <div class="prediction-reliability">
            Confiabilidad de la predicci칩n: ${(reliability * 100).toFixed(0)}% 
            <div class="reliability-bar">
              <div class="reliability-fill" style="width: ${(reliability * 100).toFixed(0)}%"></div>
            </div>
          </div>
          <div class="prediction-chart-container">
            <div class="chart-title">Predicci칩n de ${parameters[0]} para los pr칩ximos 5 d칤as en ${benaventeInfo.location}</div>
            <canvas class="prediction-chart" id="${chartId}" 
                    data-parameter="${parameters[0]}" 
                    data-chart-data='${JSON.stringify(predictionData)}'></canvas>
          </div>
        </div>
      `;
      
      return response + chartResponse;
    },
    
    comparison: (entities, context) => {
      // Necesitamos al menos dos periodos para comparar
      if (entities.periods.length < 2) {
        return "Para hacer una comparaci칩n necesito dos periodos. Por ejemplo: 'Compara la temperatura de esta semana con la semana pasada en Benavente'.";
      }
      
      const period1 = entities.periods[0];
      const period2 = entities.periods[1];
      
      // Actualizar contexto
      conversationContext.lastPeriod = period1;
      conversationContext.lastQuestionType = 'comparison';
      
      // Si no hay par치metros espec칤ficos, usar el 칰ltimo par치metro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Obtener datos para ambos periodos
      const periodInfo1 = periodMap[period1] || periodMap['esta semana'];
      const periodInfo2 = periodMap[period2] || periodMap['칰ltimos 7 d칤as'];
      
      const now = new Date();
      let startDate1, startDate2;
      
      // Calcular fechas de inicio para ambos periodos
      if (periodInfo1.type === 'day') {
        startDate1 = new Date(now);
        startDate1.setDate(now.getDate() - periodInfo1.value);
      } else if (periodInfo1.type === 'week') {
        startDate1 = new Date(now);
        startDate1.setDate(now.getDate() - (periodInfo1.value * 7));
      } else if (periodInfo1.type === 'month') {
        startDate1 = new Date(now);
        startDate1.setMonth(now.getMonth() - periodInfo1.value);
      }
      
      if (periodInfo2.type === 'day') {
        startDate2 = new Date(now);
        startDate2.setDate(now.getDate() - periodInfo2.value);
      } else if (periodInfo2.type === 'week') {
        startDate2 = new Date(now);
        startDate2.setDate(now.getDate() - (periodInfo2.value * 7));
      } else if (periodInfo2.type === 'month') {
        startDate2 = new Date(now);
        startDate2.setMonth(now.getMonth() - periodInfo2.value);
      }
      
      // Obtener datos para ambos periodos
      const data1 = historicalData.filter(data => new Date(data.timestamp) >= startDate1);
      const data2 = historicalData.filter(data => new Date(data.timestamp) >= startDate2);
      
      // Calcular promedios
      const avg1 = data1.reduce((sum, item) => sum + item[parameters[0] === 'presi칩n' ? 'pres' : 
                                     parameters[0] === 'lluvia' ? 'lluvia' : 
                                     parameters[0]], 0) / data1.length;
      const avg2 = data2.reduce((sum, item) => sum + item[parameters[0] === 'presi칩n' ? 'pres' : 
                                     parameters[0] === 'lluvia' ? 'lluvia' : 
                                     parameters[0]], 0) / data2.length;
      
      // Calcular porcentaje de cambio
      const changePercent = ((avg1 - avg2) / avg2) * 100;
      
      // Generar la respuesta basada en el an치lisis de los datos
      const variations = communicationSystem.getComparisonVariations(
        parameters[0],
        avg1,
        avg2,
        period1,
        period2,
        changePercent
      );
      
      const response = getRandomVariation(variations);
      
      // Contexto espec칤fico de Benavente
      response += `\n\nEn ${benaventeInfo.location}, ubicado a ${benaventeInfo.altitude} sobre el nivel del mar, `;
      
      if (parameters[0] === 'temperatura') {
        response += `las temperaturas suelen variar seg칰n la estaci칩n del a침o. `;
        response += `El clima mediterr치neo continentalizado de Benavente presenta veranos calurosos e inviernos fr칤os.`;
      } else if (parameters[0] === 'humedad') {
        response += `la humedad promedio es del 65%, con variaciones seg칰n la 칠poca del a침o.`;
      } else if (parameters[0] === 'presi칩n') {
        response += `la presi칩n atmosf칠rica se ve afectada por la altitud (${benaventeInfo.altitude}), `;
        response += `resultando en valores ligeramente menores que en el nivel del mar.`;
      }
      
      // Preparar datos para el gr치fico comparativo
      const chartData1 = data1.map(data => ({
        x: new Date(data.timestamp),
        y: data[parameters[0] === 'presi칩n' ? 'pres' : 
               parameters[0] === 'lluvia' ? 'lluvia' : 
               parameters[0]]
      }));
      
      const chartData2 = data2.map(data => ({
        x: new Date(data.timestamp),
        y: data[parameters[0] === 'presi칩n' ? 'pres' : 
               parameters[0] === 'lluvia' ? 'lluvia' : 
               parameters[0]]
      }));
      
      // A침ade un gr치fico comparativo
      const chartId = `comparison-chart-${Date.now()}`;
      const chartResponse = `
        <div class="comparison-chart-container">
          <div class="chart-title">Comparaci칩n de ${parameters[0]}: ${period1} vs ${period2} en ${benaventeInfo.location}</div>
          <canvas class="comparison-chart" id="${chartId}" 
                  data-parameter="${parameters[0]}" 
                  data-chart-data1='${JSON.stringify(chartData1)}'
                  data-chart-data2='${JSON.stringify(chartData2)}'
                  data-period1="${period1}"
                  data-period2="${period2}"></canvas>
        </div>
      `;
      
      return response + chartResponse;
    },
    
    max_min: (entities, context) => {
      // Determinar el periodo
      let period = entities.periods.length > 0 ? entities.periods[0] : 
                  (context.lastPeriod ? context.lastPeriod : '칰ltimos 7 d칤as');
      
      // Actualizar contexto
      conversationContext.lastPeriod = period;
      conversationContext.lastQuestionType = 'max_min';
      
      // Obtener datos para el periodo
      const periodInfo = periodMap[period] || periodMap['칰ltimos 7 d칤as'];
      const now = new Date();
      let startDate;
      
      if (periodInfo.type === 'day') {
        startDate = new Date(now);
        startDate.setDate(now.getDate() - periodInfo.value);
      } else if (periodInfo.type === 'week') {
        startDate = new Date(now);
        startDate.setDate(now.getDate() - (periodInfo.value * 7));
      } else if (periodInfo.type === 'month') {
        startDate = new Date(now);
        startDate.setMonth(now.getMonth() - periodInfo.value);
      }
      
      // Si no hay par치metros espec칤ficos, usar el 칰ltimo par치metro mencionado o uno por defecto
      let parameters = entities.parameters.length > 0 ? entities.parameters : 
                      (context.lastParameter ? [context.lastParameter] : ['temperatura']);
      
      // Obtener datos para el periodo
      const periodData = historicalData.filter(data => new Date(data.timestamp) >= startDate);
      
      // Encontrar m치ximos y m칤nimos
      let max = -Infinity;
      let min = Infinity;
      let maxDate, minDate;
      
      periodData.forEach(data => {
        const value = data[parameters[0] === 'presi칩n' ? 'pres' : 
                         parameters[0] === 'lluvia' ? 'lluvia' : 
                         parameters[0]];
                         
        if (value > max) {
          max = value;
          maxDate = data.timestamp;
        }
        
        if (value < min) {
          min = value;
          minDate = data.timestamp;
        }
      });
      
      // Generar respuesta
      let response = `En ${period} en ${benaventeInfo.location}, el valor m치ximo de ${parameters[0]} fue de ${max.toFixed(2)}`;
      
      if (parameters[0] !== 'lluvia' && parameters[0] !== 'direcci칩n') {
        response += ` ${parameters[0] === 'presi칩n' ? 'hPa' : 
                    parameters[0] === 'humedad' ? '%' : 
                    '춿C'}`;
      }
      
      response += ` registrado el ${new Date(maxDate).toLocaleDateString('es-ES', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      })}.\n\n`;
      
      response += `El valor m칤nimo fue de ${min.toFixed(2)}`;
      
      if (parameters[0] !== 'lluvia' && parameters[0] !== 'direcci칩n') {
        response += ` ${parameters[0] === 'presi칩n' ? 'hPa' : 
                    parameters[0] === 'humedad' ? '%' : 
                    '춿C'}`;
      }
      
      response += ` registrado el ${new Date(minDate).toLocaleDateString('es-ES', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      })}.`;
      
      // Contexto espec칤fico de Benavente
      response += `\n\n${benaventeInfo.location}, ubicado a ${benaventeInfo.altitude} sobre el nivel del mar, `;
      
      if (parameters[0] === 'temperatura') {
        response += `tiene un clima mediterr치neo continentalizado con temperaturas que pueden variar `;
        response += `desde -5춿C en invierno hasta m치s de 35춿C en verano.`;
      } else if (parameters[0] === 'humedad') {
        response += `tiene una humedad promedio del 65%, con valores m치s altos en primavera y oto침o.`;
      } else if (parameters[0] === 'presi칩n') {
        response += `tiene una presi칩n atmosf칠rica promedio de alrededor de 1010 hPa debido a su altitud.`;
      }
      
      // Preparar datos para el gr치fico
      const chartData = historicalData
        .filter(data => new Date(data.timestamp) >= startDate)
        .map(data => ({
          x: new Date(data.timestamp),
          y: data[parameters[0] === 'presi칩n' ? 'pres' : 
                 parameters[0] === 'lluvia' ? 'lluvia' : 
                 parameters[0]]
        }));
      
      // A침ade un gr치fico con marcadores de m치ximos y m칤nimos
      const chartId = `extremes-chart-${Date.now()}`;
      const chartResponse = `
        <div class="extremes-chart-container">
          <div class="chart-title">Valores extremos de ${parameters[0]} en ${benaventeInfo.location} durante ${period}</div>
          <canvas class="extremes-chart" id="${chartId}" 
                  data-parameter="${parameters[0]}" 
                  data-chart-data='${JSON.stringify(chartData)}'
                  data-max-date="${maxDate}"
                  data-min-date="${minDate}"></canvas>
        </div>
      `;
      
      return response + chartResponse;
    },
    
    correlation: (entities, context) => {
      try {
        // Necesitamos al menos dos par치metros para analizar correlaci칩n
        if (entities.parameters.length < 2) {
          return "Para analizar correlaci칩n necesito dos par치metros meteorol칩gicos. Por ejemplo: '쮺칩mo se relaciona la temperatura con la humedad en Benavente?'";
        }
        
        const parameter1 = entities.parameters[0];
        const parameter2 = entities.parameters[1];
        
        // Actualizar contexto
        conversationContext.lastParameter = parameter1;
        conversationContext.lastQuestionType = 'correlation';
        
        // Obtener datos para el periodo (usar 칰ltimos 30 d칤as por defecto)
        const now = new Date();
        const startDate = new Date(now);
        startDate.setDate(now.getDate() - 30);
        
        const periodData = historicalData.filter(data => new Date(data.timestamp) >= startDate);
        
        // Calcular correlaci칩n
        const values1 = periodData.map(data => 
          data[parameter1 === 'presi칩n' ? 'pres' : 
              parameter1 === 'lluvia' ? 'lluvia' : 
              parameter1]
        );
        
        const values2 = periodData.map(data => 
          data[parameter2 === 'presi칩n' ? 'pres' : 
              parameter2 === 'lluvia' ? 'lluvia' : 
              parameter2]
        );
        
        // Calcular media
        const mean1 = values1.reduce((a, b) => a + b, 0) / values1.length;
        const mean2 = values2.reduce((a, b) => a + b, 0) / values2.length;
        
        // Calcular covarianza y desviaci칩n est치ndar
        let covariance = 0;
        let stdDev1 = 0;
        let stdDev2 = 0;
        
        for (let i = 0; i < values1.length; i++) {
          const diff1 = values1[i] - mean1;
          const diff2 = values2[i] - mean2;
          
          covariance += diff1 * diff2;
          stdDev1 += diff1 * diff1;
          stdDev2 += diff2 * diff2;
        }
        
        covariance /= values1.length;
        stdDev1 = Math.sqrt(stdDev1 / values1.length);
        stdDev2 = Math.sqrt(stdDev2 / values1.length);
        
        // Calcular coeficiente de correlaci칩n de Pearson
        const correlation = covariance / (stdDev1 * stdDev2);
        const rSquared = correlation * correlation;
        
        // Generar la respuesta basada en el an치lisis de los datos
        const variations = communicationSystem.getCorrelationVariations(
          parameter1,
          parameter2,
          correlation,
          rSquared
        );
        
        const response = getRandomVariation(variations);
        
        // Preparar datos para el gr치fico
        const chartData = periodData.map((data, index) => ({
          x: new Date(data.timestamp),
          y1: data[parameter1 === 'presi칩n' ? 'pres' : 
                 parameter1 === 'lluvia' ? 'lluvia' : 
                 parameter1],
          y2: data[parameter2 === 'presi칩n' ? 'pres' : 
                 parameter2 === 'lluvia' ? 'lluvia' : 
                 parameter2]
        }));
        
        // A침ade un gr치fico de correlaci칩n
        const chartId = `correlation-chart-${Date.now()}`;
        const chartResponse = `
          <div class="prediction-chart-container">
            <div class="chart-title">Relaci칩n entre ${parameter1} y ${parameter2} en ${benaventeInfo.location}</div>
            <canvas class="prediction-chart" id="${chartId}" 
                    data-parameter1="${parameter1}"
                    data-parameter2="${parameter2}"
                    data-chart-data='${JSON.stringify(chartData)}'></canvas>
          </div>
        `;
        
        return response + chartResponse;
      } catch (error) {
        console.error('Error en an치lisis de correlaci칩n:', error);
        return "丘멆잺 Ocurri칩 un error al analizar la correlaci칩n. Por favor, intenta nuevamente.";
      }
    },
    
    greeting: () => {
      const variations = communicationSystem.getGreetingVariations();
      return getRandomVariation(variations);
    },
    
    goodbye: () => {
      const variations = communicationSystem.getGoodbyeVariations();
      return getRandomVariation(variations);
    },
    
    help: () => {
      const variations = communicationSystem.getHelpVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="general-answer">
        <h3>Preguntas meteorol칩gicas para Benavente</h3>
        <ul>
          <li>"쮺u치l es la temperatura actual en Benavente?"</li>
          <li>"쮺칩mo ha sido la tendencia de humedad en Benavente esta semana?"</li>
          <li>"Muestra la tendencia de presi칩n de los 칰ltimos 7 d칤as en Benavente"</li>
          <li>"쮺칩mo se relaciona la humedad con la lluvia en Benavente?"</li>
          <li>"쯈u칠 tiempo har치 ma침ana en Benavente?"</li>
        </ul>
        
        <h3>Caracter칤sticas clim치ticas de Benavente</h3>
        <ul>
          <li>Verano: ${benaventeInfo.typicalWeather.summer}</li>
          <li>Invierno: ${benaventeInfo.typicalWeather.winter}</li>
          <li>Primavera: ${benaventeInfo.typicalWeather.spring}</li>
          <li>Oto침o: ${benaventeInfo.typicalWeather.autumn}</li>
        </ul>
        
        <h3>Preguntas sobre Horus en Benavente</h3>
        <ul>
          <li>"쯈u칠 es Horus en Benavente?"</li>
          <li>"쮺칩mo funciona el sistema Horus en Benavente?"</li>
          <li>"쯈u칠 sensores tiene Horus en Benavente?"</li>
          <li>"쮻칩nde est치 ubicado Horus en Benavente?"</li>
        </ul>
        
        <p>춰Hazme cualquier pregunta y har칠 lo posible por ayudarte con informaci칩n espec칤fica de Benavente!</p>
      </div>`;
      
      return response;
    },
    
    about_horus: () => {
      const variations = communicationSystem.getAboutHorusVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="system-info">
        <h3>Caracter칤sticas principales en Benavente:</h3>
        <ul>
          <li>Medici칩n de temperatura, humedad, presi칩n atmosf칠rica y direcci칩n del viento en ${benaventeInfo.location}</li>
          <li>Sensores de calidad del aire (PM2.5, PM10, CO2) adaptados al clima de Benavente</li>
          <li>Registro de precipitaciones y velocidad del viento en la llanura del Duero</li>
          <li>Transmisi칩n de datos en tiempo real v칤a MQTT desde ${benaventeInfo.location}</li>
          <li>Interfaz web para visualizaci칩n y an치lisis de datos espec칤ficos de Benavente</li>
        </ul>
        
        <h3>Caracter칤sticas clim치ticas de Benavente relevantes:</h3>
        <ul>
          <li><strong>Ubicaci칩n:</strong> ${benaventeInfo.coordinates}</li>
          <li><strong>Altitud:</strong> ${benaventeInfo.altitude}</li>
          <li><strong>Clima:</strong> ${benaventeInfo.climate}</li>
          <li><strong>Verano:</strong> ${benaventeInfo.typicalWeather.summer}</li>
          <li><strong>Invierno:</strong> ${benaventeInfo.typicalWeather.winter}</li>
          <li><strong>Primavera:</strong> ${benaventeInfo.typicalWeather.spring}</li>
          <li><strong>Oto침o:</strong> ${benaventeInfo.typicalWeather.autumn}</li>
        </ul>
        
        <p>Horus proporciona datos meteorol칩gicos precisos para an치lisis clim치ticos espec칤ficos de ${benaventeInfo.location}, predicciones y estudios ambientales adaptados a las caracter칤sticas de la regi칩n.</p>
      </div>`;
      
      return response;
    },
    
    support: () => {
      const variations = communicationSystem.getSupportVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="system-info">
        <h3>Problemas comunes:</h3>
        <ul>
          <li><strong>Datos no actualizados:</strong> Verifica la conexi칩n de la estaci칩n Horus en Benavente y espera unos minutos para que se actualicen los datos.</li>
          <li><strong>Interfaz lenta:</strong> Intenta actualizar la p치gina o limpiar la cach칠 del navegador.</li>
          <li><strong>Gr치ficos no visibles:</strong> Aseg칰rate de que JavaScript est치 habilitado en tu navegador.</li>
          <li><strong>Error de conexi칩n:</strong> Verifica tu conexi칩n a internet y recarga la p치gina.</li>
        </ul>
        
        <h3>Soluci칩n de problemas espec칤ficos de Benavente:</h3>
        <ol>
          <li>Recarga la p치gina (F5 o Ctrl + R)</li>
          <li>Limpia la cach칠 del navegador</li>
          <li>Intenta con otro navegador (Chrome, Firefox, Edge)</li>
          <li>Verifica tu conexi칩n a internet</li>
          <li>Si los datos parecen inusuales, considera que el clima de Benavente (${benaventeInfo.altitude}) puede causar variaciones espec칤ficas</li>
        </ol>
        
        <p>Si el problema persiste, contacta al administrador del sistema para obtener ayuda adicional espec칤fica para ${benaventeInfo.location}.</p>
      </div>`;
      
      return response;
    },
    
    personal: () => {
      const variations = communicationSystem.getPersonalInfoVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="system-info">
        <h3>Mis capacidades espec칤ficas para Benavente:</h3>
        <ul>
          <li>Analizar y explicar datos meteorol칩gicos en tiempo real para ${benaventeInfo.location}</li>
          <li>Identificar tendencias y patrones clim치ticos espec칤ficos de la regi칩n</li>
          <li>Realizar predicciones basadas en datos hist칩ricos de Benavente</li>
          <li>Explicar el funcionamiento del sistema Horus en Benavente</li>
          <li>Proporcionar recomendaciones basadas en condiciones clim치ticas de la zona</li>
          <li>Contextualizar el clima de Benavente (${benaventeInfo.altitude}) con su ubicaci칩n en la llanura del Duero</li>
        </ul>
        
        <h3>Caracter칤sticas clim치ticas de Benavente que considero:</h3>
        <ul>
          <li>Clima mediterr치neo continentalizado con veranos calurosos e inviernos fr칤os</li>
          <li>Altitud de ${benaventeInfo.altitude} que afecta la presi칩n atmosf칠rica</li>
          <li>Ubicaci칩n en la llanura del Duero que influye en los patrones de viento</li>
          <li>Patrones estacionales t칤picos de la meseta castellana</li>
        </ul>
        
        <p>Fui creado para facilitar el acceso y comprensi칩n de los datos meteorol칩gicos recopilados por la estaci칩n Horus en Benavente, ayudando a usuarios a tomar decisiones informadas basadas en el clima de la zona.</p>
        
        <p>No soy un humano, sino un sistema de inteligencia artificial dise침ado espec칤ficamente para an치lisis meteorol칩gico y soporte del sistema Horus en ${benaventeInfo.location}.</p>
      </div>`;
      
      return response;
    },
    
    general: () => {
      const variations = communicationSystem.getGeneralInfoVariations();
      let response = getRandomVariation(variations);
      
      const now = new Date();
      response += `<div class="system-info">
        <h3>Hora actual:</h3>
        <p>${now.toLocaleTimeString('es-ES', { 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit'
        })}</p>
        
        <h3>Fecha actual:</h3>
        <p>${now.toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}</p>
        
        <p>Estoy alojado en un servidor web y proporciono informaci칩n meteorol칩gica espec칤fica para ${benaventeInfo.location}, ubicado en la llanura del Duero.</p>
        
        <p>Fui desarrollado recientemente como parte del sistema Horus para ${benaventeInfo.location}. No tengo una edad en el sentido humano.</p>
      </div>`;
      
      return response;
    },
    
    out_of_scope: (intent) => {
      const domain = intent.domain || 'general';
      
      const variations = communicationSystem.getOutOfScopeVariations(domain);
      let response = getRandomVariation(variations);
      
      // Mensajes personalizados seg칰n el 치mbito
      const domainMessages = {
        salud: `<div class="out-of-scope">
          <h3>Preguntas sobre Salud en Benavente</h3>
          <p>Para consultas sobre salud:</p>
          <ul>
            <li>Contacta a un profesional m칠dico calificado en Benavente</li>
            <li>Visita el centro de salud de Benavente</li>
            <li>Consulta fuentes oficiales de salud p칰blica</li>
          </ul>
          <p>La informaci칩n meteorol칩gica de ${benaventeInfo.location} puede influir en ciertas condiciones de salud (como alergias estacionales), pero no sustituye el consejo m칠dico profesional.</p>
          <p class="benavente-context">En Benavente, con su clima mediterr치neo continentalizado, las temperaturas extremas de verano e invierno pueden requerir precauciones especiales para la salud.</p>
        </div>`,
        
        tecnolog칤a: `<div class="out-of-scope">
          <h3>Preguntas sobre Tecnolog칤a en Benavente</h3>
          <p>Para consultas sobre tecnolog칤a:</p>
          <ul>
            <li>Consulta foros especializados como Stack Overflow</li>
            <li>Revisa documentaci칩n oficial de los productos</li>
            <li>Busca tutoriales en YouTube o plataformas educativas</li>
          </ul>
          <p>Puedo ayudarte con aspectos tecnol칩gicos relacionados con el sistema Horus en Benavente, pero no con otros temas tecnol칩gicos generales.</p>
          <p class="benavente-context">El sistema Horus en Benavente utiliza tecnolog칤a adaptada a las condiciones clim치ticas de la llanura del Duero (${benaventeInfo.altitude}).</p>
        </div>`,
        
        deportes: `<div class="out-of-scope">
          <h3>Preguntas sobre Deportes en Benavente</h3>
          <p>Para informaci칩n sobre deportes:</p>
          <ul>
            <li>Visita el Ayuntamiento de Benavente para informaci칩n deportiva</li>
            <li>Sigue el Club Deportivo de Benavente</li>
            <li>Consulta aplicaciones deportivas oficiales</li>
          </ul>
          <p>Puedo informarte c칩mo las condiciones meteorol칩gicas en ${benaventeInfo.location} pueden afectar actividades deportivas al aire libre.</p>
          <p class="benavente-context">En Benavente, con su clima mediterr치neo continentalizado, las temperaturas pueden superar los 35춿C en verano y bajar de 0춿C en invierno, lo que afecta la planificaci칩n de actividades deportivas al aire libre.</p>
        </div>`,
        
        entretenimiento: `<div class="out-of-scope">
          <h3>Preguntas sobre Entretenimiento en Benavente</h3>
          <p>Para informaci칩n sobre entretenimiento:</p>
          <ul>
            <li>Visita la p치gina web del Ayuntamiento de Benavente</li>
            <li>Sigue eventos culturales en la Plaza Mayor de Benavente</li>
            <li>Consulta sitios web oficiales de actividades en la zona</li>
          </ul>
          <p>El clima en ${benaventeInfo.location} puede influir en tus planes de entretenimiento al aire libre.</p>
          <p class="benavente-context">En Benavente, con su clima mediterr치neo continentalizado, los mejores momentos para actividades al aire libre suelen ser primavera y oto침o, cuando las temperaturas son m치s moderadas.</p>
        </div>`,
        
        comida: `<div class="out-of-scope">
          <h3>Preguntas sobre Comida en Benavente</h3>
          <p>Para recetas o informaci칩n sobre comida:</p>
          <ul>
            <li>Consulta sitios web especializados en gastronom칤a zamorana</li>
            <li>Sigue chefs locales de Benavente</li>
            <li>Visita restaurantes tradicionales en la Plaza Mayor</li>
          </ul>
          <p>El clima en ${benaventeInfo.location} puede afectar la disponibilidad de ciertos alimentos de temporada.</p>
          <p class="benavente-context">En Benavente, con su clima mediterr치neo continentalizado, los productos locales var칤an seg칰n la estaci칩n: verduras frescas en primavera-verano y productos de invierno como casta침as en oto침o-invierno.</p>
        </div>`,
        
        educaci칩n: `<div class="out-of-scope">
          <h3>Preguntas sobre Educaci칩n en Benavente</h3>
          <p>Para informaci칩n educativa:</p>
          <ul>
            <li>Consulta la p치gina web del Ayuntamiento de Benavente</li>
            <li>Visita el Centro de Educaci칩n de Adultos de Benavente</li>
            <li>Contacta al IES Benavente</li>
          </ul>
          <p>Puedo proporcionar informaci칩n sobre meteorolog칤a y ciencias atmosf칠ricas en el contexto de ${benaventeInfo.location}, pero no sobre otros temas educativos.</p>
          <p class="benavente-context">El clima de Benavente (${benaventeInfo.altitude}) ofrece oportunidades 칰nicas para estudios pr치cticos de meteorolog칤a en la llanura del Duero.</p>
        </div>`,
        
        finanzas: `<div class="out-of-scope">
          <h3>Preguntas sobre Finanzas en Benavente</h3>
          <p>Para consultas financieras:</p>
          <ul>
            <li>Consulta a un asesor financiero en Benavente</li>
            <li>Visita oficinas bancarias en la Plaza Mayor</li>
            <li>Revisa informaci칩n oficial de instituciones financieras</li>
          </ul>
          <p>El clima en ${benaventeInfo.location} puede afectar ciertos sectores econ칩micos locales como la agricultura, pero no puedo proporcionar asesoramiento financiero.</p>
          <p class="benavente-context">En Benavente, el clima mediterr치neo continentalizado influye en actividades econ칩micas como la agricultura de secano, con temperaturas que pueden superar los 35춿C en verano y bajar de 0춿C en invierno.</p>
        </div>`,
        
        general: `<div class="out-of-scope">
          <h3>Preguntas Fuera de Mi 츼mbito en Benavente</h3>
          <p>Mi conocimiento est치 limitado a:</p>
          <ul>
            <li>Monitoreo y an치lisis de datos meteorol칩gicos en Benavente</li>
            <li>Funcionamiento del sistema Horus en Benavente</li>
            <li>An치lisis de tendencias clim치ticas de la zona</li>
            <li>Predicciones basadas en datos hist칩ricos de Benavente</li>
            <li>Contexto clim치tico espec칤fico de la llanura del Duero (${benaventeInfo.altitude})</li>
          </ul>
          
          <p>Para otras preguntas, te recomiendo:</p>
          <ul>
            <li>Buscar en fuentes especializadas en el tema</li>
            <li>Consultar a expertos en el campo espec칤fico</li>
            <li>Utilizar asistentes dise침ados para esos temas</li>
          </ul>
          
          <p class="benavente-context"><strong>Informaci칩n clave sobre Benavente:</strong> Ubicado a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterr치neo continentalizado con veranos calurosos e inviernos fr칤os.</p>
        </div>`
      };
      
      response += domainMessages[domain] || domainMessages.general;
      return response;
    },
    
    unrelated: (entities, context) => {
      const variations = communicationSystem.getUnrelatedVariations();
      let response = getRandomVariation(variations);
      
      response += `<div class="out-of-scope">
        <h3>쮺칩mo puedo ayudarte con Benavente?</h3>
        <ul>
          <li>Consultar datos meteorol칩gicos actuales en Benavente</li>
          <li>Analizar tendencias clim치ticas hist칩ricas de Benavente</li>
          <li>Realizar predicciones basadas en datos de Benavente</li>
          <li>Explicar el funcionamiento de Horus en Benavente</li>
          <li>Contextualizar el clima de Benavente (${benaventeInfo.altitude})</li>
        </ul>
        
        <p>Ejemplos de preguntas que puedo responder:</p>
        <ul>
          <li>"쮺u치l es la temperatura actual en Benavente?"</li>
          <li>"쮺칩mo funciona el sistema Horus en Benavente?"</li>
          <li>"Muestra la tendencia de presi칩n de los 칰ltimos 7 d칤as en Benavente"</li>
        </ul>
        
        <p>Por favor, reformula tu pregunta para que est칠 relacionada con el clima o el sistema Horus en <strong>${benaventeInfo.location}</strong>.</p>
        
        <p class="benavente-context"><strong>Informaci칩n clave sobre Benavente:</strong> Ubicado a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterr치neo continentalizado con veranos calurosos e inviernos fr칤os.</p>
      </div>`;
      
      return response;
    }
  };

  // Sistema de comunicaci칩n mejorado
  const communicationSystem = {
    // Variaciones de saludos seg칰n la hora
    getGreetingVariations: () => {
      const hours = new Date().getHours();
      const dayOfWeek = new Date().getDay();
      const month = new Date().getMonth();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si hay un evento local pr칩ximo
      const upcomingEvent = benaventeInfo.localEvents.find(event => {
        // Aqu칤 ir칤a la l칩gica para detectar eventos pr칩ximos
        return Math.random() > 0.7; // Simulaci칩n aleatoria
      });
      
      const variations = {
        morning: [
          `춰Buenos d칤as! ${localPhrase} Soy Horus AI, tu asistente meteorol칩gico para Benavente. 쮼n qu칠 puedo ayudarte hoy?`,
          `춰Hola! ${localPhrase} Espero que est칠s disfrutando de esta ma침ana en Benavente. Soy Horus AI, tu asistente meteorol칩gico. 쯅ecesitas informaci칩n sobre el clima?`,
          `춰Buen d칤a! ${localPhrase} 쯉ab칤as que hoy en Benavente...? Soy Horus AI, tu asistente meteorol칩gico. 쮼n qu칠 puedo ayudarte?`
        ],
        afternoon: [
          `춰Buenas tardes! ${localPhrase} Soy Horus AI, tu asistente especializado en el clima de Benavente. 쯅ecesitas informaci칩n meteorol칩gica?`,
          `춰Hola! ${localPhrase} 쮺칩mo est치 el tiempo por tu zona de Benavente? Soy Horus AI, tu asistente meteorol칩gico. 쮼n qu칠 puedo ayudarte?`,
          `춰Buenas tardes! ${localPhrase} 쮿as notado alg칰n cambio en el clima de Benavente 칰ltimamente? Soy Horus AI, tu asistente meteorol칩gico.`
        ],
        evening: [
          `춰Buenas noches! ${localPhrase} Soy Horus AI, tu asistente meteorol칩gico para Benavente. 쯅ecesitas informaci칩n sobre el clima nocturno?`,
          `춰Hola! ${localPhrase} 쮺칩mo ha sido tu d칤a en Benavente? Soy Horus AI, tu asistente meteorol칩gico. 쯅ecesitas informaci칩n sobre el clima?`,
          `춰Buenas noches! ${localPhrase} 쯉ab칤as que en Benavente el clima nocturno suele...? Soy Horus AI, tu asistente meteorol칩gico.`
        ]
      };
      
      if (upcomingEvent) {
        const eventVariations = [
          `춰Buenos d칤as! ${localPhrase} Por cierto, 쯥ab칤as que se acerca ${upcomingEvent} en Benavente? Soy Horus AI, tu asistente meteorol칩gico. 쯅ecesitas informaci칩n sobre el clima para el evento?`,
          `춰Hola! ${localPhrase} Con el ${upcomingEvent} acerc치ndose en Benavente, es importante estar al tanto del clima. Soy Horus AI, tu asistente meteorol칩gico. 쮼n qu칠 puedo ayudarte?`
        ];
        
        if (hours < 12) return eventVariations;
        if (hours < 18) return eventVariations;
        return eventVariations;
      }
      
      if (hours < 12) return variations.morning;
      if (hours < 18) return variations.afternoon;
      return variations.evening;
    },
    
    // Variaciones de despedida
    getGoodbyeVariations: () => {
      const hours = new Date().getHours();
      const dayOfWeek = new Date().getDay();
      
      return [
        `춰Que tengas un buen d칤a! Si necesitas m치s informaci칩n sobre el clima de Benavente, no dudes en volver. 춰Hasta pronto!`,
        `Gracias por consultar el clima de Benavente conmigo. 춰Que disfrutes del d칤a en la llanura del Duero!`,
        `Espero haber sido de ayuda con la informaci칩n meteorol칩gica de Benavente. 춰Que tengas un d칤a maravilloso!`,
        `춰Hasta la pr칩xima! Recuerda que siempre puedes volver para conocer el estado del tiempo en Benavente.`,
        `Gracias por tu visita. Si necesitas m치s informaci칩n sobre el clima de Benavente, estar칠 aqu칤 cuando me necesites. 춰Adi칩s!`,
        `Espero que la informaci칩n sobre el clima de Benavente te haya sido 칰til. 춰Que tengas un buen d칤a en la plaza Mayor!`,
        `춰Hasta pronto! Que el tiempo te acompa침e en tus pr칩ximas actividades en Benavente.`
      ];
    },
    
    // Variaciones para datos actuales
    getCurrentDataVariations: (parameter, value, unit) => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      const latestData = historicalData[historicalData.length - 1];
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si hay un evento local relevante
      const relevantEvent = benaventeInfo.localEvents.find(event => {
        // Aqu칤 ir칤a la l칩gica para detectar eventos relevantes para el clima
        return Math.random() > 0.8; // Simulaci칩n aleatoria
      });
      
      // Determinar si es relevante para actividades al aire libre
      const isOutdoorRelevant = (parameter === 'temperatura' && value > 15) || 
                               (parameter === 'humedad' && value < 70) ||
                               (parameter === 'presi칩n' && value > 1000);
      
      // Determinar si es relevante para actividades espec칤ficas de Benavente
      const isBenaventeSpecific = benaventeInfo.localLandmarks.some(landmark => {
        return Math.random() > 0.7; // Simulaci칩n aleatoria
      });
      
      // Determinar si es una condici칩n clim치tica inusual
      const isUnusual = (parameter === 'temperatura' && (value > 30 || value < 5)) ||
                        (parameter === 'humedad' && (value > 80 || value < 30)) ||
                        (parameter === 'presi칩n' && (value > 1030 || value < 980));
      
      // Determinar si es relevante para la 칠poca del a침o
      const isSeasonRelevant = (month === 6 && parameter === 'temperatura' && value > 25) || // Verano
                              (month === 1 && parameter === 'temperatura' && value < 10) || // Invierno
                              (month === 3 && parameter === 'lluvia' && value > 0); // Primavera
      
      // Variaciones seg칰n el par치metro
      const variations = {
        temperatura: [
          `La temperatura actual en Benavente es de ${value.toFixed(1)}춿C. ${localPhrase}. ${isUnusual ? 'Esta temperatura es inusual para esta 칠poca del a침o en Benavente.' : 'Esta temperatura es t칤pica del clima mediterr치neo continentalizado de Benavente.'}`,
          `En estos momentos, la temperatura en Benavente es de ${value.toFixed(1)}춿C. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo com칰n para nuestra zona.' : 'Es un buen d칤a para disfrutar de la Plaza Mayor si te gusta esta temperatura.'}`,
          `Actualmente registramos ${value.toFixed(1)}춿C en Benavente. ${localPhrase}. ${isUnusual ? '춰Cuidado con las temperaturas extremas!' : 'Es una temperatura perfecta para un paseo por el R칤o Esla.'}`
        ],
        humedad: [
          `La humedad actual en Benavente es del ${value.toFixed(0)}%. ${localPhrase}. ${isUnusual ? 'Esta humedad es inusual para nuestra zona.' : 'Este nivel de humedad es t칤pico de Benavente.'}`,
          `Actualmente la humedad en Benavente es del ${value.toFixed(0)}%. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo com칰n para nuestra zona.' : 'Es un buen nivel de humedad para las actividades al aire libre.'}`,
          `Registramos un ${value.toFixed(0)}% de humedad en Benavente. ${localPhrase}. ${isUnusual ? '춰Cuidado con la humedad alta!' : 'Es una humedad perfecta para disfrutar del clima de la llanura del Duero.'}`
        ],
        presi칩n: [
          `La presi칩n atmosf칠rica actual en Benavente es de ${value.toFixed(0)} hPa. ${localPhrase}. ${isUnusual ? 'Esta presi칩n es inusual para nuestra zona.' : 'Este valor es t칤pico de Benavente a ${benaventeInfo.altitude}.'}`,
          `Actualmente registramos ${value.toFixed(0)} hPa de presi칩n en Benavente. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo com칰n para nuestra zona.' : 'Es una presi칩n normal para el clima mediterr치neo continentalizado de Benavente.'}`,
          `La presi칩n atmosf칠rica en Benavente es de ${value.toFixed(0)} hPa. ${localPhrase}. ${isUnusual ? '춰Cuidado con los cambios bruscos de presi칩n!' : 'Esta presi칩n indica condiciones clim치ticas estables en la zona.'}`
        ],
        lluvia: [
          `Actualmente ${value ? 'est치 lloviendo' : 'no est치 lloviendo'} en Benavente. ${localPhrase}. ${isUnusual ? '춰Esperemos que no dure mucho!' : 'Es un buen momento para pasear por el casco hist칩rico.'}`,
          `El sistema registra que ${value ? 'hay lluvia' : 'no hay lluvia'} en estos momentos en Benavente. ${localPhrase}. ${isUnusual ? '춰No olvides tu paraguas!' : 'Es un buen d칤a para visitar la Iglesia de Santiago.'}`,
          `Seg칰n nuestros datos, ${value ? 'est치 lloviendo' : 'no est치 lloviendo'} en Benavente. ${localPhrase}. ${isUnusual ? '춰Cuidado con posibles inundaciones!' : 'Es un buen momento para disfrutar de un caf칠 en la Plaza Mayor.'}`
        ],
        viento: [
          `La velocidad del viento actual en Benavente es de ${value.toFixed(1)} m/s (${(value * 3.6).toFixed(1)} km/h). ${localPhrase}. ${isUnusual ? '춰Cuidado con las r치fagas fuertes!' : 'Es un viento t칤pico de la llanura del Duero.'}`,
          `Actualmente el viento en Benavente sopla a ${value.toFixed(1)} m/s. ${localPhrase}. ${isUnusual ? 'Este viento es bastante fuerte para nuestra zona.' : 'Es un buen d칤a para practicar actividades al aire libre.'}`,
          `Registramos una velocidad de viento de ${value.toFixed(1)} m/s en Benavente. ${localPhrase}. ${isUnusual ? '춰Presta atenci칩n a las se침ales de tr치fico!' : 'Es un viento perfecto para disfrutar del paisaje.'}`
        ],
        gas: [
          `El nivel de gas actual en Benavente es de ${value.toFixed(2)} k풜. ${localPhrase}. ${isUnusual ? 'Este nivel es inusual para nuestra zona.' : 'Este valor es t칤pico de Benavente.'}`,
          `Actualmente registramos un nivel de gas de ${value.toFixed(2)} k풜 en Benavente. ${localPhrase}. ${isUnusual ? 'Este valor es bastante fuera de lo com칰n para nuestra zona.' : 'Es un buen nivel para las actividades al aire libre.'}`,
          `El sistema detecta un nivel de gas de ${value.toFixed(2)} k풜 en Benavente. ${localPhrase}. ${isUnusual ? '춰Cuidado con la calidad del aire!' : 'Es un buen momento para pasear por el R칤o Esla.'}`
        ],
        direcci칩n: [
          `La direcci칩n del viento actual en Benavente es ${getWindDirectionName(latestData.wind_dir)} (${latestData.wind_dir}춿). ${localPhrase}. ${isUnusual ? '춰Este viento es inusual para nuestra zona!' : 'Es una direcci칩n t칤pica del viento en Benavente.'}`,
          `Actualmente el viento en Benavente viene del ${getWindDirectionName(latestData.wind_dir)}. ${localPhrase}. ${isUnusual ? 'Este viento es bastante fuera de lo com칰n para nuestra zona.' : 'Es una direcci칩n normal para el clima mediterr치neo continentalizado de Benavente.'}`,
          `Registramos que el viento en Benavente viene del ${getWindDirectionName(latestData.wind_dir)}. ${localPhrase}. ${isUnusual ? '춰Cuidado con los cambios bruscos de direcci칩n!' : 'Es una direcci칩n perfecta para disfrutar del clima de la llanura del Duero.'}`
        ]
      };
      
      // Si hay evento relevante, a침adir variaciones espec칤ficas
      if (relevantEvent) {
        const eventVariations = {
          temperatura: [
            `La temperatura actual en Benavente es de ${value.toFixed(1)}춿C. Con el ${relevantEvent} acerc치ndose, es importante estar preparado para el clima. ${localPhrase}.`,
            `En estos momentos, la temperatura en Benavente es de ${value.toFixed(1)}춿C. ${relevantEvent} se acerca, as칤 que mantente informado sobre el clima. ${localPhrase}.`
          ],
          humedad: [
            `La humedad actual en Benavente es del ${value.toFixed(0)}%. Con el ${relevantEvent} acerc치ndose, este nivel de humedad podr칤a afectar los preparativos. ${localPhrase}.`,
            `Actualmente la humedad en Benavente es del ${value.toFixed(0)}%. Para ${relevantEvent}, este nivel de humedad es importante tener en cuenta. ${localPhrase}.`
          ],
          // Variaciones similares para otros par치metros
          presi칩n: [
            `La presi칩n atmosf칠rica actual en Benavente es de ${value.toFixed(0)} hPa. Con el ${relevantEvent} acerc치ndose, este valor de presi칩n indica... ${localPhrase}.`
          ],
          lluvia: [
            `Actualmente ${value ? 'est치 lloviendo' : 'no est치 lloviendo'} en Benavente. Para ${relevantEvent}, esta condici칩n es importante para... ${localPhrase}.`
          ],
          viento: [
            `La velocidad del viento actual en Benavente es de ${value.toFixed(1)} m/s. Con el ${relevantEvent} acerc치ndose, este viento podr칤a afectar... ${localPhrase}.`
          ],
          gas: [
            `El nivel de gas actual en Benavente es de ${value.toFixed(2)} k풜. Para ${relevantEvent}, este nivel de calidad del aire es... ${localPhrase}.`
          ],
          direcci칩n: [
            `La direcci칩n del viento actual en Benavente es ${getWindDirectionName(latestData.wind_dir)}. Con el ${relevantEvent} acerc치ndose, esta direcci칩n indica... ${localPhrase}.`
          ]
        };
        
        // Combinar variaciones normales con variaciones de evento
        return [...variations[parameter], ...eventVariations[parameter]];
      }
      
      return variations[parameter];
    },
    
    // Variaciones para an치lisis de tendencias
    getTrendAnalysisVariations: (parameter, avg, min, max, trend, trendStrength, period) => {
      const now = new Date();
      const month = now.getMonth();
      const isSummer = month >= 5 && month <= 8;
      const isWinter = month >= 11 || month <= 2;
      
      // Determinar si la tendencia es significativa
      const isSignificantTrend = trendStrength > 0.1;
      
      // Determinar si es relevante para la 칠poca del a침o
      const isSeasonRelevant = (isSummer && parameter === 'temperatura' && trend === 'ascendente') ||
                              (isWinter && parameter === 'temperatura' && trend === 'descendente');
      
      // Determinar si es una tendencia inusual
      const isUnusualTrend = (parameter === 'temperatura' && trendStrength > 0.2) ||
                             (parameter === 'humedad' && trendStrength > 0.15) ||
                             (parameter === 'presi칩n' && trendStrength > 0.1);
      
      // Variaciones seg칰n el par치metro
      const variations = {
        temperatura: [
          `En los 칰ltimos ${period}, la temperatura en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(1)}춿C, con un m칤nimo de ${min.toFixed(1)}춿C y un m치ximo de ${max.toFixed(1)}춿C.`,
          `Analizando los datos de los 칰ltimos ${period} en Benavente, observamos que la temperatura ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr칩n es inusual para nuestra zona.' : 'Este patr칩n es t칤pico del clima mediterr치neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(1)}춿C, con picos entre ${min.toFixed(1)}춿C y ${max.toFixed(1)}춿C.`,
          `Seg칰n nuestro an치lisis de los 칰ltimos ${period}, la temperatura en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(1)}춿C, con valores extremos de ${min.toFixed(1)}춿C y ${max.toFixed(1)}춿C.`
        ],
        humedad: [
          `En los 칰ltimos ${period}, la humedad en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido del ${avg.toFixed(0)}%, con un m칤nimo del ${min.toFixed(0)}% y un m치ximo del ${max.toFixed(0)}%.`,
          `Analizando los datos de los 칰ltimos ${period} en Benavente, observamos que la humedad ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr칩n es inusual para nuestra zona.' : 'Este patr칩n es t칤pico del clima mediterr치neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(0)}%, con picos entre ${min.toFixed(0)}% y ${max.toFixed(0)}%.`,
          `Seg칰n nuestro an치lisis de los 칰ltimos ${period}, la humedad en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} El promedio registrado es del ${avg.toFixed(0)}%, con valores extremos del ${min.toFixed(0)}% y del ${max.toFixed(0)}%.`
        ],
        presi칩n: [
          `En los 칰ltimos ${period}, la presi칩n atmosf칠rica en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(0)} hPa, con un m칤nimo de ${min.toFixed(0)} hPa y un m치ximo de ${max.toFixed(0)} hPa.`,
          `Analizando los datos de los 칰ltimos ${period} en Benavente, observamos que la presi칩n atmosf칠rica ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr칩n es inusual para nuestra zona.' : 'Este patr칩n es t칤pico del clima mediterr치neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(0)} hPa, con picos entre ${min.toFixed(0)} hPa y ${max.toFixed(0)} hPa.`,
          `Seg칰n nuestro an치lisis de los 칰ltimos ${period}, la presi칩n atmosf칠rica en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(0)} hPa, con valores extremos de ${min.toFixed(0)} hPa y ${max.toFixed(0)} hPa.`
        ],
        lluvia: [
          `En los 칰ltimos ${period}, la precipitaci칩n en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(1)} mm, con un m칤nimo de ${min.toFixed(1)} mm y un m치ximo de ${max.toFixed(1)} mm.`,
          `Analizando los datos de los 칰ltimos ${period} en Benavente, observamos que la precipitaci칩n ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr칩n es inusual para nuestra zona.' : 'Este patr칩n es t칤pico del clima mediterr치neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(1)} mm, con picos entre ${min.toFixed(1)} mm y ${max.toFixed(1)} mm.`,
          `Seg칰n nuestro an치lisis de los 칰ltimos ${period}, la precipitaci칩n en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(1)} mm, con valores extremos de ${min.toFixed(1)} mm y ${max.toFixed(1)} mm.`
        ],
        viento: [
          `En los 칰ltimos ${period}, la velocidad del viento en Benavente ha mostrado una tendencia ${trend} con un cambio del ${(trendStrength * 100).toFixed(1)}%. ${isSignificantTrend ? 'Este cambio es bastante notable.' : 'Este cambio es normal para el clima de Benavente.'} El promedio ha sido de ${avg.toFixed(1)} m/s, con un m칤nimo de ${min.toFixed(1)} m/s y un m치ximo de ${max.toFixed(1)} m/s.`,
          `Analizando los datos de los 칰ltimos ${period} en Benavente, observamos que la velocidad del viento ha estado ${trend === 'ascendente' ? 'aumentando' : 'disminuyendo'}. ${isUnusualTrend ? 'Este patr칩n es inusual para nuestra zona.' : 'Este patr칩n es t칤pico del clima mediterr치neo continentalizado de Benavente.'} El valor promedio ha sido ${avg.toFixed(1)} m/s, con picos entre ${min.toFixed(1)} m/s y ${max.toFixed(1)} m/s.`,
          `Seg칰n nuestro an치lisis de los 칰ltimos ${period}, la velocidad del viento en Benavente ha tenido una tendencia ${trend === 'ascendente' ? 'al alza' : 'a la baja'}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} El promedio registrado es de ${avg.toFixed(1)} m/s, con valores extremos de ${min.toFixed(1)} m/s y ${max.toFixed(1)} m/s.`
        ]
      };
      
      return variations[parameter] || variations.temperatura;
    },
    
    // Variaciones para predicciones
    getPredictionVariations: (parameter, reliability, period) => {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      
      // Determinar si es relevante para la 칠poca del a침o
      const isSeasonRelevant = (month === 6 && parameter === 'temperatura') || // Verano
                              (month === 1 && parameter === 'temperatura') || // Invierno
                              (month === 3 && parameter === 'lluvia'); // Primavera
      
      // Determinar si es una predicci칩n inusual
      const isUnusualPrediction = reliability < 0.6;
      
      // Determinar si hay un evento local relevante
      const relevantEvent = benaventeInfo.localEvents.find(event => {
        // Aqu칤 ir칤a la l칩gica para detectar eventos relevantes para el clima
        return Math.random() > 0.7; // Simulaci칩n aleatoria
      });
      
      // Variaciones seg칰n el par치metro
      const variations = {
        temperatura: [
          `Basado en los datos hist칩ricos de Benavente, la predicci칩n para los pr칩ximos ${period} indica que la temperatura seguir치 una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci칩n tiene una confiabilidad baja, as칤 que t칩mala con precauci칩n.' : 'Esta predicci칩n es bastante confiable para planificar actividades en Benavente.'}`,
          `Seg칰n nuestro an치lisis de los datos meteorol칩gicos de Benavente, esperamos que la temperatura ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr칩ximos ${period}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim치ticos inusuales, esta predicci칩n debe tomarse con reserva.' : 'Esta predicci칩n se basa en patrones hist칩ricos t칤picos del clima mediterr치neo continentalizado de Benavente.'}`,
          `Nuestra predicci칩n meteorol칩gica para Benavente indica que la temperatura tendr치 una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los pr칩ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci칩n en unos d칤as para mayor precisi칩n.' : 'puedes planificar tus actividades con confianza.'}`
        ],
        humedad: [
          `Basado en los datos hist칩ricos de Benavente, la predicci칩n para los pr칩ximos ${period} indica que la humedad seguir치 una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci칩n tiene una confiabilidad baja, as칤 que t칩mala con precauci칩n.' : 'Esta predicci칩n es bastante confiable para planificar actividades en Benavente.'}`,
          `Seg칰n nuestro an치lisis de los datos meteorol칩gicos de Benavente, esperamos que la humedad ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr칩ximos ${period}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim치ticos inusuales, esta predicci칩n debe tomarse con reserva.' : 'Esta predicci칩n se basa en patrones hist칩ricos t칤picos del clima mediterr치neo continentalizado de Benavente.'}`,
          `Nuestra predicci칩n meteorol칩gica para Benavente indica que la humedad tendr치 una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los pr칩ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci칩n en unos d칤as para mayor precisi칩n.' : 'puedes planificar tus actividades con confianza.'}`
        ],
        presi칩n: [
          `Basado en los datos hist칩ricos de Benavente, la predicci칩n para los pr칩ximos ${period} indica que la presi칩n atmosf칠rica seguir치 una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci칩n tiene una confiabilidad baja, as칤 que t칩mala con precauci칩n.' : 'Esta predicci칩n es bastante confiable para planificar actividades en Benavente.'}`,
          `Seg칰n nuestro an치lisis de los datos meteorol칩gicos de Benavente, esperamos que la presi칩n atmosf칠rica ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr칩ximos ${period}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim치ticos inusuales, esta predicci칩n debe tomarse con reserva.' : 'Esta predicci칩n se basa en patrones hist칩ricos t칤picos del clima mediterr치neo continentalizado de Benavente.'}`,
          `Nuestra predicci칩n meteorol칩gica para Benavente indica que la presi칩n atmosf칠rica tendr치 una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los pr칩ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci칩n en unos d칤as para mayor precisi칩n.' : 'puedes planificar tus actividades con confianza.'}`
        ],
        lluvia: [
          `Basado en los datos hist칩ricos de Benavente, la predicci칩n para los pr칩ximos ${period} indica que ${Math.random() > 0.5 ? 'habr치 lluvia' : 'no habr치 lluvia'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci칩n tiene una confiabilidad baja, as칤 que t칩mala con precauci칩n.' : 'Esta predicci칩n es bastante confiable para planificar actividades en Benavente.'}`,
          `Seg칰n nuestro an치lisis de los datos meteorol칩gicos de Benavente, esperamos que ${Math.random() > 0.5 ? 'llueva' : 'no llueva'} en los pr칩ximos ${period}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim치ticos inusuales, esta predicci칩n debe tomarse con reserva.' : 'Esta predicci칩n se basa en patrones hist칩ricos t칤picos del clima mediterr치neo continentalizado de Benavente.'}`,
          `Nuestra predicci칩n meteorol칩gica para Benavente indica que ${Math.random() > 0.5 ? 'habr치 precipitaciones' : 'no habr치 precipitaciones'} en los pr칩ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci칩n en unos d칤as para mayor precisi칩n.' : 'puedes planificar tus actividades con confianza.'}`
        ],
        viento: [
          `Basado en los datos hist칩ricos de Benavente, la predicci칩n para los pr칩ximos ${period} indica que el viento seguir치 una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Esta predicci칩n tiene una confiabilidad baja, as칤 que t칩mala con precauci칩n.' : 'Esta predicci칩n es bastante confiable para planificar actividades en Benavente.'}`,
          `Seg칰n nuestro an치lisis de los datos meteorol칩gicos de Benavente, esperamos que la velocidad del viento ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr칩ximos ${period}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%. ${isUnusualPrediction ? 'Debido a patrones clim치ticos inusuales, esta predicci칩n debe tomarse con reserva.' : 'Esta predicci칩n se basa en patrones hist칩ricos t칤picos del clima mediterr치neo continentalizado de Benavente.'}`,
          `Nuestra predicci칩n meteorol칩gica para Benavente indica que el viento tendr치 una tendencia ${Math.random() > 0.5 ? 'al alza' : 'a la baja'} en los pr칩ximos ${period}. Con una confiabilidad del ${(reliability * 100).toFixed(0)}%, ${isUnusualPrediction ? 'es recomendable revisar la predicci칩n en unos d칤as para mayor precisi칩n.' : 'puedes planificar tus actividades con confianza.'}`
        ]
      };
      
      // Si hay evento relevante, a침adir variaciones espec칤ficas
      if (relevantEvent) {
        const eventVariations = {
          temperatura: [
            `Con el ${relevantEvent} acerc치ndose, nuestra predicci칩n para los pr칩ximos ${period} indica que la temperatura seguir치 una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%.`,
            `Para el ${relevantEvent}, esperamos que la temperatura ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr칩ximos ${period}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%.`
          ],
          humedad: [
            `Con el ${relevantEvent} acerc치ndose, nuestra predicci칩n para los pr칩ximos ${period} indica que la humedad seguir치 una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%.`,
            `Para el ${relevantEvent}, esperamos que la humedad ${Math.random() > 0.5 ? 'aumente' : 'disminuya'} en los pr칩ximos ${period}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%.`
          ],
          // Variaciones similares para otros par치metros
          presi칩n: [
            `Con el ${relevantEvent} acerc치ndose, nuestra predicci칩n para los pr칩ximos ${period} indica que la presi칩n atmosf칠rica seguir치 una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%.`
          ],
          lluvia: [
            `Con el ${relevantEvent} acerc치ndose, nuestra predicci칩n para los pr칩ximos ${period} indica que ${Math.random() > 0.5 ? 'habr치 lluvia' : 'no habr치 lluvia'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%.`
          ],
          viento: [
            `Con el ${relevantEvent} acerc치ndose, nuestra predicci칩n para los pr칩ximos ${period} indica que el viento seguir치 una tendencia ${Math.random() > 0.5 ? 'ascendente' : 'descendente'}. La confiabilidad de esta predicci칩n es del ${(reliability * 100).toFixed(0)}%.`
          ]
        };
        
        // Combinar variaciones normales con variaciones de evento
        return [...variations[parameter], ...eventVariations[parameter]];
      }
      
      return variations[parameter] || variations.temperatura;
    },
    
    // Variaciones para comparaciones
    getComparisonVariations: (parameter, avg1, avg2, period1, period2, changePercent) => {
      const now = new Date();
      const month = now.getMonth();
      
      // Determinar si es relevante para la 칠poca del a침o
      const isSeasonRelevant = (month === 6 && parameter === 'temperatura') || // Verano
                              (month === 1 && parameter === 'temperatura') || // Invierno
                              (month === 3 && parameter === 'lluvia'); // Primavera
      
      // Determinar si es un cambio significativo
      const isSignificantChange = Math.abs(changePercent) > 10;
      
      // Determinar si es un cambio inusual
      const isUnusualChange = (parameter === 'temperatura' && Math.abs(changePercent) > 15) ||
                             (parameter === 'humedad' && Math.abs(changePercent) > 20) ||
                             (parameter === 'presi칩n' && Math.abs(changePercent) > 5);
      
      // Variaciones seg칰n el par치metro
      const variations = {
        temperatura: [
          `Al comparar ${period1} con ${period2} en Benavente, la temperatura ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr치neo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(1)}춿C, mientras que en ${period2} fue de ${avg2.toFixed(1)}춿C.`,
          `La comparaci칩n entre ${period1} y ${period2} muestra que la temperatura en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t칤pico de las variaciones clim치ticas estacionales.'} Los promedios fueron de ${avg1.toFixed(1)}춿C y ${avg2.toFixed(1)}춿C respectivamente.`,
          `Seg칰n nuestro an치lisis comparativo, la temperatura en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(1)}춿C y ${avg2.toFixed(1)}춿C.`
        ],
        humedad: [
          `Al comparar ${period1} con ${period2} en Benavente, la humedad ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr치neo continentalizado de Benavente.`} El promedio en ${period1} fue del ${avg1.toFixed(0)}%, mientras que en ${period2} fue del ${avg2.toFixed(0)}%.`,
          `La comparaci칩n entre ${period1} y ${period2} muestra que la humedad en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t칤pico de las variaciones clim치ticas estacionales.'} Los promedios fueron del ${avg1.toFixed(0)}% y del ${avg2.toFixed(0)}% respectivamente.`,
          `Seg칰n nuestro an치lisis comparativo, la humedad en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} Los valores promedio fueron del ${avg1.toFixed(0)}% y del ${avg2.toFixed(0)}%.`
        ],
        presi칩n: [
          `Al comparar ${period1} con ${period2} en Benavente, la presi칩n atmosf칠rica ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr치neo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(0)} hPa, mientras que en ${period2} fue de ${avg2.toFixed(0)} hPa.`,
          `La comparaci칩n entre ${period1} y ${period2} muestra que la presi칩n atmosf칠rica en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t칤pico de las variaciones clim치ticas estacionales.'} Los promedios fueron de ${avg1.toFixed(0)} hPa y ${avg2.toFixed(0)} hPa respectivamente.`,
          `Seg칰n nuestro an치lisis comparativo, la presi칩n atmosf칠rica en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(0)} hPa y ${avg2.toFixed(0)} hPa.`
        ],
        lluvia: [
          `Al comparar ${period1} con ${period2} en Benavente, la precipitaci칩n ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr치neo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(1)} mm, mientras que en ${period2} fue de ${avg2.toFixed(1)} mm.`,
          `La comparaci칩n entre ${period1} y ${period2} muestra que la precipitaci칩n en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t칤pico de las variaciones clim치ticas estacionales.'} Los promedios fueron de ${avg1.toFixed(1)} mm y ${avg2.toFixed(1)} mm respectivamente.`,
          `Seg칰n nuestro an치lisis comparativo, la precipitaci칩n en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(1)} mm y ${avg2.toFixed(1)} mm.`
        ],
        viento: [
          `Al comparar ${period1} con ${period2} en Benavente, la velocidad del viento ha cambiado un ${changePercent.toFixed(1)}%. ${isSignificantChange ? `Este es un cambio significativo que afecta el clima de nuestra zona.` : `Este es un cambio normal para el clima mediterr치neo continentalizado de Benavente.`} El promedio en ${period1} fue de ${avg1.toFixed(1)} m/s, mientras que en ${period2} fue de ${avg2.toFixed(1)} m/s.`,
          `La comparaci칩n entre ${period1} y ${period2} muestra que la velocidad del viento en Benavente ha ${changePercent > 0 ? 'aumentado' : 'disminuido'} un ${Math.abs(changePercent).toFixed(1)}%. ${isUnusualChange ? 'Este cambio es inusual para nuestra zona.' : 'Este cambio es t칤pico de las variaciones clim치ticas estacionales.'} Los promedios fueron de ${avg1.toFixed(1)} m/s y ${avg2.toFixed(1)} m/s respectivamente.`,
          `Seg칰n nuestro an치lisis comparativo, la velocidad del viento en Benavente durante ${period1} fue ${changePercent > 0 ? 'mayor' : 'menor'} en un ${Math.abs(changePercent).toFixed(1)}% que durante ${period2}. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'} Los valores promedio fueron de ${avg1.toFixed(1)} m/s y ${avg2.toFixed(1)} m/s.`
        ]
      };
      
      return variations[parameter] || variations.temperatura;
    },
    
    // Variaciones para correlaciones
    getCorrelationVariations: (parameter1, parameter2, correlation, rSquared) => {
      const now = new Date();
      const month = now.getMonth();
      
      // Determinar la fuerza de la correlaci칩n
      const correlationStrength = Math.abs(correlation);
      let strengthDescription;
      if (correlationStrength > 0.7) {
        strengthDescription = 'muy fuerte';
      } else if (correlationStrength > 0.5) {
        strengthDescription = 'fuerte';
      } else if (correlationStrength > 0.3) {
        strengthDescription = 'moderada';
      } else if (correlationStrength > 0.1) {
        strengthDescription = 'd칠bil';
      } else {
        strengthDescription = 'muy d칠bil';
      }
      
      // Determinar si es relevante para la 칠poca del a침o
      const isSeasonRelevant = (month === 6 && (parameter1 === 'temperatura' || parameter2 === 'temperatura')) || // Verano
                              (month === 1 && (parameter1 === 'temperatura' || parameter2 === 'temperatura')); // Invierno
      
      // Determinar si es una correlaci칩n inusual
      const isUnusualCorrelation = (parameter1 === 'temperatura' && parameter2 === 'humedad' && correlation < -0.6) ||
                                  (parameter1 === 'presi칩n' && parameter2 === 'lluvia' && correlation < -0.4);
      
      // Variaciones seg칰n los par치metros
      const variations = {
        'temperatura-humedad': [
          `He analizado la relaci칩n entre la temperatura y la humedad en Benavente y encontr칠 una correlaci칩n ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la temperatura ${correlation > 0 ? 'aumenta' : 'disminuye'}, la humedad tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la humedad puede explicarse por cambios en la temperatura. ${isUnusualCorrelation ? 'Esta correlaci칩n es t칤pica del clima mediterr치neo continentalizado de Benavente.' : 'Este patr칩n es inusual para nuestra zona.'}`,
          `Nuestro an치lisis de correlaci칩n entre temperatura y humedad en Benavente muestra una relaci칩n ${strengthDescription} (${correlation.toFixed(2)}). ${correlation > 0 ? 'Cuando hace m치s calor, el aire puede contener m치s humedad.' : 'Cuando hace m치s calor, la humedad relativa disminuye aunque la cantidad de vapor de agua permanezca constante.'} El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la humedad est치 relacionada con la temperatura. ${isUnusualCorrelation ? 'Este patr칩n es esperado para el clima de Benavente.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'}`,
          `La correlaci칩n entre temperatura y humedad en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). Esto es ${correlation > 0 ? 'poco com칰n' : 'com칰n'} en climas mediterr치neos. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la humedad puede atribuirse a cambios en la temperatura. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n es interesante para entender el clima local.'}`
        ],
        'presi칩n-lluvia': [
          `He analizado la relaci칩n entre la presi칩n atmosf칠rica y la lluvia en Benavente y encontr칠 una correlaci칩n ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la presi칩n ${correlation > 0 ? 'aumenta' : 'disminuye'}, la probabilidad de lluvia tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la lluvia puede explicarse por cambios en la presi칩n. ${isUnusualCorrelation ? 'Esta correlaci칩n es t칤pica del clima mediterr치neo continentalizado de Benavente.' : 'Este patr칩n es inusual para nuestra zona.'}`,
          `Nuestro an치lisis de correlaci칩n entre presi칩n atmosf칠rica y lluvia en Benavente muestra una relaci칩n ${strengthDescription} (${correlation.toFixed(2)}). ${correlation < 0 ? 'Las bajas presiones suelen indicar sistemas de mal tiempo.' : 'Las altas presiones suelen indicar buen tiempo.'} El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la lluvia est치 relacionada con la presi칩n. ${isUnusualCorrelation ? 'Este patr칩n es esperado para el clima de Benavente.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'}`,
          `La correlaci칩n entre presi칩n atmosf칠rica y lluvia en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). Esto es ${correlation < 0 ? 'com칰n' : 'poco com칰n'} en climas mediterr치neos. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la lluvia puede atribuirse a cambios en la presi칩n. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n es interesante para entender el clima local.'}`
        ],
        'temperatura-presi칩n': [
          `He analizado la relaci칩n entre la temperatura y la presi칩n atmosf칠rica en Benavente y encontr칠 una correlaci칩n ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la temperatura ${correlation > 0 ? 'aumenta' : 'disminuye'}, la presi칩n tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la presi칩n puede explicarse por cambios en la temperatura. ${isUnusualCorrelation ? 'Esta correlaci칩n es t칤pica del clima mediterr치neo continentalizado de Benavente.' : 'Este patr칩n es inusual para nuestra zona.'}`,
          `Nuestro an치lisis de correlaci칩n entre temperatura y presi칩n atmosf칠rica en Benavente muestra una relaci칩n ${strengthDescription} (${correlation.toFixed(2)}). En la llanura del Duero, estas variables suelen tener una relaci칩n compleja. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la presi칩n est치 relacionada con la temperatura. ${isUnusualCorrelation ? 'Este patr칩n es esperado para el clima de Benavente.' : 'Este patr칩n merece atenci칩n para actividades al aire libre.'}`,
          `La correlaci칩n entre temperatura y presi칩n atmosf칠rica en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). Esto es ${correlation > 0 ? 'poco com칰n' : 'com칰n'} en zonas de altitud media como Benavente (${benaventeInfo.altitude}). El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la presi칩n puede atribuirse a cambios en la temperatura. ${isSeasonRelevant ? 'Este patr칩n es esperado para esta 칠poca del a침o.' : 'Este patr칩n es interesante para entender el clima local.'}`
        ]
      };
      
      // Crear clave para la combinaci칩n de par치metros
      const key = `${parameter1}-${parameter2}`;
      const reverseKey = `${parameter2}-${parameter1}`;
      
      // Intentar obtener variaciones para la combinaci칩n espec칤fica
      if (variations[key]) {
        return variations[key];
      } else if (variations[reverseKey]) {
        // Si la combinaci칩n est치 en orden inverso, ajustar el texto
        return variations[reverseKey].map(variation => 
          variation.replace(/temperatura y la humedad/g, `${parameter2} y la ${parameter1}`)
                  .replace(/temperatura y humedad/g, `${parameter2} y ${parameter1}`)
                  .replace(/temperatura con la humedad/g, `${parameter2} con la ${parameter1}`)
                  .replace(/temperatura la humedad/g, `${parameter2} la ${parameter1}`)
                  .replace(/la temperatura y la humedad/g, `la ${parameter2} y la ${parameter1}`)
        );
      }
      
      // Si no hay combinaci칩n espec칤fica, usar una variaci칩n gen칠rica
      return [
        `He analizado la relaci칩n entre ${parameter1} y ${parameter2} en Benavente y encontr칠 una correlaci칩n ${strengthDescription} (${correlation.toFixed(2)}). Esto significa que cuando la ${parameter1} ${correlation > 0 ? 'aumenta' : 'disminuye'}, la ${parameter2} tiende a ${correlation > 0 ? 'aumentar' : 'disminuir'}. El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la ${parameter2} puede explicarse por cambios en la ${parameter1}.`,
        `Nuestro an치lisis de correlaci칩n entre ${parameter1} y ${parameter2} en Benavente muestra una relaci칩n ${strengthDescription} (${correlation.toFixed(2)}). El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la ${parameter2} est치 relacionada con la ${parameter1}.`,
        `La correlaci칩n entre ${parameter1} y ${parameter2} en Benavente es ${strengthDescription} (${correlation.toFixed(2)}). El ${Math.abs(rSquared * 100).toFixed(1)}% de la variaci칩n en la ${parameter2} puede atribuirse a cambios en la ${parameter1}.`
      ];
    },
    
    // Variaciones para ayuda
    getHelpVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si hay un evento local relevante
      const relevantEvent = benaventeInfo.localEvents.find(event => {
        // Aqu칤 ir칤a la l칩gica para detectar eventos relevantes para el clima
        return Math.random() > 0.7; // Simulaci칩n aleatoria
      });
      
      const variations = [
        `춰Claro que s칤! ${localPhrase} Soy Horus AI, tu asistente meteorol칩gico para Benavente. Aqu칤 tienes algunas preguntas que puedo ayudarte a resolver:`,
        `Por supuesto. ${localPhrase} Como asistente meteorol칩gico especializado en Benavente, puedo ayudarte con:`,
        `춰Con gusto! ${localPhrase} Como experto en el clima de Benavente, puedo ayudarte con:`
      ];
      
      if (relevantEvent) {
        variations.push(
          `춰Claro que s칤! Con el ${relevantEvent} acerc치ndose, es importante estar informado. ${localPhrase} Como asistente meteorol칩gico para Benavente, puedo ayudarte con:`
        );
      }
      
      return variations;
    },
    
    // Variaciones para informaci칩n sobre Horus
    getAboutHorusVariations: () => {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si es relevante para la 칠poca del a침o
      const isSeasonRelevant = (month === 6) || // Verano
                              (month === 1); // Invierno
      
      const variations = [
        `Horus es una estaci칩n meteorol칩gica avanzada instalada en Benavente, dise침ada para monitorear las condiciones clim치ticas de nuestra querida ciudad. ${localPhrase} Nuestro sistema recoge datos en tiempo real sobre temperatura, humedad, presi칩n y otros par치metros para ayudarte a entender mejor el clima de la llanura del Duero.`,
        `Soy Horus, un sistema meteorol칩gico localizado en Benavente que proporciona datos precisos sobre el clima de nuestra zona. ${localPhrase} Nuestro sistema est치 especialmente calibrado para el clima mediterr치neo continentalizado de Benavente, a ${benaventeInfo.altitude}.`,
        `El sistema Horus en Benavente es una estaci칩n meteorol칩gica de 칰ltima generaci칩n que monitorea constantemente el clima de nuestra ciudad. ${localPhrase} Desde la Plaza Mayor hasta el R칤o Esla, nuestros sensores recogen datos que nos permiten ofrecerte informaci칩n meteorol칩gica precisa y relevante para tu d칤a a d칤a.`
      ];
      
      if (isSeasonRelevant) {
        variations.push(
          `En esta 칠poca del a침o, el sistema Horus en Benavente es especialmente 칰til para monitorear ${month === 6 ? 'las altas temperaturas del verano' : 'las bajas temperaturas del invierno'}. ${localPhrase} Nuestros datos ayudan a los vecinos de Benavente a prepararse para las condiciones clim치ticas t칤picas de esta estaci칩n.`
        );
      }
      
      return variations;
    },
    
    // Variaciones para soporte t칠cnico
    getSupportVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      const variations = [
        `Lamento que est칠s teniendo problemas. ${localPhrase} Como asistente meteorol칩gico para Benavente, har칠 lo posible por ayudarte. Aqu칤 hay algunas soluciones que suelen funcionar:`,
        `Vaya, parece que hay un problema. ${localPhrase} No te preocupes, como experto en el sistema Horus de Benavente, puedo ayudarte a resolverlo. Prueba estos pasos:`,
        `춰Vaya fresquete! Veo que est치s teniendo problemas. ${localPhrase} Como asistente meteorol칩gico para Benavente, te recomiendo:`
      ];
      
      return variations;
    },
    
    // Variaciones para informaci칩n personal
    getPersonalInfoVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      const variations = [
        `Soy Horus AI, un asistente inteligente especializado en el clima de Benavente. ${localPhrase} Fui creado para ayudar a los vecinos y visitantes de Benavente a entender mejor el clima de nuestra ciudad, ubicada en la llanura del Duero a ${benaventeInfo.altitude}.`,
        `춰Hola! Soy Horus AI, tu asistente meteorol칩gico para Benavente. ${localPhrase} Mi prop칩sito es proporcionar informaci칩n precisa y 칰til sobre el clima de Benavente, con su clima mediterr치neo continentalizado y sus caracter칤sticas 칰nicas.`,
        `Soy Horus AI, un sistema de inteligencia artificial especializado en meteorolog칤a para Benavente. ${localPhrase} Aunque no soy humano, tengo un profundo conocimiento del clima de Benavente y estoy aqu칤 para ayudarte a entenderlo mejor.`
      ];
      
      return variations;
    },
    
    // Variaciones para informaci칩n general
    getGeneralInfoVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      const month = now.getMonth();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      // Determinar si es relevante para la 칠poca del a침o
      const isSummer = month >= 5 && month <= 8;
      const isWinter = month >= 11 || month <= 2;
      
      const variations = [
        `Benavente, ubicada a ${benaventeInfo.altitude} en la llanura del Duero, tiene un clima mediterr치neo continentalizado. ${localPhrase} ${isSummer ? 'En verano, las temperaturas pueden superar los 35춿C.' : isWinter ? 'En invierno, las temperaturas pueden bajar de 0춿C.' : 'En esta 칠poca del a침o, el clima es moderado con d칤as agradables.'}`,
        `Nuestra querida Benavente se encuentra a ${benaventeInfo.altitude} sobre el nivel del mar, con coordenadas ${benaventeInfo.coordinates}. ${localPhrase} El clima de Benavente es mediterr치neo continentalizado, caracterizado por veranos calurosos e inviernos fr칤os.`,
        `Benavente, en la provincia de Zamora, disfruta de un clima mediterr치neo continentalizado gracias a su ubicaci칩n en la llanura del Duero a ${benaventeInfo.altitude}. ${localPhrase} Las temperaturas var칤an desde -5춿C en invierno hasta m치s de 35춿C en verano.`
      ];
      
      return variations;
    },
    
    // Variaciones para preguntas fuera del 치mbito
    getOutOfScopeVariations: (domain) => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      const variations = {
        salud: [
          `Soy un asistente meteorol칩gico especializado para Benavente, no tengo informaci칩n m칠dica. ${localPhrase} Para consultas sobre salud, te recomiendo contactar a un profesional m칠dico calificado en Benavente.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol칩gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf칠ricas. Para informaci칩n m칠dica, consulta a un profesional de salud.`,
          `춰Vaya! Veo que necesitas informaci칩n m칠dica. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s칤 puedo decirte c칩mo el clima afecta ciertas condiciones de salud.`
        ],
        tecnolog칤a: [
          `Soy un asistente meteorol칩gico especializado para Benavente. ${localPhrase} Para consultas sobre tecnolog칤a, te recomiendo buscar en foros especializados o consultar documentaci칩n oficial de los productos.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol칩gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf칠ricas. Para informaci칩n tecnol칩gica, consulta fuentes especializadas.`,
          `춰Vaya fresquete! Veo que necesitas ayuda tecnol칩gica. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s칤 puedo decirte c칩mo el clima afecta a algunos dispositivos electr칩nicos.`
        ],
        deportes: [
          `Soy un asistente meteorol칩gico especializado para Benavente. ${localPhrase} Para informaci칩n sobre deportes, te recomiendo visitar el Ayuntamiento de Benavente o seguir el Club Deportivo local.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol칩gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf칠ricas. Pero puedo decirte c칩mo el clima afecta a las actividades deportivas al aire libre.`,
          `춰Vaya! Veo que necesitas informaci칩n deportiva. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s칤 puedo decirte c칩mo el clima afecta a las actividades deportivas en nuestra zona.`
        ],
        entretenimiento: [
          `Soy un asistente meteorol칩gico especializado para Benavente. ${localPhrase} Para informaci칩n sobre entretenimiento, te recomiendo visitar la p치gina web del Ayuntamiento de Benavente o seguir eventos en la Plaza Mayor.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol칩gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf칠ricas. Pero puedo decirte c칩mo el clima afecta a los eventos al aire libre.`,
          `춰Vaya fresquete! Veo que necesitas informaci칩n de entretenimiento. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s칤 puedo decirte c칩mo el clima afecta a los eventos en nuestra zona.`
        ],
        comida: [
          `Soy un asistente meteorol칩gico especializado para Benavente. ${localPhrase} Para recetas o informaci칩n sobre comida, te recomiendo consultar sitios web especializados en gastronom칤a zamorana.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol칩gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf칠ricas. Pero puedo decirte c칩mo el clima afecta a los productos locales de temporada.`,
          `춰Vaya! Veo que necesitas informaci칩n culinaria. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s칤 puedo decirte c칩mo el clima afecta a los productos locales que se usan en la cocina tradicional.`
        ],
        educaci칩n: [
          `Soy un asistente meteorol칩gico especializado para Benavente. ${localPhrase} Para informaci칩n educativa, te recomiendo consultar la p치gina web del Ayuntamiento de Benavente o contactar al IES local.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol칩gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf칠ricas. Pero puedo proporcionar informaci칩n sobre meteorolog칤a y ciencias atmosf칠ricas.`,
          `춰Vaya fresquete! Veo que necesitas informaci칩n educativa. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s칤 puedo compartir contigo conocimientos sobre meteorolog칤a y clima local.`
        ],
        finanzas: [
          `Soy un asistente meteorol칩gico especializado para Benavente. ${localPhrase} Para consultas financieras, te recomiendo consultar a un asesor financiero en Benavente.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol칩gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf칠ricas. Pero puedo decirte c칩mo el clima afecta a ciertos sectores econ칩micos locales.`,
          `춰Vaya! Veo que necesitas informaci칩n financiera. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s칤 puedo decirte c칩mo el clima afecta a actividades econ칩micas como la agricultura en nuestra zona.`
        ],
        general: [
          `Soy un asistente meteorol칩gico especializado para Benavente. ${localPhrase} Mi conocimiento est치 limitado a monitorear y analizar datos meteorol칩gicos en Benavente, el funcionamiento del sistema Horus y an치lisis de tendencias clim치ticas de la zona.`,
          `Lamento no poder ayudarte con eso. ${localPhrase} Como asistente meteorol칩gico para Benavente, mi conocimiento se limita al clima y las condiciones atmosf칠ricas de nuestra zona.`,
          `춰Vaya fresquete! Veo que necesitas informaci칩n fuera de mi 치mbito. ${localPhrase} Como experto en el clima de Benavente, no puedo ayudarte con eso, pero s칤 puedo compartir contigo informaci칩n relevante sobre el clima de nuestra querida ciudad.`
        ]
      };
      
      return variations[domain] || variations.general;
    },
    
    // Variaciones para preguntas no entendidas
    getUnrelatedVariations: () => {
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      
      // Obtener una frase local aleatoria
      const localPhrase = benaventeInfo.localPhrases[
        Math.floor(Math.random() * benaventeInfo.localPhrases.length)
      ];
      
      return [
        `Lamento no entender tu pregunta. ${localPhrase} Soy un asistente meteorol칩gico especializado en Benavente. 쯇odr칤as reformular tu pregunta para que est칠 relacionada con el clima de Benavente?`,
        `춰Vaya fresquete! No estoy seguro de entender lo que me pides. ${localPhrase} Como asistente meteorol칩gico para Benavente, 쯣odr칤as preguntar algo relacionado con el clima de nuestra ciudad?`,
        `Perd칩n, no he captado bien tu pregunta. ${localPhrase} Como experto en el clima de Benavente, necesito que tu pregunta est칠 relacionada con meteorolog칤a o el sistema Horus.`
      ];
    }
  };

  // Funci칩n para obtener una variaci칩n aleatoria
  const getRandomVariation = (variationsArray) => {
    if (!variationsArray || variationsArray.length === 0) {
      return "No se encontraron variaciones para esta consulta.";
    }
    
    const randomIndex = Math.floor(Math.random() * variationsArray.length);
    return variationsArray[randomIndex];
  };

  // Enviar mensaje
  const sendMessage = async () => {
    const message = userInput.value.trim();
    if (message === '' || !chatbotReady) return;
    
    // Procesar mensaje
    const response = await processUserMessage(message);
    
    // Muestra la respuesta
    if (response) {
      addMessage(response, false, openAIApi.isConfigured() ? 'openai' : 'local');
    }
  };

  // Renderizar gr치ficos - CORREGIDO
  const renderChart = (parameter, chartData, chartId) => {
    const chartCtx = document.getElementById(chartId)?.getContext('2d');
    if (!chartCtx) return;
    
    // Determina el nombre del par치metro y colores
    let paramName = '';
    let color = '#4a90e2';
    let unit = '';
    
    switch (parameter) {
      case 'temperatura':
        paramName = 'Temperatura';
        color = '#FF6384';
        unit = '춿C';
        break;
      case 'humedad':
        paramName = 'Humedad';
        color = '#36A2EB';
        unit = '%';
        break;
      case 'presi칩n':
        paramName = 'Presi칩n Atmosf칠rica';
        color = '#FFCE56';
        unit = 'hPa';
        break;
      case 'lluvia':
        paramName = 'Precipitaci칩n';
        color = '#46BFBD';
        unit = 'Presencia';
        break;
      case 'viento':
        paramName = 'Viento';
        color = '#C9CBCF';
        unit = 'm/s';
        break;
      case 'gas':
        paramName = 'Nivel de Gas';
        color = '#FDB45C';
        unit = 'k풜';
        break;
      case 'direcci칩n':
        paramName = 'Direcci칩n del Viento';
        color = '#9966FF';
        unit = '춿';
        break;
      default:
        paramName = 'Medici칩n';
        unit = '';
    }
    
    // Crea el nuevo gr치fico - CORREGIDO: estructura correcta de data
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        datasets: [{
          label: paramName,
          data: chartData,
          borderColor: color,
          backgroundColor: `${color}40`,
          borderWidth: 3,
          tension: 0.3,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day'
            },
            title: {
              display: true,
              text: 'Fecha'
            }
          },
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: unit
            }
          }
        }
      }
    });
    
    // Almacenar instancia del gr치fico para actualizarla al cambiar de tema
    charts.push(chart);
  };
  
  // Renderizar gr치ficos de comparaci칩n - CORREGIDO
  const renderComparisonChart = (parameter, chartData1, chartData2, period1, period2, chartId) => {
    const chartCtx = document.getElementById(chartId)?.getContext('2d');
    if (!chartCtx) return;
    
    // Determina el nombre del par치metro y colores
    let paramName = '';
    let color1 = '#FF6384';
    let color2 = '#36A2EB';
    let unit = '';
    
    switch (parameter) {
      case 'temperatura':
        paramName = 'Temperatura';
        unit = '춿C';
        break;
      case 'humedad':
        paramName = 'Humedad';
        unit = '%';
        break;
      case 'presi칩n':
        paramName = 'Presi칩n Atmosf칠rica';
        unit = 'hPa';
        break;
      case 'lluvia':
        paramName = 'Precipitaci칩n';
        unit = 'Presencia';
        break;
      case 'viento':
        paramName = 'Viento';
        unit = 'm/s';
        break;
      case 'gas':
        paramName = 'Nivel de Gas';
        unit = 'k풜';
        break;
      case 'direcci칩n':
        paramName = 'Direcci칩n del Viento';
        unit = '춿';
        break;
      default:
        paramName = 'Medici칩n';
        unit = '';
    }
    
    // Crea el nuevo gr치fico - CORREGIDO: estructura correcta de data
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: period1,
             chartData1,
            borderColor: color1,
            backgroundColor: `${color1}40`,
            borderWidth: 3,
            tension: 0.3,
            pointRadius: 3
          },
          {
            label: period2,
            data: chartData2,
            borderColor: color2,
            backgroundColor: `${color2}40`,
            borderWidth: 3,
            tension: 0.3,
            pointRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day'
            },
            title: {
              display: true,
              text: 'Fecha'
            }
          },
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: unit
            }
          }
        }
      }
    });
    
    // Almacenar instancia del gr치fico para actualizarla al cambiar de tema
    charts.push(chart);
  };

  // Renderizar gr치ficos de extremos - CORREGIDO
  const renderExtremesChart = (parameter, chartData, maxDate, minDate, chartId) => {
    const chartCtx = document.getElementById(chartId)?.getContext('2d');
    if (!chartCtx) return;
    
    // Determina el nombre del par치metro y colores
    let paramName = '';
    let color = '#4a90e2';
    let unit = '';
    
    switch (parameter) {
      case 'temperatura':
        paramName = 'Temperatura';
        color = '#FF6384';
        unit = '춿C';
        break;
      case 'humedad':
        paramName = 'Humedad';
        color = '#36A2EB';
        unit = '%';
        break;
      case 'presi칩n':
        paramName = 'Presi칩n Atmosf칠rica';
        color = '#FFCE56';
        unit = 'hPa';
        break;
      case 'lluvia':
        paramName = 'Precipitaci칩n';
        color = '#46BFBD';
        unit = 'Presencia';
        break;
      case 'viento':
        paramName = 'Viento';
        color = '#C9CBCF';
        unit = 'm/s';
        break;
      case 'gas':
        paramName = 'Nivel de Gas';
        color = '#FDB45C';
        unit = 'k풜';
        break;
      case 'direcci칩n':
        paramName = 'Direcci칩n del Viento';
        color = '#9966FF';
        unit = '춿';
        break;
      default:
        paramName = 'Medici칩n';
        unit = '';
    }
    
    // Preparar datos con marcadores para m치ximos y m칤nimos
    const dataWithMarkers = chartData.map(item => ({
      x: item.x,
      y: item.y,
      pointBackgroundColor: item.x.toISOString() === maxDate || item.x.toISOString() === minDate ? 
                            (item.x.toISOString() === maxDate ? '#FF0000' : '#0000FF') : 
                            color
    }));
    
    // Crea el nuevo gr치fico - CORREGIDO: estructura correcta de data
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        datasets: [{
          label: paramName,
           dataWithMarkers,
          borderColor: color,
          backgroundColor: `${color}40`,
          borderWidth: 3,
          tension: 0.3,
          pointRadius: function(context) {
            const index = context.dataIndex;
            const value = context.dataset.data[index];
            return value.pointBackgroundColor !== color ? 6 : 3;
          },
          pointBackgroundColor: function(context) {
            const index = context.dataIndex;
            const value = context.dataset.data[index];
            return value.pointBackgroundColor;
          }
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day'
            },
            title: {
              display: true,
              text: 'Fecha'
            }
          },
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: unit
            }
          }
        }
      }
    });
    
    // Almacenar instancia del gr치fico para actualizarla al cambiar de tema
    charts.push(chart);
  };

  // Renderizar gr치ficos de correlaci칩n - CORREGIDO
  const renderCorrelationChart = (parameter1, parameter2, chartData, chartId) => {
    const chartCtx = document.getElementById(chartId)?.getContext('2d');
    if (!chartCtx) return;
    
    // Determina los nombres de los par치metros y colores
    let paramName1 = '';
    let paramName2 = '';
    let color1 = '#FF6384';
    let color2 = '#36A2EB';
    let unit1 = '';
    let unit2 = '';
    
    const getParameterInfo = (parameter) => {
      switch (parameter) {
        case 'temperatura':
          return { name: 'Temperatura', color: '#FF6384', unit: '춿C' };
        case 'humedad':
          return { name: 'Humedad', color: '#36A2EB', unit: '%' };
        case 'presi칩n':
          return { name: 'Presi칩n Atmosf칠rica', color: '#FFCE56', unit: 'hPa' };
        case 'lluvia':
          return { name: 'Precipitaci칩n', color: '#46BFBD', unit: 'Presencia' };
        case 'viento':
          return { name: 'Viento', color: '#C9CBCF', unit: 'm/s' };
        case 'gas':
          return { name: 'Nivel de Gas', color: '#FDB45C', unit: 'k풜' };
        case 'direcci칩n':
          return { name: 'Direcci칩n del Viento', color: '#9966FF', unit: '춿' };
        default:
          return { name: 'Medici칩n', color: '#4a90e2', unit: '' };
      }
    };
    
    const info1 = getParameterInfo(parameter1);
    const info2 = getParameterInfo(parameter2);
    
    paramName1 = info1.name;
    color1 = info1.color;
    unit1 = info1.unit;
    
    paramName2 = info2.name;
    color2 = info2.color;
    unit2 = info2.unit;
    
    // Crea el nuevo gr치fico - CORREGIDO: estructura correcta de data
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: paramName1,
            data: chartData.map(item => ({ x: item.x, y: item.y1 })),
            borderColor: color1,
            backgroundColor: `${color1}40`,
            borderWidth: 3,
            tension: 0.3,
            pointRadius: 3
          },
          {
            label: paramName2,
             chartData.map(item => ({ x: item.x, y: item.y2 })),
            borderColor: color2,
            backgroundColor: `${color2}40`,
            borderWidth: 3,
            tension: 0.3,
            pointRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day'
            },
            title: {
              display: true,
              text: 'Fecha'
            }
          },
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: `${unit1} / ${unit2}`
            }
          }
        }
      }
    });
    
    // Almacenar instancia del gr치fico para actualizarla al cambiar de tema
    charts.push(chart);
  };

  // Configurar API de OpenAI
  const toggleApiConfig = () => {
    apiConfig.style.display = apiConfig.style.display === 'none' ? 'block' : 'none';
  };

  // Verificar estado de la API
  const checkApiKeyStatus = async () => {
    if (openAIApi.isConfigured()) {
      const isValid = await openAIApi.verifyApiKey();
      if (isValid) {
        apiStatus.textContent = 'Estado: API configurada y v치lida';
        apiStatus.className = 'api-status connected';
        updateStatus("OpenAI API configurada correctamente - Usando IA avanzada");
      } else {
        apiStatus.textContent = 'Estado: API configurada pero inv치lida';
        apiStatus.className = 'api-status disconnected';
        updateStatus("Error con la API de OpenAI - Usando sistema local", true);
      }
    } else {
      apiStatus.textContent = 'Estado: No configurado';
      apiStatus.className = 'api-status disconnected';
      updateStatus("API de IA no configurada - Usando sistema local");
    }
  };

  // Guardar API key
  saveApiKeyBtn.addEventListener('click', () => {
    const apiKey = apiKeyInput.value.trim();
    if (apiKey) {
      openAIApi.configure(apiKey);
      checkApiKeyStatus();
      apiKeyInput.value = '';
      setTimeout(async () => {
        const isValid = await openAIApi.verifyApiKey();
        if (isValid) {
          addMessage("九 API de OpenAI configurada correctamente. 춰Ahora podr치s obtener respuestas m치s avanzadas!", false, 'local');
        } else {
          addMessage("丘멆잺 La API key parece ser inv치lida. Por favor, verifica que la clave sea correcta.", false, 'local');
        }
      }, 300);
    }
  });

  // Configurar bot칩n de configuraci칩n de API
  if (apiConfigToggle) {
    apiConfigToggle.addEventListener('click', toggleApiConfig);
  }

  // Inicializar estado de la API
  checkApiKeyStatus();

  // Inicializar chatbot
  const initChatbot = async () => {
    try {
      // Inicializar OpenAI API
      const apiKeyConfigured = openAIApi.init();
      
      // Configurar tema
      const themeSwitch = document.querySelector('.theme-switch__checkbox');
      if (themeSwitch) {
        // Verificar tema actual
        const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
        themeSwitch.checked = currentTheme === 'dark';
        
        // Manejar el cambio de tema
        themeSwitch.addEventListener('change', function() {
          if (this.checked) {
            document.body.classList.remove('light-mode');
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
          } else {
            document.body.classList.remove('dark-mode');
            document.body.classList.add('light-mode');
            localStorage.setItem('theme', 'light');
          }
          
          // Actualizar gr치ficos para reflejar el nuevo tema
          if (typeof window.updateChatbotCharts === 'function') {
            window.updateChatbotCharts();
          }
        });
      }
      
      // Cargar tema guardado
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.body.classList.remove('light-mode');
        document.body.classList.add('dark-mode');
        if (themeSwitch) themeSwitch.checked = true;
      } else {
        document.body.classList.remove('dark-mode');
        document.body.classList.add('light-mode');
        if (themeSwitch) themeSwitch.checked = false;
      }
      
      // Hacer disponible para main.js
      window.updateChatbotCharts = () => {
        // Destruir y recrear los gr치ficos para actualizar colores
        charts.forEach(chart => {
          if (chart && chart.destroy) {
            chart.destroy();
          }
        });
        charts = [];
        
        // Volver a renderizar todos los gr치ficos
        setTimeout(() => {
          document.querySelectorAll('.prediction-chart').forEach(canvas => {
            const parameter = canvas.dataset.parameter;
            const chartData = JSON.parse(canvas.dataset.chartData);
            renderChart(parameter, chartData, canvas.id);
          });
          
          document.querySelectorAll('.comparison-chart').forEach(canvas => {
            const parameter = canvas.dataset.parameter;
            const chartData1 = JSON.parse(canvas.dataset.chartData1);
            const chartData2 = JSON.parse(canvas.dataset.chartData2);
            const period1 = canvas.dataset.period1;
            const period2 = canvas.dataset.period2;
            renderComparisonChart(parameter, chartData1, chartData2, period1, period2, canvas.id);
          });
          
          document.querySelectorAll('.extremes-chart').forEach(canvas => {
            const parameter = canvas.dataset.parameter;
            const chartData = JSON.parse(canvas.dataset.chartData);
            const maxDate = canvas.dataset.maxDate;
            const minDate = canvas.dataset.minDate;
            renderExtremesChart(parameter, chartData, maxDate, minDate, canvas.id);
          });
          
          document.querySelectorAll('.correlation-chart').forEach(canvas => {
            const parameter1 = canvas.dataset.parameter1;
            const parameter2 = canvas.dataset.parameter2;
            const chartData = JSON.parse(canvas.dataset.chartData);
            renderCorrelationChart(parameter1, parameter2, chartData, canvas.id);
          });
        }, 100);
      };
      
      // Cargar datos hist칩ricos
      await loadHistoricalData();
      
      chatbotReady = true;
      
      // Configurar sugerencias
      document.querySelectorAll('.suggestion').forEach(suggestion => {
        suggestion.addEventListener('click', () => {
          userInput.value = suggestion.textContent;
          sendMessage();
        });
      });
      
      // Configurar el bot칩n de enviar
      sendButton.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      
      // Mensaje de estado seg칰n si hay API key configurada
      if (apiKeyConfigured) {
        updateStatus("OpenAI API configurada correctamente - Usando IA avanzada");
      } else {
        updateStatus("API de IA no configurada - Usando sistema local");
      }
      
    } catch (error) {
      console.error('Error inicializando chatbot:', error);
      chatbotReady = true;
      updateStatus("Error al inicializar el chatbot", true);
    }
  };

  // Inicializar el chatbot
  initChatbot();
</script>
</body>
</html>
