<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatbot Meteorológico - Horus</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/chatbot.css" />
  <script src="../js/PapaParse.js"></script>
  <script src="../js/chart.js"></script>
</head>
<body class="light-mode chatbot-page">
  <!-- El resto del HTML permanece igual hasta la sección de JavaScript -->
  
  <script src="../js/main.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ... (variables y elementos del DOM permanecen igual)
      
      // Diccionario de palabras clave meteorológicas - ¡MEJORADO!
      const weatherKeywords = {
        general: ['clima', 'tiempo', 'meteorológico', 'atmosférico', 'atmósfera', 'condiciones', 'previsión', 
                 'pronóstico', 'predicción', 'tendencia', 'patrón', 'fenómeno', 'evento', 'sistema', 'masa'],
        
        temperature: ['temperatura', 'grados', 'calor', 'frío', 'termómetro', 'térmica', 'termica', 'térmico', 'termico',
                     'térmicas', 'termicas', 'térmicos', 'termicos', 'cálido', 'calido', 'cálida', 'calida', 'cálidos', 
                     'calidos', 'cálidas', 'calidas', 'calidez', 'frialdad', 'gradiente'],
        
        humidity: ['humedad', 'húmedo', 'humedo', 'húmeda', 'humeda', 'húmedas', 'humedas', 'humedades', 'vapor', 
                  'saturación', 'saturado', 'condensación', 'rocío', 'roció', 'rocio', 'humitad', 'humitida', 'humitidad'],
        
        pressure: ['presión', 'presion', 'atmosférica', 'atmosferica', 'barométrica', 'barometrica', 'barómetro',
                  'barometro', 'barometría', 'barometria', 'isobara', 'isobaras', 'alta presión', 'baja presión',
                  'anticiclón', 'anticiclon', 'ciclón', 'ciclon', 'gradiente', 'barica', 'barico'],
        
        precipitation: ['lluvia', 'precipitación', 'precipitacion', 'pluvial', 'pluviales', 'pluviosidad', 'llovizna',
                      'aguacero', 'chubasco', 'tormenta', 'tormentas', 'diluvio', 'aguas', 'lluvioso', 'lluviosa',
                      'lluviosos', 'lluviosas', 'pluviómetro', 'pluviometro', 'pluviometría', 'pluviometria'],
        
        wind: ['viento', 'velocidad', 'ráfaga', 'ráfagas', 'rafa', 'rafagas', 'anemómetro', 'anemometro',
              'dirección', 'direccíon', 'direccon', 'direc', 'brisa', 'ráfaga', 'ráfagas', 'velocidad del viento',
              'dirección del viento', 'circulación', 'circulaciones', 'anemografia', 'anemografía', 'anemometría'],
        
        airQuality: ['gas', 'contaminación', 'contaminacion', 'pm25', 'pm10', 'partículas', 'particulas', 'calidad',
                    'calidad del aire', 'aéreo', 'aereo', 'aérea', 'aerea', 'contaminante', 'contaminantes',
                    'polución', 'polucion', 'contaminación atmosférica', 'contaminacion atmosferica']
      };
      
      // Diccionario de palabras clave fuera del ámbito meteorológico - ¡NUEVO!
      const nonWeatherKeywords = {
        salud: ['salud', 'enfermedad', 'médico', 'hospital', 'doctor', 'enfermera', 'enfermero', 'medicina', 'remedio'],
        tecnología: ['computadora', 'ordenador', 'laptop', 'pc', 'smartphone', 'teléfono', 'móvil', 'celular', 'tecnología', 'internet'],
        deportes: ['fútbol', 'baloncesto', 'tenis', 'golf', 'deporte', 'partido', 'equipo', 'jugador', 'atleta'],
        entretenimiento: ['película', 'cine', 'música', 'canción', 'actor', 'actriz', 'serie', 'programa', 'televisión'],
        comida: ['comida', 'restaurante', 'plato', 'receta', 'cocina', 'comer', 'almuerzo', 'cena', 'desayuno'],
        viajes: ['viaje', 'vacaciones', 'turismo', 'aeropuerto', 'hotel', 'país', 'ciudad', 'destino', 'avión'],
        educación: ['escuela', 'universidad', 'clase', 'profesor', 'estudiante', 'estudiar', 'aprender', 'lección', 'curso'],
        finanzas: ['dinero', 'banco', 'cuenta', 'tarjeta', 'efectivo', 'ahorro', 'inversión', 'precio', 'costo'],
        política: ['gobierno', 'política', 'elección', 'presidente', 'ministro', 'ley', 'derecho', 'político', 'politico'],
        religión: ['religión', 'iglesia', 'templo', 'creencia', 'fe', 'oración', 'sacerdote', 'pastor', 'creyente']
      };
      
      // Calcular distancia de Levenshtein para corrección de errores
      const levenshteinDistance = (a, b) => {
        // ... (función permanece igual)
      };
      
      // Corregir errores tipográficos en palabras - ¡MEJORADA!
      const correctSpelling = (word, dictionary) => {
        // ... (función permanece igual)
      };
      
      // Sistema avanzado de análisis semántico - ¡MEJORADO!
      const semanticAnalysis = {
        // ... (otros métodos permanecen iguales)
        
        // Análisis de ámbito - ¡NUEVO!
        analyzeDomain: (text) => {
          const normalizedText = text.toLowerCase().replace(/[.,!?]/g, '');
          
          // Contadores de palabras clave
          let weatherCount = 0;
          let nonWeatherCount = 0;
          
          // Contar palabras clave meteorológicas
          for (const category in weatherKeywords) {
            weatherKeywords[category].forEach(keyword => {
              if (normalizedText.includes(keyword)) {
                weatherCount++;
              }
            });
          }
          
          // Contar palabras clave no meteorológicas
          for (const category in nonWeatherKeywords) {
            nonWeatherKeywords[category].forEach(keyword => {
              if (normalizedText.includes(keyword)) {
                nonWeatherCount++;
              }
            });
          }
          
          // Determinar si es una pregunta meteorológica
          const isWeatherQuestion = weatherCount > 0 && weatherCount > nonWeatherCount;
          
          // Identificar el ámbito no meteorológico si existe
          let nonWeatherDomain = null;
          if (nonWeatherCount > 0 && !isWeatherQuestion) {
            for (const domain in nonWeatherKeywords) {
              let domainCount = 0;
              nonWeatherKeywords[domain].forEach(keyword => {
                if (normalizedText.includes(keyword)) {
                  domainCount++;
                }
              });
              
              if (domainCount > 0 && (!nonWeatherDomain || domainCount > nonWeatherKeywords[nonWeatherDomain].length)) {
                nonWeatherDomain = domain;
              }
            }
          }
          
          return {
            isWeatherQuestion,
            weatherCount,
            nonWeatherCount,
            nonWeatherDomain
          };
        },
        
        // Análisis de intención - ¡MEJORADO!
        analyzeIntent: (text, entities, domainAnalysis) => {
          // ... (código anterior)
          
          // Si no es una pregunta meteorológica, determinar si es un saludo o despedida
          if (!domainAnalysis.isWeatherQuestion) {
            if (intentKeywords.greeting.some(kw => normalizedText.includes(kw))) {
              return 'greeting';
            }
            
            if (intentKeywords.goodbye.some(kw => normalizedText.includes(kw))) {
              return 'goodbye';
            }
            
            // Si no es saludo ni despedida, es una pregunta fuera de ámbito
            return 'out_of_scope';
          }
          
          // ... (el resto del código permanece igual)
        },
        
        // ... (el resto del código permanece igual)
      };
      
      // Detectar intención del usuario con análisis semántico avanzado - ¡MEJORADO!
      const detectIntent = (message) => {
        // ... (código anterior)
        
        // Análisis de ámbito - ¡NUEVO!
        const domainAnalysis = semanticAnalysis.analyzeDomain(normalizedMessage);
        
        // Análisis semántico avanzado
        const entities = semanticAnalysis.identifyEntities(normalizedMessage);
        const intentType = semanticAnalysis.analyzeIntent(normalizedMessage, entities, domainAnalysis);
        
        // ... (el resto del código permanece igual)
        
        return { 
          type: intentType, 
          entities: detectedEntities,
          originalMessage,
          correctedMessage: normalizedMessage,
          resolvedMessage,
          domainAnalysis  // ¡NUEVO! Incluimos el análisis de ámbito
        };
      };
      
      // Generar respuesta para preguntas fuera de ámbito - ¡NUEVO!
      const handleOutOfScope = (intent) => {
        const { domainAnalysis } = intent;
        
        // Mensajes personalizados según el ámbito
        const domainMessages = {
          salud: "Soy un asistente meteorológico especializado, no tengo información sobre salud. Te recomiendo consultar a un profesional médico para obtener asesoramiento sobre temas de salud.",
          tecnología: "Soy un asistente meteorológico especializado. Para consultas sobre tecnología, te recomiendo buscar información en fuentes especializadas en tecnología.",
          deportes: "Soy un asistente meteorológico especializado. Para información sobre deportes, te recomiendo consultar fuentes especializadas en deportes.",
          entretenimiento: "Soy un asistente meteorológico especializado. Para información sobre entretenimiento, te recomiendo consultar fuentes especializadas en cine, música o televisión.",
          comida: "Soy un asistente meteorológico especializado. Para recetas o información sobre comida, te recomiendo consultar fuentes especializadas en gastronomía.",
          viajes: "Soy un asistente meteorológico especializado. Si necesitas información sobre el clima en tu destino de viaje, puedo ayudarte con eso. Para otros aspectos de viajes, consulta fuentes especializadas en turismo.",
          educación: "Soy un asistente meteorológico especializado. Para información educativa sobre otros temas, te recomiendo consultar fuentes especializadas en educación.",
          finanzas: "Soy un asistente meteorológico especializado. Para consultas financieras, te recomiendo consultar a un asesor financiero profesional.",
          política: "Soy un asistente meteorológico especializado. Para información política, te recomiendo consultar fuentes especializadas en política y actualidad.",
          religión: "Soy un asistente meteorológico especializado. Para información sobre religión, te recomiendo consultar fuentes especializadas en este tema."
        };
        
        // Mensaje predeterminado si no se identifica un ámbito específico
        const defaultMessage = "Soy un asistente meteorológico especializado. Mi función principal es ayudarte con información y análisis relacionados con el clima y las condiciones atmosféricas. Si tienes preguntas sobre temperatura, humedad, presión atmosférica, viento u otros parámetros meteorológicos, estaré encantado de ayudarte.";
        
        // Si identificamos un ámbito específico, usamos el mensaje personalizado
        if (domainAnalysis.nonWeatherDomain && domainMessages[domainAnalysis.nonWeatherDomain]) {
          return domainMessages[domainAnalysis.nonWeatherDomain];
        }
        
        // Si la pregunta incluye palabras como "hola", "adiós", etc., pero no es meteorológica
        if (message.toLowerCase().includes('hola') || message.toLowerCase().includes('buenos días') || 
            message.toLowerCase().includes('buenas tardes') || message.toLowerCase().includes('buenas noches')) {
          return handleGreeting();
        }
        
        if (message.toLowerCase().includes('adiós') || message.toLowerCase().includes('gracias') || 
            message.toLowerCase().includes('hasta luego')) {
          return handleGoodbye();
        }
        
        // Si la pregunta incluye "chatbot" o "asistente", explicamos nuestra función
        if (message.toLowerCase().includes('chatbot') || message.toLowerCase().includes('asistente') || 
            message.toLowerCase().includes('quién eres') || message.toLowerCase().includes('qué eres')) {
          return "Soy Horus AI, un asistente meteorológico especializado diseñado para ayudarte con análisis y predicciones climáticas. Mi función principal es proporcionar información sobre temperatura, humedad, presión atmosférica, viento y otros parámetros meteorológicos. Si tienes preguntas sobre el clima, estaré encantado de ayudarte.";
        }
        
        // Si la pregunta es muy corta, asumimos que es un saludo
        if (message.split(' ').length <= 3) {
          return handleGreeting();
        }
        
        // Si la pregunta incluye "qué" o "cómo" pero no es meteorológica
        if (message.toLowerCase().includes('qué') || message.toLowerCase().includes('cómo')) {
          return "Soy un asistente meteorológico especializado. Mi función principal es ayudarte con información y análisis relacionados con el clima y las condiciones atmosféricas. Si tienes preguntas sobre temperatura, humedad, presión atmosférica, viento u otros parámetros meteorológicos, estaré encantado de ayudarte. Por ejemplo, puedes preguntar: '¿Cuál es la temperatura actual?' o '¿Cómo ha sido la tendencia de humedad en la última semana?'";
        }
        
        return defaultMessage;
      };
      
      // Procesar mensaje del usuario - ¡MEJORADO!
      const processUserMessage = async (message) => {
        const intent = detectIntent(message);
        
        // ... (el resto del código permanece igual)
        
        // Procesa según la intención
        switch (intent.type) {
          case 'greeting':
            return handleGreeting();
          
          case 'goodbye':
            return handleGoodbye();
          
          case 'prediction':
            return await generateWeatherPrediction(intent);
          
          case 'analysis':
            return await analyzeHistoricalData(intent);
          
          case 'correlation':
            return await analyzeCorrelation(intent);
          
          case 'comparison':
            return await analyzeComparison(intent);
          
          case 'help':
            return handleHelp();
          
          case 'out_of_scope':  // ¡NUEVO!
            return handleOutOfScope(intent);
          
          default:
            // Intentar detectar contexto de conversación previa
            if (conversationContext.lastQuestionType && conversationContext.lastParameter) {
              let paramName = '';
              // ... (código anterior)
              
              return `Parece que estabas preguntando sobre ${paramName}. ¿Te gustaría que profundice más en ese tema o prefieres hacer una nueva consulta sobre otro aspecto meteorológico?`;
            }
            
            // Si no hay contexto previo y no es claramente fuera de ámbito, asumimos que es general
            return "No estoy seguro de entender tu pregunta. Soy un asistente meteorológico especializado. ¿Podrías reformular tu pregunta relacionada con el clima o las condiciones atmosféricas? Por ejemplo, puedes preguntar sobre temperatura, humedad, presión atmosférica o viento.";
        }
      };
      
      // ... (el resto del código permanece igual)
    });
  </script>
</body>
</html>
