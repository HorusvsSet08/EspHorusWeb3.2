<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Datos en Vivo - Horus</title>
  
  <!-- Carga A-Frame 1.4.2 -->
  <script src="../js/aframe.js"></script>
  
  <!-- Carga MQTT.js desde CDN (versión garantizada) -->
  <script src="https://unpkg.com/mqtt@4.3.4/dist/mqtt.min.js"></script>
  
  <!-- Biblioteca para el joystick -->
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
  
  <style>
    /* Estilos idénticos a tu versión anterior */
    :root {
      --primary-color: #4a90e2;
      --card-bg: #ffffff;
      --background-color: #f8f9fa;
      --text-color: #212529;
      --text-muted: #6c757d;
      --border-color: #dee2e6;
      --input-bg: #ffffff;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --card-hover-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
      --transition: all 0.3s ease;
      --border-radius: 12px;
      --primary-dark: #3a7bc8;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --vr-primary: #00eaff;
      --vr-primary-glow: #00ffff33;
      --vr-dark-bg: #000a1a;
      --vr-card-bg: #1d3a5d;
      --vr-text: #f0f0f0;
      --vr-text-secondary: #e0e0e0;
    }

    [data-theme="dark"], .dark-mode {
      --primary-color: #5a9ee2;
      --card-bg: #2d3748;
      --background-color: #1a202c;
      --text-color: #e2e8f0;
      --text-muted: #a0aec0;
      --border-color: #4a5568;
      --input-bg: #2d3748;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      --card-hover-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
    }

    /* ... (el resto de tus estilos permanecen iguales) ... */
    
    /* Mantengo todos tus estilos existentes para no alterar tu interfaz */
    
  </style>
</head>
<body class="light-mode">
  <!-- ... (tu estructura HTML permanece igual) ... -->
  
  <script>
    // Variables globales
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let mqttClient;
    let mqttConnected = false;
    
    // Elementos UI - CORREGIDOS
    const statusDot = document.querySelector('.status-dot');
    const statusText = document.querySelector('.status-text');
    const lastUpdate = document.querySelector('.last-update');
    
    // Función para registrar mensajes en la consola
    function logDebugMessage(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      
      // Registrar en la consola con el tipo apropiado
      switch(type) {
        case 'connected':
        case 'success':
          console.log(`[Horus | ${timestamp}] ✅ ${message}`);
          break;
        case 'error':
          console.error(`[Horus | ${timestamp}] ❌ ${message}`);
          break;
        case 'warning':
          console.warn(`[Horus | ${timestamp}] ⚠️ ${message}`);
          break;
        case 'info':
        default:
          console.log(`[Horus | ${timestamp}] ℹ️ ${message}`);
          break;
      }
    }
    
    // Actualizar estado de conexión con animación - CORREGIDO
    function updateConnectionStatus(connected, message = "") {
      mqttConnected = connected;
      
      // Verificar si los elementos existen antes de intentar modificarlos
      if (statusDot) {
        statusDot.className = connected ? "status-dot connected" : "status-dot";
      }
      
      if (statusText) {
        statusText.textContent = connected ? "Conectado" : (message || "Desconectado");
      }
      
      // Actualizar el tiempo de última actualización
      if (lastUpdate) {
        lastUpdate.textContent = connected ? "última: ahora" : "última: nunca";
      }
    }
    
    // === CONEXIÓN MQTT - SOLUCIÓN DEFINITIVA PARA HIVE MQ ===
    function connectToMqtt() {
      // CORREGIDO: HiveMQ requiere configuración específica de subprotocolos
      const broker = {
        url: 'wss://broker.hivemq.com:8000/mqtt',
        description: 'Broker público HiveMQ'
      };
      
      logDebugMessage(`Intentando conectar a ${broker.url} (${broker.description})`, 'info');
      updateConnectionStatus(false, `Conectando a ${broker.description}...`);
      
      // Generar un ID de cliente único
      const clientId = 'horus_client_' + Math.random().toString(36).substr(2, 9);
      
      // CONFIGURACIÓN CORRECTA PARA HIVE MQ - ¡ESTO ES LO CLAVE!
      const options = {
        clientId: clientId,
        clean: true,
        connectTimeout: 60000,  // AUMENTADO a 60 segundos para conexiones más lentas
        reconnectPeriod: 5000,
        protocolVersion: 4,
        rejectUnauthorized: false,
        // CONFIGURACIÓN CORRECTA DE SUBPROTOCOLS - ¡ESTO ES LO QUE FALTABA!
        protocols: ['mqtt'],  // HiveMQ requiere específicamente 'mqtt' como subprotocolo
        properties: {
          requestProblemInformation: true
        },
        // IMPLEMENTACIÓN CORRECTA DE transformWsUrl
        transformWsUrl: function(url, options, client) {
          logDebugMessage("Transformando URL para reconexión", 'info');
          logDebugMessage("URL original: " + url, 'info');
          const finalUrl = url;
          logDebugMessage("URL final: " + finalUrl, 'info');
          return finalUrl;
        },
        // Habilitar reconexión para errores de CONNACK
        reconnectOnConnackError: true
      };

      try {
        // Limpiar cliente anterior si existe
        if (mqttClient) {
          try {
            mqttClient.end();
          } catch (e) {
            // Ignorar errores al cerrar cliente anterior
          }
          mqttClient = null;
        }

        logDebugMessage(`Creando cliente MQTT con ID: ${clientId}`, 'info');
        
        // Conectar usando mqtt.connect()
        mqttClient = mqtt.connect(broker.url, options);
        
        // Manejar eventos
        mqttClient.on('connect', () => {
          logDebugMessage("Conexión MQTT establecida con éxito", 'connected');
          updateConnectionStatus(true, `Conectado a ${broker.description}`);
          
          // Suscribirse a todos los tópicos de Horus
          mqttClient.subscribe("horus/#", (err) => {
            if (!err) {
              logDebugMessage("Suscrito a todos los tópicos horus/#", 'success');
            } else {
              logDebugMessage(`Error al suscribirse: ${err.message}`, 'error');
            }
          });
        });
        
        mqttClient.on('error', (err) => {
          logDebugMessage(`Error MQTT: ${err.message}`, 'error');
          updateConnectionStatus(false, `Error de conexión: ${err.message}`);
        });
        
        mqttClient.on('close', () => {
          logDebugMessage("Conexión cerrada", 'info');
          updateConnectionStatus(false, 'Conexión cerrada');
          
          // Intentar reconectar automáticamente
          setTimeout(() => {
            logDebugMessage("Intentando reconectar...", 'info');
            connectToMqtt();
          }, 5000);
        });
        
        mqttClient.on('reconnect', () => {
          logDebugMessage("Intentando reconectar...", 'info');
          updateConnectionStatus(false, 'Reconectando...');
        });
        
      } catch (error) {
        logDebugMessage(`Error al inicializar MQTT: ${error.message}`, 'error');
        updateConnectionStatus(false, `Error de inicialización: ${error.message}`);
      }
    }
    
    // Inicializar la aplicación
    window.addEventListener('load', () => {
      // Conectar al broker HiveMQ
      connectToMqtt();
    });
  </script>
</body>
</html>
